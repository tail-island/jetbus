<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Androidアプリ開発ガイド</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style type="text/css">@font-face {
font-family: octicons-link;
src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAZwABAAAAAACFQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABEU0lHAAAGaAAAAAgAAAAIAAAAAUdTVUIAAAZcAAAACgAAAAoAAQAAT1MvMgAAAyQAAABJAAAAYFYEU3RjbWFwAAADcAAAAEUAAACAAJThvmN2dCAAAATkAAAABAAAAAQAAAAAZnBnbQAAA7gAAACyAAABCUM+8IhnYXNwAAAGTAAAABAAAAAQABoAI2dseWYAAAFsAAABPAAAAZwcEq9taGVhZAAAAsgAAAA0AAAANgh4a91oaGVhAAADCAAAABoAAAAkCA8DRGhtdHgAAAL8AAAADAAAAAwGAACfbG9jYQAAAsAAAAAIAAAACABiATBtYXhwAAACqAAAABgAAAAgAA8ASm5hbWUAAAToAAABQgAAAlXu73sOcG9zdAAABiwAAAAeAAAAME3QpOBwcmVwAAAEbAAAAHYAAAB/aFGpk3jaTY6xa8JAGMW/O62BDi0tJLYQincXEypYIiGJjSgHniQ6umTsUEyLm5BV6NDBP8Tpts6F0v+k/0an2i+itHDw3v2+9+DBKTzsJNnWJNTgHEy4BgG3EMI9DCEDOGEXzDADU5hBKMIgNPZqoD3SilVaXZCER3/I7AtxEJLtzzuZfI+VVkprxTlXShWKb3TBecG11rwoNlmmn1P2WYcJczl32etSpKnziC7lQyWe1smVPy/Lt7Kc+0vWY/gAgIIEqAN9we0pwKXreiMasxvabDQMM4riO+qxM2ogwDGOZTXxwxDiycQIcoYFBLj5K3EIaSctAq2kTYiw+ymhce7vwM9jSqO8JyVd5RH9gyTt2+J/yUmYlIR0s04n6+7Vm1ozezUeLEaUjhaDSuXHwVRgvLJn1tQ7xiuVv/ocTRF42mNgZGBgYGbwZOBiAAFGJBIMAAizAFoAAABiAGIAznjaY2BkYGAA4in8zwXi+W2+MjCzMIDApSwvXzC97Z4Ig8N/BxYGZgcgl52BCSQKAA3jCV8CAABfAAAAAAQAAEB42mNgZGBg4f3vACQZQABIMjKgAmYAKEgBXgAAeNpjYGY6wTiBgZWBg2kmUxoDA4MPhGZMYzBi1AHygVLYQUCaawqDA4PChxhmh/8ODDEsvAwHgMKMIDnGL0x7gJQCAwMAJd4MFwAAAHjaY2BgYGaA4DAGRgYQkAHyGMF8NgYrIM3JIAGVYYDT+AEjAwuDFpBmA9KMDEwMCh9i/v8H8sH0/4dQc1iAmAkALaUKLgAAAHjaTY9LDsIgEIbtgqHUPpDi3gPoBVyRTmTddOmqTXThEXqrob2gQ1FjwpDvfwCBdmdXC5AVKFu3e5MfNFJ29KTQT48Ob9/lqYwOGZxeUelN2U2R6+cArgtCJpauW7UQBqnFkUsjAY/kOU1cP+DAgvxwn1chZDwUbd6CFimGXwzwF6tPbFIcjEl+vvmM/byA48e6tWrKArm4ZJlCbdsrxksL1AwWn/yBSJKpYbq8AXaaTb8AAHja28jAwOC00ZrBeQNDQOWO//sdBBgYGRiYWYAEELEwMTE4uzo5Zzo5b2BxdnFOcALxNjA6b2ByTswC8jYwg0VlNuoCTWAMqNzMzsoK1rEhNqByEyerg5PMJlYuVueETKcd/89uBpnpvIEVomeHLoMsAAe1Id4AAAAAAAB42oWQT07CQBTGv0JBhagk7HQzKxca2sJCE1hDt4QF+9JOS0nbaaYDCQfwCJ7Au3AHj+LO13FMmm6cl7785vven0kBjHCBhfpYuNa5Ph1c0e2Xu3jEvWG7UdPDLZ4N92nOm+EBXuAbHmIMSRMs+4aUEd4Nd3CHD8NdvOLTsA2GL8M9PODbcL+hD7C1xoaHeLJSEao0FEW14ckxC+TU8TxvsY6X0eLPmRhry2WVioLpkrbp84LLQPGI7c6sOiUzpWIWS5GzlSgUzzLBSikOPFTOXqly7rqx0Z1Q5BAIoZBSFihQYQOOBEdkCOgXTOHA07HAGjGWiIjaPZNW13/+lm6S9FT7rLHFJ6fQbkATOG1j2OFMucKJJsxIVfQORl+9Jyda6Sl1dUYhSCm1dyClfoeDve4qMYdLEbfqHf3O/AdDumsjAAB42mNgYoAAZQYjBmyAGYQZmdhL8zLdDEydARfoAqIAAAABAAMABwAKABMAB///AA8AAQAAAAAAAAAAAAAAAAABAAAAAA==) format('woff');
}

.markdown-body {
-webkit-text-size-adjust: 100%;
box-sizing: border-box;
color: #333;
font-family: "Hiragino Mincho ProN", TakaoExMincho, Meiryo, serif;
font-size: 16px;
line-height: 1.6;
margin: 0 auto;
max-width: 980px;
min-width: 200px;
text-size-adjust: 100%;
word-wrap: break-word;
}
.markdown-body a {
background-color: transparent;
}
.markdown-body a:active,
.markdown-body a:hover {
outline: 0;
}
.markdown-body strong {
font-weight: bold;
}
.markdown-body h1 {
font-size: 2em;
margin: 0.67em 0;
}
.markdown-body img {
border: 0;
}
.markdown-body hr {
box-sizing: content-box;
height: 0;
}
.markdown-body pre {
overflow: auto;
}
.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
font-family: monospace, monospace;
font-size: 1em;
}
.markdown-body input {
color: inherit;
font: inherit;
margin: 0;
}
.markdown-body html input[disabled] {
cursor: default;
}
.markdown-body input {
line-height: normal;
}
.markdown-body input[type="checkbox"] {
box-sizing: border-box;
padding: 0;
}
.markdown-body table {
border-collapse: collapse;
border-spacing: 0;
}
.markdown-body td,
.markdown-body th {
padding: 0;
}
.markdown-body * {
box-sizing: border-box;
}
.markdown-body input {
font: 13px / 1.4 Helvetica, arial, nimbussansl, liberationsans, freesans, clean, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}
.markdown-body a {
color: #4078c0;
text-decoration: none;
}
.markdown-body a:hover,
.markdown-body a:active {
text-decoration: underline;
}
.markdown-body hr {
height: 0;
margin: 15px 0;
overflow: hidden;
background: transparent;
border: 0;
border-bottom: 1px solid #ddd;
}
.markdown-body hr:before {
display: table;
content: "";
}
.markdown-body hr:after {
display: table;
clear: both;
content: "";
}
.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
margin-top: 15px;
margin-bottom: 15px;
line-height: 1.1;
}
.markdown-body h1 {
font-size: 30px;
}
.markdown-body h2 {
font-size: 21px;
}
.markdown-body h3 {
font-size: 16px;
}
.markdown-body h4 {
font-size: 14px;
}
.markdown-body h5 {
font-size: 12px;
}
.markdown-body h6 {
font-size: 11px;
}
.markdown-body blockquote {
margin: 0;
}
.markdown-body ul,
.markdown-body ol {
padding: 0;
margin-top: 0;
margin-bottom: 0;
}
.markdown-body ol ol,
.markdown-body ul ol {
list-style-type: lower-roman;
}
.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
list-style-type: lower-alpha;
}
.markdown-body dd {
margin-left: 0;
}
.markdown-body code {
font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
font-size: 12px;
}
.markdown-body pre {
margin-top: 0;
margin-bottom: 0;
font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}
.markdown-body .select::-ms-expand {
opacity: 0;
}
.markdown-body .octicon {
font: normal normal normal 16px/1 octicons-link;
display: inline-block;
text-decoration: none;
text-rendering: auto;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
-webkit-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
.markdown-body .octicon-link:before {
content: '\f05c';
}
.markdown-body:before {
display: table;
content: "";
}
.markdown-body:after {
display: table;
clear: both;
content: "";
}
.markdown-body>*:first-child {
margin-top: 0 !important;
}
.markdown-body>*:last-child {
margin-bottom: 0 !important;
}
.markdown-body a:not([href]) {
color: inherit;
text-decoration: none;
}
.markdown-body .anchor {
display: inline-block;
padding-right: 2px;
margin-left: -18px;
}
.markdown-body .anchor:focus {
outline: none;
}
.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
margin-top: 1em;
margin-bottom: 16px;
font-weight: bold;
line-height: 1.4;
}
.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
color: #000;
vertical-align: middle;
visibility: hidden;
}
.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
text-decoration: none;
}
.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
visibility: visible;
}
.markdown-body h1 {
padding-bottom: 0.3em;
font-size: 2.25em;
line-height: 1.2;
border-bottom: 1px solid #eee;
}
.markdown-body h1 .anchor {
line-height: 1;
}
.markdown-body h2 {
padding-bottom: 0.3em;
font-size: 1.75em;
line-height: 1.225;
border-bottom: 1px solid #eee;
}
.markdown-body h2 .anchor {
line-height: 1;
}
.markdown-body h3 {
font-size: 1.5em;
line-height: 1.43;
}
.markdown-body h3 .anchor {
line-height: 1.2;
}
.markdown-body h4 {
font-size: 1.25em;
}
.markdown-body h4 .anchor {
line-height: 1.2;
}
.markdown-body h5 {
font-size: 1em;
}
.markdown-body h5 .anchor {
line-height: 1.1;
}
.markdown-body h6 {
font-size: 1em;
color: #777;
}
.markdown-body h6 .anchor {
line-height: 1.1;
}
.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre {
margin-top: 0;
margin-bottom: 16px;
}
.markdown-body hr {
height: 4px;
padding: 0;
margin: 16px 0;
background-color: #e7e7e7;
border: 0 none;
}
.markdown-body ul,
.markdown-body ol {
padding-left: 2em;
}
.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
margin-top: 0;
margin-bottom: 0;
}
.markdown-body li>p {
margin-top: 16px;
}
.markdown-body dl {
padding: 0;
}
.markdown-body dl dt {
padding: 0;
margin-top: 16px;
font-size: 1em;
font-style: italic;
font-weight: bold;
}
.markdown-body dl dd {
padding: 0 16px;
margin-bottom: 16px;
}
.markdown-body blockquote {
padding: 0 15px;
color: #777;
border-left: 4px solid #ddd;
}
.markdown-body blockquote>:first-child {
margin-top: 0;
}
.markdown-body blockquote>:last-child {
margin-bottom: 0;
}
.markdown-body table {
display: block;
width: 100%;
overflow: auto;
word-break: normal;
word-break: keep-all;
}
.markdown-body table th {
font-weight: bold;
}
.markdown-body table th,
.markdown-body table td {
padding: 6px 13px;
border: 1px solid #ddd;
}
.markdown-body table tr {
background-color: #fff;
border-top: 1px solid #ccc;
}
.markdown-body table tr:nth-child(2n) {
background-color: #f8f8f8;
}
.markdown-body img {
max-width: 100%;
box-sizing: content-box;
background-color: #fff;
}
.markdown-body code {
padding: 0;
padding-top: 0.2em;
padding-bottom: 0.2em;
margin: 0;
font-size: 85%;
background-color: rgba(0,0,0,0.04);
border-radius: 3px;
}
.markdown-body code:before,
.markdown-body code:after {
letter-spacing: -0.2em;
content: "\00a0";
}
.markdown-body pre>code {
padding: 0;
margin: 0;
font-size: 100%;
word-break: normal;
white-space: pre;
background: transparent;
border: 0;
}
.markdown-body .highlight {
margin-bottom: 16px;
}
.markdown-body .highlight pre,
.markdown-body pre {
padding: 16px;
overflow: auto;
font-size: 85%;
line-height: 1.45;
background-color: #f7f7f7;
border-radius: 3px;
}
.markdown-body .highlight pre {
margin-bottom: 0;
word-break: normal;
}
.markdown-body pre {
word-wrap: normal;
}
.markdown-body pre code {
display: inline;
max-width: initial;
padding: 0;
margin: 0;
overflow: initial;
line-height: inherit;
word-wrap: normal;
background-color: transparent;
border: 0;
}
.markdown-body pre code:before,
.markdown-body pre code:after {
content: normal;
}
.markdown-body kbd {
display: inline-block;
padding: 3px 5px;
font-size: 11px;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.markdown-body .pl-c {
color: #969896;
}
.markdown-body .pl-c1,
.markdown-body .pl-s .pl-v {
color: #0086b3;
}
.markdown-body .pl-e,
.markdown-body .pl-en {
color: #795da3;
}
.markdown-body .pl-s .pl-s1,
.markdown-body .pl-smi {
color: #333;
}
.markdown-body .pl-ent {
color: #63a35c;
}
.markdown-body .pl-k {
color: #a71d5d;
}
.markdown-body .pl-pds,
.markdown-body .pl-s,
.markdown-body .pl-s .pl-pse .pl-s1,
.markdown-body .pl-sr,
.markdown-body .pl-sr .pl-cce,
.markdown-body .pl-sr .pl-sra,
.markdown-body .pl-sr .pl-sre {
color: #183691;
}
.markdown-body .pl-v {
color: #ed6a43;
}
.markdown-body .pl-id {
color: #b52a1d;
}
.markdown-body .pl-ii {
background-color: #b52a1d;
color: #f8f8f8;
}
.markdown-body .pl-sr .pl-cce {
color: #63a35c;
font-weight: bold;
}
.markdown-body .pl-ml {
color: #693a17;
}
.markdown-body .pl-mh,
.markdown-body .pl-mh .pl-en,
.markdown-body .pl-ms {
color: #1d3e81;
font-weight: bold;
}
.markdown-body .pl-mq {
color: #008080;
}
.markdown-body .pl-mi {
color: #333;
font-style: italic;
}
.markdown-body .pl-mb {
color: #333;
font-weight: bold;
}
.markdown-body .pl-md {
background-color: #ffecec;
color: #bd2c00;
}
.markdown-body .pl-mi1 {
background-color: #eaffea;
color: #55a532;
}
.markdown-body .pl-mdr {
color: #795da3;
font-weight: bold;
}
.markdown-body .pl-mo {
color: #1d3e81;
}
.markdown-body kbd {
display: inline-block;
padding: 3px 5px;
font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.markdown-body .task-list-item {
list-style-type: none;
}
.markdown-body .task-list-item+.task-list-item {
margin-top: 3px;
}
.markdown-body .task-list-item input {
margin: 0 0.35em 0.25em -1.6em;
vertical-align: middle;
}
.markdown-body :checked+.radio-label {
z-index: 1;
position: relative;
border-color: #4078c0;
}
</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <meta name="title" content="Androidアプリ開発ガイド">
  <meta name="description" content="Androidアプリ開発の、多分最も簡単じゃないかなーと思う作り方のガイド。">
  <meta name="keywords" content="Android, Kotlin, Jetpack">
</head>
<body>
<article class="markdown-body">
<p>「Androidアプリの開発は、地球が砕け散ってもイヤです」</p>
<p>上司の問い掛けにノータイムで断りをいれて、でもしがないサラリーマンの私の我儘が通るはずなんかなくて、Androidアプリの開発があまりに辛くて滂沱のごとく涙したあの日の私。私の立場は当時と同じヒラのままですし、やっぱり上司の命令には逆らえないのですけど、Androidアプリの開発は大きく変わりました。</p>
<p>「Androidアプリの開発を、ぜひワタクシメに！」</p>
<p>今の私は、Androidアプリの開発の仕事大歓迎です。だって、今時のAndroidアプリ開発って、とても楽チンで美味しい仕事なんだもの。そう、Android Jetpackを使うならね。あと、Kotlinとコルーチンも。……え？　信じられない？　わかりました。実際にアプリを作って、その楽チンさを証明しましょう。</p>
<h1 id="androidアプリ開発が面倒だった理由とその対策">Androidアプリ開発が面倒だった理由と、その対策</h1>
<p>さて、Androidアプリの開発が面倒なのは、大昔の貧弱なスマートフォンのリソースでも動作するように初期のバージョンが作成されたためだと考えます。そして、複数のメーカーの様々なAndroid端末があったので後方互換性を考慮しなければならなくて、初期バージョンの古い設計を引きずらざるを得なかったためでしょう。</p>
<p>たとえば、Androidアプリの基本的な構成単位である<code>Activity</code>は、いつ終了させられてもよいように作らなければなりません。少ないメモリを有効活用するためには、バックグラウンドの<code>Activity</code>を終了させてメモリを解放させることが重要ですから。でも、だからといって、ただ終了させるのでは次にアプリがフォアグラウンドになった時に処理を継続できなくなってしまう。だから、<code>onSavedInstanceState()</code>で状態を退避できて<code>onRestoreInstanceState()</code>で状態を復帰できるようにしよう。待てよ、これが前提なのだから、端末を縦から横に回転したときに画面のレイアウトをやり直すようなCPUを消費する処理はやめて、<code>Activity</code>を再生成してしまうことにしよう。このような流れで出来上がったのが、<code>Activity</code>のライフサイクルという、あの複雑怪奇な図です。</p>
<p>図</p>
<p>この面倒な図を正確に理解していないと、Androidアプリの開発はできないらしい。でも、メモリが豊富な今時のスマートフォンなら、こんな仕組みは無駄なのではないでしょうか？　LinuxでもMac OSでもWindowsでも、こんな考慮はしていませんよね？</p>
<p>でも、後方互換性を考えると、APIを丸ごと書き換えるのは困難です。だから、APIの上にライブラリの層を被せることにしましょう。先ほどの問題は<code>Activity</code>そのものではなく、<code>Activity</code>の「状態」の問題なので、状態だけを抽出して、その状態については<code>Activity</code>が破棄されても破棄されないようにすればよい。そのクラスの名前はそう、MVVM（Model View ViewModel）アーキテクチャの<code>ViewModel</code>から借りてこよう。そして、プログラミング業界ではオブジェクトの生成から破棄までをライフサイクルという言葉で表現するので、ライブラリ名はLifecycleとしよう。ほら、これで、あの複雑怪奇なライフサイクルを（それほど）意識しないで済むようになって、開発は楽チンになりました。</p>
<p>でもちょっと待って。画面回転の問題は<code>Fragment</code>で解決できるのではという、従来のAndroid開発に詳しい方がいらっしゃるかもしれません。でもね、<code>Fragment</code>を使う時って、画面遷移はどうしていました？　Androidそのものは<code>Activity</code>が遷移していくように作られていて、だから<code>Fragment</code>を含む<code>Activity</code>が遷移していくように作ることになって、結果として<code>Activity</code>と<code>Fragment</code>にコードが分散して見通しが悪くなるだけになっていませんでしたか？　この問題は<code>Fragment</code>が遷移する仕組みを導入することで解消できるわけで、その仕組みをシンプルなコードで実現可能にしてくれるライブラリがNavigationです。これから先の人生では<code>Fragment</code>のことだけを考えれば済むというわけ。気難しいActivityさんと離れられて、さらに楽チンです。</p>
<p>データの管理も大変でした。RDBMS（Relational Database Management System）のSQLiteをAndroidシステムに組み込んでくれたのはとてもありがたいのですけど、そのアクセスには素のSQLを使えってのはいただけません。オブジェクト指向のObjectとRDBMSのRelationをマップする、O/Rマッパーが欲しい。ならば与えようってことでRoomという公式のO/Rマッパーが提供されて、ライブラリ選択に頭を悩ます必要がなくなって楽チン。</p>
<p>本項では紹介しませんけど、これ以外にも便利機能はいっぱいあって、Googleは<a href="https://developer.android.com/jetpack">Android Jetpack</a>としてまとめて提供しています。バックグラウンド・ジョブ管理のWorkManagerとか、面倒でしょうがなかったカメラ制御を楽にしてくれるCameraXなんてのもあります。新機能をなかなか取り入れられない、過去に縛られたダサいAPIとはこれでオサラバできるんです。</p>
<p>あと、Support Libraryも。Androidでは端末が最新OSにバージョン・アップされていることを期待できないので、OSそのものに新しい機能が組み入れられてもすぐに使うことはできません。だから、Support Libraryという形で、OSとは別に機能を提供してきました。ところが、このSupport Libraryにもバージョンの不整合という問題がでてしまったんです。<code>android.support.v4</code>とか<code>android.support.v7</code>とかね。これはもう心機一転してやりなおそうってことで、<code>androidx</code>で始まる新しいライブラリ群にまとめなおされました。前述したLifecycleやNavigationも、実は<code>androidx</code>ファミリーの一員なんです。Lifecycleは<code>androidx.lifecycle</code>ですし、Navigationは<code>androidx.navigation</code>です。当然、新しい<code>androidx.*</code>では、LifecycleやNavigationなどのJetpackの機能を前提にした機能強化がなされていて、これでもう本当に楽チンです。</p>
<p>ただね、<code>androidx.*</code>は、それぞれがそれぞれを前提としているので、整合性を保って良い感じに組み合わせて使わなければならないんですよ。個々の要素を理解するだけでは不十分で、どのように組み合わせるべきかを理解することが重要なんです。だから、Googleは<a href="https://developer.android.com/jetpack/docs/guide?hl=ja">アプリのアーキテクチャ・ガイド</a>というアプリ全体をどのように作るのかのガイドと、<a href="https://github.com/googlesamples/android-sunflower">Sunflower</a>というサンプル・アプリを提供しています。これらはとても良いモノなのですけど、私には、Jetpackに都合が良い美しい世界にとどまっていて、現実の様々な問題への対応が不十分なように感じられます。あと、いくらなんでも読者への前提が厳しすぎますよ、これ。ガイドの序文に「Androidフレームワークの基本について熟知していることを前提としています」って書いてありますけど、Jetpack以降は無駄になるような古い知識をとりあえず習得してこいってのは酷いと思うよね？</p>
<p>というわけで、もう少し現実的なサンプル・アプリと、ゆるめのガイドを作成してみました。……思いっきり蛇足な気がするけど、気のせいだよね？</p>
<h1 id="サンプルアプリ">サンプル・アプリ</h1>
<p>私が欲しいからという理由で、東京の都営バスの車両の接近情報を表示するアプリを作成します（私が生まれ育った群馬県で力合わせる200万人をはじめとする地方在住のみなさま、ごめんなさい）。というのもですね、都営バスは<a href="https://tobus.jp/">tobus.jp</a>というサイトで車両接近情報を提供していて、このサイトはグラフィカルでとてもよくできているんですけど、提供側の都営バスの論理からか情報が路線単位なんですよ。で、私の住んでいるアパートの周りにはいくつかのバス停があってそれぞれ路線が異なるので、会社から帰るときには複数の路線の車両接近情報を調べなければならなくてこれが実にかったるい。</p>
<p>図</p>
<p>なので、複数の路線の車両の接近情報を集めて表示するアプリを作成します。タイミングがよいことに、2019年5月31日に、<a href="https://metro.tokyo.jp.tosei/hodohappyo/press/2019/05/31/04.html">都営交通の運行情報等をオープンデータとして提供開始します</a>というニュースがありました。<a href="https://developer.odpt.org">公共交通オープンデータセンター開発者サイト</a>でユーザー登録すれば、誰でも無料でデータを使用できます（利用者への通知が必要などの、いくつかの制約はありますけど）。Webサイトのクローリングが不要なのでアプリ開発は容易だろうから、サンプル・アプリに適しているんじゃないかな。</p>
<p>具体化しましょう。出発バス停を指定して、到着バス停を指定すると、それらのバス停を結ぶ全ての路線の接近情報が一覧表示されます。あと、毎回出発バス停と到着バス停を選ぶのでは面倒すぎるので、ブックマークの機能を持たせます。以下のような感じ。</p>
<p>図</p>
<p>本ガイドでは、このアプリをちゃちゃっと作っていきます。</p>
<p>最終的なコードは、<a href="https://github.com/tail-island/jetbus/">GitHub</a>で公開しています。必要に応じて参照してみてください。ただし、このコードをビルドして動かすには、公共交通オープンデータセンター開発者サイトにユーザー登録すると貰えるアクセス・トークンをが必要です。コードをcloneしたら<code>./app/src/main/res/values</code>ディレクトリに<code>odpt.xml</code>を作成し、以下を参考に<code>consumerKey</code>を設定してください。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">&lt;resources&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>    <span class="kw">&lt;string</span><span class="ot"> name=</span><span class="st">&quot;consumerKey&quot;</span><span class="kw">&gt;</span>公共交通オープンデータセンターから取得したアクセス・トークン<span class="kw">&lt;/string&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw">&lt;/resources&gt;</span></span></code></pre></div>
<p>あと、Android Studioのバージョンは3.6を使用しました。これより古い場合は、Android Studioをバージョンアップしてください。</p>
<h1 id="プロジェクトの作成">プロジェクトの作成</h1>
<p>長い前置きがやっと終わって早速プログラミング……の前に、Androidアプリの開発ではプロジェクトを作成しなければなりません。Android Studioを起動して、プロジェクトを作成しましょう。</p>
<p>Android Studioを起動して、[Start a new Android Studio project]を選択します。</p>
<p>図</p>
<p>作成するプロジェクトは、余計なコードが生成されない「Empty Activity」にします。</p>
<p>図</p>
<p>[Name]にアプリ名、[Package name]にドメイン名＋アプリ名を入力します。アプリ名は、JetpackのサンプルでBusの接近情報ということで、jetbusにしてみました。あ、英語ダメダメで風呂のbathと乗り物のbusの区別がつかなかったわけじゃなくて、イタリーのミラノのJetbus社のファンなだけですよ（たぶん、Jetbusの創業者も、私と同じくらい英語がダメなんだと思う……）。[Language]はもちろん「Kotlin」にします。Javaの256倍くらい良いプログラミング言語ですし、Google I/O 2019で「Kotlinファースト」が表明されましたし、Kotlinならさらに有効活用できるJetpackの機能もあるためです。あと、[Minimum API Level]は、「API 23: Android 6.0 (Mashmallow)」にしました。Android 6.0で権限確認の方法が変更になったので、これ以前のバージョンだと権限の確認の処理が面倒なためです（今回は関係ないけどね）。古い端末を平気で使う海外までを対象にしたアプリを作るならもっと古いバージョンにすべきでしょうけど、国内が対象なら、まぁ大丈夫じゃないかな。</p>
<p>図</p>
<p>ともあれ、これで無事にプロジェクトが作成されました。でも、まだJetpackが組み込まれていません。さっそく組み込む……前に、ビルド・システムの説明をさせてください。</p>
<h2 id="ビルドシステム">ビルド・システム</h2>
<p>人類がウホウホ言いながら樹上で暮らしていた大昔、ライブラリの組み込みというのはインターネットからダウンロードしたファイルをプロジェクトのディレクトリにセーブするという作業でした。Windowsでアプリケーションをインストールするために、Webサイトからパッケージをダウンロードしてセットアップするのと似た感じ。</p>
<p>こんな面倒な作業はやってられませんから、Linuxでは<code>pacman</code>とか<code>apt</code>とか<code>yum</code>とか、Mac OSでは<code>MacPorts</code>とか<code>HomeBrew</code>とかのパッケージ管理システムを使って、アプリケーションをセットアップします。たとえば、LinuxディストリビューションのArch Linuxで今私が本稿の作成に使用しているEmacsをセットアップする場合は、ターミナルから<code>sudo pacman -S emacs</code>と入力するだけ。これだけで、パッケージ管理システムが全自動でEmacsをダウンロードし、セットアップしてくれます（私は日本語IMEにMozcを使用しているので、emacs-mozcからEmacsをインストールしたけど）。AndroidのPlay Store、iPhoneのApp Storeと同じですな。</p>
<p>で、今時の開発では様々なライブラリを使用するのが当たり前で、ライブラリ毎にWebサイトを開いてダウンロードして解凍してセーブなんて作業はやってられませんから、ライブラリの組み込みにも自動化が必要でしょう。ライブラリは他のライブラリに依存していることが多くて、その依存関係を辿る作業を手動でやるなんてのは非現実的ですもんね。</p>
<p>あと、今時の開発だと、ライブラリを組み込み終わったあとのビルドもなかなかに複雑な作業となります。ビルドついでにテストしたいとか、事前にコード生成させたいとか。このように考えると、ライブラリの管理とビルドを自動化するシステムが必要で、これがいわゆるビルド・システムとなります。Android Studioは、このビルド・システムとしてGradleというソフトウェアを使用しているわけです。</p>
<h2 id="jetpackの組み込み">Jetpackの組み込み</h2>
<p>Jetpackをビルド・システムのGradleに組み込む方法は、各ライブラリのリリース・ノートに書いてあります。たとえばNavigationなら、<a href="https://developer.android.com/jetpack/androidx/releases/navigation">https://developer.android.com/jetpack/androidx/releases/navigation</a>です。基本はこのリリース・ノートの記載に従うのですけど、いくつか注意点があります。</p>
<ul>
<li>ライブラリ名-ktxという名前のライブラリがある場合は、¥<em>-ktxを指定してください。¥</em>-ktxは、Kotlinならではの便利機能が入ったライブラリです。Kotlin向けの機能が入っていない基本バージョンのライブラリは、依存関係があるので自動で組み込まれます。</li>
<li>Jetpackではコード生成を多用しているのですけど、KotlinやJavaではコード生成の制御にアノテーション（annotation。クラスやメソッドの前に書く<code>@Foo</code>みたいなアレ）を使用していて、Javaの場合はGradleのビルド・スクリプトに<code>annotationProcessor</code>と書きます。Kotlinの場合は、Kotlin Annotation Processor Toolの略で<code>kapt</code>と書いてください。リリース・ノートに<code>annotationProcessor</code>の記述があったあとに、Kotlinではkaptを使ってねという知っている人しかわからない意味不明なコメントが書いてある場合は、<code>kapt</code>の出番となります。</li>
</ul>
<p>と、以上の注意を踏まえて、Android Studioの[Project]ビューのbuild.gradeをダブル・クリックして開いて、修正してみましょう。</p>
<p>図</p>
<p>で、以下が修正した結果。修正した行は、修正内容をコメントで書いています。</p>
<pre class="gradle:build.gradle(project:jetbus)"><code>buildscript {
    ext.kotlin_version = &#39;1.3.61&#39;
    repositories {
        google()
        jcenter()
    }
    dependencies {
        classpath &#39;com.android.tools.build:gradle:3.6.1&#39;
        classpath &quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;

        classpath &#39;androidx.navigation:navigation-safe-args-gradle-plugin:2.2.1&#39;  // 追加
    }
}

allprojects {
    repositories {
        google()
        jcenter()
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}</code></pre>
<pre class="gradle:build.gradle(module:app)"><code>apply plugin: &#39;com.android.application&#39;
apply plugin: &#39;kotlin-android&#39;
apply plugin: &#39;kotlin-android-extensions&#39;
apply plugin: &#39;kotlin-kapt&#39;                          // 追加
apply plugin: &#39;androidx.navigation.safeargs.kotlin&#39;  // 追加

android {
    compileSdkVersion 29
    buildToolsVersion &quot;29.0.3&quot;

    defaultConfig {
        applicationId &quot;com.tail_island.jetbus&quot;
        minSdkVersion 23
        targetSdkVersion 29
        versionCode 1
        versionName &quot;1.0&quot;
        testInstrumentationRunner &quot;androidx.test.runner.AndroidJUnitRunner&quot;
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile(&#39;proguard-android-optimize.txt&#39;), &#39;proguard-rules.pro&#39;
        }
    }

    kotlinOptions {        // 追加
        jvmTarget = &#39;1.8&#39;  // 追加
    }                      // 追加

    dataBinding {          // 追加
        enabled true       // 追加
    }                      // 追加
}

dependencies {
    kapt &#39;androidx.lifecycle:lifecycle-compiler:2.2.0&#39;                  // 追加
    kapt &#39;androidx.room:room-compiler:2.2.4&#39;                            // 追加

    implementation fileTree(dir: &#39;libs&#39;, include: [&#39;*.jar&#39;])

    implementation &#39;androidx.appcompat:appcompat:1.1.0&#39;
    implementation &#39;androidx.constraintlayout:constraintlayout:1.1.3&#39;
    implementation &#39;androidx.core:core-ktx:1.2.0&#39;
    implementation &#39;androidx.fragment:fragment-ktx:1.2.2&#39;               // 追加
    implementation &#39;androidx.legacy:legacy-support-v4:1.0.0&#39;            // 追加
    implementation &#39;androidx.lifecycle:lifecycle-extensions:2.2.0&#39;      // 追加
    implementation &#39;androidx.lifecycle:lifecycle-viewmodel-ktx:2.2.0&#39;   // 追加
    implementation &#39;androidx.navigation:navigation-fragment-ktx:2.2.1&#39;  // 追加
    implementation &#39;androidx.navigation:navigation-ui-ktx:2.2.1&#39;        // 追加
    implementation &#39;androidx.room:room-ktx:2.2.4&#39;                       // 追加
    implementation &quot;org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version&quot;

    testImplementation &#39;junit:junit:4.12&#39;

    androidTestImplementation &#39;androidx.test.ext:junit:1.1.1&#39;
    androidTestImplementation &#39;androidx.test.espresso:espresso-core:3.2.0&#39;
}</code></pre>
<p>これで、デモ・アプリに必要なJetpackのライブラリの組み込みが完了しました。やっとプログラミングです。最初は、作成してやった感が大きそうな、画面まわりをやってみましょう。</p>
<h1 id="navigation">Navigation</h1>
<p>まぁ、画面といっても、かっこいい画面を作るほうではなく、ダミー画面を使用した画面遷移の実装という、見栄えがあまりよくない部分のプログラミングだけどな。Navigationが火を吹きますよ。</p>
<h2 id="activityとfragmentとnavigation"><code>Activity</code>と<code>Fragment</code>とNavigation</h2>
<p>さて、例によって歴史の話から。<code>Acticity</code>と<code>Fragment</code>の話、あと、Navigationが作られた経緯です。</p>
<p><code>Activity</code>ってのは、ぶっちゃけアプリの画面1つ分です。で、一般にアプリは複数の<code>Activity</code>で構成されます。Androidはアプリ間連携（アプリを操作していたら別のアプリの画面に遷移して、で、戻るボタンで最初のアプリに戻れる）ができるところがとても素晴らしいと私は思っているのですけど、この機能は<code>Activity</code>の遷移として実現されています。同様に、アプリ内でも<code>Activity</code>の遷移で画面遷移を実現していました。</p>
<p>で、大昔のスマートフォンのアプリの単純な画面だったらこれであまり問題なかったんですけど、高機能なアプリを作ったりタブレットのような大きな画面を効率よく使おうとしたりする場合は、この方式だとコードの重複という問題が発生してしまうんです。タブレットの大きな画面では、左に一覧表示して、右にその詳細を表示するような画面が考えられます。でも、スマートフォンの小さな画面では、一覧表示する画面と、それとは別の詳細を表示する画面に分かれて、画面遷移する形で表現しなければなりません。</p>
<p>図</p>
<p>これを<code>Activity</code>で実現しようとすると、タブレット用の<code>Activity</code>を1つと、スマートフォン用の<code>Acticvity</code>を2つ作らなければなりません。そして、ほとんどのコードは重複してしまうでしょう。UIの問題なら<code>View</code>（UIコンポーネント）で解決すれば……って思うかもしれませんけど、画面に表示するデータをデータベースから取得してくるような機能を<code>View</code>に持たせるのは、<code>View</code>の責任範囲を逸脱しているのでダメです。</p>
<p>ではどうすればよいかというと、<code>Activity</code>の構成要素になりえる「何か」を追加してあげればよいわけ。この「何か」こそが、<code>Fragment</code>なのです。</p>
<p>でもね、コードの重複が発生しないようなケースで<code>Fragment</code>を使って<code>Activity</code>で画面遷移をさせると、<code>Activity</code>のコードの多くを<code>Fragment</code>に移して、で、<code>Activity</code>に<code>Fragment</code>を管理するコードを追加して、そしてもちろん<code>Fragment</code>にも自分自身の初期化処理等が必要となって、結局、コード量が増えただけで誰も得しないという状況になってしまうんです。</p>
<p>これでは無意味なので、1つの<code>Activity</code>の中で、複数の<code>Fragment</code>が遷移するというプログラミング・スタイルが編み出されました。このスタイルを実現するのが<code>FragmentTransaction</code>というAPIで、<code>Acticity</code>から<code>Fragment</code>を削除したり追加したり入れ替えたりできます。なんと[戻る]ボタンへの対応機能付き……なのですけど、高機能な分だけ使い方が複雑で、<code>Activity</code>の遷移（<code>Intent</code>のインスタンスを引数に<code>startActivity()</code>するだけ）と比べると面倒だったんです。</p>
<p>なので、Navigationが作成されました。GUIツール（私はほとんど使わないけど）で画面遷移を定義できるかっこいいライブラリです。ただ単に<code>FragmentTransaction</code>を呼び出しているだけな気もしますけど、まぁ、いろいろ楽チンなのでよし。SafeArgsという便利機能もありますしね。</p>
<h2 id="プロジェクトにfragmentを追加する">プロジェクトにFragmentを追加する</h2>
<p>以上により、画面遷移は<code>Fragment</code>遷移ということになりました。だから、プロジェクトに<code>Activity</code>ではなく<code>Fragment</code>を追加しましょう。jetbusに必要な<code>Fragment</code>は、以下の5つとなります。</p>
<ul>
<li>SplashFragment（起動処理をする間に表示するスプラッシュ画面）</li>
<li>BookmarksFragment（ブックマークの一覧を表示する画面）</li>
<li>DepartureBusStopFragment（出発バス停を指定する画面）</li>
<li>ArrivalBusStopFragment（到着バス停を指定する画面）</li>
<li>BusApproachesFragment（バスの接近情報を表示する画面）</li>
</ul>
<p>さっそく追加します。プロジェクトを右クリックして、[New] - [Fragment] - [Fragment (Blank)]メニューを選択してください。</p>
<p>図</p>
<p><code>Fragment</code>の名前を入力して、[Include fragment factory methods?]チェックボックスを外して、[Finish]ボタンを押します（このチェックボックスを外さないと、余計なコードが生成されてしまうためです。まぁ、生成されたとしても、そのコードを消せば良いだけなんですけど）。この手順を5回繰り返して、必要な<code>Fragment</code>をすべて生成してください。</p>
<p>図</p>
<p>ふう、完了。</p>
<h2 id="navigationリソースを作成する">navigationリソースを作成する</h2>
<p>さて、Navigation。Navigationでは、画面の遷移をres/navigationの下のXMLファイルで管理します。このファイルを作りましょう。プロジェクトを右クリックして、[File] - [New] - [Android Resource Directory]メニューを選びます。</p>
<p>図</p>
<p>[Resource type]を「navigation」にして、[OK]ボタンを押してください。これで、navigationディレクトリが生成されます。</p>
<p>次。画面の遷移を管理するXMLファイルです。プロジェクトを右クリックして、[File] - [New] - [Android Resource File]メニューを選びます。</p>
<p>図</p>
<p>[Resource type]を「Navigation」にして、[File name]に「navigation」と入力して、[OK]ボタンを押します。これで、navigation.xmlが生成されました。</p>
<p>図</p>
<p>GUIツールはかったるいという私の個人的な趣味嗜好により、右上の[Code]アイコンをクリックして、以下のXMLファイルを入力します。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">&lt;navigation</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="ot">    xmlns:tools=</span><span class="st">&quot;http://schemas.android.com/tools&quot;</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="ot">    app:startDestination=</span><span class="st">&quot;@id/splashFragment&quot;</span><span class="kw">&gt;</span></span>
<span id="cb4-7"><a href="#cb4-7"></a></span>
<span id="cb4-8"><a href="#cb4-8"></a>    <span class="kw">&lt;fragment</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="ot">        android:id=</span><span class="st">&quot;@+id/splashFragment&quot;</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="ot">        android:name=</span><span class="st">&quot;com.tail_island.jetbus.SplashFragment&quot;</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="ot">        android:label=</span><span class="st">&quot;@string/app_name&quot;</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="ot">        tools:layout=</span><span class="st">&quot;@layout/fragment_splash&quot;</span><span class="kw">&gt;</span></span>
<span id="cb4-13"><a href="#cb4-13"></a></span>
<span id="cb4-14"><a href="#cb4-14"></a>        <span class="kw">&lt;action</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/splashFragmentToBookmarksFragment&quot;</span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="ot">            app:destination=</span><span class="st">&quot;@id/bookmarksFragment&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb4-17"><a href="#cb4-17"></a></span>
<span id="cb4-18"><a href="#cb4-18"></a>    <span class="kw">&lt;/fragment&gt;</span></span>
<span id="cb4-19"><a href="#cb4-19"></a></span>
<span id="cb4-20"><a href="#cb4-20"></a>    <span class="kw">&lt;fragment</span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="ot">        android:id=</span><span class="st">&quot;@+id/bookmarksFragment&quot;</span></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="ot">        android:name=</span><span class="st">&quot;com.tail_island.jetbus.BookmarksFragment&quot;</span></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="ot">        android:label=</span><span class="st">&quot;ブックマーク&quot;</span></span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="ot">        tools:layout=</span><span class="st">&quot;@layout/fragment_bookmarks&quot;</span><span class="kw">&gt;</span></span>
<span id="cb4-25"><a href="#cb4-25"></a></span>
<span id="cb4-26"><a href="#cb4-26"></a>        <span class="kw">&lt;action</span></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/bookmarksFragmentToDepartureBusStopFragment&quot;</span></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="ot">            app:destination=</span><span class="st">&quot;@id/departureBusStopFragment&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb4-29"><a href="#cb4-29"></a></span>
<span id="cb4-30"><a href="#cb4-30"></a>        <span class="kw">&lt;action</span></span>
<span id="cb4-31"><a href="#cb4-31"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/bookmarksFragmentToBusApproachesFragment&quot;</span></span>
<span id="cb4-32"><a href="#cb4-32"></a><span class="ot">            app:destination=</span><span class="st">&quot;@id/busApproachesFragment&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb4-33"><a href="#cb4-33"></a></span>
<span id="cb4-34"><a href="#cb4-34"></a>    <span class="kw">&lt;/fragment&gt;</span></span>
<span id="cb4-35"><a href="#cb4-35"></a></span>
<span id="cb4-36"><a href="#cb4-36"></a>    <span class="kw">&lt;fragment</span></span>
<span id="cb4-37"><a href="#cb4-37"></a><span class="ot">        android:id=</span><span class="st">&quot;@+id/departureBusStopFragment&quot;</span></span>
<span id="cb4-38"><a href="#cb4-38"></a><span class="ot">        android:name=</span><span class="st">&quot;com.tail_island.jetbus.DepartureBusStopFragment&quot;</span></span>
<span id="cb4-39"><a href="#cb4-39"></a><span class="ot">        android:label=</span><span class="st">&quot;出発バス停&quot;</span></span>
<span id="cb4-40"><a href="#cb4-40"></a><span class="ot">        tools:layout=</span><span class="st">&quot;@layout/fragment_departure_bus_stop&quot;</span><span class="kw">&gt;</span></span>
<span id="cb4-41"><a href="#cb4-41"></a></span>
<span id="cb4-42"><a href="#cb4-42"></a>        <span class="kw">&lt;action</span></span>
<span id="cb4-43"><a href="#cb4-43"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/departureBusStopFragmentToArrivalBusStopFragment&quot;</span></span>
<span id="cb4-44"><a href="#cb4-44"></a><span class="ot">            app:destination=</span><span class="st">&quot;@id/arrivalBusStopFragment&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb4-45"><a href="#cb4-45"></a></span>
<span id="cb4-46"><a href="#cb4-46"></a>    <span class="kw">&lt;/fragment&gt;</span></span>
<span id="cb4-47"><a href="#cb4-47"></a></span>
<span id="cb4-48"><a href="#cb4-48"></a>    <span class="kw">&lt;fragment</span></span>
<span id="cb4-49"><a href="#cb4-49"></a><span class="ot">        android:id=</span><span class="st">&quot;@+id/arrivalBusStopFragment&quot;</span></span>
<span id="cb4-50"><a href="#cb4-50"></a><span class="ot">        android:name=</span><span class="st">&quot;com.tail_island.jetbus.ArrivalBusStopFragment&quot;</span></span>
<span id="cb4-51"><a href="#cb4-51"></a><span class="ot">        android:label=</span><span class="st">&quot;到着バス停&quot;</span></span>
<span id="cb4-52"><a href="#cb4-52"></a><span class="ot">        tools:layout=</span><span class="st">&quot;@layout/fragment_arrival_bus_stop&quot;</span><span class="kw">&gt;</span></span>
<span id="cb4-53"><a href="#cb4-53"></a></span>
<span id="cb4-54"><a href="#cb4-54"></a>        <span class="kw">&lt;argument</span></span>
<span id="cb4-55"><a href="#cb4-55"></a><span class="ot">            android:name=</span><span class="st">&quot;departureBusStopName&quot;</span></span>
<span id="cb4-56"><a href="#cb4-56"></a><span class="ot">            app:argType=</span><span class="st">&quot;string&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb4-57"><a href="#cb4-57"></a></span>
<span id="cb4-58"><a href="#cb4-58"></a>        <span class="kw">&lt;action</span></span>
<span id="cb4-59"><a href="#cb4-59"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/arrivalBusStopFragmentToBusApproachesFragment&quot;</span></span>
<span id="cb4-60"><a href="#cb4-60"></a><span class="ot">            app:destination=</span><span class="st">&quot;@id/busApproachesFragment&quot;</span></span>
<span id="cb4-61"><a href="#cb4-61"></a><span class="ot">            app:popUpTo=</span><span class="st">&quot;@id/bookmarksFragment&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb4-62"><a href="#cb4-62"></a></span>
<span id="cb4-63"><a href="#cb4-63"></a>    <span class="kw">&lt;/fragment&gt;</span></span>
<span id="cb4-64"><a href="#cb4-64"></a></span>
<span id="cb4-65"><a href="#cb4-65"></a>    <span class="kw">&lt;fragment</span></span>
<span id="cb4-66"><a href="#cb4-66"></a><span class="ot">        android:id=</span><span class="st">&quot;@+id/busApproachesFragment&quot;</span></span>
<span id="cb4-67"><a href="#cb4-67"></a><span class="ot">        android:name=</span><span class="st">&quot;com.tail_island.jetbus.BusApproachesFragment&quot;</span></span>
<span id="cb4-68"><a href="#cb4-68"></a><span class="ot">        android:label=</span><span class="st">&quot;バス接近情報&quot;</span></span>
<span id="cb4-69"><a href="#cb4-69"></a><span class="ot">        tools:layout=</span><span class="st">&quot;@layout/fragment_bus_approaches&quot;</span><span class="kw">&gt;</span></span>
<span id="cb4-70"><a href="#cb4-70"></a></span>
<span id="cb4-71"><a href="#cb4-71"></a>        <span class="kw">&lt;argument</span></span>
<span id="cb4-72"><a href="#cb4-72"></a><span class="ot">            android:name=</span><span class="st">&quot;departureBusStopName&quot;</span></span>
<span id="cb4-73"><a href="#cb4-73"></a><span class="ot">            app:argType=</span><span class="st">&quot;string&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb4-74"><a href="#cb4-74"></a></span>
<span id="cb4-75"><a href="#cb4-75"></a>        <span class="kw">&lt;argument</span></span>
<span id="cb4-76"><a href="#cb4-76"></a><span class="ot">            android:name=</span><span class="st">&quot;arrivalBusStopName&quot;</span></span>
<span id="cb4-77"><a href="#cb4-77"></a><span class="ot">            app:argType=</span><span class="st">&quot;string&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb4-78"><a href="#cb4-78"></a></span>
<span id="cb4-79"><a href="#cb4-79"></a>    <span class="kw">&lt;/fragment&gt;</span></span>
<span id="cb4-80"><a href="#cb4-80"></a></span>
<span id="cb4-81"><a href="#cb4-81"></a><span class="kw">&lt;/navigation&gt;</span></span></code></pre></div>
<p>どのような<code>Fragment</code>があるのかを、XMLのタグで表現します。<code>&lt;fragment&gt;</code>タグでですね。<code>android:name</code>属性で<code>Fragment</code>を実装するクラスを、<code>android:label</code>属性で画面に表示するタイトルを設定します。<code>tools:layout</code>属性は、GUIツールでグラフィカルに表示する場合向けの、プレビュー用のレイアウトの指定です。</p>
<p><code>&lt;fragment&gt;</code>タグの中の<code>&lt;action&gt;</code>タグは、画面遷移を表現します。<code>app:destination</code>属性は、遷移先を指定します。<code>arrivalBusStopFragmentToBusApproachesFragment</code>で指定されている<code>app:popUpTo</code>属性は、[戻る]ボタンが押された場合の行き先を指定しています。出発バス停を選んで、到着バス停を選んで、バスの接近情報が表示されたあとに[戻る]ボタンを押す場合は、多分その路線の情報はもういらない場合でしょうから、<code>app:popUpTo</code>属性を使用してブックマーク画面まで一気に戻るようにしました。</p>
<p><code>&lt;fragment&gt;</code>の中の<code>&lt;argument&gt;</code>は、フラグメントに遷移する際のパラメーターです。選択された出発バス停を使って到着バス停の選択肢を抽出しないと、到着バス停を選ぶところで路線がつながっていないバス停が表示されてしまうでしょ？　だから、<code>arrivalBusStopFragment</code>では<code>departureBusStopName</code>というパラメーターを指定しました。</p>
<p>あとはそう、<code>android:id</code>の説明を忘れていました。AndroidのリソースのXMLでは、<code>@+id/</code>の後に続ける形で識別子を設定します。上のXMLの<code>android:id=&quot;@+id/splashFragment&quot;</code>みたいな感じ。<code>@+id/</code>の部分が何だか分からなくて気持ち悪いという方のために補足しておくと、Androidアプリの開発ではR.javaというファイルが内部で自動生成されていて、R.javaの中にリソースの識別子が32bit整数で定義されています。XMLのような文字列の識別子では照合作業でCPUを大量に消費してしまうからという貧乏実装、でも、CPUを消費するということは電池を消費するということで、電池は今でもとても貴重な資源なので今でも素晴らしい実装です。このR.idにIDを追加して適当な32bit整数を割り振っておいてくださいねって指示が、<code>@+id/</code>なんです。ちなみに、割り振られた32bit整数を参照してくださいってのは<code>@id/</code>です。<code>&lt;action&gt;</code>の中の<code>app:destination=&quot;@id/bookmarksFragment&quot;</code>みたいな感じになります。</p>
<h2 id="layout">layout</h2>
<p>続けて、作成した<navigation>を使うように、画面を定義していきましょう。画面遷移をXMLで表現したように、Androidアプリの開発では、画面の構造もXMLで表現します。文字列を表示するなら<code>&lt;TextView ... /&gt;</code>みたいな感じです。で、この画面定義の際に重要な属性は<code>androud:layout_width</code>と<code>android:layout_height</code>です。</p>
<p><code>android:layout_width</code>と<code>android:layout_height</code>は、UIコンポーネントの幅と高さとなります。ここに指定するのは、具体的な大きさ（<code>64dp</code>など）か、<code>match_parent</code>、<code>wrap_content</code>になります。<code>match_parent</code>は階層上の親と同じところまで大きくするようにとの指示、<code>wrap_content</code>はコンテンツが入る大きさでお願いしますという指示です。</p>
<h2 id="constraintlayout">ConstraintLayout</h2>
<p>あと、AndroidのUIコンポーネントでは、他のコンポーネントを子要素として持てるものを<code>ViewGroup</code>、<code>ViewGroup</code>を継承して何らかのレイアウト機能を追加したものをLayoutと呼びます。Layoutには、後述するApp barを作るための<code>AppBarLayout</code>のような目的に特化したものと、<code>LinearLayout</code>(縦や横に直線状に並べる）のような汎用的なものがあります。で、今ここで話題にしたいのは、汎用的なほうのLayout。</p>
<p>貧弱なCPUを考慮した結果だと思う（作るのが面倒だったからだとは思いたくない）のですけど、Android SDKはとても単純な機能のLayoutしか提供しません。直線状に並べる<code>LinearLayout</code>とか並べないで重ねる<code>FrameLayout</code>みたいなのとか。これらの単純なLayoutの組み合わせで複雑なレイアウトを実現するのがAndroidアプリ開発者の腕の見せ所……だったのは遠い昔の話で、今は、<code>androidx.constraintlayout.widget.ConstraintLayout</code>だけを覚えれば大丈夫になりました。</p>
<p><code>ConstraintLayout</code>は、コンポーネントの位置を他のコンポーネントとの関係で表現します。「住所入力欄は名前入力欄の下」みたいな感じですね。具体的には、<code>app:layout_constraintTop_toBottomOf=&quot;@id/nameTextField&quot;</code>のようになります。左右については少し注意が必要で、アラビア語のように右から左に書く言語にも対応するために、LeftとRightではなくStartとEndで表現します。「住所入力欄のStartは名前入力欄のStartに合わせる」なら、<code>app:layout_constraintStart_toStartOf=&quot;@id/nameTextField&quot;</code>にするというわけ。</p>
<h2 id="navhostfragmentを追加する">NavHostFragmentを追加する</h2>
<p>これで一般論が終わりました。Projectビューの[app] - [res] - [layout]の下の「activityu_main.xml」を開いて、[Text]タブを選択して、以下を入力してください。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span><span class="ot"> xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="ot">    xmlns:tools=</span><span class="st">&quot;http://schemas.android.com/tools&quot;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="ot">    android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="ot">    android:layout_height=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="ot">    tools:context=</span><span class="st">&quot;.MainActivity&quot;</span><span class="kw">&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a>    <span class="kw">&lt;fragment</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="ot">        android:id=</span><span class="st">&quot;@+id/navHostFragment&quot;</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="ot">        android:name=</span><span class="st">&quot;androidx.navigation.fragment.NavHostFragment&quot;</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="ot">        app:navGraph=</span><span class="st">&quot;@navigation/navigation&quot;</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="ot">        app:defaultNavHost=</span><span class="st">&quot;true&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span></code></pre></div>
<p>注目していただきたいのは<code>&lt;fragment&gt;</code>タグの<code>android:name</code>属性のところ。<code>android:name</code>属性で実装のクラスを指定できるのはnavigationのときと同じで、今回のXMLで指定しているのは「androidx.navigation.fragment.NavHostFragment」です。Googleの人が作ってくれたクラスですな。このクラスが何なのかリファレンスで調べてみるとNavigationのためのエリアを提供すると書いてありますので、ここにNavigation配下の画面が表示されるようになったわけ。あとは、<code>app:navGraph</code>属性で先程作成したnavigation.xmlを指定して、<code>app:defaultNavHost</code>属性でデフォルトに指定しておきます。</p>
<p>次は、ダミーの画面レイアウトを作りましょう。そうしておかないと、遷移したのかどうか分からないですもんね。</p>
<h2 id="layout再び">layout、再び</h2>
<p>さて、これから<code>Fragment</code>向けのダミーのlayoutを作成していくわけですけど、その際に、Android Studioが自動で生成したXMLとはルート要素を変更します。Android Studioが生成したXMLではルート要素は具体的な<code>Layout</code>（私の環境では<code>FrameLayout</code>でした）だったのですけど、これを<code>&lt;layout&gt;</code>タグに変更します。</p>
<p>なんでこんなことをするのかというと、後で説明するデータ・バインディングをやりたいから。データ・バインディングをやる際には<code>&lt;data&gt;</code>タグでデータを指定するのですけど、<code>&lt;FrameLayout&gt;</code>タグの下には<code>&lt;data&gt;</code>タグを書けませんもんね。あと、ルート要素を<code>&lt;layout&gt;</code>タグにしておくと、Bindingクラスが生成されるようになってプログラミングがちょっと楽になるというのがあります。Bindingクラスについては後述することにして、代表例として、fragment_bookmarks.xmlを載せます。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">&lt;layout</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="ot">    xmlns:tools=</span><span class="st">&quot;http://schemas.android.com/tools&quot;</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="ot">    tools:context=</span><span class="st">&quot;.BookmarksFragment&quot;</span><span class="kw">&gt;</span></span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a>    <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;match_parent&quot;</span><span class="kw">&gt;</span></span>
<span id="cb6-11"><a href="#cb6-11"></a></span>
<span id="cb6-12"><a href="#cb6-12"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/textView&quot;</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="ot">            android:layout_marginStart=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="ot">            android:text=</span><span class="st">&quot;Bookmarks&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb6-21"><a href="#cb6-21"></a></span>
<span id="cb6-22"><a href="#cb6-22"></a>        <span class="kw">&lt;Button</span></span>
<span id="cb6-23"><a href="#cb6-23"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/departureBusStopButton&quot;</span></span>
<span id="cb6-24"><a href="#cb6-24"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb6-26"><a href="#cb6-26"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb6-27"><a href="#cb6-27"></a><span class="ot">            app:layout_constraintTop_toBottomOf=</span><span class="st">&quot;@id/textView&quot;</span></span>
<span id="cb6-28"><a href="#cb6-28"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;@id/textView&quot;</span></span>
<span id="cb6-29"><a href="#cb6-29"></a><span class="ot">            android:text=</span><span class="st">&quot;DEPARTURE BUS STOP&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb6-30"><a href="#cb6-30"></a></span>
<span id="cb6-31"><a href="#cb6-31"></a>        <span class="kw">&lt;Button</span></span>
<span id="cb6-32"><a href="#cb6-32"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/busApproachesButton&quot;</span></span>
<span id="cb6-33"><a href="#cb6-33"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb6-34"><a href="#cb6-34"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb6-35"><a href="#cb6-35"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb6-36"><a href="#cb6-36"></a><span class="ot">            app:layout_constraintTop_toBottomOf=</span><span class="st">&quot;@id/departureBusStopButton&quot;</span></span>
<span id="cb6-37"><a href="#cb6-37"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;@id/departureBusStopButton&quot;</span></span>
<span id="cb6-38"><a href="#cb6-38"></a><span class="ot">            android:text=</span><span class="st">&quot;BUS APPROACHES&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb6-39"><a href="#cb6-39"></a></span>
<span id="cb6-40"><a href="#cb6-40"></a>    <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb6-41"><a href="#cb6-41"></a></span>
<span id="cb6-42"><a href="#cb6-42"></a><span class="kw">&lt;/layout&gt;</span></span></code></pre></div>
<p>ConstraintLayoutのところでUIコンポーネントは<code>app:layout_constraint...</code>属性でレイアウトすると説明しておきながら、そこでは使わなかった<code>app:layout_constraint...</code>がやっと出てきてくれました（activity_main.xmlでは、<code>android:layout_width</code>属性も<code>android:layout_height</code>属性も「match_parent」だったので、制約をつける必要がなかったんですよ）。自分がなんの画面なのかを表示する<code>TextView</code>を左上に、その下に<code>Button</code>を表示するようになっています。<code>android:layout_marginTop</code>属性はマージンです。マージン分だけ隙間を開けてくれるわけですな。 こんな感じでルート要素が<code>&lt;layout&gt;</code>になるように、他の<code>Fragment</code>のレイアウトも同様に修正してください。</p>
<h2 id="fragmentの実装">Fragmentの実装</h2>
<p>レイアウトの修正が終わったら、ロジックの修正です。代表例は先ほどと同じ<code>BookmarksFragment</code>で。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.Fragment</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="kw">import</span> <span class="im">androidx.navigation.fragment.findNavController</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.FragmentBookmarksBinding</span></span>
<span id="cb7-10"><a href="#cb7-10"></a></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="kw">class</span> BookmarksFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb7-12"><a href="#cb7-12"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateView</span>(<span class="va">inflater</span>: <span class="dt">LayoutInflater</span>, <span class="va">container</span>: <span class="dt">ViewGroup?</span>, <span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>): <span class="dt">View?</span> {</span>
<span id="cb7-13"><a href="#cb7-13"></a>        <span class="kw">return</span> FragmentBookmarksBinding.inflate(inflater, container, <span class="kw">false</span>).apply {</span>
<span id="cb7-14"><a href="#cb7-14"></a>            departureBusStopButton.setOnClickListener {</span>
<span id="cb7-15"><a href="#cb7-15"></a>                findNavController().navigate(BookmarksFragmentDirections.bookmarksFragmentToDepartureBusStopFragment())</span>
<span id="cb7-16"><a href="#cb7-16"></a>            }</span>
<span id="cb7-17"><a href="#cb7-17"></a></span>
<span id="cb7-18"><a href="#cb7-18"></a>            busApproachesButton.setOnClickListener {</span>
<span id="cb7-19"><a href="#cb7-19"></a>                findNavController().navigate(BookmarksFragmentDirections.bookmarksFragmentToBusApproachesFragment(<span class="st">&quot;日本ユニシス本社前&quot;</span>, <span class="st">&quot;深川第八中学校前&quot;</span>))</span>
<span id="cb7-20"><a href="#cb7-20"></a>            }</span>
<span id="cb7-21"><a href="#cb7-21"></a>        }.root</span>
<span id="cb7-22"><a href="#cb7-22"></a>    }</span>
<span id="cb7-23"><a href="#cb7-23"></a>}</span></code></pre></div>
<p>importの最後で<code>com.tail_island.jetbus.databinding.FragmentBookmarksBinding</code>をインポートしていますけど、この<code>FragmentBookmarksBinding</code>クラスは、先程fragment_bookmarks.xmlのルート要素を<code>&lt;layout&gt;</code>タグに変更したことで生成されたクラスです（XMLのファイル名からクラス名を決定するので、<code>BookmarksFragmentBinding</code>ではなくて<code>FragmentBookmarksBinding</code>になります。不整合がキモチワルイけど、Android Studioのデフォルトはこのファイル名なのでしょうがない……）。あと、もしコードを書いているときにAndroid Studioがそんなクラスはないよと文句をつけてきたら、レイアウトXMLの変更を忘れたか、レイアウトXMLの変更後にビルドをしていないか（ビルドのときに自動生成されます）です。確認してみてください。</p>
<p>次。<code>Fragment</code>を初期化する処理は、コンストラクタではなく、<code>onCreateView()</code>メソッドの中に書くことに注意してください。<code>Fragment</code>は画面と結び付けられていて、画面というのは複雑で初期化が大変なソフトウェア部品です。だから、初期化のステージに合わせて、小刻みにメソッドが呼ばれる方式が採用されました。<code>Fragment</code>を作成するときに呼ばれる<code>onCreate()</code>メソッドとか、<code>Fragment</code>の<code>View</code>を生成するときに呼ばれる<code>onCreateView()</code>メソッドとか。で、一般に<code>Fragment</code>の初期化というのは画面の初期化なので、画面を構成する<code>View</code>がない状態では初期化の作業ができません。だから、<code>onCreate()</code>メソッドではなくて、<code>onCreateView()</code>メソッドに初期化のコードを書きます。</p>
<p>さて、<code>onCreateView()</code>メソッドでやらなければならない作業は、<code>Fragment</code>の<code>View</code>の生成です。Android Studioが生成する<code>Fragment</code>のコードでは、引数で渡ってくる<code>inflater: LayoutInflater</code>の<code>inflate()</code>メソッドをレイアウトXMLを引数にして呼び出すコードが生成されるのですけど、将来のデータ・バインディングのために、<code>FragmentBookmarksBinding</code>の<code>inflate()</code>メソッドを使用します。で、<code>...Binding</code>の<code>inflate()</code>メソッドで生成されるのは<code>...Binding</code>なので、<code>View</code>である<code>root</code>プロパティを返します。コードにすると、こんな感じ。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">return</span> FragmentBookmarksBinding.inflate(inflater, container, <span class="kw">false</span>).root</span></code></pre></div>
<h2 id="スコープ関数">スコープ関数</h2>
<p>でもね、私達は画面の初期化をしたいわけで、初期化にはボタンが押されたときの<code>Listener</code>の登録等も含まれます。以下のようなコードになるでしょうか。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">val</span> <span class="va">binding</span> = FragmentBookmarksBinding.inflate(inflater, container, <span class="kw">false</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a>binding.departureBusStopButton.setOnClickListener {</span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="co">// ボタンが押された場合の処理</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>}</span>
<span id="cb9-6"><a href="#cb9-6"></a></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="kw">return</span> binding.root</span></code></pre></div>
<p><code>...Binding</code>では、レイアウトXMLで定義されたUIコンポーネントを<code>android:id</code>と同じプロパティ名で参照するためのコードが生成されていますから、<code>binding.departureBusStopButton</code>で画面のボタンを参照できます。ボタンがクリックされたときのリスナーを設定するメソッドは<code>setOnClickListener()</code>で、その引数は関数です。で、関数はラムダ式で定義することができます。あと、Kotlinには、最後のパラメータがラムダ式の場合はそのパラメーターはカッコの外に指定するという慣習があります。さらに、ラムダ式だけを引数にする場合は、括弧を省略できる。というわけで、上のようなシンプルなコードになるわけです。</p>
<p>ただね、このようなコードはよく見るのですけど、実はこれ、とても悪いコードなんです。その理由は、ローカル変数（val binding）を使っているから（グローバル変数を使えと言っているわけじゃないですよ、念の為）。</p>
<p>ローカル変数は、そのブロックを抜けるまで有効です。長期間に渡ってコードに影響を与えるというわけ。<code>val</code>にしてイミュータブル（不変）にした場合でも、状態遷移という影響は減るけれども変数があることを覚えておかなければならないのは一緒で、コードを読むのが大変になってしまう。私のような、記憶力が衰えまくっているおっさんには、ローカル変数は辛いんですよ。だから、変数のスコープを小さくします。関数の最初で変数を宣言しなければならなかくてその変数が関数の最後まで有効な大昔のプログラミング言語より、どこでも変数を宣言できてブロックが終わると変数のスコープが切れる今どきの言語の方が使いやすいですよね？　変数のスコープは、小さければ小さいほど良いんです。</p>
<p>と、このような、変数のスコープを小さく、かつ、分かりやすい形で制御したい場合に使えるKotlinの便利ライブラリが、スコープ関数なんです。</p>
<p>たとえば、<code>foo()</code>の戻り値を使用したい場合は、</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">val</span> <span class="va">x</span> = foo()</span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a>x.bar()</span></code></pre></div>
<p>と書くのではなくて、</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb11-1"><a href="#cb11-1"></a>foo().let { it.bar() }</span></code></pre></div>
<p>と書きます。<code>let()</code>スコープ関数は、自分自身を引数にしたラムダ式を呼び出すというわけ。あ、ラムダ式の中の<code>it</code>は、ラムダ式のパラメーターを宣言しなかった場合の暗黙の名前です。<code>let()</code>スコープ関数は自分自身を引数にしますから、この場合の<code>it</code>は<code>foo()</code>の戻り値になります。</p>
<p>他のスコープ関数には、<code>apply()</code>（<code>this</code>を自分自身に設定したラムダ式を呼び出して、自分自身を返す。初期化等で便利）、<code>also()</code>（自分自身を引数にしたラムダ式を呼び出して、自分自身を返す。自分自身を使う他のオブジェクトの初期化等で便利）、<code>run()</code>（自分自身を<code>this</code>にしたラムダ式を実行して、ラムダ式の戻り値を返す。その場でメソッドを定義する感じ）があります。とにかく便利なので、ぜひ使い倒してください。</p>
<p>というわけで、今回は<code>apply()</code>を使用して、<code>FragmentBookmarksBinding</code>のボタンへのリスナー登録という初期化処理を書きます。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">return</span> FragmentBookmarksBinding.inflate(inflater, container, <span class="kw">false</span>).apply {</span>
<span id="cb12-2"><a href="#cb12-2"></a>    departureBusStopButton.setOnClickListener {</span>
<span id="cb12-3"><a href="#cb12-3"></a>        <span class="co">// ボタンが押された場合の処理</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>    }</span>
<span id="cb12-5"><a href="#cb12-5"></a>}.root</span></code></pre></div>
<p><code>apply()</code>なので<code>this</code>は<code>FragmentBookmarksBinding</code>になっていて、だから<code>FragmentBookmarksBinding</code>の<code>departureBusStopButton</code>に修飾なしでアクセスできて便利。スコープの範囲がインデントされて判別しやすいのも、認知機能が衰えた私のようなおっさんには嬉しいです。</p>
<h2 id="画面遷移">画面遷移</h2>
<p>Navigationでの画面の遷移は、<code>findNavController()</code>で取得できる<code>NavController</code>クラスの<code>navigate()</code>メソッドで実施します。リファレンスを見てみると<code>navigation()</code>メソッドにはオーバーロードされた様々なバリエーションがあって、色々な引数を取れるようになっています。今回、この中で注目していただきたいのは、<code>NavDirections</code>を引数に取るバージョンです。ナビゲーションのXMLで<code>&lt;action&gt;</code>を作成するとこのNavDirectionsが自動生成されるので、とても簡単に呼び出せます。というわけで、画面遷移のコードは以下のようになります。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb13-1"><a href="#cb13-1"></a>findNavController().navigate(BookmarksFragmentDirections.bookmarksFragmentToDepartureBusStopFragment())</span></code></pre></div>
<p>あと、記憶力が良い方は、ナビゲーションのXMLを作成したときに、<code>&lt;argument&gt;</code>で<code>Fragment</code>への遷移のパラメーターを定義したことを覚えているかもしれません。<code>&lt;argument&gt;</code>を定義しておくと、<code>NavDirections</code>を生成するときにパラメーターを追加してくれます。記憶力が壊滅している私のようなおっさんの場合でも、パラメーターを指定しないとコンパイル・エラーになるから思い出せますな。というわけで、以下のようなコードになります。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb14-1"><a href="#cb14-1"></a>findNavController().navigate(</span>
<span id="cb14-2"><a href="#cb14-2"></a>    BookmarksFragmentDirections.bookmarksFragmentToBusApproachesFragment(<span class="st">&quot;日本ユニシス本社前&quot;</span>, <span class="st">&quot;深川第八中学校前&quot;</span>)</span>
<span id="cb14-3"><a href="#cb14-3"></a>)</span></code></pre></div>
<p>プログラムを書く以外はどこもかしこも満遍なくダメダメだねと評判の私ごときを雇ってくださっている奇特な会社から家まで帰るルートですな。</p>
<h2 id="navigationを試してみる">Navigationを試してみる</h2>
<p>こんな感じですべての<code>Fragment</code>をプログラミングして、動かしてみると以下のようになります。</p>
<p>動画</p>
<p>[到着バス停]画面から[バス接近情報]画面に遷移した後、[戻る]ボタンを押すとレイアウトのXMLの<code>app:popUpTo</code>属性が効いて、[ブックマーク一覧]画面に戻ってくれていてとても嬉しい。</p>
<p>でも、なんか画面が寂しい気がします……。どうにかならないかな？　大体、ナビゲーションのXMLでわざわざ設定した<code>android:label</code>属性はどうなったんでしょうか？　どの画面でも、画面上部には「jetbus」って表示されているんだけど。</p>
<h2 id="app-barとnavigation-drawer">App barとNavigation drawer</h2>
<p>さて、AndroidアプリのUIは、<a href="https://material.io">Material Design</a>というデザイン・ガイドに従うことになっています。このMaterial Designにはいろいろなコンポーネントがあるのですけど、App barというコンポーネントで画面の情報を表示して、Navigation drawerでメニューを実現する方式が一般的みたいです。</p>
<p>図</p>
<p>図</p>
<p>今の画面でもApp barっぽいのはありますけど、Navigation drawerがありません。作ってみましょう。[Project]ビューの[app] - [res] - [layout]の下の「activity_main.xml」を開いて、右上の[Code]アイコンを選択して、activity_main.xmlを以下に変更します。<code>Fragment</code>のレイアウトと統一するために、ルート要素は<code>&lt;layuout&gt;</code>に変更しました。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span> <span class="kw">&lt;layout</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="ot">    xmlns:tools=</span><span class="st">&quot;http://schemas.android.com/tools&quot;</span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="ot">    tools:context=</span><span class="st">&quot;.MainActivity&quot;</span><span class="kw">&gt;</span></span>
<span id="cb15-6"><a href="#cb15-6"></a></span>
<span id="cb15-7"><a href="#cb15-7"></a>    <span class="kw">&lt;androidx.drawerlayout.widget.DrawerLayout</span></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="ot">        android:id=</span><span class="st">&quot;@+id/drawerLayout&quot;</span></span>
<span id="cb15-9"><a href="#cb15-9"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;match_parent&quot;</span><span class="kw">&gt;</span></span>
<span id="cb15-11"><a href="#cb15-11"></a></span>
<span id="cb15-12"><a href="#cb15-12"></a>        <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb15-13"><a href="#cb15-13"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb15-14"><a href="#cb15-14"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;match_parent&quot;</span><span class="kw">&gt;</span></span>
<span id="cb15-15"><a href="#cb15-15"></a></span>
<span id="cb15-16"><a href="#cb15-16"></a>            <span class="kw">&lt;com.google.android.material.appbar.AppBarLayout</span></span>
<span id="cb15-17"><a href="#cb15-17"></a><span class="ot">                android:id=</span><span class="st">&quot;@+id/appBarLayout&quot;</span></span>
<span id="cb15-18"><a href="#cb15-18"></a><span class="ot">                android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb15-19"><a href="#cb15-19"></a><span class="ot">                android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb15-20"><a href="#cb15-20"></a><span class="ot">                app:layout_constraintTop_toTopOf=</span><span class="st">&quot;parent&quot;</span><span class="kw">&gt;</span></span>
<span id="cb15-21"><a href="#cb15-21"></a></span>
<span id="cb15-22"><a href="#cb15-22"></a>                <span class="kw">&lt;androidx.appcompat.widget.Toolbar</span></span>
<span id="cb15-23"><a href="#cb15-23"></a><span class="ot">                    android:id=</span><span class="st">&quot;@+id/toolbar&quot;</span></span>
<span id="cb15-24"><a href="#cb15-24"></a><span class="ot">                    android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb15-25"><a href="#cb15-25"></a><span class="ot">                    android:layout_height=</span><span class="st">&quot;?attr/actionBarSize&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb15-26"><a href="#cb15-26"></a></span>
<span id="cb15-27"><a href="#cb15-27"></a>            <span class="kw">&lt;/com.google.android.material.appbar.AppBarLayout&gt;</span></span>
<span id="cb15-28"><a href="#cb15-28"></a></span>
<span id="cb15-29"><a href="#cb15-29"></a>            <span class="kw">&lt;fragment</span><span class="ot"> android:id=</span><span class="st">&quot;@+id/navHostFragment&quot;</span></span>
<span id="cb15-30"><a href="#cb15-30"></a><span class="ot">                android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb15-31"><a href="#cb15-31"></a><span class="ot">                android:layout_height=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb15-32"><a href="#cb15-32"></a><span class="ot">                app:layout_constraintTop_toBottomOf=</span><span class="st">&quot;@id/appBarLayout&quot;</span></span>
<span id="cb15-33"><a href="#cb15-33"></a><span class="ot">                app:layout_constraintBottom_toBottomOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb15-34"><a href="#cb15-34"></a><span class="ot">                android:name=</span><span class="st">&quot;androidx.navigation.fragment.NavHostFragment&quot;</span></span>
<span id="cb15-35"><a href="#cb15-35"></a><span class="ot">                app:navGraph=</span><span class="st">&quot;@navigation/navigation&quot;</span></span>
<span id="cb15-36"><a href="#cb15-36"></a><span class="ot">                app:defaultNavHost=</span><span class="st">&quot;true&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb15-37"><a href="#cb15-37"></a></span>
<span id="cb15-38"><a href="#cb15-38"></a>        <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb15-39"><a href="#cb15-39"></a></span>
<span id="cb15-40"><a href="#cb15-40"></a>        <span class="kw">&lt;com.google.android.material.navigation.NavigationView</span></span>
<span id="cb15-41"><a href="#cb15-41"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb15-42"><a href="#cb15-42"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb15-43"><a href="#cb15-43"></a><span class="ot">            android:layout_gravity=</span><span class="st">&quot;start&quot;</span></span>
<span id="cb15-44"><a href="#cb15-44"></a><span class="ot">            app:headerLayout=</span><span class="st">&quot;@layout/item_navigation_header&quot;</span></span>
<span id="cb15-45"><a href="#cb15-45"></a><span class="ot">            app:menu=</span><span class="st">&quot;@menu/menu_navigation&quot;</span></span>
<span id="cb15-46"><a href="#cb15-46"></a><span class="ot">            style=</span><span class="st">&quot;@style/Widget.MaterialComponents.NavigationView&quot;</span><span class="kw">&gt;</span></span>
<span id="cb15-47"><a href="#cb15-47"></a></span>
<span id="cb15-48"><a href="#cb15-48"></a>            <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb15-49"><a href="#cb15-49"></a><span class="ot">                android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb15-50"><a href="#cb15-50"></a><span class="ot">                android:layout_height=</span><span class="st">&quot;match_parent&quot;</span><span class="kw">&gt;</span></span>
<span id="cb15-51"><a href="#cb15-51"></a></span>
<span id="cb15-52"><a href="#cb15-52"></a>                <span class="kw">&lt;TextView</span><span class="ot"> android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb15-53"><a href="#cb15-53"></a><span class="ot">                    android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb15-54"><a href="#cb15-54"></a><span class="ot">                    android:layout_marginStart=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb15-55"><a href="#cb15-55"></a><span class="ot">                    android:layout_marginEnd=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb15-56"><a href="#cb15-56"></a><span class="ot">                    android:layout_marginBottom=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb15-57"><a href="#cb15-57"></a><span class="ot">                    app:layout_constraintBottom_toBottomOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb15-58"><a href="#cb15-58"></a><span class="ot">                    android:textSize=</span><span class="st">&quot;10sp&quot;</span></span>
<span id="cb15-59"><a href="#cb15-59"></a><span class="ot">                    android:text=</span><span class="st">&quot;本アプリが使用する公共交通データは、公共交通オープンデータセンターにおいて提供されるものです。\n\n公共交通事業者により提供されたデータを元にしていますが、必ずしも正確／完全なものとは限りません。本アプリの表示内容について、公共交通事業者に直接問い合わせないでください。\n\n本アプリに関するお問い合わせはrojima1@gmail.comにお願いします。&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb15-60"><a href="#cb15-60"></a></span>
<span id="cb15-61"><a href="#cb15-61"></a>            <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb15-62"><a href="#cb15-62"></a></span>
<span id="cb15-63"><a href="#cb15-63"></a>        <span class="kw">&lt;/com.google.android.material.navigation.NavigationView&gt;</span></span>
<span id="cb15-64"><a href="#cb15-64"></a></span>
<span id="cb15-65"><a href="#cb15-65"></a>    <span class="kw">&lt;/androidx.drawerlayout.widget.DrawerLayout&gt;</span></span>
<span id="cb15-66"><a href="#cb15-66"></a></span>
<span id="cb15-67"><a href="#cb15-67"></a><span class="kw">&lt;/layout&gt;</span></span></code></pre></div>
<p>……長くてごめんなさい。でも、思い出してください。我々はNavigationを使用していますので、画面といえば<code>Fragment</code>なわけです。<code>Activity</code>はアプリ全体でこれ一つだけ。なので、まぁ、一回だけならば長くても許容できるかなぁと。次のアプリの開発でも、ほぼコピー＆ペーストでいけますし。私もこれ、コピペで作成して、<code>&lt;NavigationView&gt;</code>の子要素の部分を付け加えただけで作っています。本アプリで子要素を追加するという面倒な作業が追加になった理由は、<a href="https://www.odpt.org/">公共交通オープンデータセンター</a>からデータを取得する際には「本アプリが使用する……」のような通知を書く必要があったためです。</p>
<p>でも、あれ？　<code>&lt;com.google.android.material.navigation.NavigationView&gt;</code>タグの属性を見ていくと、<code>app:headerLayout=&quot;@layout/item_navigation_header&quot;</code>や<code>app:menu=&quot;@menu/menu_navigation&quot;</code>と書いてあって、こんなリソースは無いとエラーになっています。以下の図のようにNavigation drawerはヘッダーとメニューとそれ以外で構成されていて、それ以外は子要素で定義したので、残りのヘッダーとメニューを定義しなければならないんですね。</p>
<p>図</p>
<p>というわけで、ヘッダーを作成します。プロジェクトを右クリックして、[New] - [Android Resource File]メニューを選択し、[File name]に「item_navigation_header」を入力して[Resource type]を「Layout」に設定し、作成されたitem_navigation_header.xmlに以下を入力します。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="kw">&lt;layout</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span><span class="kw">&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5"></a></span>
<span id="cb16-6"><a href="#cb16-6"></a>    <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="ot">        android:paddingBottom=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="ot">        android:background=</span><span class="st">&quot;@color/colorPrimary&quot;</span><span class="kw">&gt;</span></span>
<span id="cb16-11"><a href="#cb16-11"></a></span>
<span id="cb16-12"><a href="#cb16-12"></a>        <span class="kw">&lt;ImageView</span></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/imageView&quot;</span></span>
<span id="cb16-14"><a href="#cb16-14"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;64dp&quot;</span></span>
<span id="cb16-15"><a href="#cb16-15"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;64dp&quot;</span></span>
<span id="cb16-16"><a href="#cb16-16"></a><span class="ot">            android:layout_marginStart=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb16-17"><a href="#cb16-17"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb16-18"><a href="#cb16-18"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb16-19"><a href="#cb16-19"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb16-20"><a href="#cb16-20"></a><span class="ot">            android:src=</span><span class="st">&quot;@mipmap/ic_launcher_round&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb16-21"><a href="#cb16-21"></a></span>
<span id="cb16-22"><a href="#cb16-22"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb16-23"><a href="#cb16-23"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb16-24"><a href="#cb16-24"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb16-25"><a href="#cb16-25"></a><span class="ot">            android:layout_marginStart=</span><span class="st">&quot;8dp&quot;</span></span>
<span id="cb16-26"><a href="#cb16-26"></a><span class="ot">            app:layout_constraintStart_toEndOf=</span><span class="st">&quot;@id/imageView&quot;</span></span>
<span id="cb16-27"><a href="#cb16-27"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;@id/imageView&quot;</span></span>
<span id="cb16-28"><a href="#cb16-28"></a><span class="ot">            app:layout_constraintBottom_toBottomOf=</span><span class="st">&quot;@id/imageView&quot;</span></span>
<span id="cb16-29"><a href="#cb16-29"></a><span class="ot">            android:text=</span><span class="st">&quot;@string/app_name&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb16-30"><a href="#cb16-30"></a></span>
<span id="cb16-31"><a href="#cb16-31"></a>    <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb16-32"><a href="#cb16-32"></a></span>
<span id="cb16-33"><a href="#cb16-33"></a><span class="kw">&lt;/layout&gt;</span></span></code></pre></div>
<p>次。メニューです。プロジェクトを右クリックして、[New] - [Android Resource Directory]メニューを選択し、[Resource type]を「Menu」に設定してres/menuを作成します。そのうえで、プロジェクトを右クリックして、[New] - [Android Resource File]メニューを選択して、[File name]に「menu_navigation」を入力して[Resource type]を「Menu」に設定し、作成されたmenu_navigation.xmlに以下を入力します。</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="kw">&lt;menu</span><span class="ot"> xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span><span class="kw">&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3"></a>    <span class="kw">&lt;group&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4"></a>        <span class="kw">&lt;item</span><span class="ot"> android:id=</span><span class="st">&quot;@+id/clearDatabase&quot;</span><span class="ot"> android:title=</span><span class="st">&quot;バス停と路線のデータを再取得&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb17-5"><a href="#cb17-5"></a>    <span class="kw">&lt;/group&gt;</span></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="kw">&lt;/menu&gt;</span></span></code></pre></div>
<p><a href="https://www.odpt.org/">公共交通オープンデータセンター</a>から取得したデータのキャッシュが古くなった場合に、再取得するためのメニューですね。</p>
<p>いろいろと作業してきましたけど、ごめんなさい、でもまだ終わりません。元の画面でもApp barっぽいのがあったのに、activity_main.xmlに新たに<code>&lt;com.google.android.material.appbar.AppBarLayout&gt;</code>が追加されたことが不思議ではありませんでしたか？　こんなことをした理由は、元の画面でのApp barっぽいのは制御ができない（少なくとも私は制御のやり方をしらない）から。だから、新しいのを追加したわけですな。</p>
<p>新しいのを追加した以上は古いのを削除しなければならないわけで、そのためにはAndroidManifest.xmlを修正します。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="kw">&lt;manifest</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="ot">    package=</span><span class="st">&quot;com.tail_island.jetbus&quot;</span><span class="kw">&gt;</span></span>
<span id="cb18-5"><a href="#cb18-5"></a></span>
<span id="cb18-6"><a href="#cb18-6"></a>    <span class="kw">&lt;application</span></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="ot">        android:allowBackup=</span><span class="st">&quot;true&quot;</span></span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="ot">        android:icon=</span><span class="st">&quot;@mipmap/ic_launcher&quot;</span></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="ot">        android:label=</span><span class="st">&quot;@string/app_name&quot;</span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="ot">        android:roundIcon=</span><span class="st">&quot;@mipmap/ic_launcher_round&quot;</span></span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="ot">        android:supportsRtl=</span><span class="st">&quot;true&quot;</span></span>
<span id="cb18-12"><a href="#cb18-12"></a><span class="ot">        android:theme=</span><span class="st">&quot;@style/AppTheme&quot;</span><span class="kw">&gt;</span></span>
<span id="cb18-13"><a href="#cb18-13"></a></span>
<span id="cb18-14"><a href="#cb18-14"></a>        <span class="kw">&lt;activity</span><span class="ot"> android:name=</span><span class="st">&quot;.MainActivity&quot;</span><span class="ot"> android:theme=</span><span class="st">&quot;@style/AppTheme.NoActionBar&quot;</span><span class="kw">&gt;</span>  <span class="co">&lt;!-- android:theme属性を追加 --&gt;</span></span>
<span id="cb18-15"><a href="#cb18-15"></a>            <span class="kw">&lt;intent-filter&gt;</span></span>
<span id="cb18-16"><a href="#cb18-16"></a>                <span class="kw">&lt;action</span><span class="ot"> android:name=</span><span class="st">&quot;android.intent.action.MAIN&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb18-17"><a href="#cb18-17"></a>                <span class="kw">&lt;category</span><span class="ot"> android:name=</span><span class="st">&quot;android.intent.category.LAUNCHER&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb18-18"><a href="#cb18-18"></a>            <span class="kw">&lt;/intent-filter&gt;</span></span>
<span id="cb18-19"><a href="#cb18-19"></a>        <span class="kw">&lt;/activity&gt;</span></span>
<span id="cb18-20"><a href="#cb18-20"></a>    <span class="kw">&lt;/application&gt;</span></span>
<span id="cb18-21"><a href="#cb18-21"></a></span>
<span id="cb18-22"><a href="#cb18-22"></a><span class="kw">&lt;/manifest&gt;</span></span></code></pre></div>
<p><code>AppTheme.NoActionBar</code>というスタイルにするように指定しているわけ……なのですけど、この<code>AppTheme.NoActionBar</code>は自分で作らなければならないんですよ。無駄に感じる作業が続いてかなり腹が立ってきた頃かと思いますが（私は、毎回この作業の途中で独り言で文句を言っているらしくて、周囲に不気味がられます）、アプリ開発につき1回だけ、しかもコピー＆ペーストで済む作業ですので頑張りましょう。[Project]ビューのres/values/styles.xmlを、以下に変更します。</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="kw">&lt;resources&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a>    <span class="kw">&lt;style</span><span class="ot"> name=</span><span class="st">&quot;BaseAppTheme&quot;</span><span class="ot"> parent=</span><span class="st">&quot;Theme.MaterialComponents.Light.DarkActionBar&quot;</span><span class="kw">&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>        <span class="kw">&lt;item</span><span class="ot"> name=</span><span class="st">&quot;colorPrimary&quot;</span><span class="kw">&gt;</span>@color/colorPrimary<span class="kw">&lt;/item&gt;</span></span>
<span id="cb19-6"><a href="#cb19-6"></a>        <span class="kw">&lt;item</span><span class="ot"> name=</span><span class="st">&quot;colorPrimaryDark&quot;</span><span class="kw">&gt;</span>@color/colorPrimaryDark<span class="kw">&lt;/item&gt;</span></span>
<span id="cb19-7"><a href="#cb19-7"></a>        <span class="kw">&lt;item</span><span class="ot"> name=</span><span class="st">&quot;colorAccent&quot;</span><span class="kw">&gt;</span>@color/colorAccent<span class="kw">&lt;/item&gt;</span></span>
<span id="cb19-8"><a href="#cb19-8"></a>    <span class="kw">&lt;/style&gt;</span></span>
<span id="cb19-9"><a href="#cb19-9"></a></span>
<span id="cb19-10"><a href="#cb19-10"></a>    <span class="kw">&lt;style</span><span class="ot"> name=</span><span class="st">&quot;AppTheme&quot;</span><span class="ot"> parent=</span><span class="st">&quot;BaseAppTheme&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb19-11"><a href="#cb19-11"></a></span>
<span id="cb19-12"><a href="#cb19-12"></a>    <span class="kw">&lt;style</span><span class="ot"> name=</span><span class="st">&quot;AppTheme.NoActionBar&quot;</span><span class="kw">&gt;</span></span>
<span id="cb19-13"><a href="#cb19-13"></a>        <span class="kw">&lt;item</span><span class="ot"> name=</span><span class="st">&quot;windowActionBar&quot;</span><span class="kw">&gt;</span>false<span class="kw">&lt;/item&gt;</span></span>
<span id="cb19-14"><a href="#cb19-14"></a>        <span class="kw">&lt;item</span><span class="ot"> name=</span><span class="st">&quot;windowNoTitle&quot;</span><span class="kw">&gt;</span>true<span class="kw">&lt;/item&gt;</span></span>
<span id="cb19-15"><a href="#cb19-15"></a>    <span class="kw">&lt;/style&gt;</span></span>
<span id="cb19-16"><a href="#cb19-16"></a></span>
<span id="cb19-17"><a href="#cb19-17"></a>    <span class="kw">&lt;style</span><span class="ot"> name=</span><span class="st">&quot;AppTheme.AppBarOverlay&quot;</span><span class="ot"> parent=</span><span class="st">&quot;ThemeOverlay.MaterialComponents.Dark.ActionBar&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb19-18"><a href="#cb19-18"></a></span>
<span id="cb19-19"><a href="#cb19-19"></a>    <span class="kw">&lt;style</span><span class="ot"> name=</span><span class="st">&quot;AppTheme.PopupOverlay&quot;</span><span class="ot"> parent=</span><span class="st">&quot;ThemeOverlay.MaterialComponents.Light&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb19-20"><a href="#cb19-20"></a></span>
<span id="cb19-21"><a href="#cb19-21"></a><span class="kw">&lt;/resources&gt;</span></span></code></pre></div>
<p>App barとNavigation drawerとライブラリのNavigationを組み合わせましょう。MainActivity.ktを開いて、以下に変更してください。</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb20-2"><a href="#cb20-2"></a></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="kw">import</span> <span class="im">androidx.appcompat.app.AppCompatActivity</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="kw">import</span> <span class="im">androidx.core.view.GravityCompat</span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="kw">import</span> <span class="im">androidx.databinding.DataBindingUtil</span></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="kw">import</span> <span class="im">androidx.navigation.findNavController</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="kw">import</span> <span class="im">androidx.navigation.ui.AppBarConfiguration</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="kw">import</span> <span class="im">androidx.navigation.ui.NavigationUI</span></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.ActivityMainBinding</span></span>
<span id="cb20-12"><a href="#cb20-12"></a></span>
<span id="cb20-13"><a href="#cb20-13"></a><span class="kw">class</span> MainActivity: <span class="dt">AppCompatActivity</span>() {</span>
<span id="cb20-14"><a href="#cb20-14"></a>    <span class="kw">private</span> lateinit <span class="kw">var</span> <span class="va">binding</span>: ActivityMainBinding</span>
<span id="cb20-15"><a href="#cb20-15"></a></span>
<span id="cb20-16"><a href="#cb20-16"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreate</span>(<span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>) {</span>
<span id="cb20-17"><a href="#cb20-17"></a>        <span class="kw">super</span>.onCreate(savedInstanceState)</span>
<span id="cb20-18"><a href="#cb20-18"></a></span>
<span id="cb20-19"><a href="#cb20-19"></a>        <span class="co">// Bindingを生成します</span></span>
<span id="cb20-20"><a href="#cb20-20"></a>        binding = DataBindingUtil.setContentView&lt;ActivityMainBinding&gt;(<span class="kw">this</span>, R.layout.activity_main).also {</span>
<span id="cb20-21"><a href="#cb20-21"></a>            <span class="co">// NavigationControllerを初期化します</span></span>
<span id="cb20-22"><a href="#cb20-22"></a>            findNavController(R.id.navHostFragment).apply {</span>
<span id="cb20-23"><a href="#cb20-23"></a>                <span class="co">// レイアウトで設定したToolbarとDrawerLayoutと協調させます。また、BookmarksFragmentをルートにします。itは、ActivityMainBindingのインスタンスです</span></span>
<span id="cb20-24"><a href="#cb20-24"></a>                NavigationUI.setupWithNavController(it.toolbar, <span class="kw">this</span>, AppBarConfiguration(setOf(R.id.bookmarksFragment), it.drawerLayout))</span>
<span id="cb20-25"><a href="#cb20-25"></a></span>
<span id="cb20-26"><a href="#cb20-26"></a>                <span class="co">// SplashFragmentでは、ツールバーを非表示にします</span></span>
<span id="cb20-27"><a href="#cb20-27"></a>                addOnDestinationChangedListener { _, destination, _ -&gt;</span>
<span id="cb20-28"><a href="#cb20-28"></a>                    it.appBarLayout.visibility = <span class="cf">if</span> (destination.id == R.id.splashFragment) View.GONE <span class="cf">else</span> View.VISIBLE</span>
<span id="cb20-29"><a href="#cb20-29"></a>                }</span>
<span id="cb20-30"><a href="#cb20-30"></a>            }</span>
<span id="cb20-31"><a href="#cb20-31"></a>        }</span>
<span id="cb20-32"><a href="#cb20-32"></a>    }</span>
<span id="cb20-33"><a href="#cb20-33"></a></span>
<span id="cb20-34"><a href="#cb20-34"></a>    <span class="co">// 不整合の辻褄をあわせます。なんで我々がと思うけど我慢……。</span></span>
<span id="cb20-35"><a href="#cb20-35"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onBackPressed</span>() {</span>
<span id="cb20-36"><a href="#cb20-36"></a>        <span class="cf">if</span> (binding.drawerLayout.isDrawerOpen(GravityCompat.START)) {  <span class="co">// Navigation drawerが開いているときは、[戻る]ボタンでクローズします</span></span>
<span id="cb20-37"><a href="#cb20-37"></a>            binding.drawerLayout.closeDrawer(GravityCompat.START)</span>
<span id="cb20-38"><a href="#cb20-38"></a>            <span class="kw">return</span></span>
<span id="cb20-39"><a href="#cb20-39"></a>        }</span>
<span id="cb20-40"><a href="#cb20-40"></a></span>
<span id="cb20-41"><a href="#cb20-41"></a>        <span class="cf">if</span> (findNavController(R.id.navHostFragment).currentDestination?.id == R.id.bookmarksFragment) {  <span class="co">// AppBarConfiguration()したのでツールバーはハンバーガー・アイコンになっていますが、それでもバック・ボタンでは戻れちゃうので、チェックします</span></span>
<span id="cb20-42"><a href="#cb20-42"></a>            finish()</span>
<span id="cb20-43"><a href="#cb20-43"></a>            <span class="kw">return</span></span>
<span id="cb20-44"><a href="#cb20-44"></a>        }</span>
<span id="cb20-45"><a href="#cb20-45"></a></span>
<span id="cb20-46"><a href="#cb20-46"></a>        <span class="kw">super</span>.onBackPressed()</span>
<span id="cb20-47"><a href="#cb20-47"></a>    }</span>
<span id="cb20-48"><a href="#cb20-48"></a>}</span></code></pre></div>
<p>このコードは少し複雑ですから、解説を。</p>
<p>NavigationとNavigation drwerとApp barはとても良くできていて、上のコードのように<code>NavigationUI.setupWithNavController()</code>で結合できるのですけど、少しだけ、AndroidのAPIとの不整合があります。不整合その1は、Navigation drawerが開いているときに[戻る]ボタンが押されたときの動作です。Navigation drawerが表示されるというのは<code>&lt;com.google.android.material.navigation.NavigationView&gt;</code>に画面遷移したように見えるのですけど、内部的には画面遷移になっていないので、[戻る]ボタンを押してもNavigation drawerは閉じられません。これではユーザーが混乱しますから、<code>onBackPressed()</code>をオーバーライドして「Navigation drawerが開いている場合は閉じる」処理を追加しました。不整合その2は、本アプリでは、NavigationのXMLでのトップ／レベルの画面は<code>SplashFragment</code>なのですけど、アプリ的には<code>BookmarksFragment</code>がトップ・レベルであることです。なので、上のコードの<code>AppBarConfiguration(setOf(R.id.bookmarksFragment), ...)</code>でトップ・レベルの指定をしているのですけど、やっぱり[戻る]ボタンでの動作がおかしくなっちゃう。<code>BookmarksFragment</code>ではApp barの左がハンバーガー・アイコンになって戻れない様になっていて正しいのですけど、[戻る]ボタンを押すと<code>SplashFragment</code>に戻ってしまいます。なのでやっぱり、<code>onBackPressed()</code>の中に遷移を制御する処理を追加しました。</p>
<p>で、<code>onBackPressed()</code>はメソッドですから、<code>onCreate()</code>と<code>Binding</code>を共有したい場合は属性を追加しなければなりません。なので<code>binding</code>という属性を追加したのですけど、この<code>binding</code>は、<code>onCreate()</code>が呼ばれるまで値を設定できないという問題があります。しょうがないので最初は<code>null</code>を設定する……のは、KotlinのようなNull安全を目指している言語では悪手です。今回のように、<code>binding</code>の値が設定される前に使用されないことを保証できる（<code>onBackPressed()</code>は<code>onCreate()</code>が終わった後にしか呼び出されないので、保証できます）場合は、プログラマーの責任で属性を<code>lateinit</code>として定義できます。<code>lateinit</code>にすると初期値を設定しなくてよいので、ほら、<code>binding</code>の型を<code>null</code>を許容「しない」<code>ActivityMainBinding</code>に設定できました。</p>
<p>あと、上のコードでやっているのは、<code>SplashFragment</code>でApp barを消しています。何もしないとApp barに[戻る]アイコンが表示されてしまいますし、調べた限りでは、他のアプリでもスプラッシュ画面にはApp barがありませんでしたから。</p>
<p>ともあれ、これで作業完了のはず。試してみましょう</p>
<p>動画</p>
<p>うん、完璧ですな。Navigationよ今夜もありがとう。Navigationくらいに楽チンな、App barとNavigation drawerをどうにかしてくれるライブラリがJetpackに追加されないかなぁ……。</p>
<h1 id="retrofit2">Retrofit2</h1>
<p>さて、本アプリは<a href="https://www.odpt.org/">公共交通オープンデータセンター</a>が提供してくれるデータが無いと動きようがありませんので、個々の画面の機能を作っていく前に、HTTP通信でWebサーバーからデータを取得する処理を作ってみましょう。残念なことにJetpackにはHTTP通信の機能がありませんので、外部のライブラリであるRetrofit2を使用します。</p>
<h2 id="retrofit2の組み込み">Retrofit2の組み込み</h2>
<p>Retrofit2を組み込むために、build.gradelを変更します。</p>
<pre class="gradle"><code>dependencies {
    ...

    implementation &#39;androidx.room:room-ktx:2.2.0-beta01&#39;
    implementation &#39;com.squareup.retrofit2:retrofit:2.6.1&#39;  // 追加
    implementation &#39;com.squareup.retrofit2:converter-gson:2.6.1&#39;  // 追加
    implementation &quot;org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version&quot;

    ...
}</code></pre>
<p>これで、いつでもHTTP通信できるわけですけど、その前に、公共交通オープンデータセンターにユーザー登録しないとね。</p>
<h2 id="公共交通オープンデータセンターへのユーザー登録">公共交通オープンデータセンターへのユーザー登録</h2>
<p><a href="https://odpt.org/">公共交通オープンデータセンター</a>のサイトを開いて、下の方にある[<a href="https://developer.odpt.org/ja/info">公共交通オープンデータセンター開発者サイト</a>]リンクをクリックします。で、真ん中あたりにある[ユーザ登録のお願い]ボタンを押して、もろもろ入力して[この内容で登録を申請する]ボタンを押すと、「最大2営業日」で登録完了のメールが送られてきます。……どうして、最大とはいえ2営業日もかかるんだろ？</p>
<p>登録が完了したらログインして、右上の[Account]メニューの[アクセストークンの確認・追加]を選ぶと、アクセス・トークンが表示されます。まずはこれをコピーしてください。この情報の保存先としては、リソースを使用します。プロジェクトを右クリックして、[New] - [Android Resource File]メニューを選択して、[File name]に「odpt」を入力して[Resource type]を「Value」に設定し、作成されたodpt.xmlに以下を入力します。</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="kw">&lt;resources&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>    <span class="kw">&lt;string</span><span class="ot"> name=</span><span class="st">&quot;consumerKey&quot;</span><span class="kw">&gt;</span>アクセス・トークンをここにペースト<span class="kw">&lt;/string&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="kw">&lt;/resources&gt;</span></span></code></pre></div>
<p>よし、これで公共交通オープンデータセンターのデータを使い放題……なのですけど、いったい、どんなデータがあるのでしょうか？</p>
<h2 id="公共交通オープンデータセンターのデータ">公共交通オープンデータセンターのデータ</h2>
<p><a href="https://developer.odpt.org/">公共交通オープンデータセンター開発者サイト</a>の[<a href="https://developer.odpt.org/documents">API仕様</a>]リンクをクリックすれば、公共交通オープンデータセンターが提供するデータの仕様が分かります。</p>
<p>左に表示されている目次の[4. ODPT Bus API]リンクをクリックすると、バスに関するどのようなデータをとれるのかが分かります。見てみると、以下の6つの情報を取得できるみたい。</p>
<ul>
<li><code>odpt:BusstopPole</code>（バス停（標柱）の情報）</li>
<li><code>odpt:BusroutePattern</code>（バス路線の系統情報）</li>
<li><code>odpt:BusstopPoleTimetable</code>（バス停(標柱)の時刻表）</li>
<li><code>odpt:BusTimetable</code>（バスの便の時刻表）</li>
<li><code>odpt:BusroutePatternFare</code>（運賃情報）</li>
<li><code>odpt:Bus</code>（バスの運行情報）</li>
</ul>
<p>バスの運行情報がありますから、バスの車両の接近情報は表示できそうですね。なんかいろいろ細かいことが書いてありますけど、習うより慣れろってことで、Webブラウザを開いて、まずはバス停を取得してみましょう。「<a href="https://api.odpt.org/api/v4/odpt:BusstopPole?acl:consumerKey=ACL\_CONSUMERKEY&amp;odpt:operator=odpt.Operator:Toei" class="uri">https://api.odpt.org/api/v4/odpt:BusstopPole?acl:consumerKey=ACL\_CONSUMERKEY&amp;odpt:operator=odpt.Operator:Toei</a>」（ACL_CONSUMERKEYの部分には、ユーザー登録で取得したアクセストークンをコピー＆ペーストしてください）を開いてみます。なるほどバス停のデータが取得できている……のですけど、検索しても、こんなダラダラ生きている私を雇用してくださってるとてもありがたい「日本ユニシス本社前」という、私が会社からの帰りに使うバス停が見つかりませんでした。</p>
<p>図</p>
<p>データが欠落しているのは、API仕様の[1.3. インターフェース]の中の[1.3.1. 留意点]に「APIによって出力される結果がシステムの上限件数を超える場合、上限件数以下にフィルターされた結果が返る」とあって、リンクを辿って調べてみたら、その上限件数は1,000件だったためです（2019年8月現在）。<code>odpt:BusstopPole</code>はバス停ではなくてバス停の標柱（方面ごとに立っているアレ）で大量なので、余裕で1,000件を超えてしまって切り捨てられちゃったみたい。</p>
<p>というわけで、データ検索APIではなくて、データダンプAPIを使いましょう。「<a href="https://api.odpt.org/api/v4/odpt:BusstopPole.json?acl:consumerKey=ACL\_CONSUMERKEY" class="uri">https://api.odpt.org/api/v4/odpt:BusstopPole.json?acl:consumerKey=ACL\_CONSUMERKEY</a>」（URIに「.json」が追加されました。あと、先ほどと同様に、ACL_CONSUMERKEYの部分には、ユーザー登録で取得したアクセストークンをコピー＆ペーストしてください）を開いて、データの取得が完了するまで、しばし待ちます。日本全国津々浦々のバス停の標柱全てという大量のデータなので、時間がかかるんですよ……。はい、今度は、「日本ユニシス本社前」のデータが見つかりました。</p>
<p>図</p>
<p>ドキュメントによれば、<code>odpt:BusstopPole</code>と<code>odpt:BusroutePattern</code>は<code>owl:sameAs</code>属性で互いに紐付けられるので、出発バス停の標柱群（一つのバス停に複数の標柱がある）と到着バス停の標柱群を指定すれば、その両方に紐付いている<code>odpt:BusroutePattern</code>を抽出することで路線を見つけることができそう。ただ、<code>odpt:BusroutePattern</code>の検索APIのクエリー・パラメーターには<code>odpt:BusstopPole</code>がなかったので、抽出は自前のコードでやらなければなりませんけどね。どうせ抽出を自前のコードでやるのであれば、<code>odpt:BusroutePattern</code>もデータダンプAPIでまるっと取得してしまうことにしましょう。</p>
<p>次。<code>odpt:Bus</code>です。APIの[4.ODPT Bus API]の中の[4.2.パス]を読むと、<code>odpt:BusroutePattern</code>をクエリー・パラメーターにとることができて、[1.4. データ検索API (/v4/RDF_TYPE?)]の中の[1.4.1. フィルター処理]によれば、カンマ区切りにすればOR条件での検索になるらしい。これなら、複数の路線のバスの運行情報を一発で取得できる……のですけど、[4.3. 定義]の中の[4.3.1. odpt:Bus]の記述によれば、どのバス停を通過したのかは分かるけど、あとどれくらいで今私の目の前にあるバス停に到着するのかは分からないみたい。なので、<code>odpt:BusTimetable</code>も取得して、時刻表からバス停とバス停の間の時間を調べて、それを足し合わせて到着までの予想時間としましょう。だから、<code>odpt:BusTimetable</code>を取得する処理も作らないとね。</p>
<p>あと、API仕様にはバスの現在の位置によって<code>odpt:fromBusstopPole</code>属性（直近に通過した、あるいは停車中のバス停）と<code>odpt:BusstopPole</code>（次に到着するバス停）の情報がいろいろ変わると書いてあるのですけど、都営バスの実際のデータを取得して調べてみると、どうも現在位置がどうであれ<code>odpt:fromBusstopPole</code>属性と<code>odpt:toBusstopPole</code>属性の両方が設定されているみたい。ならば手を抜いて<code>odpt:fromBusstopPole</code>属性だけを見ればいいかなぁと。さらに、<code>odpt:BusTimetable</code>の<code>odpt:calendar</code>属性（平日時刻表とか休日時刻表とか）は[2.3. 定義]の中の[2.3.1. odpt:Calendar]に書いてある汎用データを使用していませんでした。なんだか、都営バス独自の特殊なデータが並んでいやがります……。まぁ、今回の<code>odbt:BusTimetable</code>の使用目的は到着時間を計算するための元ネタでしかありませんから、<code>odpt:calendar</code>も無視することにしましょう。プログラムが簡単になるし。</p>
<p>そうそう、<code>odpt:BusstopPole</code>と<code>odpt:BusroutePattern</code>、<code>odpt:BusTimetable</code>は、データの取得に時間がかかる上にほとんど変更がない情報ですから、RDBMSにキャッシュすることにしましょう。RDBMSを使えば、突き合わせの処理が楽になりますしね。</p>
<h2 id="webサービスの定義">Webサービスの定義</h2>
<p>やることが決まりましたので、Webサービスの定義を作りましょう。でもその前に、データ受け渡しのためのクラスを作成します。まずは、<code>odpt:Bus</code>を表現するクラスを作成します。モデルを入れるための<code>model</code>パッケージを作成して、その中にBus.ktファイルを作成して、以下のコードを入力してください。</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode kotlin:bus.kt"><code class="sourceCode kotlin"><span id="cb23-1"><a href="#cb23-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb23-2"><a href="#cb23-2"></a></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="kw">import</span> <span class="im">com.google.gson.annotations.SerializedName</span></span>
<span id="cb23-4"><a href="#cb23-4"></a></span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="kw">data</span> <span class="kw">class</span> Bus(</span>
<span id="cb23-6"><a href="#cb23-6"></a>    @<span class="va">SerializedName</span>(&quot;<span class="va">owl</span>:<span class="dt">sameAs</span>&quot;)</span>
<span id="cb23-7"><a href="#cb23-7"></a>    <span class="kw">var</span> id: <span class="dt">String</span>,</span>
<span id="cb23-8"><a href="#cb23-8"></a></span>
<span id="cb23-9"><a href="#cb23-9"></a>    @<span class="dt">SerializedName</span>(&quot;<span class="va">odpt</span>:<span class="dt">busroutePattern</span>&quot;)</span>
<span id="cb23-10"><a href="#cb23-10"></a>    <span class="kw">var</span> <span class="va">routeId</span>: <span class="kw">String</span>,</span>
<span id="cb23-11"><a href="#cb23-11"></a></span>
<span id="cb23-12"><a href="#cb23-12"></a>    <span class="at">@SerializedName</span>(<span class="st">&quot;odpt:fromBusstopPole&quot;</span>)</span>
<span id="cb23-13"><a href="#cb23-13"></a>    <span class="kw">var</span> <span class="va">fromBusStopPoleId</span>: <span class="kw">String</span></span>
<span id="cb23-14"><a href="#cb23-14"></a>)</span></code></pre></div>
<p>なんでクラスの後ろの括弧が波括弧（<code>{}</code>）じゃなくて丸括弧（<code>()</code>）なんだという疑問を抱いたJavaプログラマの方がいるかもしれませんので、ここで少しだけKotlinの解説をさせてください。</p>
<p>Kotlinでは、Scalaと同様に、クラス定義の際にコンストラクタの引数を定義できます。<code>class Foo(param1: Type, param2: Type)</code>みたいな感じ。そんなところに引数を書いたらコンストラクタでの処理はどこに書くんだよと思うかもしれませんけど、コンストラクタの処理は普通は書きません（どうしても書きたい場合には<code>init {}</code>という構文があるのでご安心を）。どうして普通は書かないのかと言うと、コンストラクタでの処理は一般にインスタンスの状態の設定で、インスタンスの状態である属性の定義ではコンストラクタの引数が使えるから。<code>class Foo(param: Type) { var bar = param.doSomething() }</code>みたいな感じです。</p>
<p>あと、Kotlinはミュータブル（可変）の変数は<code>var</code>、イミュータブル（不変）の変数は<code>val</code>で宣言するのですけど、<code>var</code>や<code>val</code>は先のコードのようにプロパティの定義でも使えます（<code>var</code>だと<code>get</code>と<code>set</code>が生成されて、<code>val</code>だと<code>get</code>だけが生成される）。これがコンストラクタの引数にも適用されて、<code>class Foo(var param1: Type, val param2: Type) {}</code>と書けば、ミュータブルなプロパティの<code>param1</code>とイミュータブルなプロパティの<code>param2</code>が生成されるというわけ。</p>
<p>さらに、データを保持するためのクラス作成専用の<code>data class</code>という構文があります。<code>data class</code>を使うと、<code>equals()</code>メソッドや<code>hashCode()</code>メソッド、<code>toString()</code>メソッド、<code>copy()</code>メソッド（あと<code>componentN()</code>メソッド）が自動で生成されてとても便利。さらに、<code>data class</code>でメソッドの定義が不要な場合は<code>{}</code>を省略できるので、上のようなコードになるわけですな。</p>
<p>さて、Retrofit2（が内部で使用しているGSON）的に重要なのは、<code>@SerializedName</code>の部分です。これはアノテーションと呼ばれるもので、ライブラリやコード・ジェネレーターが参照します。Retrofit2（が内部で使用しているGSON）は、<code>@SerializedName</code>アノテーションを見つけると、JSONを作成する際に<code>@SerializedName</code>アノテーションの引数で指定した文字列を使用してくれます。これで、<code>owl:sameAs</code>のようなKotlinでは許されない名前の属性を持ったJSONでも取り扱えるようになるというわけ。ふう、これで<code>odpt:Bus</code>を受け取る準備は完璧です。</p>
<p>同様に残りの<code>odpt:BusstopPole</code>と<code>odpt:BusroutePattern</code>、<code>odpt:BusTimetable</code>も……と考えたのですけど、これらはRDBMSにキャッシュすることにしましたから、RDBMSのレコードを表現するクラスとごっちゃになってしまって混乱しそう。だから今回はクラスを作成しないで、Retrofit2（が内部で使用しているGSON）が提供する<code>JsonArray</code>（検索APIは配列を返すので、<code>JsonObject</code>ではなくて<code>JsonArray</code>にしました）を使用します。</p>
<p>以上でWebサービスを呼び出した結果を受け取るクラスの型が全て決まりましたので、Webサービスを呼び出す部分をRetrofit2を使用して作成しましょう。といっても、実装は簡単で<code>interface</code>を定義するだけ。HTTP通信のメソッドをアノテーション（今回は<code>@GET</code>）で設定して、Webサービスの引数を同様にアノテーション（今回はクエリー・パラメーターなので<code>@Query</code>）で定義するだけですが。モデルを作成した<code>model</code>パッケージの中にWebService.ktファイルを作成して、以下を入力してください。</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode kotlin:webservice.kt"><code class="sourceCode kotlin"><span id="cb24-1"><a href="#cb24-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb24-2"><a href="#cb24-2"></a></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="kw">import</span> <span class="im">com.google.gson.JsonArray</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="kw">import</span> <span class="im">retrofit2.Call</span></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="kw">import</span> <span class="im">retrofit2.http.GET</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="kw">import</span> <span class="im">retrofit2.http.Query</span></span>
<span id="cb24-7"><a href="#cb24-7"></a></span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="kw">interface</span> WebService {</span>
<span id="cb24-9"><a href="#cb24-9"></a>    <span class="at">@GET</span>(<span class="st">&quot;/api/v4/odpt:BusstopPole.json&quot;</span>)</span>
<span id="cb24-10"><a href="#cb24-10"></a>    <span class="kw">fun</span> <span class="fu">busstopPole</span>(@<span class="va">Query</span>(&quot;<span class="va">acl</span>:<span class="dt">consumerKey</span>&quot;) <span class="fu">consumerKey</span>: <span class="dt">String</span>): <span class="dt">Call</span>&lt;<span class="dt">JsonArray</span>&gt;</span>
<span id="cb24-11"><a href="#cb24-11"></a></span>
<span id="cb24-12"><a href="#cb24-12"></a>    @<span class="fu">GET</span>(&quot;/<span class="va">api</span>/<span class="va">v4</span>/<span class="va">odpt</span>:<span class="dt">BusroutePattern</span>.<span class="va">json</span>&quot;)</span>
<span id="cb24-13"><a href="#cb24-13"></a>    <span class="kw">fun</span> <span class="fu">busroutePattern</span>(@<span class="va">Query</span>(&quot;<span class="va">acl</span>:<span class="dt">consumerKey</span>&quot;) <span class="fu">consumerKey</span>: <span class="dt">String</span>): <span class="dt">Call</span>&lt;<span class="dt">JsonArray</span>&gt;</span>
<span id="cb24-14"><a href="#cb24-14"></a></span>
<span id="cb24-15"><a href="#cb24-15"></a>    @<span class="fu">GET</span>(&quot;/<span class="va">api</span>/<span class="va">v4</span>/<span class="va">odpt</span>:<span class="dt">BusTimetable</span>&quot;)</span>
<span id="cb24-16"><a href="#cb24-16"></a>    <span class="kw">fun</span> <span class="fu">busTimeTable</span>(@<span class="va">Query</span>(&quot;<span class="va">acl</span>:<span class="dt">consumerKey</span>&quot;) <span class="fu">consumerKey</span>: <span class="dt">String</span>, @<span class="fu">Query</span>(&quot;<span class="va">odpt</span>:<span class="dt">busroutePattern</span>&quot;) <span class="fu">routePattern</span>: <span class="dt">String</span>): <span class="dt">Call</span>&lt;<span class="dt">JsonArray</span>&gt;</span>
<span id="cb24-17"><a href="#cb24-17"></a></span>
<span id="cb24-18"><a href="#cb24-18"></a>    @<span class="fu">GET</span>(&quot;/<span class="va">api</span>/<span class="va">v4</span>/<span class="va">odpt</span>:<span class="dt">Bus</span>&quot;)</span>
<span id="cb24-19"><a href="#cb24-19"></a>    <span class="kw">fun</span> <span class="fu">bus</span>(@<span class="va">Query</span>(&quot;<span class="va">acl</span>:<span class="dt">consumerKey</span>&quot;) <span class="fu">consumerKey</span>: <span class="dt">String</span>, @<span class="fu">Query</span>(&quot;<span class="va">odpt</span>:<span class="dt">busroutePattern</span>&quot;) <span class="fu">routePattern</span>: <span class="dt">String</span>): <span class="dt">Call</span>&lt;<span class="dt">List</span>&lt;<span class="dt">Bus</span>&gt;&gt;</span>
<span id="cb24-20"><a href="#cb24-20"></a>}</span></code></pre></div>
<p>はい、完成です。楽チン。</p>
<h2 id="webサービスの呼び出し">Webサービスの呼び出し</h2>
<p>とは言っても<code>interface</code>は呼び出しができませんので、なんとかして（Retrofit2のAPIが要求する形で）インスタンスを生成する方法を調べなければなりません。あとですね、Webサービスの呼び出しには時間がかかることにも、考慮が必要です。というのも、AndroidではUIの制御はメイン・スレッド<em>のみ</em>から実施できることになっていて、だからメイン・スレッドでWebサービスのような時間がかかる処理をすると、その処理の間は画面が無反応になっちゃう。だから、Webサービスの呼び出しは<em>別スレッドでやらなければならない</em>んです（そうしないと、画面が無反応になる以前に実行時エラーとなります）。</p>
<p>と、こんな感じでいろいろ複雑なので、とりあえずコードを書いてみましょう。まずは、<code>odpt:BusstopPole</code>を取得してみます。最初に表示される画面である<code>SplashFragment</code>の、画面に表示される直前に呼び出される<code>onStart()</code>メソッドを追加して、以下の処理を書き加えます。</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb25-1"><a href="#cb25-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb25-2"><a href="#cb25-2"></a></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="co">// ....</span></span>
<span id="cb25-4"><a href="#cb25-4"></a></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="kw">import</span> <span class="im">android.util.Log</span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.WebService</span></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="kw">import</span> <span class="im">retrofit2.Call</span></span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="kw">import</span> <span class="im">retrofit2.Retrofit</span></span>
<span id="cb25-9"><a href="#cb25-9"></a><span class="kw">import</span> <span class="im">retrofit2.converter.gson.GsonConverterFactory</span></span>
<span id="cb25-10"><a href="#cb25-10"></a><span class="kw">import</span> <span class="im">java.io.IOException</span></span>
<span id="cb25-11"><a href="#cb25-11"></a><span class="kw">import</span> <span class="im">kotlin.concurrent.thread</span></span>
<span id="cb25-12"><a href="#cb25-12"></a></span>
<span id="cb25-13"><a href="#cb25-13"></a><span class="kw">class</span> SplashFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb25-14"><a href="#cb25-14"></a>    <span class="co">// ...</span></span>
<span id="cb25-15"><a href="#cb25-15"></a></span>
<span id="cb25-16"><a href="#cb25-16"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onStart</span>() {</span>
<span id="cb25-17"><a href="#cb25-17"></a>        <span class="kw">super</span>.onStart()</span>
<span id="cb25-18"><a href="#cb25-18"></a></span>
<span id="cb25-19"><a href="#cb25-19"></a>        <span class="co">// リソースからアクセス・トークンを取得します。consumerKeyって名前は提供側の用語なので嫌だけど、公共交通オープンデータセンターがこの名前を使っちゃっているからなぁ……</span></span>
<span id="cb25-20"><a href="#cb25-20"></a>        <span class="kw">val</span> <span class="va">consumerKey</span> = getString(R.string.consumerKey)</span>
<span id="cb25-21"><a href="#cb25-21"></a></span>
<span id="cb25-22"><a href="#cb25-22"></a>        <span class="co">// WebServiceのインスタンスを生成します。スコープ関数が存在しない哀れな環境向けのFluentなBuilderパターン……</span></span>
<span id="cb25-23"><a href="#cb25-23"></a>        <span class="kw">val</span> <span class="va">webService</span> = Retrofit.Builder().apply {</span>
<span id="cb25-24"><a href="#cb25-24"></a>            baseUrl(<span class="st">&quot;https://api.odpt.org&quot;</span>)</span>
<span id="cb25-25"><a href="#cb25-25"></a>            addConverterFactory(GsonConverterFactory.create())</span>
<span id="cb25-26"><a href="#cb25-26"></a>        }.build().create(WebService::<span class="kw">class</span>.java)</span>
<span id="cb25-27"><a href="#cb25-27"></a></span>
<span id="cb25-28"><a href="#cb25-28"></a>        // Webサービスを呼んでいる間は画面が無反応になるのでは困るので、スレッドを生成します。今は素のスレッドを使用していますけど、後でもっとかっこいい方式をご紹介しますのでご安心ください</span>
<span id="cb25-29"><a href="#cb25-29"></a>        thread {</span>
<span id="cb25-30"><a href="#cb25-30"></a>            <span class="cf">try</span> {</span>
<span id="cb25-31"><a href="#cb25-31"></a>                <span class="co">// WebServiceを呼び出します</span></span>
<span id="cb25-32"><a href="#cb25-32"></a>                <span class="kw">val</span> <span class="va">response</span> = webService.busstopPole(consumerKey).execute()</span>
<span id="cb25-33"><a href="#cb25-33"></a></span>
<span id="cb25-34"><a href="#cb25-34"></a>                <span class="co">// HTTP通信した結果が失敗の場合は、エラーをログに出力してnullを返します</span></span>
<span id="cb25-35"><a href="#cb25-35"></a>                <span class="cf">if</span> (!response.isSuccessful) {</span>
<span id="cb25-36"><a href="#cb25-36"></a>                    Log.e(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;HTTP Error: ${response.code()}&quot;</span>)</span>
<span id="cb25-37"><a href="#cb25-37"></a>                    return<span class="at">@thread</span></span>
<span id="cb25-38"><a href="#cb25-38"></a>                }</span>
<span id="cb25-39"><a href="#cb25-39"></a></span>
<span id="cb25-40"><a href="#cb25-40"></a>                <span class="co">// レスポンスのボディは、interfaceの定義に従ってJsonArrayになります</span></span>
<span id="cb25-41"><a href="#cb25-41"></a>                <span class="kw">val</span> <span class="va">busStopPoleJsonArray</span> = response.body()</span>
<span id="cb25-42"><a href="#cb25-42"></a></span>
<span id="cb25-43"><a href="#cb25-43"></a>                <span class="co">// nullチェック</span></span>
<span id="cb25-44"><a href="#cb25-44"></a>                <span class="cf">if</span> (busStopPoleJsonArray == <span class="kw">null</span>) {</span>
<span id="cb25-45"><a href="#cb25-45"></a>                    return<span class="at">@thread</span></span>
<span id="cb25-46"><a href="#cb25-46"></a>                }</span>
<span id="cb25-47"><a href="#cb25-47"></a></span>
<span id="cb25-48"><a href="#cb25-48"></a>                <span class="co">// JsonObjectに変換して、都営バスのデータだけにフィルターして、最初の10件だけで、ループします</span></span>
<span id="cb25-49"><a href="#cb25-49"></a>                <span class="cf">for</span> (busStopPoleJsonObject <span class="kw">in</span> busStopPoleJsonArray.map { it.asJsonObject }.filter { it.<span class="kw">get</span>(<span class="st">&quot;odpt:operator&quot;</span>).asString == <span class="st">&quot;odpt.Operator:Toei&quot;</span> }.take(<span class="dv">10</span>)) {</span>
<span id="cb25-50"><a href="#cb25-50"></a>                    <span class="co">// 確認のために、いくつかの属性をログ出力します</span></span>
<span id="cb25-51"><a href="#cb25-51"></a>                    Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${busStopPoleJsonObject.get(&quot;</span>owl:sameAs<span class="st">&quot;)}&quot;</span>)</span>
<span id="cb25-52"><a href="#cb25-52"></a>                    Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${busStopPoleJsonObject.get(&quot;</span>dc:title<span class="st">&quot;)}&quot;</span>)</span>
<span id="cb25-53"><a href="#cb25-53"></a>                    Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${busStopPoleJsonObject.get(&quot;</span>odpt:kana<span class="st">&quot;)}&quot;</span>)</span>
<span id="cb25-54"><a href="#cb25-54"></a>                }</span>
<span id="cb25-55"><a href="#cb25-55"></a></span>
<span id="cb25-56"><a href="#cb25-56"></a>            } <span class="cf">catch</span> (e: IOException) {</span>
<span id="cb25-57"><a href="#cb25-57"></a>                <span class="co">// HTTP以前のエラーへの考慮も必要です。ログ出力しておきます</span></span>
<span id="cb25-58"><a href="#cb25-58"></a>                Log.e(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${e.message}&quot;</span>)</span>
<span id="cb25-59"><a href="#cb25-59"></a>            }</span>
<span id="cb25-60"><a href="#cb25-60"></a>        }</span>
<span id="cb25-61"><a href="#cb25-61"></a>    }</span>
<span id="cb25-62"><a href="#cb25-62"></a>}</span></code></pre></div>
<p>「公共交通オープンデータセンターへのユーザー登録」で設定した文字列リソースは、<code>getString()</code>メソッドで取得できます。<code>Retrofit</code>の生成APIはFluentなBuilderパターンで作られているんですけど、Fluentが主でBuilderパターンの意味は少なくて、<code>apply</code>スコープ関数があるKotlinでは無意味……。でもしょうがないので、折衷案なスタイルのコードとなりました。これで初期化作業は終了。</p>
<p>前述したようにWebサービスの呼び出しは別スレッドでやらなければならないのですけど、Kotlinなら<code>kotlin.concurrent.thread</code>でラムダ式を別スレッドで実行できて便利です。でもまぁ、コード中のコメントにも書きましたけど、後の章で述べるコルーチンを使えばさらにかっこよく書けるので、この書き方はすぐに忘れちゃって大丈夫なんだけどね。</p>
<p>別スレッドの中で、先程取得した<code>WebService</code>のインスタンスの<code>busstopPole()</code>メソッドを呼び出して<code>Call</code>インスタンスを取得して、さらに<code>execute()</code>しています。こんな面倒な形になっているのは、同期で呼び出す場合にも非同期（コールバック方式）で呼び出す場合にも対応しているから。で、今回は可読性が高い同期の<code>execute()</code>メソッドを使用しました。あとは、<code>isSuccessful</code>でHTTPのエラーが発生していないことを確認して、<code>body()</code>を取得して、これで通信は終了。</p>
<p>ここまででWebサービスから取得した<code>JsonArray</code>は、テストのために、<code>Log.d()</code>で内容をログ出力して終了です。あとは、HTTP以前のエラー（たとえばサーバーが見つからない等）に対応するために、<code>try/catch</code>します。</p>
<p>と、こんな感じでRetrofit2は使用できるのですけど、上のコードは、実はかなり格好悪いコードなんですよ。Kotlinの良さを全く引き出せていません。なので、修正しましょう。</p>
<h2 id="null安全の便利機能を使ってみる">Null安全の便利機能を使ってみる</h2>
<p>Kotlinでは、<code>NullPointerException</code>が発生するようなコードは、基本的にコンパイルできません。たとえば、先程のコードの「nullチェック」とコメントした<code>if</code>をコメント・アウトすると、コンパイル・エラーとなります。</p>
<p>Kotlinがこのような離れ業をするには、変数や関数の戻り値が<code>null</code>になりえるかどうかをコード上で表現できなければならないわけで、Kotlinでは、型名の後ろに<code>?</code>がつくかどうかで表現しています。<code>Int</code>なら<code>null</code>になることはない、<code>Int?</code>ならば<code>null</code>になる可能性があるって感じ。上のコードのRetrofit2の<code>Response</code>の<code>body()</code>は<code>JsonArray?</code>を返すので、その戻り値のメソッドを呼ぶとコンパイル・エラーになるというわけ。</p>
<p>で、Kotlinで<code>Foo?</code>の変数を<code>Foo</code>にするのは簡単で、<code>if</code>等で<code>null</code>でないことを確認すればよい。先程のコードの<code>if</code>がまさにそれなわけですな。でも、そんな<code>if</code>だらけのコードを書くのは大変すぎるし読みづらすぎるので、いくつかの便利な記法があります。</p>
<p>１つ目は、<code>!!</code>。文法的には<code>null</code>の可能性があるように見えるかもしれないけれど、<code>null</code>でないことを我々プログラマーが保証してやるぜって場合です。<code>var x: Foo? = null; x.bar()</code>はコンパイル・エラーになりますけど、<code>var x: Foo? = null; x!!.bar()</code>ならコンパイルは通ります。もちろん、実行時に<code>NullPointerException</code>が出るでしょうけど。</p>
<p>2つ目は、<code>?.</code>。<code>null</code>ならばメソッドを呼び出さないで<code>null</code>を返して、そうでなければメソッドを実行してその戻り値を返すという記法です。<code>var x: Foo? = null; var y = x?.bar()</code>は、コンパイルも通りますし<code>NullPointerException</code>も出ません。<code>bar()</code>は実行されず、<code>y</code>には<code>null</code>がセットされます。</p>
<p>3つ目は、<code>?:</code>。<code>?.</code>の反対で、<code>null</code>の場合に実行させたい処理を記述できます。<code>var x: Foo ?= null; var y = x?.bar() ?: &quot;BAR&quot;</code>なら、<code>y</code>の値は<code>null</code>ではなく「BAR」になります。</p>
<p>これらの記法ともはや見慣れたスコープ関数を組み合わせれば、先程のコードはもっときれいになります。たとえば、こんな感じ。</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb26-1"><a href="#cb26-1"></a>run {</span>
<span id="cb26-2"><a href="#cb26-2"></a>    <span class="kw">val</span> <span class="va">response</span> = webService.busstopPole(consumerKey).execute()</span>
<span id="cb26-3"><a href="#cb26-3"></a></span>
<span id="cb26-4"><a href="#cb26-4"></a>    <span class="cf">if</span> (!response.isSuccessful) {</span>
<span id="cb26-5"><a href="#cb26-5"></a>        Log.e(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;HTTP Error: ${response.code()}&quot;</span>)</span>
<span id="cb26-6"><a href="#cb26-6"></a>        return<span class="at">@run</span> <span class="kw">null</span></span>
<span id="cb26-7"><a href="#cb26-7"></a>    }</span>
<span id="cb26-8"><a href="#cb26-8"></a></span>
<span id="cb26-9"><a href="#cb26-9"></a>    response.body()  <span class="co">// ラムダ式では、最後の式の結果がラムダ式の戻り値になります</span></span>
<span id="cb26-10"><a href="#cb26-10"></a></span>
<span id="cb26-11"><a href="#cb26-11"></a>}?.let { busStopPoleJsonArray -&gt;  <span class="co">// ?.なので、run { ... }の結果がnullならlet { ... }は実行されません。</span></span>
<span id="cb26-12"><a href="#cb26-12"></a>   <span class="cf">for</span> (busStopPoleJsonObject <span class="kw">in</span> busStopPoleJsonArray.map { it.asJsonObject }.filter { it.<span class="kw">get</span>(<span class="st">&quot;odpt:operator&quot;</span>).asString == <span class="st">&quot;odpt.Operator:Toei&quot;</span> }.take(<span class="dv">10</span>)) {</span>
<span id="cb26-13"><a href="#cb26-13"></a>        Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${busStopPoleJsonObject.get(&quot;</span>owl:sameAs<span class="st">&quot;)}&quot;</span>)</span>
<span id="cb26-14"><a href="#cb26-14"></a>        Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${busStopPoleJsonObject.get(&quot;</span>dc:title<span class="st">&quot;)}&quot;</span>)</span>
<span id="cb26-15"><a href="#cb26-15"></a>        Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${busStopPoleJsonObject.get(&quot;</span>odpt:kana<span class="st">&quot;)}&quot;</span>)</span>
<span id="cb26-16"><a href="#cb26-16"></a>    }</span>
<span id="cb26-17"><a href="#cb26-17"></a>} ?: return<span class="at">@thread</span>  <span class="co">// run { ... }の結果がnullならリターン</span></span></code></pre></div>
<p>うん、マシになりました。でもまだ駄目です。他のWebサービスも呼び出す場合は、<code>run { ... }</code>の中のほとんどをもう一回書かなければならないでしょうから。</p>
<h2 id="高階関数を作ってみる">高階関数を作ってみる</h2>
<p>というわけで、関数化しましょう。こんな感じ。</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb27-1"><a href="#cb27-1"></a><span class="kw">private</span> <span class="kw">fun</span> &lt;<span class="dt">T</span>&gt; <span class="fu">getWebServiceResultBody</span>(<span class="va">callWebService</span>: () -&gt; <span class="dt">Call</span>&lt;<span class="va">T</span>&gt;): <span class="dt">T?</span> {</span>
<span id="cb27-2"><a href="#cb27-2"></a>    <span class="kw">val</span> <span class="va">response</span> = callWebService().execute()</span>
<span id="cb27-3"><a href="#cb27-3"></a></span>
<span id="cb27-4"><a href="#cb27-4"></a>    <span class="cf">if</span> (!response.isSuccessful) {</span>
<span id="cb27-5"><a href="#cb27-5"></a>        Log.e(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;HTTP Error: ${response.code()}&quot;</span>)</span>
<span id="cb27-6"><a href="#cb27-6"></a>        <span class="kw">return</span> <span class="kw">null</span></span>
<span id="cb27-7"><a href="#cb27-7"></a>    }</span>
<span id="cb27-8"><a href="#cb27-8"></a></span>
<span id="cb27-9"><a href="#cb27-9"></a>    <span class="kw">return</span> response.body()</span>
<span id="cb27-10"><a href="#cb27-10"></a>}</span></code></pre></div>
<p>引数は関数です。このような関数を引数にする関数を高階関数と呼びます。Kotlinでは、<code>(引数) -&gt; 戻り値</code>で関数の型を表現できて、上のコードの<code>&lt;T&gt;</code>の部分はテンプレートです。呼び出し側はこんな感じです。</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb28-1"><a href="#cb28-1"></a>getWebServiceResultBody { webService.busstopPole(consumerKey) }?.let { busStopPoleJsonArray -&gt;</span>
<span id="cb28-2"><a href="#cb28-2"></a>    <span class="cf">for</span> (busStopPoleJsonObject <span class="kw">in</span> busStopPoleJsonArray.map { it.asJsonObject }.filter { it.<span class="kw">get</span>(<span class="st">&quot;odpt:operator&quot;</span>).asString == <span class="st">&quot;odpt.Operator:Toei&quot;</span> }.take(<span class="dv">10</span>)) {</span>
<span id="cb28-3"><a href="#cb28-3"></a>        Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${busStopPoleJsonObject.get(&quot;</span>owl:sameAs<span class="st">&quot;)}&quot;</span>)</span>
<span id="cb28-4"><a href="#cb28-4"></a>        Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${busStopPoleJsonObject.get(&quot;</span>dc:title<span class="st">&quot;)}&quot;</span>)</span>
<span id="cb28-5"><a href="#cb28-5"></a>        Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${busStopPoleJsonObject.get(&quot;</span>odpt:kana<span class="st">&quot;)}&quot;</span>)</span>
<span id="cb28-6"><a href="#cb28-6"></a>    }</span>
<span id="cb28-7"><a href="#cb28-7"></a>}</span></code></pre></div>
<p>もはや見慣れたコードですな。前にも述べましたけど、関数はラムダ式で定義することができて、最後のパラメーターがラムダ式の場合はそのパラメーターは括弧の外にだす慣習があって、そして、ラムダ式だけを引数にする場合は括弧を省略できるので、このようなすっきりした記述になります。</p>
<p>ついでですから、<code>odpt:BusroutePattern</code>を取得して、その路線の<code>odpt:Bus</code>を取得するコードも書いてみましょう。</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb29-1"><a href="#cb29-1"></a>getWebServiceResultBody { webService.busroutePattern(consumerKey) }?.let { busroutePatternJsonArray -&gt;</span>
<span id="cb29-2"><a href="#cb29-2"></a>    <span class="cf">for</span> (busroutePatternJsonObject <span class="kw">in</span> busroutePatternJsonArray.map { it.asJsonObject }.filter { it.<span class="kw">get</span>(<span class="st">&quot;odpt:operator&quot;</span>).asString == <span class="st">&quot;odpt.Operator:Toei&quot;</span> }.take(<span class="dv">10</span>)) {</span>
<span id="cb29-3"><a href="#cb29-3"></a>        Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${busroutePatternJsonObject.get(&quot;</span>owl:sameAs<span class="st">&quot;)}&quot;</span>)</span>
<span id="cb29-4"><a href="#cb29-4"></a>        Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${busroutePatternJsonObject.get(&quot;</span>dc:title<span class="st">&quot;)}&quot;</span>)</span>
<span id="cb29-5"><a href="#cb29-5"></a></span>
<span id="cb29-6"><a href="#cb29-6"></a>        <span class="cf">for</span> (busstopPoleOrderJsonObject <span class="kw">in</span> busroutePatternJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:busstopPoleOrder&quot;</span>).asJsonArray.take(<span class="dv">10</span>).map { it.asJsonObject }) {</span>
<span id="cb29-7"><a href="#cb29-7"></a>            Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${busstopPoleOrderJsonObject.get(&quot;</span>odpt:index<span class="st">&quot;)}&quot;</span>)</span>
<span id="cb29-8"><a href="#cb29-8"></a>            Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${busstopPoleOrderJsonObject.get(&quot;</span>odpt:busstopPole<span class="st">&quot;)}&quot;</span>)</span>
<span id="cb29-9"><a href="#cb29-9"></a>        }</span>
<span id="cb29-10"><a href="#cb29-10"></a></span>
<span id="cb29-11"><a href="#cb29-11"></a>        getWebServiceResultBody { webService.bus(consumerKey, busroutePatternJsonObject.<span class="kw">get</span>(<span class="st">&quot;owl:sameAs&quot;</span>).asString) }?.let { buses -&gt;</span>
<span id="cb29-12"><a href="#cb29-12"></a>            <span class="cf">for</span> (bus <span class="kw">in</span> buses.take(<span class="dv">10</span>)) {</span>
<span id="cb29-13"><a href="#cb29-13"></a>                Log.d(<span class="st">&quot;SplashFragment&quot;</span>, bus.id)</span>
<span id="cb29-14"><a href="#cb29-14"></a>                Log.d(<span class="st">&quot;SplashFragment&quot;</span>, bus.routeId)</span>
<span id="cb29-15"><a href="#cb29-15"></a>                Log.d(<span class="st">&quot;SplashFragment&quot;</span>, bus.fromBusStopPoleId)</span>
<span id="cb29-16"><a href="#cb29-16"></a>            }</span>
<span id="cb29-17"><a href="#cb29-17"></a>        }</span>
<span id="cb29-18"><a href="#cb29-18"></a>    }</span>
<span id="cb29-19"><a href="#cb29-19"></a>}</span></code></pre></div>
<p><code>getWebServiceResultBody()</code>メソッドを定義済みなのでとても簡単です。<code>odpt:Bus</code>の方は、クラスを定義したのでさらに簡単なコードになっていますな。</p>
<h2 id="アプリへの権限の付与">アプリへの権限の付与</h2>
<p>というわけで、コーディングは終わり。早速実行……するまえに、アプリにインターネット・アクセスの権限を付加しなければなりません。[Project]ビューの[app] - [manifests]の下のAndroidManifest.xmlを開いて、<code>&lt;uses-permission&gt;</code>タグを追加してください。</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb30-1"><a href="#cb30-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="kw">&lt;manifest</span></span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="ot">    package=</span><span class="st">&quot;com.tail_island.jetbus&quot;</span><span class="kw">&gt;</span></span>
<span id="cb30-5"><a href="#cb30-5"></a></span>
<span id="cb30-6"><a href="#cb30-6"></a>    <span class="kw">&lt;uses-permission</span><span class="ot"> android:name=</span><span class="st">&quot;android.permission.INTERNET&quot;</span> <span class="kw">/&gt;</span>  <span class="co">&lt;!-- 追加 --&gt;</span></span>
<span id="cb30-7"><a href="#cb30-7"></a></span>
<span id="cb30-8"><a href="#cb30-8"></a>    <span class="kw">&lt;application</span></span>
<span id="cb30-9"><a href="#cb30-9"></a>        <span class="er">....</span><span class="kw">&gt;</span></span>
<span id="cb30-10"><a href="#cb30-10"></a>        ....</span>
<span id="cb30-11"><a href="#cb30-11"></a>    <span class="kw">&lt;/application&gt;</span></span>
<span id="cb30-12"><a href="#cb30-12"></a></span>
<span id="cb30-13"><a href="#cb30-13"></a><span class="kw">&lt;/manifest&gt;</span></span></code></pre></div>
<p>これで本当に全て完了。実行してみましょう。<code>Log</code>で出力した結果は、Android Studioの[Logcat]ビューで見ることができます。</p>
<p>絵</p>
<p>うん、正しくデータを取れていますね。Retrofit2ならWebサービス呼び出しはとても楽チン。</p>
<h1 id="room">Room</h1>
<p>前章で取得した公共交通オープンデータセンターのデータは、取得に時間がかかる上に変更が少ないので、RDBMSにキャッシュするとしていました。というわけで、Android OS内蔵のSQLiteへの抽象化レイヤを提供するRoomを使用してみます。そこそこ便利ですよ。</p>
<h2 id="roomが他のorマッピングツールとは異なるところ">Roomが、他のO/Rマッピング・ツールとは異なるところ</h2>
<p>さて、O/Rマッピングというと、データを表現するクラスを元にテーブルが生成され（もしくは、テーブル定義からクラスが生成され）、黙っていてもINSERTやUPDATE、DELETEをするメソッドが自動生成され、さらに、条件を指定するSELECTがメソッド呼び出しで実施できるようになって、ついにはテーブルとテーブルの間の関連を辿るメソッドが魔法のように現れる重厚長大なツールを想像するかもしれません。</p>
<p>でも、ごめんなさい、Roomは違うんです。それも、悪い意味で。</p>
<p>まず、テーブルとテーブルの間の関連を辿ることはできません。Roomでは、テーブル単位での操作しかできないんです。もちろん理由はあって、データベースの操作という重い処理を、UI制御を担当するメイン・スレッドでやるわけにはいかないためです。メイン・スレッドの中で関連を辿るメソッドを呼んだらデータベース・アクセスが動いてUIが止まってしまう……なんてのは困りますもんね。</p>
<p>あと、条件を指定してのSELECTでは、条件を指定する部分はSQL文を文字列としてベタ打ちしなければなりません。呼び出す側からはオブジェクト指向っぽく見えるけど、実装する側からはゴリゴリSQLなんです。まぁ、SQL文を書くのは面倒に感じますけど、<code>find(column: String, value: Int)</code>みたいな変なメソッドしか提供されなくて効率が悪いSQLが実行されちゃうよりはマシかですけど。後で説明しますけど、テーブルとテーブルの間の関連を辿る機能がない問題も、SQL文をベタ書きできるならあまり問題にはなりませんし。</p>
<p>一般的なO/Rマッピング・ツールの残りの機能は提供されるのですけど、残っているのは、アノテーションをつけることでINSERTやUPDATE、DELETEが自動生成されるのと、データを表現するクラスを書けばテーブルが生成されることだけです。ぶっちゃけ、Roomが提供する機能はこれだけなんですよ。</p>
<p>と、ここまでを読んで「そんなヘッポコなのはO/Rマッピング・ツールじゃない」と思われたかもしれませんけど、O/Rマッピングとはオブジェクトとリレーションのマッピングで、この「リレーション」というのはリレーショナル・データベース用語ではテーブルのことなんです（テーブルとテーブルの間の関連は、リレーション<em>シップ</em>）。だから、RoomをO/Rマッピングと呼んでも、言葉の意味では問題ないかなぁ。</p>
<p>まぁ、いろいろとひどいことを書きましたけど、実は私はRoomが好きです。「こういうのでいいんだよ。こういうので」ってヤツですな。他のO/Rマッピング・ツールがオーバースペックなだけ。ほら、前の章でJSONそのものを表現するJsonObjectを使った場合（<code>obpt:BusstopPole</code>や<code>odpt:BusroutePattern</code>の場合）より、JSONのデータをクラスにマッピングさせた場合（<code>odpt:Bus</code>の場合）のほうがコードが簡単だったでしょ？　あれと同じで、テーブルのレコードをインスタンスにマップしてくれるだけでも、プログラミングはとても楽になるんです。単純な機能しかないので使うの簡単ですし、SQLベタ書きなのでリレーショナル・データベースの機能を引き出しやすいですしね。</p>
<h2 id="データ構造の設計">データ構造の設計</h2>
<p>と、他のO/Rマッピング・ツール経験者への言い訳が終わったところで、作業に入りましょう。まずは、データ構造の設計です。私はいきなりコードを書き出すタイプの人間ですけど、そんな私でもプログラミング前にデータ構造だけは設計します。ER図かUMLのクラス図を描くだけですけどね。こんなの。</p>
<p>絵</p>
<p>今回はER図にしてみました。手書きのなぐり書きですけど、設計はこれで十分。だって、これでアプリが機能を提供できるかを確認できますから。試しにやってみましょう。到着バス停を指定する画面を作れるか、確認してみます。</p>
<p>出発バス停を指定する画面ではしょうがないのですべてのバス停を表示しますけど、今確認している到着バス停を選ぶ画面では、出発バス停とつながっている（乗り換え無しで行ける）バス停だけを表示して欲しいですよね？　この機能を実現できるかを確認します。</p>
<p><code>BusStop</code>から<code>BusStopPole</code>を辿れることは、図から明らかです。<code>BusStopPole</code>まで行ければ、<code>RouteBusStopPole</code>を経由して<code>Route</code>を取得できます。<code>Route</code>が分かれば、今度は逆に辿ることで<code>BusStop</code>まで行けます。ほら、出発バス停が指定されれば、そこから、出発バス停とつながっているバス停の一覧を取得できます。これで、到着バス停を指定する画面を余裕で作れることが確認できました。</p>
<p>あと、出発バス停と到着バス停が分かれば、対象となる<code>Route</code>が上りなのか下りなのかの判断ができます。<code>RouteBusStopPole</code>には<code>order</code>があって、これは<code>Route</code>における順序です。だから、出発の<code>BusStop</code>に関連付けられた<code>RouteBusStopPole.order</code>が到着の<code>BusStop</code>に関連付けられた<code>RouteBusStopPole.order</code>よりも小さい方の<code>Route</code>を選べば、上りか下りのどちらかとなるというわけ。SQLで書くと、こんな感じです。</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb31-1"><a href="#cb31-1"></a><span class="kw">SELECT</span> Route.<span class="op">*</span></span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="kw">FROM</span> BusStopPole <span class="kw">AS</span> ArrivalBusStopPole</span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> RouteBusStopPole <span class="kw">AS</span> ArrivalRouteBusStopPole <span class="kw">ON</span></span>
<span id="cb31-4"><a href="#cb31-4"></a>           ArrivalRouteBusStopPole.busStopPoleId <span class="op">=</span> ArrivalBusStopPole.<span class="kw">id</span></span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> Route <span class="kw">ON</span></span>
<span id="cb31-6"><a href="#cb31-6"></a>           Route.<span class="kw">id</span> <span class="op">=</span> ArrivalRouteBusStopPole.routeId</span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> RouteBusStopPole <span class="kw">As</span> DepartureRouteBusStopPole <span class="kw">ON</span></span>
<span id="cb31-8"><a href="#cb31-8"></a>           DepartureRouteBusStopPole.routeId <span class="op">=</span> Route.<span class="kw">id</span></span>
<span id="cb31-9"><a href="#cb31-9"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> BusStopPole <span class="kw">AS</span> DepartureBusStopPole <span class="kw">ON</span></span>
<span id="cb31-10"><a href="#cb31-10"></a>           DepartureBusStopPole.<span class="kw">id</span> <span class="op">=</span> DepartureRouteBusStopPole.busStopPoleId</span>
<span id="cb31-11"><a href="#cb31-11"></a><span class="kw">WHERE</span> ArrivalRouteBusStopPole.<span class="st">&#39;order&#39;</span> <span class="op">&gt;</span> DepartureRouteBusStopPole.<span class="st">&#39;order&#39;</span> <span class="kw">AND</span></span>
<span id="cb31-12"><a href="#cb31-12"></a>      DepartureBusStopPole.busStopName <span class="op">=</span> <span class="ot">&quot;日本ユニシス本社前&quot;</span> <span class="kw">AND</span></span>
<span id="cb31-13"><a href="#cb31-13"></a>      ArrivalBusStopPole.busStopName <span class="op">=</span> <span class="ot">&quot;塩浜二丁目&quot;</span></span></code></pre></div>
<p>前の方でRoomにはテーブル間の関係を辿る機能がないと書きましたけど、このSQLのように<code>JOIN</code>で繋げば（もしくは、後の章で述べるように副問合せを使えば）他のテーブルのカラムを検索条件に指定することは可能です。だから、Roomにテーブルの間の関連を辿る機能がなくても大丈夫なんです。そもそも、この処理なんて、普通のO/Rマッピング・ツールで書くとかえって大変ですよ。出発の<code>BusStopPole</code>の集合を作成して<code>RouteBusStopPole</code>を経由して<code>Route</code>の集合を取得し、到着でも同じ処理をして、それぞれの<code>Route</code>の集合を<code>union</code>して、さらにその後に<code>order</code>を使用してフィルタリングするような処理になっちゃうでしょうからね。</p>
<p>さて、<code>Route</code>が分かれば<code>TimeTable</code>を取得できます。ただ、バスは一つの路線を日に何回も行き来していますから、<code>Route</code>と<code>TimeTable</code>の関係は1対多となっています。よって、複数ある<code>TimeTable</code>の中から一つを選ばなければなりません。最初の一つとかランダムで一つとかを選んでもいいのですけど、道路が空いているときと混んでいるときで時刻表は変わるだろうと考えて、到着バス停に関連付けられた<code>TimeTableDetail.arrival</code>が現在時刻に最も近いものを選ぶことにしましょう。</p>
<p>あとは、データベースでは管理しないけどER図には追加しておいた<code>Bus</code>に関連付けられた<code>BusStopPole</code>に関連付けられた<code>TimeTableDetails.arrival</code>と、出発<code>BusStopPole</code>と関連付けられている<code>TimeTableDetails.arrival</code>の差を計算すれば、ほら、これで到着までの時間になります。バスの接近情報を表示する画面も完璧ですな。</p>
<p>と、こんな感じでシミュレーションできたので、これで設計は終わり！　プログラミングに入りましょう。</p>
<h2 id="エンティティの定義">エンティティの定義</h2>
<p>設計したER図のエンティティをプログラミングします。とは言っても、Retrofit2のところでやったデータ受け渡しのクラスの作成と似た作業、<code>data class</code>を作るだけの簡単作業です。まずは、<code>BusStop</code>を作ってみましょう。</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb32-2"><a href="#cb32-2"></a></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="kw">import</span> <span class="im">androidx.room.Entity</span></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="kw">import</span> <span class="im">androidx.room.PrimaryKey</span></span>
<span id="cb32-5"><a href="#cb32-5"></a></span>
<span id="cb32-6"><a href="#cb32-6"></a><span class="at">@Entity</span></span>
<span id="cb32-7"><a href="#cb32-7"></a><span class="kw">data</span> <span class="kw">class</span> BusStop(</span>
<span id="cb32-8"><a href="#cb32-8"></a>    @<span class="va">PrimaryKey</span></span>
<span id="cb32-9"><a href="#cb32-9"></a>    <span class="kw">var</span> <span class="va">name</span>: <span class="dt">String</span>,</span>
<span id="cb32-10"><a href="#cb32-10"></a></span>
<span id="cb32-11"><a href="#cb32-11"></a>    <span class="kw">var</span> <span class="va">phoneticName</span>: <span class="dt">String?</span></span>
<span id="cb32-12"><a href="#cb32-12"></a>)</span></code></pre></div>
<p>RoomのエンティティであることをRoomに伝えるために、<code>@Entity</code>アノテーションを追加しておきます。あと、リレーショナル・データベースではレコードを識別するための主キーが必要なので、<code>@PrimaryKey</code>アノテーションで主キーを指定しています。</p>
<p><code>BusStop</code>に関連付けられる<code>BusStopPole</code>も作りましょう。</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb33-1"><a href="#cb33-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="kw">import</span> <span class="im">androidx.room.ColumnInfo</span></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="kw">import</span> <span class="im">androidx.room.Entity</span></span>
<span id="cb33-5"><a href="#cb33-5"></a><span class="kw">import</span> <span class="im">androidx.room.ForeignKey</span></span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="kw">import</span> <span class="im">androidx.room.PrimaryKey</span></span>
<span id="cb33-7"><a href="#cb33-7"></a></span>
<span id="cb33-8"><a href="#cb33-8"></a><span class="at">@Entity</span>(foreignKeys = [ForeignKey(entity = BusStop::<span class="kw">class</span>, parentColumns = [&quot;name&quot;], childColumns = [&quot;busStopName&quot;])])</span>
<span id="cb33-9"><a href="#cb33-9"></a><span class="kw">data</span> <span class="kw">class</span> BusStopPole(</span>
<span id="cb33-10"><a href="#cb33-10"></a>    @<span class="va">PrimaryKey</span></span>
<span id="cb33-11"><a href="#cb33-11"></a>    <span class="kw">var</span> <span class="va">id</span>: <span class="dt">String</span>,</span>
<span id="cb33-12"><a href="#cb33-12"></a></span>
<span id="cb33-13"><a href="#cb33-13"></a>    @<span class="va">ColumnInfo</span>(<span class="va">index</span> = true)</span>
<span id="cb33-14"><a href="#cb33-14"></a>    <span class="kw">var</span> busStopName: <span class="dt">String</span></span>
<span id="cb33-15"><a href="#cb33-15"></a>)</span></code></pre></div>
<p><code>BusStopPole</code>では、<code>BusStop</code>と関連付けられていることを示すために<code>@Entity</code>アノテーションの<code>foreignKeys</code>を指定してます。参照整合性と呼ばれるアレですな。あと、<code>busStopName</code>で検索するときに速度が出るように<code>@ColumnInfo</code>アノテーションの<code>index</code>に<code>true</code>を指定しています。データベース管理者が検索のパフォーマンス・チューニングのときに貼るインデックスのことですな。</p>
<p>参照整合性というのは、テーブルのレコード間の関連を正しく保つ仕組みです。存在しない<code>BusStop</code>に関連付けられた<code>BusStopPole</code>は存在しては駄目ですよね？　上のコードのように<code>foreignKeys</code>を指定しておけば、<code>BusStopPole</code>をデータベースに追加する際に、<code>busStopName</code>と同じ値を<code>name</code>に持つ<code>BusStop</code>が存在することを確認してくれるようになります。これでデータの信頼性が高まって素晴らしい。</p>
<p>インデックスというのは、検索のための索引（インデックス）を作成する仕組みです。インデックスが「ない」場合は、テーブルの行を順に見ていって、条件を満たすものがあるか調べます。Kotlinでいうところの<code>records.filter { record -&gt; record.busStopName = &quot;日本ユニシス本社前&quot; }</code>みたいな感じ。レコード数が100件とかなら別にこれでいいですけど、100万件とか1億件とかになると、これでは遅くてやってられません。なので、検索専用のデータ構造を別に作るわけです。B+木というデータ構造を使うことが多いみたいで、B+木を使うとデータ件数が多くてもあっという間に検索できます。Kotlinでも、<code>Map</code>を使うと検索がとても早くなりますよね？　あんな感じ。データの追加や更新でインデックスを更新する手間がかかって少しだけ遅くなりますけど、検索が圧倒的に速くなるのでトータルでは素晴らしい。</p>
<p>さて、これで他のエンティティと関係づけられている場合の書き方もわかりましたから、残りもどんどん作っていきます。<code>Route</code>はこんな感じ。</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb34-1"><a href="#cb34-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb34-2"><a href="#cb34-2"></a></span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="kw">import</span> <span class="im">androidx.room.Entity</span></span>
<span id="cb34-4"><a href="#cb34-4"></a><span class="kw">import</span> <span class="im">androidx.room.PrimaryKey</span></span>
<span id="cb34-5"><a href="#cb34-5"></a></span>
<span id="cb34-6"><a href="#cb34-6"></a><span class="at">@Entity</span></span>
<span id="cb34-7"><a href="#cb34-7"></a><span class="kw">data</span> <span class="kw">class</span> Route(</span>
<span id="cb34-8"><a href="#cb34-8"></a>    @<span class="va">PrimaryKey</span></span>
<span id="cb34-9"><a href="#cb34-9"></a>    <span class="kw">var</span> <span class="va">id</span>: <span class="dt">String</span>,</span>
<span id="cb34-10"><a href="#cb34-10"></a></span>
<span id="cb34-11"><a href="#cb34-11"></a>    <span class="kw">var</span> <span class="va">name</span>: <span class="dt">String</span></span>
<span id="cb34-12"><a href="#cb34-12"></a>)</span></code></pre></div>
<p><code>BusStop</code>とほぼ同じですな。続けてこれまでの知見を活用して<code>RouteBusStopPole</code>を作る……際に問題となるのは、<code>RouteBusStopPole</code>の主キーです。これまで作成してきたエンティティでは公共交通オープンデータセンターのID（である<code>owl:sameAs</code>属性の値）をそのまま使えばよかったのですけど、<code>RouteBusStopPole</code>ではその手は使えません。でも、独自の重複しないIDを生成して割り当てる処理を作るのは面倒です……。と、そんな場合は<code>@PrimaryKey</code>アノテーションの<code>autoGenerate</code>を使用できます。こんな感じ。</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb35-1"><a href="#cb35-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb35-2"><a href="#cb35-2"></a></span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="kw">import</span> <span class="im">androidx.room.ColumnInfo</span></span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="kw">import</span> <span class="im">androidx.room.Entity</span></span>
<span id="cb35-5"><a href="#cb35-5"></a><span class="kw">import</span> <span class="im">androidx.room.ForeignKey</span></span>
<span id="cb35-6"><a href="#cb35-6"></a><span class="kw">import</span> <span class="im">androidx.room.PrimaryKey</span></span>
<span id="cb35-7"><a href="#cb35-7"></a></span>
<span id="cb35-8"><a href="#cb35-8"></a><span class="at">@Entity</span>(foreignKeys = [ForeignKey(entity = Route::<span class="kw">class</span>, parentColumns = [&quot;id&quot;], childColumns = [&quot;routeId&quot;]), ForeignKey(<span class="va">entity</span> = BusStopPole::class, <span class="va">parentColumns</span> = [<span class="st">&quot;id&quot;</span>], <span class="va">childColumns</span> = [<span class="st">&quot;busStopPoleId&quot;</span>])])</span>
<span id="cb35-9"><a href="#cb35-9"></a><span class="kw">data</span> <span class="kw">class</span> RouteBusStopPole(</span>
<span id="cb35-10"><a href="#cb35-10"></a>    @<span class="va">ColumnInfo</span>(<span class="va">index</span> = true)</span>
<span id="cb35-11"><a href="#cb35-11"></a>    <span class="kw">var</span> routeId: <span class="dt">String</span>,</span>
<span id="cb35-12"><a href="#cb35-12"></a></span>
<span id="cb35-13"><a href="#cb35-13"></a>    <span class="kw">var</span> <span class="va">order</span>: <span class="kw">Int</span>,</span>
<span id="cb35-14"><a href="#cb35-14"></a></span>
<span id="cb35-15"><a href="#cb35-15"></a>    <span class="at">@ColumnInfo</span>(index = <span class="kw">true</span>)</span>
<span id="cb35-16"><a href="#cb35-16"></a>    <span class="kw">var</span> <span class="va">busStopPoleId</span>: <span class="kw">String</span></span>
<span id="cb35-17"><a href="#cb35-17"></a>) {</span>
<span id="cb35-18"><a href="#cb35-18"></a>    <span class="at">@PrimaryKey</span>(autoGenerate = <span class="kw">true</span>)</span>
<span id="cb35-19"><a href="#cb35-19"></a>    <span class="kw">var</span> <span class="va">id</span>: <span class="kw">Long</span> = <span class="dv">0</span></span>
<span id="cb35-20"><a href="#cb35-20"></a>}</span></code></pre></div>
<p><code>@PrimaryKey(autoGenerate = true)</code>と書けば、主キーには重複しない値が自動で設定されます。なお、上のコードで<code>var id</code>をコンストラクタの引数にしていないのは、<code>RouteBusStopPole</code>のインスタンスを作成するときに<code>id</code>のことを考えたくないから。<code>data class</code>にも普通のクラスと同じようにメソッドやプロパティは追加できるので、<code>{ ... }</code>で囲んだ中に普通に<code>var id: Long = 0</code>でデフォルト値付きのプロパティを追加したというわけです。</p>
<p>以上でエンティティの作成に必要な知識は揃いましたので、同様に<code>TimeTable</code>と<code>TimeTableDetail</code>、<code>Bookmark</code>を定義しましょう。何も新しいことはしていませんので、コードは省略で。どうしても見たい場合は、GitHubのコードを参照してみてください。</p>
<h2 id="データアクセスオブジェクトの作成">データ・アクセス・オブジェクトの作成</h2>
<p>データを入れるエンティティは作成できたので、これを使用してデータベースを操作したい。そのためのオブジェクトがデータ・アクセス・オブジェクト、DAOと省略されるアレですね。さっそく作ってみましょう。<code>BusStop</code>用の<code>BusStopDao</code>を作ります。</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb36-1"><a href="#cb36-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb36-2"><a href="#cb36-2"></a></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="kw">import</span> <span class="im">androidx.room.Dao</span></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="kw">import</span> <span class="im">androidx.room.Insert</span></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="kw">import</span> <span class="im">androidx.room.Query</span></span>
<span id="cb36-6"><a href="#cb36-6"></a></span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="at">@Dao</span></span>
<span id="cb36-8"><a href="#cb36-8"></a><span class="kw">interface</span> BusStopDao {</span>
<span id="cb36-9"><a href="#cb36-9"></a>    <span class="at">@Insert</span></span>
<span id="cb36-10"><a href="#cb36-10"></a>    <span class="kw">fun</span> <span class="fu">add</span>(<span class="va">busStop</span>: <span class="dt">BusStop</span>)</span>
<span id="cb36-11"><a href="#cb36-11"></a></span>
<span id="cb36-12"><a href="#cb36-12"></a>    @<span class="fu">Query</span>(&quot;<span class="va">DELETE</span> <span class="va">FROM</span> <span class="va">BusStop</span>&quot;)</span>
<span id="cb36-13"><a href="#cb36-13"></a>    <span class="kw">fun</span> <span class="fu">clear</span>()</span>
<span id="cb36-14"><a href="#cb36-14"></a></span>
<span id="cb36-15"><a href="#cb36-15"></a>    @<span class="fu">Query</span>(&quot;<span class="va">SELECT</span> * <span class="va">FROM</span> <span class="va">BusStop</span> <span class="va">WHERE</span> <span class="va">name</span> = :name LIMIT 1<span class="st">&quot;)</span></span>
<span id="cb36-16"><a href="#cb36-16"></a>    fun getByName(name: String): BusStop?</span>
<span id="cb36-17"><a href="#cb36-17"></a>}</span></code></pre></div>
<p>データ・アクセス・オブジェクトであることを指示するために<code>@Dao</code>アノテーションを追加して、データの追加と更新、削除のメソッドには<code>@Inert</code>と<code>@Update</code>、<code>@Delete</code>を追加します。今回は公共交通オープンデーターセンターから取得したデータを追加するだけなので<code>@Insert</code>アノテーションのみ。メソッドの引数はエンティティ・オブジェクトにします。</p>
<p><code>@Query</code>アノテーションは、メソッドが呼ばれたらSQLを実行するようにとの指示です。どんなSQLでもオッケー、Queryという名前を無視して検索ではないSQLを指定しても大丈夫です。上のコードの<code>clear()</code>メソッドがそれですね。公共交通オープンデータセンターのデータと再同期するときのために、<code>clear()</code>ではすべてのデータを消す<code>DELETE FROM BusStop</code>を実行するように指示しています。</p>
<p>あとは、バス停の名前を指定して<code>BusStop</code>を取得するための<code>getByName()</code>メソッドを作成しました。メソッドの引数をSQLに渡す場合は、上のコードのように<code>:パラメーター名</code>とします。<code>name = :name</code>のところですね。<code>BusStop.name</code>は主キーなので1件しか存在しないのですけど、念の為<code>LIMIT 1</code>を指定しみました。<code>LIMIT</code>の分で最適化とかが働くといいなぁ……。そうそう、存在しない<code>name</code>が指定された場合に備えるために、戻り値の型は<code>null</code>を許容する<code>BusStop?</code>にしています。</p>
<p>で、他のデータ・アクセス・オブジェクトもほぼ同様の作り方で作成できるのですけど、エンティティ・オブジェクトで<code>@PrimaryKey(autoGenerate = true)</code>とした場合は、少しだけ注意が必要です。というのも、新しいエンティティ・オブジェクトを作成してそれをINSERTした場合、自動生成された主キーが分からないと二度とそのオブジェクトにアクセスできなくなっちゃうんです（検索して取得しようにも、主キー以外で検索したのでは一意になる保証がないですもんね）。というわけで、<code>@PrimaryKey(autoGenerate = true)</code>な<code>RouteBusStopPole</code>向けの<code>RouteBusStopPoleDao</code>は、以下のようなコードになります。</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb37-1"><a href="#cb37-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb37-2"><a href="#cb37-2"></a></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="kw">import</span> <span class="im">androidx.room.Dao</span></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="kw">import</span> <span class="im">androidx.room.Insert</span></span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="kw">import</span> <span class="im">androidx.room.Query</span></span>
<span id="cb37-6"><a href="#cb37-6"></a></span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="at">@Dao</span></span>
<span id="cb37-8"><a href="#cb37-8"></a><span class="kw">interface</span> RouteBusStopPoleDao {</span>
<span id="cb37-9"><a href="#cb37-9"></a>    <span class="at">@Insert</span></span>
<span id="cb37-10"><a href="#cb37-10"></a>    <span class="kw">fun</span> <span class="fu">add</span>(<span class="va">routeBusStopPole</span>: <span class="dt">RouteBusStopPole</span>): <span class="dt">Long</span></span>
<span id="cb37-11"><a href="#cb37-11"></a></span>
<span id="cb37-12"><a href="#cb37-12"></a>    @<span class="fu">Query</span>(&quot;<span class="va">DELETE</span> <span class="va">FROM</span> <span class="va">RouteBusStopPole</span>&quot;)</span>
<span id="cb37-13"><a href="#cb37-13"></a>    <span class="kw">fun</span> <span class="fu">clear</span>()</span>
<span id="cb37-14"><a href="#cb37-14"></a>}</span></code></pre></div>
<p><code>@Insert</code>のメソッドの戻り値を主キーの型にしただけ。これだけで、INSERT時に自動生成された主キーを、戻り値として取得できるようになります。</p>
<h2 id="データベースを定義する">データベースを定義する</h2>
<p>最後。データベースの定義です。こんな感じ。</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb38-1"><a href="#cb38-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb38-2"><a href="#cb38-2"></a></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="kw">import</span> <span class="im">androidx.room.Database</span></span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="kw">import</span> <span class="im">androidx.room.RoomDatabase</span></span>
<span id="cb38-5"><a href="#cb38-5"></a></span>
<span id="cb38-6"><a href="#cb38-6"></a><span class="at">@Database</span>(entities = [Bookmark::<span class="kw">class</span>, BusStop::<span class="kw">class</span>, BusStopPole::<span class="kw">class</span>, Route::<span class="kw">class</span>, RouteBusStopPole::<span class="kw">class</span>, TimeTable::<span class="kw">class</span>, TimeTableDetail::<span class="kw">class</span>], version = 1, exportSchema = false)</span>
<span id="cb38-7"><a href="#cb38-7"></a>abstract <span class="kw">class</span> AppDatabase: <span class="dt">RoomDatabase</span>() {</span>
<span id="cb38-8"><a href="#cb38-8"></a>    abstract <span class="kw">fun</span> <span class="fu">getBookmarkDao</span>(): <span class="dt">BookmarkDao</span></span>
<span id="cb38-9"><a href="#cb38-9"></a>    <span class="fu">abstract</span> <span class="kw">fun</span> <span class="fu">getBusStopDao</span>(): <span class="dt">BusStopDao</span></span>
<span id="cb38-10"><a href="#cb38-10"></a>    <span class="fu">abstract</span> <span class="kw">fun</span> <span class="fu">getBusStopPoleDao</span>(): <span class="dt">BusStopPoleDao</span></span>
<span id="cb38-11"><a href="#cb38-11"></a>    <span class="fu">abstract</span> <span class="kw">fun</span> <span class="fu">getRouteBusStopPoleDao</span>(): <span class="dt">RouteBusStopPoleDao</span></span>
<span id="cb38-12"><a href="#cb38-12"></a>    <span class="fu">abstract</span> <span class="kw">fun</span> <span class="fu">getRouteDao</span>(): <span class="dt">RouteDao</span></span>
<span id="cb38-13"><a href="#cb38-13"></a>    <span class="fu">abstract</span> <span class="kw">fun</span> <span class="fu">getTimeTableDao</span>(): <span class="dt">TimeTableDao</span></span>
<span id="cb38-14"><a href="#cb38-14"></a>    <span class="fu">abstract</span> <span class="kw">fun</span> <span class="fu">getTimeTableDetailDao</span>(): <span class="dt">TimeTableDetailDao</span></span>
<span id="cb38-15"><a href="#cb38-15"></a>}</span></code></pre></div>
<p><code>@Database</code>アノテーションの<code>entities</code>でデータベースに含めるエンティティを指定して、<code>version</code>で適当にバージョンを指定します。<code>exportSchema</code>というのはデータベースを生成するときに使用したスキーマをビルド時に出力してくれる便利機能なのですけど、出力先が指定されていないというビルド・エラーが出たので<code>false</code>を設定して出力されないようにしました。</p>
<p>あとは、データ・アクセス・オブジェクトを取得するメソッドを定義するだけです。データ・アクセス・オブジェクトでは<code>interface</code>、データベースでは<code>abstract class</code>しか定義していませんけど、build.gradleで指定したKotlin Annoataion Processing Tool（kapt）が実体を自動生成してくれますのでご安心ください。</p>
<h2 id="roomを呼び出してみる">Roomを呼び出してみる</h2>
<p>以上ででRoomの準備は完了です。準備が終わった以上は使ってみたい。前章で作成した公共交通オープンデータセンターからデータを取得するコードを改造して、データベースにデータをキャッシュする処理を書いてみます。</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb39-1"><a href="#cb39-1"></a><span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onStart</span>() {</span>
<span id="cb39-2"><a href="#cb39-2"></a>    <span class="kw">super</span>.onStart()</span>
<span id="cb39-3"><a href="#cb39-3"></a></span>
<span id="cb39-4"><a href="#cb39-4"></a>    <span class="kw">val</span> <span class="va">consumerKey</span> = getString(R.string.consumerKey)</span>
<span id="cb39-5"><a href="#cb39-5"></a>    <span class="kw">val</span> <span class="va">webService</span> = Retrofit.Builder().apply {</span>
<span id="cb39-6"><a href="#cb39-6"></a>        baseUrl(<span class="st">&quot;https://api.odpt.org&quot;</span>)</span>
<span id="cb39-7"><a href="#cb39-7"></a>        addConverterFactory(GsonConverterFactory.create())</span>
<span id="cb39-8"><a href="#cb39-8"></a>    }.build().create(WebService::<span class="kw">class</span>.java)</span>
<span id="cb39-9"><a href="#cb39-9"></a></span>
<span id="cb39-10"><a href="#cb39-10"></a>    // データベースのインスタンスを作成します。</span>
<span id="cb39-11"><a href="#cb39-11"></a>    <span class="kw">val</span> database = Room.databaseBuilder(<span class="va">requireContext</span>(), AppDatabase::<span class="kw">class</span>.java, &quot;jetbus.db&quot;).build()</span>
<span id="cb39-12"><a href="#cb39-12"></a></span>
<span id="cb39-13"><a href="#cb39-13"></a>    thread {</span>
<span id="cb39-14"><a href="#cb39-14"></a>        <span class="cf">try</span> {</span>
<span id="cb39-15"><a href="#cb39-15"></a>            Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;Start.&quot;</span>)</span>
<span id="cb39-16"><a href="#cb39-16"></a></span>
<span id="cb39-17"><a href="#cb39-17"></a>            <span class="co">// データを削除します。</span></span>
<span id="cb39-18"><a href="#cb39-18"></a>            database.getTimeTableDetailDao().clear()</span>
<span id="cb39-19"><a href="#cb39-19"></a>            database.getTimeTableDao().clear()</span>
<span id="cb39-20"><a href="#cb39-20"></a>            database.getRouteBusStopPoleDao().clear()</span>
<span id="cb39-21"><a href="#cb39-21"></a>            database.getRouteDao().clear()</span>
<span id="cb39-22"><a href="#cb39-22"></a>            database.getBusStopPoleDao().clear()</span>
<span id="cb39-23"><a href="#cb39-23"></a>            database.getBusStopDao().clear()</span>
<span id="cb39-24"><a href="#cb39-24"></a></span>
<span id="cb39-25"><a href="#cb39-25"></a>            <span class="co">// Webサービスからデータを取得します。</span></span>
<span id="cb39-26"><a href="#cb39-26"></a>            <span class="kw">val</span> <span class="va">busStopPoleJsonArray</span> = getWebServiceResultBody { webService.busstopPole(consumerKey)     } ?: return<span class="at">@thread</span></span>
<span id="cb39-27"><a href="#cb39-27"></a>            <span class="kw">val</span> <span class="va">routeJsonArray</span>       = getWebServiceResultBody { webService.busroutePattern(consumerKey) } ?: return<span class="at">@thread</span></span>
<span id="cb39-28"><a href="#cb39-28"></a></span>
<span id="cb39-29"><a href="#cb39-29"></a>            <span class="co">// BusStopとBusStopPoleを登録します。</span></span>
<span id="cb39-30"><a href="#cb39-30"></a>            <span class="cf">for</span> (busStopPoleJsonObject <span class="kw">in</span> busStopPoleJsonArray.map { it.asJsonObject }.filter { it.<span class="kw">get</span>(<span class="st">&quot;odpt:operator&quot;</span>).asString == <span class="st">&quot;odpt.Operator:Toei&quot;</span> }) {</span>
<span id="cb39-31"><a href="#cb39-31"></a>                <span class="kw">val</span> <span class="va">busStop</span> = database.getBusStopDao().getByName(busStopPoleJsonObject.<span class="kw">get</span>(<span class="st">&quot;dc:title&quot;</span>).asString) ?: run {</span>
<span id="cb39-32"><a href="#cb39-32"></a>                    BusStop(</span>
<span id="cb39-33"><a href="#cb39-33"></a>                        busStopPoleJsonObject.<span class="kw">get</span>(<span class="st">&quot;dc:title&quot;</span>).asString,</span>
<span id="cb39-34"><a href="#cb39-34"></a>                        busStopPoleJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:kana&quot;</span>)?.asString</span>
<span id="cb39-35"><a href="#cb39-35"></a>                    ).also {</span>
<span id="cb39-36"><a href="#cb39-36"></a>                        database.getBusStopDao().add(it)</span>
<span id="cb39-37"><a href="#cb39-37"></a>                    }</span>
<span id="cb39-38"><a href="#cb39-38"></a>                }</span>
<span id="cb39-39"><a href="#cb39-39"></a></span>
<span id="cb39-40"><a href="#cb39-40"></a>                BusStopPole(</span>
<span id="cb39-41"><a href="#cb39-41"></a>                    busStopPoleJsonObject.<span class="kw">get</span>(<span class="st">&quot;owl:sameAs&quot;</span>).asString,</span>
<span id="cb39-42"><a href="#cb39-42"></a>                    busStop.name</span>
<span id="cb39-43"><a href="#cb39-43"></a>                ).also {</span>
<span id="cb39-44"><a href="#cb39-44"></a>                    database.getBusStopPoleDao().add(it)</span>
<span id="cb39-45"><a href="#cb39-45"></a>                }</span>
<span id="cb39-46"><a href="#cb39-46"></a>            }</span>
<span id="cb39-47"><a href="#cb39-47"></a></span>
<span id="cb39-48"><a href="#cb39-48"></a>            <span class="co">// Routeを登録します。</span></span>
<span id="cb39-49"><a href="#cb39-49"></a>            <span class="cf">for</span> (routeJsonObject <span class="kw">in</span> routeJsonArray.map { it.asJsonObject}.filter { it.<span class="kw">get</span>(<span class="st">&quot;odpt:operator&quot;</span>).asString == <span class="st">&quot;odpt.Operator:Toei&quot;</span> }) {</span>
<span id="cb39-50"><a href="#cb39-50"></a>                <span class="kw">val</span> <span class="va">route</span> = Route(</span>
<span id="cb39-51"><a href="#cb39-51"></a>                    routeJsonObject.<span class="kw">get</span>(<span class="st">&quot;owl:sameAs&quot;</span>).asString,</span>
<span id="cb39-52"><a href="#cb39-52"></a>                    routeJsonObject.<span class="kw">get</span>(<span class="st">&quot;dc:title&quot;</span>).asString</span>
<span id="cb39-53"><a href="#cb39-53"></a>                ).also {</span>
<span id="cb39-54"><a href="#cb39-54"></a>                    database.getRouteDao().add(it)</span>
<span id="cb39-55"><a href="#cb39-55"></a>                }</span>
<span id="cb39-56"><a href="#cb39-56"></a></span>
<span id="cb39-57"><a href="#cb39-57"></a>                <span class="cf">for</span> (routeBusStopPoleJsonObject <span class="kw">in</span> routeJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:busstopPoleOrder&quot;</span>).asJsonArray.map { it.asJsonObject }) {</span>
<span id="cb39-58"><a href="#cb39-58"></a>                    RouteBusStopPole(</span>
<span id="cb39-59"><a href="#cb39-59"></a>                        route.id,</span>
<span id="cb39-60"><a href="#cb39-60"></a>                        routeBusStopPoleJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:index&quot;</span>).asInt,</span>
<span id="cb39-61"><a href="#cb39-61"></a>                        routeBusStopPoleJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:busstopPole&quot;</span>).asString</span>
<span id="cb39-62"><a href="#cb39-62"></a>                    ).also {</span>
<span id="cb39-63"><a href="#cb39-63"></a>                        it.id = database.getRouteBusStopPoleDao().add(it)</span>
<span id="cb39-64"><a href="#cb39-64"></a>                    }</span>
<span id="cb39-65"><a href="#cb39-65"></a>                }</span>
<span id="cb39-66"><a href="#cb39-66"></a>            }</span>
<span id="cb39-67"><a href="#cb39-67"></a></span>
<span id="cb39-68"><a href="#cb39-68"></a>            Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;Finish.&quot;</span>)</span>
<span id="cb39-69"><a href="#cb39-69"></a></span>
<span id="cb39-70"><a href="#cb39-70"></a>        } <span class="cf">catch</span> (e: IOException) {</span>
<span id="cb39-71"><a href="#cb39-71"></a>            Log.e(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;${e.message}&quot;</span>)</span>
<span id="cb39-72"><a href="#cb39-72"></a>        }</span>
<span id="cb39-73"><a href="#cb39-73"></a>    }</span>
<span id="cb39-74"><a href="#cb39-74"></a>}</span></code></pre></div>
<p>少しだけ、解説を。</p>
<p>データベースのインスタンス作成は、<code>Room.databaseBuilder(context!!, AppDatabase::class.java, &quot;jetbus.db&quot;).build()</code>でやっています。これで、データベースのファイルが無ければエンティティ・オブジェクトの定義に合わせて自動で作り、そのファイルを使用するデータベースが生成されます。</p>
<p>データ・アクセス・オブジェクトで定義したメソッドの実体はRoomが生成してくれますから、たとえばデータを削除しているところでは<code>database.getTimeTableDatailDao().clear()</code>のようにごく普通に呼び出せばオッケーです。</p>
<p>あと、公共交通オープンデータセンターのデータでは<code>BusStopPole</code>と<code>BusStop</code>が一つのJsonObjectになって渡ってきますので、それを分割するために少し面倒なことをしています。<code>database.getBusStopDao().getByName()</code>で<code>BusStop</code>を取得してみて、もし存在しなければ（<code>null</code>が返ってきたなら）、<code>BusStop</code>のインスタンスを生成してデータベースに追加しています。エルビス演算子はとても便利！　あと、<code>also</code>スコープ関数も。</p>
<p>実行してみます。ログを調べてみると……。</p>
<p>絵</p>
<p>はい。成功です。Room簡単ですな。</p>
<h2 id="データベースをダウンロードして正しく動いたのか確認してみる">データベースをダウンロードして、正しく動いたのか確認してみる</h2>
<p>……ごめんなさい。ログに「Finish.」という文字が出たからRoomを正しく使えたと思えってのは、あまりに乱暴でしたね。もう少しきちんと確認します。</p>
<p>スマートフォン上に生成されたデータベースのファイルは、AndroidStudioを使用してダウンロードする事ができます。Android Studioで[Device File Explorer]を開いて、data/data/com.tail_island.jetbus/databases」を開くと、その下に「jetbus.db」というファイルがあります。これ、SQLite3のファイルなんですよ。このファイルを右クリックして、[Save As...]メニューでローカルに保存します。</p>
<p>絵</p>
<p>ダウンロードしたデータベースのファイルの中を見て、正しく動作したのかを確認してみましょう。sqlite3コマンドでデータベースを開いて<code>SELECT * FROM BusStop LIMIT 10;</code>を実行して、はい、たしかにバス停が保存されています。この章の前で書いた、出発バス停名と到着バス停名から<code>Route</code>を取得するSQLも実行してみます。うん、上りか下りなのかの判別まで含めてうまく行っています。やっぱり、Room簡単ですな。</p>
<p>絵</p>
<h1 id="dagger">Dagger</h1>
<p>このあたりで少し冷静になってこれまでに作成したコードを見直してみると、なんだか、<code>SplashFragment</code>があまりに汚い……。ちょっとWebサービス呼び出してみようかなってたびに、前準備として以下のコード書くなんてやってられないですよね？</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb40-1"><a href="#cb40-1"></a><span class="kw">val</span> <span class="va">webService</span> = Retrofit.Builder().apply {</span>
<span id="cb40-2"><a href="#cb40-2"></a>    baseUrl(<span class="st">&quot;https://api.odpt.org&quot;</span>)</span>
<span id="cb40-3"><a href="#cb40-3"></a>    addConverterFactory(GsonConverterFactory.create())</span>
<span id="cb40-4"><a href="#cb40-4"></a>}.build().create(WebService::<span class="kw">class</span>.java)</span></code></pre></div>
<p>でもまぁ、この問題は<code>WebService</code>を作る関数を作成すれば解決できそうな気がします。こんな感じ。</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb41-1"><a href="#cb41-1"></a><span class="kw">fun</span> <span class="fu">createWebService</span>(): <span class="dt">WebService</span> {</span>
<span id="cb41-2"><a href="#cb41-2"></a>    <span class="kw">return</span> Retrofit.Builder().apply {</span>
<span id="cb41-3"><a href="#cb41-3"></a>        baseUrl(<span class="st">&quot;https://api.odpt.org&quot;</span>)</span>
<span id="cb41-4"><a href="#cb41-4"></a>        addConverterFactory(GsonConverterFactory.create())</span>
<span id="cb41-5"><a href="#cb41-5"></a>    }.build().create(WebService::<span class="kw">class</span>.java)</span>
<span id="cb41-6"><a href="#cb41-6"></a>}</span>
<span id="cb41-7"><a href="#cb41-7"></a></span>
<span id="cb41-8"><a href="#cb41-8"></a>createWebService().getWebServiceResultBody { ... }</span></code></pre></div>
<p>ただし<code>AppDatabase</code>、テメーはダメだ！　<code>AppDatabase</code>を生成するコードを、よく見てみましょう。</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb42-1"><a href="#cb42-1"></a><span class="kw">val</span> <span class="va">database</span> = Room.databaseBuilder(requireContext(), AppDatabase::<span class="kw">class</span>.java, &quot;jetbus.db&quot;).build()</span></code></pre></div>
<p>このコードの<code>databaseBuilder()</code>メソッドの引数の<code>requireContext()</code>がダメ。だって、<code>requireContext()</code>は<code>Fragment</code>のメソッドなんですよ。だから、<code>createAppDatabase()</code>関数を作る場合は、その引数に<code>Context</code>を追加してあげなければなりません。そうすると、この関数は<code>Context</code>を提供可能な<code>Fragment</code>や<code>Activity</code>等からしか呼び出せなくなっちゃう。だから<code>AppDatabase</code>を使う処理は<code>Fragment</code>や<code>Activity</code>に書くしかなくて、その結果として<code>Fragment</code>や<code>Activity</code>に処理のすべてが埋め込まれた汚いコードが出来上がっちゃう……。</p>
<p>うん、Dependency InjectionツールのDaggerを使ってどうにかしましょう！</p>
<h2 id="dependency-injection">Dependency Injection</h2>
<p>Dependency Injection（依存性の注入。DIと省略される）はちょっと分かりづらい技術なので、具体的なコードで説明しましょう。<code>ComponentA</code>が<code>ComponentB</code>に依存している（使用している）とします。</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb43-1"><a href="#cb43-1"></a><span class="kw">class</span> ComponentA {</span>
<span id="cb43-2"><a href="#cb43-2"></a>    <span class="kw">private</span> componentB = new ComponentB()</span>
<span id="cb43-3"><a href="#cb43-3"></a></span>
<span id="cb43-4"><a href="#cb43-4"></a>    <span class="kw">fun</span> <span class="fu">doSomething</span>() {</span>
<span id="cb43-5"><a href="#cb43-5"></a>        ...</span>
<span id="cb43-6"><a href="#cb43-6"></a>    }</span>
<span id="cb43-7"><a href="#cb43-7"></a>}</span></code></pre></div>
<p>このコードの<code>ComponentB</code>が、実はインターネットにあるサービスを呼び出すものでとても遅い場合を考えてみてください。そうなると、単体テストがとても遅くなっちゃう。だから……</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb44-1"><a href="#cb44-1"></a><span class="kw">interface</span> ComponentB {  <span class="co">// classからinterfaceにします</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>    ...</span>
<span id="cb44-3"><a href="#cb44-3"></a>}</span>
<span id="cb44-4"><a href="#cb44-4"></a></span>
<span id="cb44-5"><a href="#cb44-5"></a><span class="kw">class</span> ComponentA(<span class="va">componentB</span>: <span class="dt">ComponentB</span>) {</span>
<span id="cb44-6"><a href="#cb44-6"></a>    <span class="kw">fun</span> <span class="fu">doSomething</span>() {</span>
<span id="cb44-7"><a href="#cb44-7"></a>        ...</span>
<span id="cb44-8"><a href="#cb44-8"></a>    }</span>
<span id="cb44-9"><a href="#cb44-9"></a>}</span>
<span id="cb44-10"><a href="#cb44-10"></a></span>
<span id="cb44-11"><a href="#cb44-11"></a>ComponentA(MockComponentB()).doSomething()  <span class="co">// 単体テストではモックを使用して呼び出します</span></span></code></pre></div>
<p>コードをこんな感じに変更して、単体テスト用の<code>ComponentB</code>のモックを用意して、それを使って単体テストします。使用するオブジェクトを実行時に設定することで、オブジェクトを自由に組み合わせられるようにしているわけですな。で、この組み合わせる部分を自動化したり柔軟にしてくれるのが、Daggerを始めとするDependency Injectionツールなんです。</p>
<p>ただ、個人的には、Dependency Injectionはあまり好きではありません。だって、インターフェイスを書くのが面倒なんだもん。動的型付けのプログラミング言語（実行時に型チェックされる言語。JavaScriptとか私が大好きなClojureとか）では<code>interface</code>を書かなくてよいから使うし、関数型プログラミング言語（Haskellとか私が愛してやまないClojureとか）なら関数を組み合わせる関数合成を当たり前に使うけど、静的型付けのプログラミング言語（JavaとかKotlinとか。C++は静的型付だけど<code>template</code>を使えばコード上では動的に型付けできるから別）でのDependency Injectionはベネフィットよりもコストが大きいと感じちゃう。</p>
<h2 id="dependency-injectionツールを敢えて誤用する">Dependency Injectionツールを敢えて誤用する</h2>
<p>Dependency Injectionのメリットは、オブジェクト間の結合度が減ること。オブジェクト間の結合を変更可能にする技術は、静的型付けのオブジェクト指向プログラミング言語ではインターフェイス。でもインターフェイスを書くのは面倒なので、Dependency Injectionは諦めてオブジェクト間の結合度が増えるのは我慢する。でも、Dependency InjectionツールであるDaggerは使う。これがここまでの私の主張。……無茶苦茶ですがな。</p>
<p>なんでこんな無茶な主張になるのかというと、私はただ単に属性に値を設定する便利ツールとしてDaggerを使っているからです。Adnroidアプリの場合、前述したRoomの<code>Database</code>のように<code>Context</code>を引数にしないと実現できない処理が多数存在します。これを関数の引数として表現すると呼び出せる場所が限られてしまってよくない。属性にしてコンストラクタで設定する方式も、<code>Fragment</code>や<code>Activity</code>の生成はAndroidがやるので手を出せないから実現不能です。でも、Daggerを使えば属性を設定できるんですよ。<code>Context</code>をDaggerの中で引き回せば、<code>Fragment</code>や<code>Activity</code>以外でも<code>Context</code>を必要とする属性の設定をやりたい放題にできます。</p>
<p>もちろん、インターフェイスを書いていませんから、オブジェクト間の結合度は大きいままです。Dependency Injectionというのは実はデザイン・パターンで、Dependency Injectionツールはそれを実現する手段の一つ。私の意識が高ければツールへの依存性も減らして独自にDependency Injectionパターンを実装するでしょうし、道具が作成された目的を無視して使用するなんてことは絶対にやらないのでしょうけど、残念なことに私は底辺なのでDependency Injectionツールの誤用くらい全然オッケー。苦情は、結合度が異常に高いAndroidのAPIを最初に作った人に言ってください。</p>
<p>ただね、Daggerを使っておけば、本来のDependency Injectionパターンが必要になったときに取り入れやすいと思うんですよ。意識が高い人は、どうかその前準備をしているんだと考えてください。</p>
<h2 id="daggerの組み込み">Daggerの組み込み</h2>
<p>まずは、Daggerを組み込むためにbuild.gradleを変更してください。</p>
<pre class="gradle"><code>dependencies {
    ...

    kapt &#39;androidx.room:room-compiler:2.2.4&#39;
    kapt &#39;com.google.dagger:dagger-compiler:2.24&#39;  // 追加

    implementation fileTree(dir: &#39;libs&#39;, include: [&#39;*.jar&#39;])

    ...

    implementation &#39;androidx.room:room-ktx:2.2.4&#39;
    implementation &#39;com.google.dagger:dagger:2.24&#39;  // 追加
    implementation &#39;com.squareup.retrofit2:retrofit:2.6.1&#39;

    ...
}</code></pre>
<p>アノテーションによるコード生成が必要ですので、<code>kapt</code>を忘れないように気をつけてください。</p>
<h2 id="inject">Inject</h2>
<p>まずは、設定したい属性を作成して、<code>@Inject</code>アノテーションを追加します。Daggerは属性の型で設定するインスタンスを決定するのですけど、それでは足りない場合（文字列型の<code>consumerKey</code>に文字列を設定するとか）は<code>@field:Named()</code>アノテーションを使用します。具体的にはこんな感じ。</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb46-1"><a href="#cb46-1"></a><span class="kw">class</span> SplashFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb46-2"><a href="#cb46-2"></a>    <span class="at">@Inject</span> <span class="at">@field</span>:Named(<span class="st">&quot;consumerKey&quot;</span>) lateinit <span class="kw">var</span> <span class="va">consumerKey</span>: <span class="kw">String</span>  <span class="co">// 追加</span></span>
<span id="cb46-3"><a href="#cb46-3"></a>    <span class="at">@Inject</span> lateinit <span class="kw">var</span> <span class="va">webService</span>: WebService                           <span class="co">// 追加</span></span>
<span id="cb46-4"><a href="#cb46-4"></a>    <span class="at">@Inject</span> lateinit <span class="kw">var</span> <span class="va">database</span>: AppDatabase                            <span class="co">// 追加</span></span>
<span id="cb46-5"><a href="#cb46-5"></a></span>
<span id="cb46-6"><a href="#cb46-6"></a>    ...</span>
<span id="cb46-7"><a href="#cb46-7"></a></span>
<span id="cb46-8"><a href="#cb46-8"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onStart</span>() {</span>
<span id="cb46-9"><a href="#cb46-9"></a>        <span class="kw">super</span>.onStart()</span>
<span id="cb46-10"><a href="#cb46-10"></a></span>
<span id="cb46-11"><a href="#cb46-11"></a>        <span class="co">// 不要になるので削除</span></span>
<span id="cb46-12"><a href="#cb46-12"></a>        <span class="co">// val consumerKey = getString(R.string.consumerKey)</span></span>
<span id="cb46-13"><a href="#cb46-13"></a>        <span class="co">// val webService = Retrofit.Builder().apply {</span></span>
<span id="cb46-14"><a href="#cb46-14"></a>        <span class="co">//     baseUrl(&quot;https://api.odpt.org&quot;)</span></span>
<span id="cb46-15"><a href="#cb46-15"></a>        <span class="co">//     addConverterFactory(GsonConverterFactory.create())</span></span>
<span id="cb46-16"><a href="#cb46-16"></a>        <span class="co">// }.build().create(WebService::class.java)</span></span>
<span id="cb46-17"><a href="#cb46-17"></a>        <span class="co">// val database = Room.databaseBuilder(requireContext(), AppDatabase::class.java, &quot;jetbus.db&quot;).build()</span></span>
<span id="cb46-18"><a href="#cb46-18"></a></span>
<span id="cb46-19"><a href="#cb46-19"></a>        thread {</span>
<span id="cb46-20"><a href="#cb46-20"></a>            <span class="cf">try</span> {</span>
<span id="cb46-21"><a href="#cb46-21"></a>                Log.d(<span class="st">&quot;SplashFragment&quot;</span>, <span class="st">&quot;Start.&quot;</span>)</span>
<span id="cb46-22"><a href="#cb46-22"></a></span>
<span id="cb46-23"><a href="#cb46-23"></a>                ...</span></code></pre></div>
<h2 id="appmodule">AppModule</h2>
<p>次に、注入するオブジェクトを生成するクラスを生成します。名前は<code>AppModule</code>にしましょう。<code>@Module</code>アノテーションを付加したクラスを作成して、<code>@Provides</code>アノテーションを付加した注入するオブジェクトを生成するメソッドを作成します。具体的にはこんな感じ。</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb47-1"><a href="#cb47-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb47-2"><a href="#cb47-2"></a></span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="kw">import</span> <span class="im">android.app.Application</span></span>
<span id="cb47-4"><a href="#cb47-4"></a><span class="kw">import</span> <span class="im">android.content.Context</span></span>
<span id="cb47-5"><a href="#cb47-5"></a><span class="kw">import</span> <span class="im">androidx.room.Room</span></span>
<span id="cb47-6"><a href="#cb47-6"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.AppDatabase</span></span>
<span id="cb47-7"><a href="#cb47-7"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.WebService</span></span>
<span id="cb47-8"><a href="#cb47-8"></a><span class="kw">import</span> <span class="im">dagger.Module</span></span>
<span id="cb47-9"><a href="#cb47-9"></a><span class="kw">import</span> <span class="im">dagger.Provides</span></span>
<span id="cb47-10"><a href="#cb47-10"></a><span class="kw">import</span> <span class="im">okhttp3.OkHttpClient</span></span>
<span id="cb47-11"><a href="#cb47-11"></a><span class="kw">import</span> <span class="im">retrofit2.Retrofit</span></span>
<span id="cb47-12"><a href="#cb47-12"></a><span class="kw">import</span> <span class="im">retrofit2.converter.gson.GsonConverterFactory</span></span>
<span id="cb47-13"><a href="#cb47-13"></a><span class="kw">import</span> <span class="im">java.util.concurrent.TimeUnit</span></span>
<span id="cb47-14"><a href="#cb47-14"></a><span class="kw">import</span> <span class="im">javax.inject.Named</span></span>
<span id="cb47-15"><a href="#cb47-15"></a><span class="kw">import</span> <span class="im">javax.inject.Singleton</span></span>
<span id="cb47-16"><a href="#cb47-16"></a></span>
<span id="cb47-17"><a href="#cb47-17"></a><span class="at">@Module</span></span>
<span id="cb47-18"><a href="#cb47-18"></a><span class="kw">class</span> AppModule(<span class="kw">private</span> <span class="kw">val</span> <span class="va">application</span>: <span class="dt">Application</span>) {</span>
<span id="cb47-19"><a href="#cb47-19"></a>    <span class="at">@Provides</span></span>
<span id="cb47-20"><a href="#cb47-20"></a>    <span class="at">@Singleton</span></span>
<span id="cb47-21"><a href="#cb47-21"></a>    <span class="kw">fun</span> <span class="fu">provideContext</span>() = application <span class="kw">as</span> Context</span>
<span id="cb47-22"><a href="#cb47-22"></a></span>
<span id="cb47-23"><a href="#cb47-23"></a>    <span class="at">@Provides</span></span>
<span id="cb47-24"><a href="#cb47-24"></a>    <span class="at">@Singleton</span></span>
<span id="cb47-25"><a href="#cb47-25"></a>    <span class="at">@Named</span>(<span class="st">&quot;consumerKey&quot;</span>)</span>
<span id="cb47-26"><a href="#cb47-26"></a>    <span class="kw">fun</span> <span class="fu">provideConsumerKey</span>(<span class="va">context</span>: <span class="dt">Context</span>) = context.getString(R.string.consumerKey)</span>
<span id="cb47-27"><a href="#cb47-27"></a></span>
<span id="cb47-28"><a href="#cb47-28"></a>    <span class="at">@Provides</span></span>
<span id="cb47-29"><a href="#cb47-29"></a>    <span class="at">@Singleton</span></span>
<span id="cb47-30"><a href="#cb47-30"></a>    <span class="kw">fun</span> <span class="fu">provideDatabase</span>(<span class="va">context</span>: <span class="dt">Context</span>) = Room.databaseBuilder(context, AppDatabase::<span class="kw">class</span>.java, &quot;jetbus.db&quot;).build()</span>
<span id="cb47-31"><a href="#cb47-31"></a></span>
<span id="cb47-32"><a href="#cb47-32"></a>    @Provides</span>
<span id="cb47-33"><a href="#cb47-33"></a>    @Singleton</span>
<span id="cb47-34"><a href="#cb47-34"></a>    <span class="kw">fun</span> provideWebService() = Retrofit.Builder().apply {</span>
<span id="cb47-35"><a href="#cb47-35"></a>        baseUrl(<span class="st">&quot;https://api.odpt.org&quot;</span>)</span>
<span id="cb47-36"><a href="#cb47-36"></a>        client(</span>
<span id="cb47-37"><a href="#cb47-37"></a>            OkHttpClient.Builder().apply {</span>
<span id="cb47-38"><a href="#cb47-38"></a>                connectTimeout(<span class="dv">180</span>, TimeUnit.SECONDS)</span>
<span id="cb47-39"><a href="#cb47-39"></a>                readTimeout(<span class="dv">180</span>, TimeUnit.SECONDS)</span>
<span id="cb47-40"><a href="#cb47-40"></a>                writeTimeout(<span class="dv">180</span>, TimeUnit.SECONDS)</span>
<span id="cb47-41"><a href="#cb47-41"></a>            }.build()</span>
<span id="cb47-42"><a href="#cb47-42"></a>        )</span>
<span id="cb47-43"><a href="#cb47-43"></a>        addConverterFactory(GsonConverterFactory.create())</span>
<span id="cb47-44"><a href="#cb47-44"></a>    }.build().create(WebService::<span class="kw">class</span>.java)</span>
<span id="cb47-45"><a href="#cb47-45"></a>}</span></code></pre></div>
<p>上のコードで使用している<code>@Singleton</code>は、注入するオブジェクトのインスタンスを1つだけにしたい場合に付加します。今回はたまたま全部についていますけど、異なるインスタンスを使用したい場合は外してください。<code>@Named</code>アノテーションは、何を提供すればよいのかが型だけでは判別できない場合向け。<code>@Inject</code>のときの<code>@field:Named</code>の対になっているわけですな。</p>
<p>で、上のコードで面白いのは、例えば<code>provideConsumerKey()</code>メソッドの引数の<code>context: Context</code>です。このコードだけを見るとなんだよDagger使っても結局<code>Context</code>を引数にしなければならないのかよと感じるんですけど、Daggerはすぐ上の<code>provideContext()</code>メソッドが<code>Context</code>を提供してくれることを知っています。だから、<code>consumerKey</code>を提供するために<code>provideConsumerKey()</code>メソッドを実行するときには、Daggerが自動的に<code>provideContext()</code>を実行して引数を準備してくれるんです（さらにすごいことに、Lifecycleのところで使用しますけど、引数のすべてを<code>@Provides</code>できるコンストラクタを持っているクラスなら何も書かなくても提供できます）。というわけで、もうこれで<code>Context</code>をどうやって取得しよう問題はクリア！</p>
<p>まぁ、<code>AppModule</code>生成の引数に<code>Application</code>が含まれているので、問題を先送りしただけなんだけどな。</p>
<h2 id="app">App</h2>
<p>というわけで、<code>Application</code>を引数にして<code>AppModule</code>を生成する処理を追加してみましょう。そのために、<code>Application</code>を継承した<code>App</code>クラスを作成します。</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb48-1"><a href="#cb48-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb48-2"><a href="#cb48-2"></a></span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="kw">import</span> <span class="im">android.app.Application</span></span>
<span id="cb48-4"><a href="#cb48-4"></a></span>
<span id="cb48-5"><a href="#cb48-5"></a><span class="kw">class</span> App: <span class="dt">Application</span>() {</span>
<span id="cb48-6"><a href="#cb48-6"></a>    <span class="co">// DaggerのComponentを取得するためのプロパティ</span></span>
<span id="cb48-7"><a href="#cb48-7"></a>    lateinit <span class="kw">var</span> <span class="va">component</span>: AppComponent</span>
<span id="cb48-8"><a href="#cb48-8"></a>        <span class="kw">private</span> <span class="kw">set</span></span>
<span id="cb48-9"><a href="#cb48-9"></a></span>
<span id="cb48-10"><a href="#cb48-10"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreate</span>() {</span>
<span id="cb48-11"><a href="#cb48-11"></a>        <span class="kw">super</span>.onCreate()</span>
<span id="cb48-12"><a href="#cb48-12"></a></span>
<span id="cb48-13"><a href="#cb48-13"></a>        <span class="co">// 先程作成したAppModuleを使用して、DaggerのComponentを作成します</span></span>
<span id="cb48-14"><a href="#cb48-14"></a>        component = DaggerAppComponent.builder().apply {</span>
<span id="cb48-15"><a href="#cb48-15"></a>            appModule(AppModule(this<span class="at">@App</span>))</span>
<span id="cb48-16"><a href="#cb48-16"></a>        }.build()</span>
<span id="cb48-17"><a href="#cb48-17"></a>    }</span>
<span id="cb48-18"><a href="#cb48-18"></a>}</span></code></pre></div>
<p>そのうえで、作成した<code>App</code>が使用されるようにAndroidManifest.xmlを修正します。</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb49-1"><a href="#cb49-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb49-2"><a href="#cb49-2"></a><span class="kw">&lt;manifest</span></span>
<span id="cb49-3"><a href="#cb49-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb49-4"><a href="#cb49-4"></a><span class="ot">    package=</span><span class="st">&quot;com.tail_island.jetbus&quot;</span><span class="kw">&gt;</span></span>
<span id="cb49-5"><a href="#cb49-5"></a></span>
<span id="cb49-6"><a href="#cb49-6"></a>    <span class="kw">&lt;uses-permission</span><span class="ot"> android:name=</span><span class="st">&quot;android.permission.INTERNET&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb49-7"><a href="#cb49-7"></a></span>
<span id="cb49-8"><a href="#cb49-8"></a>    <span class="kw">&lt;application</span></span>
<span id="cb49-9"><a href="#cb49-9"></a><span class="ot">        android:allowBackup=</span><span class="st">&quot;true&quot;</span></span>
<span id="cb49-10"><a href="#cb49-10"></a><span class="ot">        android:icon=</span><span class="st">&quot;@mipmap/ic_launcher&quot;</span></span>
<span id="cb49-11"><a href="#cb49-11"></a><span class="ot">        android:label=</span><span class="st">&quot;@string/app_name&quot;</span></span>
<span id="cb49-12"><a href="#cb49-12"></a><span class="ot">        android:name=</span><span class="st">&quot;.App&quot;</span>  <span class="er">&lt;!--</span> <span class="er">追加</span> <span class="er">--</span><span class="kw">&gt;</span></span>
<span id="cb49-13"><a href="#cb49-13"></a>        android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;</span>
<span id="cb49-14"><a href="#cb49-14"></a>        android:supportsRtl=&quot;true&quot;</span>
<span id="cb49-15"><a href="#cb49-15"></a>        android:theme=&quot;@style/AppTheme&quot;&gt;</span>
<span id="cb49-16"><a href="#cb49-16"></a></span>
<span id="cb49-17"><a href="#cb49-17"></a>        <span class="kw">&lt;activity</span><span class="ot"> android:name=</span><span class="st">&quot;.MainActivity&quot;</span><span class="ot"> android:theme=</span><span class="st">&quot;@style/AppTheme.NoActionBar&quot;</span><span class="kw">&gt;</span></span>
<span id="cb49-18"><a href="#cb49-18"></a>            <span class="kw">&lt;intent-filter&gt;</span></span>
<span id="cb49-19"><a href="#cb49-19"></a>                <span class="kw">&lt;action</span><span class="ot"> android:name=</span><span class="st">&quot;android.intent.action.MAIN&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb49-20"><a href="#cb49-20"></a></span>
<span id="cb49-21"><a href="#cb49-21"></a>                <span class="kw">&lt;category</span><span class="ot"> android:name=</span><span class="st">&quot;android.intent.category.LAUNCHER&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb49-22"><a href="#cb49-22"></a>            <span class="kw">&lt;/intent-filter&gt;</span></span>
<span id="cb49-23"><a href="#cb49-23"></a>        <span class="kw">&lt;/activity&gt;</span></span>
<span id="cb49-24"><a href="#cb49-24"></a></span>
<span id="cb49-25"><a href="#cb49-25"></a>    <span class="kw">&lt;/application&gt;</span></span>
<span id="cb49-26"><a href="#cb49-26"></a></span>
<span id="cb49-27"><a href="#cb49-27"></a><span class="kw">&lt;/manifest&gt;</span></span></code></pre></div>
<p>修正は、<code>android:name=&quot;.App&quot;</code>属性の追加だけ。これで、標準の<code>Application</code>ではなく、先程作成した<code>App</code>が使用されるようになります。</p>
<h2 id="appcomponent">AppComponent</h2>
<p>でも、先程の<code>App</code>のコード中にでてきたDaggerの<code>Component</code>っていったい何なんでしょ？　このDaggerの<code>Component</code>は、<code>Module</code>から取得したオブジェクトのインスタンスを注入するオブジェクトで、<code>@Component</code>アノテーションを付加した<code>interface</code>を定義するだけで自動生成されます。この<code>inreface</code>を定義しましょう。</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb50-1"><a href="#cb50-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb50-2"><a href="#cb50-2"></a></span>
<span id="cb50-3"><a href="#cb50-3"></a><span class="kw">import</span> <span class="im">dagger.Component</span></span>
<span id="cb50-4"><a href="#cb50-4"></a><span class="kw">import</span> <span class="im">javax.inject.Singleton</span></span>
<span id="cb50-5"><a href="#cb50-5"></a></span>
<span id="cb50-6"><a href="#cb50-6"></a><span class="at">@Singleton</span></span>
<span id="cb50-7"><a href="#cb50-7"></a><span class="at">@Component</span>(modules = [AppModule::<span class="kw">class</span>])</span>
<span id="cb50-8"><a href="#cb50-8"></a><span class="kw">interface</span> AppComponent {</span>
<span id="cb50-9"><a href="#cb50-9"></a>    <span class="kw">fun</span> <span class="fu">inject</span>(<span class="va">splashFragment</span>: <span class="dt">SplashFragment</span>)</span>
<span id="cb50-10"><a href="#cb50-10"></a>}</span></code></pre></div>
<p><code>AppComponent</code>という名前で<code>interface</code>を作ると、Daggerが<code>DaggerAppComponent</code>を自動生成してくれます。先程の<code>App</code>の中でDaggerのドキュメントの中に存在しない<code>DaggerAppComponent</code>を使えていたのは、自動生成されるからなんですね。先程の<code>App</code>のコードを書いているときに<code>DaggerAppComponent</code>がないというエラーがでて不安になった方、ごめんなさい。<code>interface AppCompoent</code>を作成して一度ビルドすれば、<code>DaggerAppComponent</code>がないというエラーは解消されます。</p>
<p>あと、今回は<code>Application</code>経由でDaggerの<code>Component</code>を取得するので（その結果として1つだけになるから）なくてもよいのですけど、Daggerの<code>Component</code>は1つであって欲しいので念の為に<code>@Singleton</code>アノテーションを付加しておきます。宣言するメソッドは、依存性を注入する対象を引数にしたメソッドだけ。これで、Daggerを使うための準備は完了です。面倒な作業ですけど、機械作業なので難しくはないから我慢してください。</p>
<h2 id="依存性を注入する">依存性を注入する</h2>
<p>準備が完了したので、<code>SplashFragment</code>に依存性を注入しましょう。SplashFragment.ktを開いて、以下の修正をします。</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb51-1"><a href="#cb51-1"></a><span class="kw">class</span> SplashFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb51-2"><a href="#cb51-2"></a>    ...</span>
<span id="cb51-3"><a href="#cb51-3"></a></span>
<span id="cb51-4"><a href="#cb51-4"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateView</span>(<span class="va">inflater</span>: <span class="dt">LayoutInflater</span>, <span class="va">container</span>: <span class="dt">ViewGroup?</span>, <span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>): <span class="dt">View?</span> {</span>
<span id="cb51-5"><a href="#cb51-5"></a>        <span class="co">// Daggerを使用して、依存性を注入します</span></span>
<span id="cb51-6"><a href="#cb51-6"></a>        (requireActivity().application <span class="kw">as</span> App).component.inject(<span class="kw">this</span>)  <span class="co">// 追加</span></span>
<span id="cb51-7"><a href="#cb51-7"></a></span>
<span id="cb51-8"><a href="#cb51-8"></a>        <span class="kw">return</span> FragmentSplashBinding.inflate(inflater, container, <span class="kw">false</span>).apply {</span>
<span id="cb51-9"><a href="#cb51-9"></a>            bookmarksButton.setOnClickListener {</span>
<span id="cb51-10"><a href="#cb51-10"></a>                findNavController().navigate(SplashFragmentDirections.splashFragmentToBookmarksFragment())</span>
<span id="cb51-11"><a href="#cb51-11"></a>            }</span>
<span id="cb51-12"><a href="#cb51-12"></a>        }.root</span>
<span id="cb51-13"><a href="#cb51-13"></a>    }</span></code></pre></div>
<p><code>requireActivity()</code>で取得した<code>Activity</code>を経由して<code>Application</code>を取得して、そこからDaggerの<code>Component</code>を取得して自分自身を引数に<code>inject()</code>します……って、これ、結局<code>Context</code>の代わりに<code>Application</code>が必要になっただけじゃん！　Daggerで楽するために単純作業に耐えてきたのに、ベネフィットは複数の属性を1行で設定できるようになっただけ？</p>
<p>こんなの絶対おかしいよ……とどこぞの魔法少女のように絶望したかもしれませんけど、安心してください、幸いなことにDaggerには救いがあります。どう救われるのかは、次に説明するLifecycleの中で！</p>
<h1 id="lifecycle">Lifecycle</h1>
<p>と、かなり強引な引きで始めてみたLifecycleなのですけど、ごめんなさい、やたらと書くことが多いので、Daggerの世界が救われるのはこの章の半ばまでお預けです。</p>
<p>考えてみれば、Androidアプリの開発が大変だった一番大きな理由は、本校の最初の方で述べたライフサイクルの管理が大変なためなんです。やたらと複雑な<code>Activity</code>のライフサイクルから、もうとにかく逃げたい。そのために状態をViewModelに分離したというわけ。なので、ViewModelとはなんぞやというアーキテクチャーの話をしなければなりません。あと、<code>Activity</code>や<code>Fragment</code>の状態の変化に合わせて正しく動作するには、データの変更を監視する方式が定まっていないとダメ。そうでなければ、状態の変化に対応するための制御を入れられないですもんね。だから、その手段であるLiveDataについての説明も必要です。で、LiveDataは前述したRoomといい感じに協調して動作するように作られているのでデータベースの話まで戻らなくちゃなりません。Roomで不足しているように感じた機能が、LiveDataと組み合わせると不足していたのではなくて無いことこそが正しいとなるのでとても面白いですよ。</p>
<p>覚悟してください。この章はとても長いですよ……。</p>
<h2 id="mvvmmodel-view-viewmodelアーキテクチャとは">MVVM（Model-View-ViewModel）アーキテクチャとは？</h2>
<p>Android Jetpackでは、MVVMアーキテクチャを使うことが推奨されています。このMVVMアーキテクチャを理解するには、その前段であるMVC（Model-View-Controller）アーキテクチャの知識があると楽。しかも、Android JetpackのMVVMアーキテクチャは、普通のMVVMアーキテクチャとは少し違っていたりします。</p>
<p>というわけで、MVCアーキテクチャ、MVVMアーキテクチャ、Android JetpackのMVVMアーキテクチャの順に説明させてください。</p>
<h3 id="mvcmodel-view-controllerアーキテクチャ">MVC（Model-View-Controller）アーキテクチャ</h3>
<p>大昔にゼロックス社のパロアルト研究所が開発したSmalltalkという伝説的なプログラミング言語があって（今もあって熱烈なファンがいるけど）、このSmalltalkはパロアルト研究所が開発したAltoというコンピューターのOS（Operating System）でした。プログラミング言語がOSなんておかしいと思ってしまった人は、電源を入れるとMSX-BASICのインタープリターが起動するMSXでコンピューターを始めた私に謝ってください。特定のプログラミング言語を動かすためのコンピューターって、大昔にはけっこうあったんですよ。</p>
<p>で、このAltoってのは当時にしてはものすごく先進的なコンピューターで、マウスがついていてGUI（Graphical User Interface）を持っていました。もちろん世界初です。この世界初のGUIをどうにかしていい感じに開発できないかなぁと考えて作られたのが、MVCアーキテクチャなんです。</p>
<p>絵</p>
<p>Controllerは入力機器（マウスとかキーボードとか）からの入力を監視し、マウス・クリックとかキーボードのAが押されたとかのイベントをもとに、Modelというデータとデータ操作の手続きを管理するオブジェクトにメッセージを送り（メソッドを呼び出し）ます。Modelのデータが変更されたことはViewに通知され（Observerパターン）、通知を受け取ったViewは自分自身を置き換えて出力する。以上がMVCアーキテクチャなんです。</p>
<p>MVCアーキテクチャには良いところもあったのでしょうけど、GUIが複雑になってくると、GUIの入力と出力を分けるのは無理がある（たとえばボタンがタップされたときのアニメーションを、ControllerとModel経由でやるのは無駄が多すぎる）ということになりました。だから、Androidアプリ開発ではControllerは分割されていません。</p>
<p>ちなみに、このViewとControllerが一体化した場合のアーキテクチャがDocument-Viewアーキテクチャだったりします。代表例はMFC（Microsoft Foundation Classes）、懐かしいなぁ。</p>
<p>ただ、世の中には用語を適当に使う人たちがいるので、Webアプリケーションの開発でもMVCアーキテクチャという言葉が使われるようになってしまったんですよ……。</p>
<p>WebアプリケーションのMVCアーキテクチャはSmalltalkのMVCとは<em>無関係</em>で、一般的にModelはO/Rマッピング・ツールでマッピングされたレコードを表現するオブジェクトです（もちろん普通のクラスが含まれていても構いません）。Controllerはリクエストを受け取ってModelを更新/取得してViewが必要とするデータを用意し、ViewはControllerから渡されたデータをHTMLに変換します。これがWebアプリケーションの場合のMVCアーキテクチャなんですけど、勝手に名乗っているだけな上に無関係なので、今回はこのMVCアーキテクチャは忘れてください。</p>
<h3 id="mvvmmodel-view-viewmodelアーキテクチャ">MVVM（Model-View-ViewModel）アーキテクチャ</h3>
<p>MVVMアーキテクチャというのは、.NET Framework 3.0のWPF（Windows Presentation Foundation）やSilverlightのために考案されたアーキテクチャです。理屈の上ではModelとViewだけで良さそうなのですけど、WPFやSilverlightではXAMLというViewをXMLで定義する言語を持っていて、この言語はとても高機能で素晴らしいのですけど、XAMLだけでViewを作成した場合は、Model側にViewのためのコードを書く必要がありました。これではModelとViewに分割した意味がありませんから、間にViewModelを挟んで、Model-View-ViewModelとなりました。MVVMアーキテクチャでは、メソッドの呼び出しは片方向（View→ViewModel→Model）だけで、逆の方向は変更の通知で情報を伝えることになっています（ModelとViewModelの間は返り値でもOK）。</p>
<p>絵</p>
<p>さて、ViewをレイアウトのXMLとソース・コードの合わせ技で実装するAndroidアプリ開発ではViewModelは不要に感じられるのですけど、AndroidのViewである<code>Activity</code>や<code>Fragment</code>には状態を持てないという別の制約がありました。このViewの状態を管理するために、ViewModelを使用するというわけ。必要に迫られて仕方なく、という感じのアーキテクチャなんですな。</p>
<h3 id="android-jetpackでのmodel-view-viewmodelアーキテクチャ">Android JetpackでのModel-View-ViewModelアーキテクチャ</h3>
<p>Android Jetpackでは、もう一つ層を追加することを提案しています。それがRepositoryです。</p>
<p>絵</p>
<p>Androidが動作するスマートフォンやタブレット、ウェアラブル・デバイスは、インターネットとの親和性が高いデバイスです。だから、我々が作成するアプリもインターネットと頻繁に通信する可能性や高い。しかもローカルのファイルやデータベースだって使用するわけで、だから、モデルはWebサービスに基づく場合とデータベースやファイルに基づく場合がありえます。これらがバラバラのままだと管理が大変になってしまうので、Repositoryという層を追加してViewModelはRepositoryだけに依存しましょうという感じ。</p>
<p>で、本来のMVVMのModelはビジネス・ロジックを含む分厚い層で、Android Jetpackのドキュメントでも図だけはそんな感じに書いてあるのですけど、実際としては、ただのRoomによるDAO（Data Access Object）とEntity、Retrofit2によるWebサービスになります。だって、ModelというのはReposirotyでラップできるようなレベルなんですしね。後述するLiveDataとRoomを組み合わせれば、データベースの変更がViewModelに通知されて楽ちんだし。結果としてViewModelは少し大きくなるけど、Android JetpackだとViewModel上にロジックを書くのがやたらと楽だしね。</p>
<p>MVVMアーキテクチャ原理派の方々はこんなやり方は認めないのでしょうけど、楽にコードを書けるのだから私的には全然オッケー。</p>
<h2 id="livedata">LiveData</h2>
<p>というわけで長いMVVMアーキテクチャの説明が終わったのでさっそくViewModelを作る……前に、MVVMアーキテクチャではViewModelからViewへの情報の伝達は通知で実現されることになっていたことを思い出してください。</p>
<p>しかも、考えたくもないしLiveDataを使えば考える必要はほとんどなくなるのですけど、<code>Activity</code>や<code>Fragment</code>は複雑なライフサイクルを持っているので、単純にObserverパターンを使うと通知が来たときにはすでに<code>Activity</code>や<code>Fragment</code>が破棄されていて処理を実行したら即クラッシュなんて可能性もあるんですよ。</p>
<p>これらの課題を、LiveDataでサクサク解決しちゃいましょう。</p>
<h3 id="mutablelivedata"><code>MutableLiveData</code></h3>
<p>と思ったのですけど、さて、困りました。LiveDataのオブジェクトはViewModelのプロパティとするのが普通なのですけれど、まだViewModelの作り方を説明できていません……。とりあえずは、<code>Fragment</code>から参照できて<code>Activity</code>や<code>Fragment</code>よりも生存期間が長い<code>App</code>に置くことにしましょう。出発バス停の名前を表現する<code>MutableLiveData</code>を作成します。</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb52-1"><a href="#cb52-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb52-2"><a href="#cb52-2"></a></span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="kw">import</span> <span class="im">android.app.Application</span></span>
<span id="cb52-4"><a href="#cb52-4"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.MutableLiveData</span></span>
<span id="cb52-5"><a href="#cb52-5"></a></span>
<span id="cb52-6"><a href="#cb52-6"></a><span class="kw">class</span> App: <span class="dt">Application</span>() {</span>
<span id="cb52-7"><a href="#cb52-7"></a>    lateinit <span class="kw">var</span> <span class="va">component</span>: AppComponent</span>
<span id="cb52-8"><a href="#cb52-8"></a>        <span class="kw">private</span> <span class="kw">set</span></span>
<span id="cb52-9"><a href="#cb52-9"></a></span>
<span id="cb52-10"><a href="#cb52-10"></a>    <span class="kw">val</span> <span class="va">departureBusStopName</span> = MutableLiveData&lt;<span class="kw">String</span>&gt;()</span>
<span id="cb52-11"><a href="#cb52-11"></a></span>
<span id="cb52-12"><a href="#cb52-12"></a>    ...</span></code></pre></div>
<p><code>MutableLiveData</code>が作成できましたので、監視してみましょう。バス接近情報を表示する<code>BusApproachesFragment</code>では確実に出発バス停の情報が必要になるでしょうから、<code>BusApproachesFragment</code>に配置してみます。まずはfragment_bus_approaches.xmlの変更。</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb53-1"><a href="#cb53-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb53-2"><a href="#cb53-2"></a><span class="kw">&lt;layout</span></span>
<span id="cb53-3"><a href="#cb53-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb53-4"><a href="#cb53-4"></a><span class="ot">    xmlns:tools=</span><span class="st">&quot;http://schemas.android.com/tools&quot;</span></span>
<span id="cb53-5"><a href="#cb53-5"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span>
<span id="cb53-6"><a href="#cb53-6"></a><span class="ot">    tools:context=</span><span class="st">&quot;.DepartureBusStopFragment&quot;</span><span class="kw">&gt;</span></span>
<span id="cb53-7"><a href="#cb53-7"></a></span>
<span id="cb53-8"><a href="#cb53-8"></a>    <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb53-9"><a href="#cb53-9"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb53-10"><a href="#cb53-10"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;match_parent&quot;</span><span class="kw">&gt;</span></span>
<span id="cb53-11"><a href="#cb53-11"></a></span>
<span id="cb53-12"><a href="#cb53-12"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb53-13"><a href="#cb53-13"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/departureBusStopNameTextView&quot;</span></span>
<span id="cb53-14"><a href="#cb53-14"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb53-15"><a href="#cb53-15"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb53-16"><a href="#cb53-16"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb53-17"><a href="#cb53-17"></a><span class="ot">            android:layout_marginStart=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb53-18"><a href="#cb53-18"></a><span class="ot">            android:layout_marginEnd=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb53-19"><a href="#cb53-19"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb53-20"><a href="#cb53-20"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb53-21"><a href="#cb53-21"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;parent&quot;</span><span class="kw">/&gt;</span></span>
<span id="cb53-22"><a href="#cb53-22"></a></span>
<span id="cb53-23"><a href="#cb53-23"></a>    <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb53-24"><a href="#cb53-24"></a></span>
<span id="cb53-25"><a href="#cb53-25"></a><span class="kw">&lt;/layout&gt;</span></span></code></pre></div>
<p>続いて、BusApproachesFragment.ktの変更です。</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb54-1"><a href="#cb54-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb54-2"><a href="#cb54-2"></a></span>
<span id="cb54-3"><a href="#cb54-3"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb54-4"><a href="#cb54-4"></a><span class="kw">import</span> <span class="im">android.util.Log</span></span>
<span id="cb54-5"><a href="#cb54-5"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.Fragment</span></span>
<span id="cb54-6"><a href="#cb54-6"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb54-7"><a href="#cb54-7"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb54-8"><a href="#cb54-8"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb54-9"><a href="#cb54-9"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.Observer</span></span>
<span id="cb54-10"><a href="#cb54-10"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.FragmentBusApproachesBinding</span></span>
<span id="cb54-11"><a href="#cb54-11"></a><span class="kw">import</span> <span class="im">kotlin.concurrent.thread</span></span>
<span id="cb54-12"><a href="#cb54-12"></a></span>
<span id="cb54-13"><a href="#cb54-13"></a><span class="kw">class</span> BusApproachesFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb54-14"><a href="#cb54-14"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateView</span>(<span class="va">inflater</span>: <span class="dt">LayoutInflater</span>, <span class="va">container</span>: <span class="dt">ViewGroup?</span>, <span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>): <span class="dt">View?</span> {</span>
<span id="cb54-15"><a href="#cb54-15"></a>        <span class="kw">return</span> FragmentBusApproachesBinding.inflate(inflater, container, <span class="kw">false</span>).apply {</span>
<span id="cb54-16"><a href="#cb54-16"></a>            (requireActivity().application <span class="kw">as</span> App).departureBusStopName.observe(viewLifecycleOwner, Observer { departureBusStopNameValue -&gt;</span>
<span id="cb54-17"><a href="#cb54-17"></a>                Log.d(<span class="st">&quot;BusApproachesFragment&quot;</span>, <span class="st">&quot;departureBusStopName.observe()&quot;</span>)</span>
<span id="cb54-18"><a href="#cb54-18"></a>                departureBusStopNameTextView.text = departureBusStopNameValue</span>
<span id="cb54-19"><a href="#cb54-19"></a>            })</span>
<span id="cb54-20"><a href="#cb54-20"></a></span>
<span id="cb54-21"><a href="#cb54-21"></a>            thread {</span>
<span id="cb54-22"><a href="#cb54-22"></a>                Thread.sleep(<span class="dv">5000</span>)</span>
<span id="cb54-23"><a href="#cb54-23"></a></span>
<span id="cb54-24"><a href="#cb54-24"></a>                (requireActivity().application <span class="kw">as</span> App).departureBusStopName.postValue(<span class="st">&quot;日本ユニシス本社前&quot;</span>)</span>
<span id="cb54-25"><a href="#cb54-25"></a>                Log.d(<span class="st">&quot;BusApproachesFragment&quot;</span>, <span class="st">&quot;MutableLiveData.postValue()&quot;</span>)</span>
<span id="cb54-26"><a href="#cb54-26"></a>            }</span>
<span id="cb54-27"><a href="#cb54-27"></a>        }.root</span>
<span id="cb54-28"><a href="#cb54-28"></a>    }</span>
<span id="cb54-29"><a href="#cb54-29"></a>}</span></code></pre></div>
<p>はい、これで作業終了。<code>MutableLiveData</code>に値を設定するには、メイン・スレッドからの場合は<code>value</code>プロパティ、他のスレッドからの場合は<code>postValue()</code>メソッドを使用します。スレッドを作成して5秒経ったら、私の両親が「お前をまだクビにしてないんだから度量が大きい会社だな」と評価した会社の前にあるバス停が設定され、画面に表示されます。</p>
<p>で、ここで試していただきたいのですけど、バス接近情報を表示する画面に遷移したら、5秒経つ前にホーム画面を表示してアプリをバックグラウンドに移動させてみてください。バックグラウンドに移ったので画面を更新する必要はなくて、だから<code>Observer</code>の呼び出しは無駄です。LiveDataはこのことを知っていて、しかも、<code>Fragment</code>がどのような状態にあるのかを<code>viewLifecycleOwner</code>を経由して知ることができるので、変更を通知しなくなるんです。その証拠に、ほら、logcatを見てください「departureBusStopName.observe()」が表示されていないでしょ？　で、アプリをフォアグランドに戻すと、すぐにlogcatに「departureBusStopName.observe()」が表示されて、私の会社の前にあるバス停の名前が画面に表示される。 というわけで、ほら、LiveDataのおかげで<code>Activity</code>や<code>Fragment</code>のライフサイクルがどうなっているのかを考えながらプログラミングする手間はほぼなくなりました！</p>
<h3 id="livedataとroomを組み合わせる">LiveDataとRoomを組み合わせる</h3>
<p>まだまだLiveDataはこんなもんではありません。RoomとLiveDataを組みわせるともっとすごいことができるんです。</p>
<p>以前の章でRoomを使ったときのことを思い出してみましょう。Roomはメイン・スレッドからは呼び出せなくて、とても面倒だった記憶が蘇ってきました（SplashFragment.ktを参照してください）。</p>
<p>この問題、LiveDataを使うととても簡単に解消できるんですよ。出発バス停と路線がつながっている到着バス停の一覧を取得する処理を考えてみましょう。まずは、<code>BusStopDao</code>に到着バス停を取得するメソッドを追加してみます。</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb55-1"><a href="#cb55-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb55-2"><a href="#cb55-2"></a></span>
<span id="cb55-3"><a href="#cb55-3"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.LiveData</span></span>
<span id="cb55-4"><a href="#cb55-4"></a><span class="kw">import</span> <span class="im">androidx.room.Dao</span></span>
<span id="cb55-5"><a href="#cb55-5"></a><span class="kw">import</span> <span class="im">androidx.room.Insert</span></span>
<span id="cb55-6"><a href="#cb55-6"></a><span class="kw">import</span> <span class="im">androidx.room.Query</span></span>
<span id="cb55-7"><a href="#cb55-7"></a></span>
<span id="cb55-8"><a href="#cb55-8"></a><span class="at">@Dao</span></span>
<span id="cb55-9"><a href="#cb55-9"></a><span class="kw">interface</span> BusStopDao {</span>
<span id="cb55-10"><a href="#cb55-10"></a>    ...</span>
<span id="cb55-11"><a href="#cb55-11"></a></span>
<span id="cb55-12"><a href="#cb55-12"></a>    <span class="at">@Query</span>(</span>
<span id="cb55-13"><a href="#cb55-13"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb55-14"><a href="#cb55-14"></a><span class="st">            SELECT DISTINCT ArrivalBusStop.*</span></span>
<span id="cb55-15"><a href="#cb55-15"></a><span class="st">            FROM BusStop AS ArrivalBusStop</span></span>
<span id="cb55-16"><a href="#cb55-16"></a><span class="st">            INNER JOIN BusStopPole AS ArrivalBusStopPole ON ArrivalBusStopPole.busStopName = ArrivalBusStop.name</span></span>
<span id="cb55-17"><a href="#cb55-17"></a><span class="st">            INNER JOIN RouteBusStopPole AS ArrivalRouteBusStopPole ON ArrivalRouteBusStopPole.busStopPoleId = ArrivalBusStopPole.id</span></span>
<span id="cb55-18"><a href="#cb55-18"></a><span class="st">            INNER JOIN Route ON Route.id = ArrivalRouteBusStopPole.routeId</span></span>
<span id="cb55-19"><a href="#cb55-19"></a><span class="st">            INNER JOIN RouteBusStopPole AS DepartureRouteBusStopPole ON DepartureRouteBusStopPole.routeId = Route.id</span></span>
<span id="cb55-20"><a href="#cb55-20"></a><span class="st">            INNER JOIN BusStopPole AS DepartureBusStopPole ON DepartureBusStopPole.id = DepartureRouteBusStopPole.busStopPoleId</span></span>
<span id="cb55-21"><a href="#cb55-21"></a><span class="st">            INNER JOIN BusStop AS DepartureBusStop ON DepartureBusStop.name = DepartureBusStopPole.busStopName</span></span>
<span id="cb55-22"><a href="#cb55-22"></a><span class="st">            WHERE DepartureBusStop.name = :departureBusStopName AND ArrivalBusStop.name &lt;&gt; :departureBusStopName</span></span>
<span id="cb55-23"><a href="#cb55-23"></a><span class="st">            ORDER BY ArrivalBusStop.phoneticName</span></span>
<span id="cb55-24"><a href="#cb55-24"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb55-25"><a href="#cb55-25"></a>    )</span>
<span id="cb55-26"><a href="#cb55-26"></a>    <span class="kw">fun</span> <span class="fu">getObservablesByDepartureBusStopName</span>(<span class="va">departureBusStopName</span>: <span class="dt">String</span>): <span class="dt">LiveData</span>&lt;<span class="dt">List</span>&lt;<span class="dt">BusStop</span>&gt;&gt;</span>
<span id="cb55-27"><a href="#cb55-27"></a>}</span></code></pre></div>
<p>SQLが複雑に見えますけど、BusStop（到着）→BusStopPole（到着）→RouteBusStopPole（到着）→Route→RouteBusStopPole（出発）→BusStopPole（出発）→BusStop（出発）と<code>INNER JOIN</code>で辿っているだけ。Roomの解説の章でダウンロードしたSQLite3のデータベース・ファイルを使って実際に試しながらやれば、容易に作成できるでしょう。</p>
<p>で、このコードの重要なところは、<code>getObservablesByDepartureBusStopName()</code>メソッドの返り値の「型」です。普通にRoomを使う場合の返り値の型は<code>List&lt;BusStop&gt;</code>になるのですけど、上のコードでは<code>LiveData&lt;List&lt;BusStop&gt;&gt;</code>になっています。この小さな変更だけで、LiveData対応のデータ・アクセスのメソッドが生成されるんです。</p>
<p>次の作業は、<code>App</code>へのRoomで作成するLiveData型のプロパティ追加なのですけど、そのためには<code>AppDatabase</code>が必要なので、まずは<code>AppCompoenent</code>に<code>fun inject(app: App)</code>を追加します。そのうえで、<code>App</code>を以下に修正してください。</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb56-1"><a href="#cb56-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb56-2"><a href="#cb56-2"></a></span>
<span id="cb56-3"><a href="#cb56-3"></a><span class="kw">import</span> <span class="im">android.app.Application</span></span>
<span id="cb56-4"><a href="#cb56-4"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.LiveData</span></span>
<span id="cb56-5"><a href="#cb56-5"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.MediatorLiveData</span></span>
<span id="cb56-6"><a href="#cb56-6"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.MutableLiveData</span></span>
<span id="cb56-7"><a href="#cb56-7"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.Transformations</span></span>
<span id="cb56-8"><a href="#cb56-8"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.AppDatabase</span></span>
<span id="cb56-9"><a href="#cb56-9"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.BusStop</span></span>
<span id="cb56-10"><a href="#cb56-10"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb56-11"><a href="#cb56-11"></a></span>
<span id="cb56-12"><a href="#cb56-12"></a><span class="kw">class</span> App: <span class="dt">Application</span>() {</span>
<span id="cb56-13"><a href="#cb56-13"></a>    lateinit <span class="kw">var</span> <span class="va">component</span>: AppComponent</span>
<span id="cb56-14"><a href="#cb56-14"></a>        <span class="kw">private</span> <span class="kw">set</span></span>
<span id="cb56-15"><a href="#cb56-15"></a></span>
<span id="cb56-16"><a href="#cb56-16"></a>    <span class="at">@Inject</span> lateinit <span class="kw">var</span> <span class="va">database</span>: AppDatabase</span>
<span id="cb56-17"><a href="#cb56-17"></a></span>
<span id="cb56-18"><a href="#cb56-18"></a>    <span class="kw">val</span> <span class="va">departureBusStopName</span> = MutableLiveData&lt;<span class="kw">String</span>&gt;()</span>
<span id="cb56-19"><a href="#cb56-19"></a>    <span class="kw">val</span> <span class="va">arrivalBusStops</span>: LiveData&lt;List&lt;BusStop&gt;&gt; <span class="kw">by</span> lazy { database.getBusStopDao().getObservablesByDepartureBusStopName(<span class="st">&quot;日本ユニシス本社前&quot;</span>) }</span>
<span id="cb56-20"><a href="#cb56-20"></a></span>
<span id="cb56-21"><a href="#cb56-21"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreate</span>() {</span>
<span id="cb56-22"><a href="#cb56-22"></a>        <span class="kw">super</span>.onCreate()</span>
<span id="cb56-23"><a href="#cb56-23"></a></span>
<span id="cb56-24"><a href="#cb56-24"></a>        component = DaggerAppComponent.builder().apply {</span>
<span id="cb56-25"><a href="#cb56-25"></a>            appModule(AppModule(this<span class="at">@App</span>))</span>
<span id="cb56-26"><a href="#cb56-26"></a>        }.build()</span>
<span id="cb56-27"><a href="#cb56-27"></a></span>
<span id="cb56-28"><a href="#cb56-28"></a>        component.inject(<span class="kw">this</span>)</span>
<span id="cb56-29"><a href="#cb56-29"></a>    }</span>
<span id="cb56-30"><a href="#cb56-30"></a>}</span></code></pre></div>
<p><code>arrivalBusStops</code>プロパティで使っている<code>by lazy</code>は、必要になるまでプロパティの初期化を遅らせる機能で、移譲プロパティと呼ばれる機能の一つです。<code>database</code>が注入される前に<code>database.getBusStopDao()</code>するわけにはいかないですもんね。</p>
<p>最後は、<code>BusApproachesFragment</code>の修正です。<code>MutableLiveData</code>の場合と同様に、<code>observe()</code>メソッドを呼び出して変更に合わせて画面を変更するようにしておきます。</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb57-1"><a href="#cb57-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb57-2"><a href="#cb57-2"></a></span>
<span id="cb57-3"><a href="#cb57-3"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb57-4"><a href="#cb57-4"></a><span class="kw">import</span> <span class="im">android.util.Log</span></span>
<span id="cb57-5"><a href="#cb57-5"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.Fragment</span></span>
<span id="cb57-6"><a href="#cb57-6"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb57-7"><a href="#cb57-7"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb57-8"><a href="#cb57-8"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb57-9"><a href="#cb57-9"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.Observer</span></span>
<span id="cb57-10"><a href="#cb57-10"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.FragmentBusApproachesBinding</span></span>
<span id="cb57-11"><a href="#cb57-11"></a><span class="kw">import</span> <span class="im">kotlin.concurrent.thread</span></span>
<span id="cb57-12"><a href="#cb57-12"></a></span>
<span id="cb57-13"><a href="#cb57-13"></a><span class="kw">class</span> BusApproachesFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb57-14"><a href="#cb57-14"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateView</span>(<span class="va">inflater</span>: <span class="dt">LayoutInflater</span>, <span class="va">container</span>: <span class="dt">ViewGroup?</span>, <span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>): <span class="dt">View?</span> {</span>
<span id="cb57-15"><a href="#cb57-15"></a>        <span class="kw">return</span> FragmentBusApproachesBinding.inflate(inflater, container, <span class="kw">false</span>).apply {</span>
<span id="cb57-16"><a href="#cb57-16"></a>            (requireActivity().application <span class="kw">as</span> App).departureBusStopName.observe(viewLifecycleOwner, Observer { departureBusStopNameValue -&gt;</span>
<span id="cb57-17"><a href="#cb57-17"></a>                Log.d(<span class="st">&quot;BusApproachesFragment&quot;</span>, <span class="st">&quot;departureBusStopName.observe()&quot;</span>)</span>
<span id="cb57-18"><a href="#cb57-18"></a>                departureBusStopNameTextView.text = departureBusStopNameValue</span>
<span id="cb57-19"><a href="#cb57-19"></a>            })</span>
<span id="cb57-20"><a href="#cb57-20"></a></span>
<span id="cb57-21"><a href="#cb57-21"></a>            (requireActivity().application <span class="kw">as</span> App).arrivalBusStops.observe(viewLifecycleOwner, Observer { arrivalBusStopsValue -&gt;</span>
<span id="cb57-22"><a href="#cb57-22"></a>                Log.d(<span class="st">&quot;BusApproachesFragment&quot;</span>, <span class="st">&quot;arrivalBusStops.observe(), ${arrivalBusStopsValue.size}&quot;</span>)</span>
<span id="cb57-23"><a href="#cb57-23"></a>                arrivalBusStopNamesTextView.text = arrivalBusStopsValue.map { it.name }.joinToString(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb57-24"><a href="#cb57-24"></a>            })</span>
<span id="cb57-25"><a href="#cb57-25"></a></span>
<span id="cb57-26"><a href="#cb57-26"></a>            thread {</span>
<span id="cb57-27"><a href="#cb57-27"></a>                Thread.sleep(<span class="dv">5000</span>)</span>
<span id="cb57-28"><a href="#cb57-28"></a></span>
<span id="cb57-29"><a href="#cb57-29"></a>                (requireActivity().application <span class="kw">as</span> App).departureBusStopName.postValue(<span class="st">&quot;日本ユニシス本社前&quot;</span>)</span>
<span id="cb57-30"><a href="#cb57-30"></a>                Log.d(<span class="st">&quot;BusApproachesFragment&quot;</span>, <span class="st">&quot;MutableLiveData.postValue()&quot;</span>)</span>
<span id="cb57-31"><a href="#cb57-31"></a>            }</span>
<span id="cb57-32"><a href="#cb57-32"></a>        }.root</span>
<span id="cb57-33"><a href="#cb57-33"></a>    }</span>
<span id="cb57-34"><a href="#cb57-34"></a>}</span></code></pre></div>
<p>Kotlinは関数型プログラミングのテクニックが使えてとても便利ですな。<code>map</code>で名前だけのリストに変換して、<code>joinToString()</code>で一つの文字列にまとめています。</p>
<p>プログラムが完成したので、早速実行してみます。手早くバス接近情報の画面まで遷移してlogcatを見てみると、何度も何度も「arrivalBusStops.observe()」と表示されて、かなり時間が経ってから、少しづつ到着バス停の候補が画面に表示されていきます。え？　どうしてこうなった？</p>
<p>あの、実はこれこそが、LiveDataとRoomを組み合わせるとできるようになる本当にすごいことなんです。LiveDataとRoomを組み合わせた場合は、データベースに変更があると通知がやってくるんですよ！</p>
<p>前にやった作業なのですっかり忘れていましたけど、我々は<code>SplashFragment</code>の中でWebサービスを呼び出して、取得したデータでデータベースを書き換える処理を実装していました。その処理はLifecycleを使わずにスレッドとして実装しましたから、SplashFragmentが終了しても動き続けます。なので、手早くバス接近情報の画面まで移動すると、まだデータベースの更新処理が動いているんですよ。で、データが更新されるたびに通知が来るので、何度も何度も「arrivalBusStops.observe()」と表示され、少しづつ到着バス停の候補が画面に表示されるという動きになったわけですな。</p>
<p>というわけで、LiveDataとRoomを組み合わせれば、MVVMのModelからViewModelへの変更の通知も実現できるんですよ。素晴らしい！</p>
<h3 id="transformations"><code>Transformations</code></h3>
<p>でもちょっと待って。先程のコードで<code>getObservablesByDepartureBusStopName()</code>を呼び出すときの引数をソース・コードに直打ちしていなかった？　それでは実用に耐えないのでは？</p>
<p>はい。おっしゃるとおり。<code>departureBusStopName</code>が変更されたらその値で<code>getObservablesByDepartureBusStopName()</code>が呼ばれるようになっていないとなりません。もちろん、Android Jetpackはそのための機能を提供していて、それが<code>Transformations</code>です。さっそく<code>Transformations</code>を使ってみましょう。</p>
<p><code>App</code>を以下のように修正します。</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb58-1"><a href="#cb58-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb58-2"><a href="#cb58-2"></a></span>
<span id="cb58-3"><a href="#cb58-3"></a><span class="kw">import</span> <span class="im">android.app.Application</span></span>
<span id="cb58-4"><a href="#cb58-4"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.LiveData</span></span>
<span id="cb58-5"><a href="#cb58-5"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.MediatorLiveData</span></span>
<span id="cb58-6"><a href="#cb58-6"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.MutableLiveData</span></span>
<span id="cb58-7"><a href="#cb58-7"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.Transformations</span></span>
<span id="cb58-8"><a href="#cb58-8"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.AppDatabase</span></span>
<span id="cb58-9"><a href="#cb58-9"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb58-10"><a href="#cb58-10"></a></span>
<span id="cb58-11"><a href="#cb58-11"></a><span class="kw">class</span> App: <span class="dt">Application</span>() {</span>
<span id="cb58-12"><a href="#cb58-12"></a>    lateinit <span class="kw">var</span> <span class="va">component</span>: AppComponent</span>
<span id="cb58-13"><a href="#cb58-13"></a>        <span class="kw">private</span> <span class="kw">set</span></span>
<span id="cb58-14"><a href="#cb58-14"></a></span>
<span id="cb58-15"><a href="#cb58-15"></a>    <span class="at">@Inject</span> lateinit <span class="kw">var</span> <span class="va">database</span>: AppDatabase</span>
<span id="cb58-16"><a href="#cb58-16"></a></span>
<span id="cb58-17"><a href="#cb58-17"></a>    <span class="kw">val</span> <span class="va">departureBusStopName</span> = MutableLiveData&lt;<span class="kw">String</span>&gt;()</span>
<span id="cb58-18"><a href="#cb58-18"></a></span>
<span id="cb58-19"><a href="#cb58-19"></a>    <span class="kw">val</span> <span class="va">arrivalBusStops</span> = Transformations.switchMap(departureBusStopName) { arrivalBusStopNameValue -&gt;</span>
<span id="cb58-20"><a href="#cb58-20"></a>        database.getBusStopDao().getObservablesByDepartureBusStopName(arrivalBusStopNameValue)</span>
<span id="cb58-21"><a href="#cb58-21"></a>    }</span>
<span id="cb58-22"><a href="#cb58-22"></a></span>
<span id="cb58-23"><a href="#cb58-23"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreate</span>() {</span>
<span id="cb58-24"><a href="#cb58-24"></a>        <span class="kw">super</span>.onCreate()</span>
<span id="cb58-25"><a href="#cb58-25"></a></span>
<span id="cb58-26"><a href="#cb58-26"></a>        component = DaggerAppComponent.builder().apply {</span>
<span id="cb58-27"><a href="#cb58-27"></a>            appModule(AppModule(this<span class="at">@App</span>))</span>
<span id="cb58-28"><a href="#cb58-28"></a>        }.build()</span>
<span id="cb58-29"><a href="#cb58-29"></a></span>
<span id="cb58-30"><a href="#cb58-30"></a>        component.inject(<span class="kw">this</span>)</span>
<span id="cb58-31"><a href="#cb58-31"></a>    }</span>
<span id="cb58-32"><a href="#cb58-32"></a>}</span></code></pre></div>
<p><code>Transformations</code>の<code>switchMap()</code>メソッドは、１つ目の引数で指定した<code>LiveData</code>が変更になったら、2つ目の引数のラムダ式の結果がセットされる<code>LiveData</code>を返します。なお、今回はラムダ式が<code>LiveData</code>を返すので<code>switchMap()</code>を使用しましたが、<code>Transformations</code>には、<code>LiveData</code>ではない返り値を使う場合向けの<code>map()</code>というメソッドもあります。</p>
<p>で、この<code>Transformations</code>を使うと、Roomにテーブルとテーブルの間を辿る機能がないことが気にならなくなります。たとえば注文と注文明細を表示するような場合は、注文と注文明細を<code>Transformations</code>でつないで、注文と関係づけられた注文明細を取得するデータ・アクセス・オブジェクトのメソッドを書けばいいんですから。というわけで、Roomは前に書いたような「こういうのでいいんだよ。こういうので」と表現されるような機能が貧弱なO/Rマッピング・ツールではなくて、不要な機能がついていないとても洗練された非常に出来が良いO/Rマッピング・ツールなんです。「Roomは機能が貧弱で」とのたまうRoomの説明を書いていたときの私みたいな人がいたら、分かってないなぁと鼻で笑ってやってください。</p>
<p>最後。せっかく<code>departureBusStopName</code>が変更になったら<code>arrivalBusStops</code>が変更されるようになったのですから、<code>BusApproachesFragment</code>を修正して画面も変更されるようにしましょう。</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb59-1"><a href="#cb59-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb59-2"><a href="#cb59-2"></a><span class="kw">&lt;layout</span></span>
<span id="cb59-3"><a href="#cb59-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb59-4"><a href="#cb59-4"></a><span class="ot">    xmlns:tools=</span><span class="st">&quot;http://schemas.android.com/tools&quot;</span></span>
<span id="cb59-5"><a href="#cb59-5"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span>
<span id="cb59-6"><a href="#cb59-6"></a><span class="ot">    tools:context=</span><span class="st">&quot;.DepartureBusStopFragment&quot;</span><span class="kw">&gt;</span></span>
<span id="cb59-7"><a href="#cb59-7"></a></span>
<span id="cb59-8"><a href="#cb59-8"></a>    <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb59-9"><a href="#cb59-9"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb59-10"><a href="#cb59-10"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;match_parent&quot;</span><span class="kw">&gt;</span></span>
<span id="cb59-11"><a href="#cb59-11"></a></span>
<span id="cb59-12"><a href="#cb59-12"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb59-13"><a href="#cb59-13"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/departureBusStopNameTextView&quot;</span></span>
<span id="cb59-14"><a href="#cb59-14"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb59-15"><a href="#cb59-15"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb59-16"><a href="#cb59-16"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb59-17"><a href="#cb59-17"></a><span class="ot">            android:layout_marginStart=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb59-18"><a href="#cb59-18"></a><span class="ot">            android:layout_marginEnd=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb59-19"><a href="#cb59-19"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb59-20"><a href="#cb59-20"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb59-21"><a href="#cb59-21"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;parent&quot;</span><span class="kw">/&gt;</span></span>
<span id="cb59-22"><a href="#cb59-22"></a></span>
<span id="cb59-23"><a href="#cb59-23"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb59-24"><a href="#cb59-24"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/arrivalBusStopNamesTextView&quot;</span></span>
<span id="cb59-25"><a href="#cb59-25"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb59-26"><a href="#cb59-26"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb59-27"><a href="#cb59-27"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb59-28"><a href="#cb59-28"></a><span class="ot">            android:layout_marginBottom=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb59-29"><a href="#cb59-29"></a><span class="ot">            app:layout_constraintTop_toBottomOf=</span><span class="st">&quot;@id/departureBusStopNameTextView&quot;</span></span>
<span id="cb59-30"><a href="#cb59-30"></a><span class="ot">            app:layout_constraintBottom_toBottomOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb59-31"><a href="#cb59-31"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;@id/departureBusStopNameTextView&quot;</span></span>
<span id="cb59-32"><a href="#cb59-32"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;@id/departureBusStopNameTextView&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb59-33"><a href="#cb59-33"></a></span>
<span id="cb59-34"><a href="#cb59-34"></a>    <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb59-35"><a href="#cb59-35"></a></span>
<span id="cb59-36"><a href="#cb59-36"></a><span class="kw">&lt;/layout&gt;</span></span></code></pre></div>
<div class="sourceCode" id="cb60"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb60-1"><a href="#cb60-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb60-2"><a href="#cb60-2"></a></span>
<span id="cb60-3"><a href="#cb60-3"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb60-4"><a href="#cb60-4"></a><span class="kw">import</span> <span class="im">android.util.Log</span></span>
<span id="cb60-5"><a href="#cb60-5"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.Fragment</span></span>
<span id="cb60-6"><a href="#cb60-6"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb60-7"><a href="#cb60-7"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb60-8"><a href="#cb60-8"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb60-9"><a href="#cb60-9"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.Observer</span></span>
<span id="cb60-10"><a href="#cb60-10"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.FragmentBusApproachesBinding</span></span>
<span id="cb60-11"><a href="#cb60-11"></a><span class="kw">import</span> <span class="im">kotlin.concurrent.thread</span></span>
<span id="cb60-12"><a href="#cb60-12"></a></span>
<span id="cb60-13"><a href="#cb60-13"></a><span class="kw">class</span> BusApproachesFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb60-14"><a href="#cb60-14"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateView</span>(<span class="va">inflater</span>: <span class="dt">LayoutInflater</span>, <span class="va">container</span>: <span class="dt">ViewGroup?</span>, <span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>): <span class="dt">View?</span> {</span>
<span id="cb60-15"><a href="#cb60-15"></a>        <span class="kw">return</span> FragmentBusApproachesBinding.inflate(inflater, container, <span class="kw">false</span>).apply {</span>
<span id="cb60-16"><a href="#cb60-16"></a>            (requireActivity().application <span class="kw">as</span> App).departureBusStopName.observe(viewLifecycleOwner, Observer { departureBusStopNameValue -&gt;</span>
<span id="cb60-17"><a href="#cb60-17"></a>                Log.d(<span class="st">&quot;BusApproachesFragment&quot;</span>, <span class="st">&quot;departureBusStopName.observe()&quot;</span>)</span>
<span id="cb60-18"><a href="#cb60-18"></a>                departureBusStopNameTextView.text = departureBusStopNameValue</span>
<span id="cb60-19"><a href="#cb60-19"></a>            })</span>
<span id="cb60-20"><a href="#cb60-20"></a></span>
<span id="cb60-21"><a href="#cb60-21"></a>            (requireActivity().application <span class="kw">as</span> App).arrivalBusStops.observe(viewLifecycleOwner, Observer { arrivalBusStopsValue -&gt;</span>
<span id="cb60-22"><a href="#cb60-22"></a>                Log.d(<span class="st">&quot;BusApproachesFragment&quot;</span>, <span class="st">&quot;arrivalBusStops.observe(), ${arrivalBusStopsValue.size}&quot;</span>)</span>
<span id="cb60-23"><a href="#cb60-23"></a>                arrivalBusStopNamesTextView.text = arrivalBusStopsValue.map { it.name }.joinToString(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb60-24"><a href="#cb60-24"></a>            })</span>
<span id="cb60-25"><a href="#cb60-25"></a></span>
<span id="cb60-26"><a href="#cb60-26"></a>            thread {</span>
<span id="cb60-27"><a href="#cb60-27"></a>                Thread.sleep(<span class="dv">5000</span>)</span>
<span id="cb60-28"><a href="#cb60-28"></a></span>
<span id="cb60-29"><a href="#cb60-29"></a>                (requireActivity().application <span class="kw">as</span> App).departureBusStopName.postValue(<span class="st">&quot;日本ユニシス本社前&quot;</span>)</span>
<span id="cb60-30"><a href="#cb60-30"></a>                Log.d(<span class="st">&quot;BusApproachesFragment&quot;</span>, <span class="st">&quot;MutableLiveData.postValue()&quot;</span>)</span>
<span id="cb60-31"><a href="#cb60-31"></a></span>
<span id="cb60-32"><a href="#cb60-32"></a>                Thread.sleep(<span class="dv">5000</span>)</span>
<span id="cb60-33"><a href="#cb60-33"></a></span>
<span id="cb60-34"><a href="#cb60-34"></a>                (requireActivity().application <span class="kw">as</span> App).departureBusStopName.postValue(<span class="st">&quot;深川第八中学校前&quot;</span>)</span>
<span id="cb60-35"><a href="#cb60-35"></a>            }</span>
<span id="cb60-36"><a href="#cb60-36"></a>        }.root</span>
<span id="cb60-37"><a href="#cb60-37"></a>    }</span>
<span id="cb60-38"><a href="#cb60-38"></a>}</span></code></pre></div>
<p>5秒たったら<code>departureBusStopName</code>を「日本ユニシス本社前」に設定して、また5秒たったら<code>departureBusStopName</code>を私のアパートの最寄りバス停である「深川第八中学校前」に変更するわけですな。<code>SplashFragment</code>でlogcatに「Finish.」が表示されるまで待って（そうしないとデータベースの更新と<code>departureBusStopName</code>の更新が合わさって変な動きになっちゃう）、バス接近情報の画面に遷移します。</p>
<p>5秒後に「日本ユニシス本社前」とつながっているバス停の一覧が表示されて、さらに5秒たったら画面が「深川第八中学校前」とそこにつながっているバス停の一覧に変更されたでしょ？　はい、これで終わり。<code>Transformations</code>は実に便利ですな。</p>
<h3 id="mediatorlivedata"><code>MediatorLiveData</code></h3>
<p>でも、あれ、ユーザーIDとパスワードが入力されたらログインして認証済みかどうかの<code>LiveData</code>を更新するような場合はどうするのでしょうか？　今回のアプリだと、出発バス停と到着バス停からルートを取得するような場合です。<code>Transformations</code>は1つの<code>LiveData</code>しか監視できないですよね？　それでは、要件を満たせません。</p>
<p>というわけで、そんな場合は<code>MediatorLiveData</code>を使いましょう。出発バス停の名称と到着バス停の名称からルートを取得する処理を作りたいので、まずはルートを取得するメソッドを<code>RouteDao</code>に追加します。</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb61-1"><a href="#cb61-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb61-2"><a href="#cb61-2"></a></span>
<span id="cb61-3"><a href="#cb61-3"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.LiveData</span></span>
<span id="cb61-4"><a href="#cb61-4"></a><span class="kw">import</span> <span class="im">androidx.room.Dao</span></span>
<span id="cb61-5"><a href="#cb61-5"></a><span class="kw">import</span> <span class="im">androidx.room.Insert</span></span>
<span id="cb61-6"><a href="#cb61-6"></a><span class="kw">import</span> <span class="im">androidx.room.Query</span></span>
<span id="cb61-7"><a href="#cb61-7"></a></span>
<span id="cb61-8"><a href="#cb61-8"></a><span class="at">@Dao</span></span>
<span id="cb61-9"><a href="#cb61-9"></a><span class="kw">interface</span> RouteDao {</span>
<span id="cb61-10"><a href="#cb61-10"></a>    ...</span>
<span id="cb61-11"><a href="#cb61-11"></a></span>
<span id="cb61-12"><a href="#cb61-12"></a>    <span class="at">@Query</span>(</span>
<span id="cb61-13"><a href="#cb61-13"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb61-14"><a href="#cb61-14"></a><span class="st">            SELECT Route.*</span></span>
<span id="cb61-15"><a href="#cb61-15"></a><span class="st">            FROM BusStopPole AS ArrivalBusStopPole</span></span>
<span id="cb61-16"><a href="#cb61-16"></a><span class="st">            INNER JOIN RouteBusStopPole AS ArrivalRouteBusStopPole ON ArrivalRouteBusStopPole.busStopPoleId = ArrivalBusStopPole.id</span></span>
<span id="cb61-17"><a href="#cb61-17"></a><span class="st">            INNER JOIN Route ON Route.id = ArrivalRouteBusStopPole.routeId</span></span>
<span id="cb61-18"><a href="#cb61-18"></a><span class="st">            INNER JOIN RouteBusStopPole As DepartureRouteBusStopPole ON DepartureRouteBusStopPole.routeId = Route.id</span></span>
<span id="cb61-19"><a href="#cb61-19"></a><span class="st">            INNER JOIN BusStopPole AS DepartureBusStopPole ON DepartureBusStopPole.id = DepartureRouteBusStopPole.busStopPoleId</span></span>
<span id="cb61-20"><a href="#cb61-20"></a><span class="st">            WHERE ArrivalRouteBusStopPole.&#39;order&#39; &gt; DepartureRouteBusStopPole.&#39;order&#39; AND DepartureBusStopPole.busStopName = :departureBusStopName AND ArrivalBusStopPole.busStopName = :arrivalBusStopName</span></span>
<span id="cb61-21"><a href="#cb61-21"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb61-22"><a href="#cb61-22"></a>    )</span>
<span id="cb61-23"><a href="#cb61-23"></a>    <span class="kw">fun</span> <span class="fu">getObservablesByDepartureBusStopNameAndArrivalBusStopName</span>(<span class="va">departureBusStopName</span>: <span class="dt">String</span>, <span class="va">arrivalBusStopName</span>: <span class="dt">String</span>): <span class="dt">LiveData</span>&lt;<span class="dt">List</span>&lt;<span class="dt">Route</span>&gt;&gt;</span>
<span id="cb61-24"><a href="#cb61-24"></a>}</span></code></pre></div>
<p>そのうえで、<code>App</code>のコードを以下に変更します。</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb62-1"><a href="#cb62-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb62-2"><a href="#cb62-2"></a></span>
<span id="cb62-3"><a href="#cb62-3"></a><span class="kw">import</span> <span class="im">android.app.Application</span></span>
<span id="cb62-4"><a href="#cb62-4"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.LiveData</span></span>
<span id="cb62-5"><a href="#cb62-5"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.MediatorLiveData</span></span>
<span id="cb62-6"><a href="#cb62-6"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.MutableLiveData</span></span>
<span id="cb62-7"><a href="#cb62-7"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.Transformations</span></span>
<span id="cb62-8"><a href="#cb62-8"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.AppDatabase</span></span>
<span id="cb62-9"><a href="#cb62-9"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.Route</span></span>
<span id="cb62-10"><a href="#cb62-10"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb62-11"><a href="#cb62-11"></a></span>
<span id="cb62-12"><a href="#cb62-12"></a><span class="kw">class</span> App: <span class="dt">Application</span>() {</span>
<span id="cb62-13"><a href="#cb62-13"></a>    lateinit <span class="kw">var</span> <span class="va">component</span>: AppComponent</span>
<span id="cb62-14"><a href="#cb62-14"></a>        <span class="kw">private</span> <span class="kw">set</span></span>
<span id="cb62-15"><a href="#cb62-15"></a></span>
<span id="cb62-16"><a href="#cb62-16"></a>    <span class="at">@Inject</span> lateinit <span class="kw">var</span> <span class="va">database</span>: AppDatabase</span>
<span id="cb62-17"><a href="#cb62-17"></a></span>
<span id="cb62-18"><a href="#cb62-18"></a>    <span class="kw">val</span> <span class="va">departureBusStopName</span> = MutableLiveData&lt;<span class="kw">String</span>&gt;()</span>
<span id="cb62-19"><a href="#cb62-19"></a></span>
<span id="cb62-20"><a href="#cb62-20"></a>    <span class="kw">val</span> <span class="va">arrivalBusStops</span> = Transformations.switchMap(departureBusStopName) { arrivalBusStopNameValue -&gt;</span>
<span id="cb62-21"><a href="#cb62-21"></a>        database.getBusStopDao().getObservablesByDepartureBusStopName(arrivalBusStopNameValue)</span>
<span id="cb62-22"><a href="#cb62-22"></a>    }</span>
<span id="cb62-23"><a href="#cb62-23"></a></span>
<span id="cb62-24"><a href="#cb62-24"></a>    <span class="kw">val</span> <span class="va">arrivalBusStopName</span> = Transformations.map(arrivalBusStops) { arrivalBusStopsValue -&gt;</span>
<span id="cb62-25"><a href="#cb62-25"></a>        arrivalBusStopsValue[<span class="fl">0.</span>until(arrivalBusStopsValue.size).random()].name</span>
<span id="cb62-26"><a href="#cb62-26"></a>    }</span>
<span id="cb62-27"><a href="#cb62-27"></a></span>
<span id="cb62-28"><a href="#cb62-28"></a>    <span class="kw">val</span> <span class="va">routes</span> = MediatorLiveData&lt;List&lt;Route&gt;&gt;().apply {</span>
<span id="cb62-29"><a href="#cb62-29"></a>        <span class="kw">var</span> <span class="va">source</span>: LiveData&lt;List&lt;Route&gt;&gt;? = <span class="kw">null</span></span>
<span id="cb62-30"><a href="#cb62-30"></a></span>
<span id="cb62-31"><a href="#cb62-31"></a>        <span class="kw">fun</span> <span class="fu">update</span>() {</span>
<span id="cb62-32"><a href="#cb62-32"></a>            <span class="kw">val</span> <span class="va">departureBusStopNameValue</span> = departureBusStopName.value ?: <span class="kw">return</span></span>
<span id="cb62-33"><a href="#cb62-33"></a>            <span class="kw">val</span> <span class="va">arrivalBusStopNameValue</span>   = arrivalBusStopName.value   ?: <span class="kw">return</span></span>
<span id="cb62-34"><a href="#cb62-34"></a></span>
<span id="cb62-35"><a href="#cb62-35"></a>            source?.let {</span>
<span id="cb62-36"><a href="#cb62-36"></a>                removeSource(it)</span>
<span id="cb62-37"><a href="#cb62-37"></a>            }</span>
<span id="cb62-38"><a href="#cb62-38"></a></span>
<span id="cb62-39"><a href="#cb62-39"></a>            source = database.getRouteDao().getObservablesByDepartureBusStopNameAndArrivalBusStopName(departureBusStopNameValue, arrivalBusStopNameValue).also {</span>
<span id="cb62-40"><a href="#cb62-40"></a>                addSource(it) { sourceValue -&gt;</span>
<span id="cb62-41"><a href="#cb62-41"></a>                    value = sourceValue</span>
<span id="cb62-42"><a href="#cb62-42"></a>                }</span>
<span id="cb62-43"><a href="#cb62-43"></a>            }</span>
<span id="cb62-44"><a href="#cb62-44"></a>        }</span>
<span id="cb62-45"><a href="#cb62-45"></a></span>
<span id="cb62-46"><a href="#cb62-46"></a>        addSource(departureBusStopName) { update() }</span>
<span id="cb62-47"><a href="#cb62-47"></a>        addSource(arrivalBusStopName)   { update() }</span>
<span id="cb62-48"><a href="#cb62-48"></a>    }</span>
<span id="cb62-49"><a href="#cb62-49"></a></span>
<span id="cb62-50"><a href="#cb62-50"></a>    ...</span></code></pre></div>
<p>うぉ、面倒臭そう……なので、少し解説を。</p>
<p><code>departureBusStopName</code>（出発バス停名称）が変更になったら、<code>arrivalBusStops</code>（到着バス停のリスト）を設定するところまでは前にやりました。今回は<code>arrivalBusStopName</code>（到着バス停名称）も必要なので、<code>Transformations</code>の<code>map()</code>メソッドを使用して<code>arrivalBusStops</code>が変更になったらその中の一つをランダムに選ぶようにしました。</p>
<p>で、<code>routes</code>（ルートのリスト）が問題の<code>MediatorLiveData</code>です。<code>MediatorLiveData</code>では、監視対象の<code>LiveData</code>を<code>addSource()</code>メソッドで追加できます。<code>addSource()</code>メソッドの2つ目の引数はラムダ式で、監視対象が変更になった場合に実行する処理です。今回は、その直前に定義している<code>update()</code>関数を呼び出しています。で、<code>MediatorLiveData</code>の値を変更したい場合は、<code>value</code>プロパティに値を設定すればよくて、監視対象の<code>LiveData</code>の値は<code>LiveData</code>の<code>value</code>プロパティで取得できるのですけど、残念なことに<code>RouteDao</code>に定義したのは<code>LiveData&lt;List&lt;Route&gt;&gt;</code>を返すメソッドで、そのままでは<code>value</code>に設定できません。</p>
<p>だから、<code>getObservablesByDepartureBusStopNameAndArrivalBusStopName()</code>の返り値を格納するための<code>source</code>変数を作成して、設定と同時に<code>also</code>で<code>addSource()</code>して<code>value</code>に値を設定するようにしています。<code>source</code>が複数になると動作がおかしくなりますから、<code>source?.let</code>で過去に設定した<code>source</code>がある場合は<code>removeSource()</code>しています。</p>
<p>あと、<code>update()</code>の中でエルビス演算子（<code>:?</code>）を使用しているのは、<code>LiveData</code>のテンプレート引数が<code>null</code>を許容しない型であったとしても、値がまだ設定されていない場合は<code>value</code>プロパティの値が<code>null</code>になってしまうためです。出発バス停名称と到着バス停名称の両方が揃った場合に初めて処理を実施するというわけですな。</p>
<p>……とまぁ、異常に複雑で、これを少しでも簡単にするには「<code>RouteDao</code>に<code>LiveData</code>を返さないメソッドを定義する」という手があるのですけど、場合によって作り方を変更するのは混乱の元になるので避けたい。まぁ、複雑だとはいっても毎回同じなのでいつかは見慣れるでしょうから、ごめんなさい、このままで。こーゆーもんなんだと飲み込んでください。で、誰かライブラリ化してくれないかなぁ。KotlinにLISPやRustのマクロがあれば、こんな場合にも簡単にライブラリ化できるのに……。</p>
<p>ともあれ、面倒くさいのはここまでで終わり。あとは、これまでと同じです。レイアウトのXMLをいい感じに修正して……</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb63-1"><a href="#cb63-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb63-2"><a href="#cb63-2"></a><span class="kw">&lt;layout</span></span>
<span id="cb63-3"><a href="#cb63-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb63-4"><a href="#cb63-4"></a><span class="ot">    xmlns:tools=</span><span class="st">&quot;http://schemas.android.com/tools&quot;</span></span>
<span id="cb63-5"><a href="#cb63-5"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span>
<span id="cb63-6"><a href="#cb63-6"></a><span class="ot">    tools:context=</span><span class="st">&quot;.DepartureBusStopFragment&quot;</span><span class="kw">&gt;</span></span>
<span id="cb63-7"><a href="#cb63-7"></a></span>
<span id="cb63-8"><a href="#cb63-8"></a>    <span class="kw">&lt;data&gt;</span></span>
<span id="cb63-9"><a href="#cb63-9"></a>        <span class="kw">&lt;variable</span><span class="ot"> name=</span><span class="st">&quot;app&quot;</span><span class="ot"> type=</span><span class="st">&quot;com.tail_island.jetbus.App&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb63-10"><a href="#cb63-10"></a>    <span class="kw">&lt;/data&gt;</span></span>
<span id="cb63-11"><a href="#cb63-11"></a></span>
<span id="cb63-12"><a href="#cb63-12"></a>    <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb63-13"><a href="#cb63-13"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb63-14"><a href="#cb63-14"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;match_parent&quot;</span><span class="kw">&gt;</span></span>
<span id="cb63-15"><a href="#cb63-15"></a></span>
<span id="cb63-16"><a href="#cb63-16"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb63-17"><a href="#cb63-17"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/departureBusStopNameTextView&quot;</span></span>
<span id="cb63-18"><a href="#cb63-18"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb63-19"><a href="#cb63-19"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb63-20"><a href="#cb63-20"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb63-21"><a href="#cb63-21"></a><span class="ot">            android:layout_marginStart=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb63-22"><a href="#cb63-22"></a><span class="ot">            android:layout_marginEnd=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb63-23"><a href="#cb63-23"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb63-24"><a href="#cb63-24"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb63-25"><a href="#cb63-25"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;parent&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb63-26"><a href="#cb63-26"></a></span>
<span id="cb63-27"><a href="#cb63-27"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb63-28"><a href="#cb63-28"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/arrivalBusStopNameTextView&quot;</span></span>
<span id="cb63-29"><a href="#cb63-29"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb63-30"><a href="#cb63-30"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb63-31"><a href="#cb63-31"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb63-32"><a href="#cb63-32"></a><span class="ot">            app:layout_constraintTop_toBottomOf=</span><span class="st">&quot;@id/departureBusStopNameTextView&quot;</span></span>
<span id="cb63-33"><a href="#cb63-33"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;@id/departureBusStopNameTextView&quot;</span></span>
<span id="cb63-34"><a href="#cb63-34"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;@id/departureBusStopNameTextView&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb63-35"><a href="#cb63-35"></a></span>
<span id="cb63-36"><a href="#cb63-36"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb63-37"><a href="#cb63-37"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/routeNamesTextView&quot;</span></span>
<span id="cb63-38"><a href="#cb63-38"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb63-39"><a href="#cb63-39"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb63-40"><a href="#cb63-40"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb63-41"><a href="#cb63-41"></a><span class="ot">            android:layout_marginBottom=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb63-42"><a href="#cb63-42"></a><span class="ot">            app:layout_constraintTop_toBottomOf=</span><span class="st">&quot;@id/arrivalBusStopNameTextView&quot;</span></span>
<span id="cb63-43"><a href="#cb63-43"></a><span class="ot">            app:layout_constraintBottom_toBottomOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb63-44"><a href="#cb63-44"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;@id/arrivalBusStopNameTextView&quot;</span></span>
<span id="cb63-45"><a href="#cb63-45"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;@id/arrivalBusStopNameTextView&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb63-46"><a href="#cb63-46"></a></span>
<span id="cb63-47"><a href="#cb63-47"></a>    <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb63-48"><a href="#cb63-48"></a></span>
<span id="cb63-49"><a href="#cb63-49"></a><span class="kw">&lt;/layout&gt;</span></span></code></pre></div>
<p><code>Fragment</code>側も修正します。</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb64-1"><a href="#cb64-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb64-2"><a href="#cb64-2"></a></span>
<span id="cb64-3"><a href="#cb64-3"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb64-4"><a href="#cb64-4"></a><span class="kw">import</span> <span class="im">android.util.Log</span></span>
<span id="cb64-5"><a href="#cb64-5"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.Fragment</span></span>
<span id="cb64-6"><a href="#cb64-6"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb64-7"><a href="#cb64-7"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb64-8"><a href="#cb64-8"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb64-9"><a href="#cb64-9"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.Observer</span></span>
<span id="cb64-10"><a href="#cb64-10"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.FragmentBusApproachesBinding</span></span>
<span id="cb64-11"><a href="#cb64-11"></a><span class="kw">import</span> <span class="im">kotlin.concurrent.thread</span></span>
<span id="cb64-12"><a href="#cb64-12"></a></span>
<span id="cb64-13"><a href="#cb64-13"></a><span class="kw">class</span> BusApproachesFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb64-14"><a href="#cb64-14"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateView</span>(<span class="va">inflater</span>: <span class="dt">LayoutInflater</span>, <span class="va">container</span>: <span class="dt">ViewGroup?</span>, <span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>): <span class="dt">View?</span> {</span>
<span id="cb64-15"><a href="#cb64-15"></a>        <span class="kw">return</span> FragmentBusApproachesBinding.inflate(inflater, container, <span class="kw">false</span>).apply {</span>
<span id="cb64-16"><a href="#cb64-16"></a>            (requireActivity().application <span class="kw">as</span> App).departureBusStopName.observe(viewLifecycleOwner, Observer { departureBusStopNameValue -&gt;</span>
<span id="cb64-17"><a href="#cb64-17"></a>                Log.d(<span class="st">&quot;BusApproachesFragment&quot;</span>, <span class="st">&quot;departureBusStopName.observe()&quot;</span>)</span>
<span id="cb64-18"><a href="#cb64-18"></a>                departureBusStopNameTextView.text = departureBusStopNameValue</span>
<span id="cb64-19"><a href="#cb64-19"></a>            })</span>
<span id="cb64-20"><a href="#cb64-20"></a></span>
<span id="cb64-21"><a href="#cb64-21"></a>            (requireActivity().application <span class="kw">as</span> App).arrivalBusStopName.observe(viewLifecycleOwner, Observer { arrivalBusStopNameValue -&gt;</span>
<span id="cb64-22"><a href="#cb64-22"></a>                arrivalBusStopNameTextView.text = departureBusStopNameValue</span>
<span id="cb64-23"><a href="#cb64-23"></a>            })</span>
<span id="cb64-24"><a href="#cb64-24"></a></span>
<span id="cb64-25"><a href="#cb64-25"></a>            (requireActivity().application <span class="kw">as</span> App).routes.observe(viewLifecycleOwner, Observer { routesValue -&gt;</span>
<span id="cb64-26"><a href="#cb64-26"></a>                routeNamesTextView.text = routesValue.map { it.name }.joinToString(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb64-27"><a href="#cb64-27"></a>            })</span>
<span id="cb64-28"><a href="#cb64-28"></a></span>
<span id="cb64-29"><a href="#cb64-29"></a>            thread {</span>
<span id="cb64-30"><a href="#cb64-30"></a>                Thread.sleep(<span class="dv">5000</span>)</span>
<span id="cb64-31"><a href="#cb64-31"></a></span>
<span id="cb64-32"><a href="#cb64-32"></a>                (requireActivity().application <span class="kw">as</span> App).departureBusStopName.postValue(<span class="st">&quot;日本ユニシス本社前&quot;</span>)</span>
<span id="cb64-33"><a href="#cb64-33"></a>                Log.d(<span class="st">&quot;BusApproachesFragment&quot;</span>, <span class="st">&quot;MutableLiveData.postValue()&quot;</span>)</span>
<span id="cb64-34"><a href="#cb64-34"></a></span>
<span id="cb64-35"><a href="#cb64-35"></a>                Thread.sleep(<span class="dv">5000</span>)</span>
<span id="cb64-36"><a href="#cb64-36"></a></span>
<span id="cb64-37"><a href="#cb64-37"></a>                (requireActivity().application <span class="kw">as</span> App).departureBusStopName.postValue(<span class="st">&quot;深川第八中学校前&quot;</span>)</span>
<span id="cb64-38"><a href="#cb64-38"></a>            }</span>
<span id="cb64-39"><a href="#cb64-39"></a>        }.root</span>
<span id="cb64-40"><a href="#cb64-40"></a>    }</span>
<span id="cb64-41"><a href="#cb64-41"></a>}</span></code></pre></div>
<p>これで出発バス停の名称と到着バス停の名称とその2つのバス停をつなぐルートの一覧が表示されるようになりました。あ、このアプリを動かすとルートが複数表示されるのは、ルートの出発バス停や到着バス停が異なる場合があるためです。</p>
<p>これでLiveDataの説明は完了です。<code>MediatorLiveData</code>の使い方が少し面倒でしたけど、全体で見ればとても便利でしょ？　長かった説明が終わってよかった……。</p>
<h3 id="データバインディング">データ・バインディング</h3>
<p>まだだ！　まだ終わらんよ！　だって、<code>Fragment</code>のコードで<code>observe()</code>するのって面倒じゃあないですか？　この処理って、データ・バインディングを使うととても簡単になるんです。</p>
<p>さっそくやってみましょう。データ・バインディングは、レイアウトのXMLに記載します。</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb65-1"><a href="#cb65-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb65-2"><a href="#cb65-2"></a><span class="kw">&lt;layout</span></span>
<span id="cb65-3"><a href="#cb65-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb65-4"><a href="#cb65-4"></a><span class="ot">    xmlns:tools=</span><span class="st">&quot;http://schemas.android.com/tools&quot;</span></span>
<span id="cb65-5"><a href="#cb65-5"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span>
<span id="cb65-6"><a href="#cb65-6"></a><span class="ot">    tools:context=</span><span class="st">&quot;.DepartureBusStopFragment&quot;</span><span class="kw">&gt;</span></span>
<span id="cb65-7"><a href="#cb65-7"></a></span>
<span id="cb65-8"><a href="#cb65-8"></a>    <span class="kw">&lt;data&gt;</span></span>
<span id="cb65-9"><a href="#cb65-9"></a>        <span class="kw">&lt;variable</span><span class="ot"> name=</span><span class="st">&quot;app&quot;</span><span class="ot"> type=</span><span class="st">&quot;com.tail_island.jetbus.App&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb65-10"><a href="#cb65-10"></a>    <span class="kw">&lt;/data&gt;</span></span>
<span id="cb65-11"><a href="#cb65-11"></a></span>
<span id="cb65-12"><a href="#cb65-12"></a>    <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb65-13"><a href="#cb65-13"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb65-14"><a href="#cb65-14"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;match_parent&quot;</span><span class="kw">&gt;</span></span>
<span id="cb65-15"><a href="#cb65-15"></a></span>
<span id="cb65-16"><a href="#cb65-16"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb65-17"><a href="#cb65-17"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/departureBusStopNameTextView&quot;</span></span>
<span id="cb65-18"><a href="#cb65-18"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb65-19"><a href="#cb65-19"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb65-20"><a href="#cb65-20"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb65-21"><a href="#cb65-21"></a><span class="ot">            android:layout_marginStart=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb65-22"><a href="#cb65-22"></a><span class="ot">            android:layout_marginEnd=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb65-23"><a href="#cb65-23"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb65-24"><a href="#cb65-24"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb65-25"><a href="#cb65-25"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb65-26"><a href="#cb65-26"></a><span class="ot">            android:text=</span><span class="st">&#39;@{app.departureBusStopName}&#39;</span> <span class="kw">/&gt;</span></span>
<span id="cb65-27"><a href="#cb65-27"></a></span>
<span id="cb65-28"><a href="#cb65-28"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb65-29"><a href="#cb65-29"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/arrivalBusStopNameTextView&quot;</span></span>
<span id="cb65-30"><a href="#cb65-30"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb65-31"><a href="#cb65-31"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb65-32"><a href="#cb65-32"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb65-33"><a href="#cb65-33"></a><span class="ot">            app:layout_constraintTop_toBottomOf=</span><span class="st">&quot;@id/departureBusStopNameTextView&quot;</span></span>
<span id="cb65-34"><a href="#cb65-34"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;@id/departureBusStopNameTextView&quot;</span></span>
<span id="cb65-35"><a href="#cb65-35"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;@id/departureBusStopNameTextView&quot;</span></span>
<span id="cb65-36"><a href="#cb65-36"></a><span class="ot">            android:text=</span><span class="st">&#39;@{app.arrivalBusStopName}&#39;</span> <span class="kw">/&gt;</span></span>
<span id="cb65-37"><a href="#cb65-37"></a></span>
<span id="cb65-38"><a href="#cb65-38"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb65-39"><a href="#cb65-39"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/routeNamesTextView&quot;</span></span>
<span id="cb65-40"><a href="#cb65-40"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb65-41"><a href="#cb65-41"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb65-42"><a href="#cb65-42"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb65-43"><a href="#cb65-43"></a><span class="ot">            android:layout_marginBottom=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb65-44"><a href="#cb65-44"></a><span class="ot">            app:layout_constraintTop_toBottomOf=</span><span class="st">&quot;@id/arrivalBusStopNameTextView&quot;</span></span>
<span id="cb65-45"><a href="#cb65-45"></a><span class="ot">            app:layout_constraintBottom_toBottomOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb65-46"><a href="#cb65-46"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;@id/arrivalBusStopNameTextView&quot;</span></span>
<span id="cb65-47"><a href="#cb65-47"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;@id/arrivalBusStopNameTextView&quot;</span></span>
<span id="cb65-48"><a href="#cb65-48"></a><span class="ot">            android:text=</span><span class="st">&#39;@{app.routeNames}&#39;</span> <span class="kw">/&gt;</span></span>
<span id="cb65-49"><a href="#cb65-49"></a></span>
<span id="cb65-50"><a href="#cb65-50"></a>    <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb65-51"><a href="#cb65-51"></a></span>
<span id="cb65-52"><a href="#cb65-52"></a><span class="kw">&lt;/layout&gt;</span></span></code></pre></div>
<p><code>&lt;data&gt;</code>タグの中の<code>&lt;variable&gt;</code>タグで、このレイアウトで扱うデータを定義します。今回は<code>App</code>のプロパティを使用して画面を表示するので、<code>App</code>にします。</p>
<p>で、<code>android:text</code>属性の値の<code>@{...}</code>の部分がバインディング先の指定です。<code>app.departureBusStopName</code>は<code>LiveData</code>型だけど文字列型にしなくていいの？　とお考えになった方がいらっしゃるかもしれませんが、データ・バインディングは<code>LiveData</code>対応ですのでこれで大丈夫なんです。</p>
<p>ただ、良いことばかり続くわけではないのが世の常です。<code>routeNamesTextView</code>の<code>android:text</code>プロパティを見てください。<code>map()</code>や<code>joinToString()</code>を使わずに、まだ定義してない<code>App</code>の<code>routeNames</code>プロパティをバインディングしています。というのもですね、データ・バインディングの<code>@{...}</code>の中ってKotlinのコードを書けないんですよ。詳しい言語仕様は<a href="https://developer.android.com/topic/libraries/data-binding/expressions?hl=ja">レイアウトとバインディング式</a>に書いてあるので見ていただきたいのですけど、たとえばKotlinの<code>if</code>は式なので、Kotlinのプログラマーは<code>val x = if (condition) &quot;OK&quot; else &quot;BAD&quot;</code>のように書くのに慣れていますけど、データ・バインディングのときは昔懐かしい三項演算子（<code>condition ? &quot;OK&quot; : &quot;BAD&quot;</code>）で書かないとダメだったりするんです。</p>
<p>やってられないので、あっさり諦めて<code>App</code>にプロパティを追加しました。<code>App</code>に追加というとやっちゃいけないことのように感じられますけど、本章の最後までやればViewModelへの追加となります。ViewModelはViewのためのものなのですから、この程度は良いんじゃないかなぁと。ViewModelがViewを呼び出すのはダメですけど、Viewのことを考えながらViewModelを作るのはアリなのですから。もちろん、こんなプロパティは無いほうがいいのですけど、でも、言語仕様がアレなんだもん。</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb66-1"><a href="#cb66-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb66-2"><a href="#cb66-2"></a></span>
<span id="cb66-3"><a href="#cb66-3"></a><span class="kw">import</span> <span class="im">android.app.Application</span></span>
<span id="cb66-4"><a href="#cb66-4"></a><span class="kw">import</span> <span class="im">android.util.Log</span></span>
<span id="cb66-5"><a href="#cb66-5"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.LiveData</span></span>
<span id="cb66-6"><a href="#cb66-6"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.MediatorLiveData</span></span>
<span id="cb66-7"><a href="#cb66-7"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.MutableLiveData</span></span>
<span id="cb66-8"><a href="#cb66-8"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.Transformations</span></span>
<span id="cb66-9"><a href="#cb66-9"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.AppDatabase</span></span>
<span id="cb66-10"><a href="#cb66-10"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.Route</span></span>
<span id="cb66-11"><a href="#cb66-11"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb66-12"><a href="#cb66-12"></a></span>
<span id="cb66-13"><a href="#cb66-13"></a><span class="kw">class</span> App: <span class="dt">Application</span>() {</span>
<span id="cb66-14"><a href="#cb66-14"></a>    ...</span>
<span id="cb66-15"><a href="#cb66-15"></a></span>
<span id="cb66-16"><a href="#cb66-16"></a>    <span class="kw">val</span> <span class="va">routeNames</span> = Transformations.map(routes) { routesValue -&gt;</span>
<span id="cb66-17"><a href="#cb66-17"></a>        routesValue.map { it.name }.joinToString(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb66-18"><a href="#cb66-18"></a>    }</span>
<span id="cb66-19"><a href="#cb66-19"></a></span>
<span id="cb66-20"><a href="#cb66-20"></a>    ...</span>
<span id="cb66-21"><a href="#cb66-21"></a>}</span></code></pre></div>
<p>最後。<code>BusApproachesFragment</code>を修正します。</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb67-1"><a href="#cb67-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb67-2"><a href="#cb67-2"></a></span>
<span id="cb67-3"><a href="#cb67-3"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb67-4"><a href="#cb67-4"></a><span class="kw">import</span> <span class="im">android.util.Log</span></span>
<span id="cb67-5"><a href="#cb67-5"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.Fragment</span></span>
<span id="cb67-6"><a href="#cb67-6"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb67-7"><a href="#cb67-7"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb67-8"><a href="#cb67-8"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb67-9"><a href="#cb67-9"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.FragmentBusApproachesBinding</span></span>
<span id="cb67-10"><a href="#cb67-10"></a><span class="kw">import</span> <span class="im">kotlin.concurrent.thread</span></span>
<span id="cb67-11"><a href="#cb67-11"></a></span>
<span id="cb67-12"><a href="#cb67-12"></a><span class="kw">class</span> BusApproachesFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb67-13"><a href="#cb67-13"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateView</span>(<span class="va">inflater</span>: <span class="dt">LayoutInflater</span>, <span class="va">container</span>: <span class="dt">ViewGroup?</span>, <span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>): <span class="dt">View?</span> {</span>
<span id="cb67-14"><a href="#cb67-14"></a>        <span class="kw">return</span> FragmentBusApproachesBinding.inflate(inflater, container, <span class="kw">false</span>).apply {</span>
<span id="cb67-15"><a href="#cb67-15"></a>            lifecycleOwner = viewLifecycleOwner</span>
<span id="cb67-16"><a href="#cb67-16"></a></span>
<span id="cb67-17"><a href="#cb67-17"></a>            app = (requireActivity().application <span class="kw">as</span> App)</span>
<span id="cb67-18"><a href="#cb67-18"></a></span>
<span id="cb67-19"><a href="#cb67-19"></a>            thread {</span>
<span id="cb67-20"><a href="#cb67-20"></a>                Thread.sleep(<span class="dv">5000</span>)</span>
<span id="cb67-21"><a href="#cb67-21"></a></span>
<span id="cb67-22"><a href="#cb67-22"></a>                (requireActivity().application <span class="kw">as</span> App).departureBusStopName.postValue(<span class="st">&quot;日本ユニシス本社前&quot;</span>)</span>
<span id="cb67-23"><a href="#cb67-23"></a>                Log.d(<span class="st">&quot;BusApproachesFragment&quot;</span>, <span class="st">&quot;MutableLiveData.postValue()&quot;</span>)</span>
<span id="cb67-24"><a href="#cb67-24"></a></span>
<span id="cb67-25"><a href="#cb67-25"></a>                Thread.sleep(<span class="dv">5000</span>)</span>
<span id="cb67-26"><a href="#cb67-26"></a></span>
<span id="cb67-27"><a href="#cb67-27"></a>                (requireActivity().application <span class="kw">as</span> App).departureBusStopName.postValue(<span class="st">&quot;深川第八中学校前&quot;</span>)</span>
<span id="cb67-28"><a href="#cb67-28"></a>            }</span>
<span id="cb67-29"><a href="#cb67-29"></a>        }.root</span>
<span id="cb67-30"><a href="#cb67-30"></a>    }</span>
<span id="cb67-31"><a href="#cb67-31"></a>}</span></code></pre></div>
<p>不要になった<code>observe()</code>メソッドの呼び出しをまるっと削除して、データ・バインディングが<code>LiveData</code>を監視できるように<code>lifeCycleOwner</code>プロパティを設定して、あと、<code>&lt;data&gt;</code>タグで設定した<code>app</code>プロパティを設定しているだけ。<code>thread { ... }</code>の部分はテスト用のコードで本番ではなくなりますから、かなりシンプルなコードです。こんな単純になっても、今までと同じ動作をしてくれるんですよ。</p>
<p>うん、LiveDataとデータ・バインディングは、コード量を激減させてくれて素晴らしいですな。</p>
<h2 id="repository">Repository</h2>
<p>やっとLiveDataが終わりましたから、あとはRepositoryを作るだけでViewModelを作れます。とはいっても、ただ普通に<code>class</code>を作るだけで、とある事情（後述するコルーチンを使わないと書きづらい）でWebサービス側はとりあえず作らないので、とても簡単なんですけどね。</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb68-1"><a href="#cb68-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb68-2"><a href="#cb68-2"></a></span>
<span id="cb68-3"><a href="#cb68-3"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb68-4"><a href="#cb68-4"></a><span class="kw">import</span> <span class="im">javax.inject.Singleton</span></span>
<span id="cb68-5"><a href="#cb68-5"></a></span>
<span id="cb68-6"><a href="#cb68-6"></a><span class="at">@Singleton</span></span>
<span id="cb68-7"><a href="#cb68-7"></a><span class="kw">class</span> Repository @Inject <span class="kw">constructor</span>(<span class="kw">private</span> <span class="kw">val</span> <span class="va">database</span>: <span class="dt">AppDatabase</span>) {</span>
<span id="cb68-8"><a href="#cb68-8"></a>    <span class="kw">fun</span> <span class="fu">getObservableBusStopsByDepartureBusStopName</span>(<span class="va">departureBusStopName</span>: <span class="dt">String</span>) = database.getBusStopDao().getObservablesByDepartureBusStopName(departureBusStopName)</span>
<span id="cb68-9"><a href="#cb68-9"></a>    <span class="kw">fun</span> <span class="fu">getObservableRoutesByDepartureBusStopNameAndArrivalBusStopName</span>(<span class="va">departureBusStopName</span>: <span class="dt">String</span>, <span class="va">arrivalBusStopName</span>: <span class="dt">String</span>) = database.getRouteDao().getObservablesByDepartureBusStopNameAndArrivalBusStopName(departureBusStopName, arrivalBusStopName)</span>
<span id="cb68-10"><a href="#cb68-10"></a>}</span></code></pre></div>
<p>はい、これだけ。<code>AppDatabase</code>のメソッドをラップしているだけです。<code>@Singleton</code>アノテーションや<code>@Inject</code>アノテーションが付いている理由は、もう少し後で。</p>
<h2 id="viewmodel">ViewModel</h2>
<p>ついにViewModelです。ここまで長かった……。ViewModelは、<code>ViewModel</code>を継承して作成します。</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb69-1"><a href="#cb69-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.view_model</span></span>
<span id="cb69-2"><a href="#cb69-2"></a></span>
<span id="cb69-3"><a href="#cb69-3"></a><span class="kw">import</span> <span class="im">android.util.Log</span></span>
<span id="cb69-4"><a href="#cb69-4"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.*</span></span>
<span id="cb69-5"><a href="#cb69-5"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.Repository</span></span>
<span id="cb69-6"><a href="#cb69-6"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.Route</span></span>
<span id="cb69-7"><a href="#cb69-7"></a></span>
<span id="cb69-8"><a href="#cb69-8"></a><span class="kw">class</span> BusApproachesViewModel(<span class="kw">private</span> <span class="kw">val</span> <span class="va">repository</span>: <span class="dt">Repository</span>): <span class="dt">ViewModel</span>() {</span>
<span id="cb69-9"><a href="#cb69-9"></a>    <span class="kw">val</span> <span class="va">departureBusStopName</span> = MutableLiveData&lt;<span class="kw">String</span>&gt;()</span>
<span id="cb69-10"><a href="#cb69-10"></a></span>
<span id="cb69-11"><a href="#cb69-11"></a>    <span class="kw">val</span> <span class="va">arrivalBusStops</span> = Transformations.switchMap(departureBusStopName) { arrivalBusStopNameValue -&gt;</span>
<span id="cb69-12"><a href="#cb69-12"></a>        repository.getObservableBusStopsByDepartureBusStopName(arrivalBusStopNameValue)</span>
<span id="cb69-13"><a href="#cb69-13"></a>    }</span>
<span id="cb69-14"><a href="#cb69-14"></a></span>
<span id="cb69-15"><a href="#cb69-15"></a>    <span class="kw">val</span> <span class="va">arrivalBusStopName</span> = Transformations.map(arrivalBusStops) { arrivalBusStopsValue -&gt;</span>
<span id="cb69-16"><a href="#cb69-16"></a>        <span class="cf">if</span> (arrivalBusStopsValue.isEmpty()) {</span>
<span id="cb69-17"><a href="#cb69-17"></a>            return<span class="at">@map</span> <span class="kw">null</span></span>
<span id="cb69-18"><a href="#cb69-18"></a>        }</span>
<span id="cb69-19"><a href="#cb69-19"></a></span>
<span id="cb69-20"><a href="#cb69-20"></a>        arrivalBusStopsValue[<span class="fl">0.</span>until(arrivalBusStopsValue.size).random()].name</span>
<span id="cb69-21"><a href="#cb69-21"></a>    }</span>
<span id="cb69-22"><a href="#cb69-22"></a></span>
<span id="cb69-23"><a href="#cb69-23"></a>    <span class="kw">val</span> <span class="va">routes</span> = MediatorLiveData&lt;List&lt;Route&gt;&gt;().apply {</span>
<span id="cb69-24"><a href="#cb69-24"></a>        <span class="kw">var</span> <span class="va">source</span>: LiveData&lt;List&lt;Route&gt;&gt;? = <span class="kw">null</span></span>
<span id="cb69-25"><a href="#cb69-25"></a></span>
<span id="cb69-26"><a href="#cb69-26"></a>        <span class="kw">fun</span> <span class="fu">update</span>() {</span>
<span id="cb69-27"><a href="#cb69-27"></a>            <span class="kw">val</span> <span class="va">departureBusStopNameValue</span> = departureBusStopName.value ?: <span class="kw">return</span></span>
<span id="cb69-28"><a href="#cb69-28"></a>            <span class="kw">val</span> <span class="va">arrivalBusStopNameValue</span>   = arrivalBusStopName.value   ?: <span class="kw">return</span></span>
<span id="cb69-29"><a href="#cb69-29"></a></span>
<span id="cb69-30"><a href="#cb69-30"></a>            source?.let {</span>
<span id="cb69-31"><a href="#cb69-31"></a>                removeSource(it)</span>
<span id="cb69-32"><a href="#cb69-32"></a>            }</span>
<span id="cb69-33"><a href="#cb69-33"></a></span>
<span id="cb69-34"><a href="#cb69-34"></a>            source = repository.getObservableRoutesByDepartureBusStopNameAndArrivalBusStopName(departureBusStopNameValue, arrivalBusStopNameValue).also {</span>
<span id="cb69-35"><a href="#cb69-35"></a>                addSource(it) { sourceValue -&gt;</span>
<span id="cb69-36"><a href="#cb69-36"></a>                    value = sourceValue</span>
<span id="cb69-37"><a href="#cb69-37"></a>                }</span>
<span id="cb69-38"><a href="#cb69-38"></a>            }</span>
<span id="cb69-39"><a href="#cb69-39"></a>        }</span>
<span id="cb69-40"><a href="#cb69-40"></a></span>
<span id="cb69-41"><a href="#cb69-41"></a>        addSource(departureBusStopName) { update() }</span>
<span id="cb69-42"><a href="#cb69-42"></a>        addSource(arrivalBusStopName)   { update() }</span>
<span id="cb69-43"><a href="#cb69-43"></a>    }</span>
<span id="cb69-44"><a href="#cb69-44"></a></span>
<span id="cb69-45"><a href="#cb69-45"></a>    <span class="kw">val</span> <span class="va">routeNames</span> = Transformations.map(routes) { routesValue -&gt;</span>
<span id="cb69-46"><a href="#cb69-46"></a>        routesValue.map { it.name }.joinToString(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb69-47"><a href="#cb69-47"></a>    }</span>
<span id="cb69-48"><a href="#cb69-48"></a>}</span></code></pre></div>
<p>……ここまでもったいぶっておいて何なのですけど、前述したように<code>ViewModel</code>を継承するようにして、これまでとりあえずAppに書いていたコードを移動させ、<code>AppDatabase</code>ではなく<code>Repository</code>のメソッドを呼び出すように修正しただけです。</p>
<h2 id="viewmodelをdaggerから取得する"><code>ViewModel</code>をDaggerから取得する</h2>
<p>では、ViewModelを使ってみましょう。ドキュメントの<a href="https://developer.android.com/topic/libraries/architecture/viewmodel?hl=ja">ViewModelの概要</a>を見ると、なるほど、<code>ViewModelProviders.of(this)[BusApproachesViewModel::class.java]</code>でインスタンスを取得できるのね……って、これではインスタンス生成が自動化されていて手が出せないので、<code>Repository</code>を引数にしてコンストラクタを呼び出すことできないじゃん！</p>
<p>同じ問題は<code>Activity</code>や<code>Fragment</code>で経験済みで、あのときはDaggerによるDependency Injectionで解決できました。でも、<code>ViewModel</code>からは<code>App</code>にアクセスできないので、同じ解決策は使えません……。</p>
<p>幸いなことに、Daggerは有名なプロダクトですから、いろいろな人が使い方を調べて解説を書いてくださっています。その一つが<a href="https://qiita.com/superman9387/items/bea94e4316c2ccf8fb68">ViewModelをDagger2でDIする</a>です。ありがてぇ。というわけで、ここに書いてある通りにすればオッケー。ちなみに、難しすぎて私は中身を理解できてません。たぶん、<code>ViewModelPrividesr</code>をいい感じに騙しているんだと思う。</p>
<p>というわけで、黙々と作業します。解説と順序は違いますが、まずは<code>ViewModelKey</code>アノテーションと<code>AppViewModelProviderFactory</code>を作成します。新規にUtility.ktを作成して、以下の内容を入力します。</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb70-1"><a href="#cb70-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb70-2"><a href="#cb70-2"></a></span>
<span id="cb70-3"><a href="#cb70-3"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.ViewModel</span></span>
<span id="cb70-4"><a href="#cb70-4"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.ViewModelProvider</span></span>
<span id="cb70-5"><a href="#cb70-5"></a><span class="kw">import</span> <span class="im">dagger.MapKey</span></span>
<span id="cb70-6"><a href="#cb70-6"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb70-7"><a href="#cb70-7"></a><span class="kw">import</span> <span class="im">javax.inject.Provider</span></span>
<span id="cb70-8"><a href="#cb70-8"></a><span class="kw">import</span> <span class="im">kotlin.reflect.KClass</span></span>
<span id="cb70-9"><a href="#cb70-9"></a></span>
<span id="cb70-10"><a href="#cb70-10"></a><span class="co">// ViewModel and Dagger.</span></span>
<span id="cb70-11"><a href="#cb70-11"></a></span>
<span id="cb70-12"><a href="#cb70-12"></a><span class="at">@Retention</span>(AnnotationRetention.RUNTIME)</span>
<span id="cb70-13"><a href="#cb70-13"></a><span class="at">@MapKey</span></span>
<span id="cb70-14"><a href="#cb70-14"></a>annotation <span class="kw">class</span> ViewModelKey(<span class="kw">val</span> <span class="va">value</span>: <span class="dt">KClass</span>&lt;<span class="kw">out</span> <span class="va">ViewModel</span>&gt;)</span>
<span id="cb70-15"><a href="#cb70-15"></a></span>
<span id="cb70-16"><a href="#cb70-16"></a><span class="kw">class</span> AppViewModelProvideFactory @Inject <span class="kw">constructor</span>(<span class="kw">private</span> <span class="kw">val</span> <span class="va">factories</span>: <span class="dt">Map</span>&lt;<span class="va">Class</span>&lt;<span class="kw">out</span> <span class="va">ViewModel</span>&gt;, @<span class="va">JvmSuppressWildcards</span> <span class="va">Provider</span>&lt;<span class="va">ViewModel</span>&gt;&gt;): <span class="dt">ViewModelProvider</span>.<span class="dt">Factory</span> {</span>
<span id="cb70-17"><a href="#cb70-17"></a>    <span class="at">@Suppress</span>(<span class="st">&quot;UNCHECKED_CAST&quot;</span>)</span>
<span id="cb70-18"><a href="#cb70-18"></a>    <span class="kw">override</span> <span class="kw">fun</span> &lt;<span class="dt">T</span>: <span class="dt">ViewModel</span>&gt; <span class="fu">create</span>(<span class="va">modelClass</span>: <span class="dt">Class</span>&lt;<span class="va">T</span>&gt;): <span class="dt">T</span> {</span>
<span id="cb70-19"><a href="#cb70-19"></a>        <span class="kw">return</span> factories.entries.find { modelClass.isAssignableFrom(it.key) }!!.value.<span class="kw">get</span>() <span class="kw">as</span> T</span>
<span id="cb70-20"><a href="#cb70-20"></a>    }</span>
<span id="cb70-21"><a href="#cb70-21"></a>}</span></code></pre></div>
<p><code>AppModule</code>はこんな感じ。</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb71-1"><a href="#cb71-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb71-2"><a href="#cb71-2"></a></span>
<span id="cb71-3"><a href="#cb71-3"></a><span class="kw">import</span> <span class="im">android.app.Application</span></span>
<span id="cb71-4"><a href="#cb71-4"></a><span class="kw">import</span> <span class="im">android.content.Context</span></span>
<span id="cb71-5"><a href="#cb71-5"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.ViewModel</span></span>
<span id="cb71-6"><a href="#cb71-6"></a><span class="kw">import</span> <span class="im">androidx.room.Room</span></span>
<span id="cb71-7"><a href="#cb71-7"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.AppDatabase</span></span>
<span id="cb71-8"><a href="#cb71-8"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.Repository</span></span>
<span id="cb71-9"><a href="#cb71-9"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.WebService</span></span>
<span id="cb71-10"><a href="#cb71-10"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.view_model.BusApproachesViewModel</span></span>
<span id="cb71-11"><a href="#cb71-11"></a><span class="kw">import</span> <span class="im">dagger.Module</span></span>
<span id="cb71-12"><a href="#cb71-12"></a><span class="kw">import</span> <span class="im">dagger.Provides</span></span>
<span id="cb71-13"><a href="#cb71-13"></a><span class="kw">import</span> <span class="im">dagger.multibindings.IntoMap</span></span>
<span id="cb71-14"><a href="#cb71-14"></a><span class="kw">import</span> <span class="im">okhttp3.OkHttpClient</span></span>
<span id="cb71-15"><a href="#cb71-15"></a><span class="kw">import</span> <span class="im">retrofit2.Retrofit</span></span>
<span id="cb71-16"><a href="#cb71-16"></a><span class="kw">import</span> <span class="im">retrofit2.converter.gson.GsonConverterFactory</span></span>
<span id="cb71-17"><a href="#cb71-17"></a><span class="kw">import</span> <span class="im">java.util.concurrent.TimeUnit</span></span>
<span id="cb71-18"><a href="#cb71-18"></a><span class="kw">import</span> <span class="im">javax.inject.Named</span></span>
<span id="cb71-19"><a href="#cb71-19"></a><span class="kw">import</span> <span class="im">javax.inject.Singleton</span></span>
<span id="cb71-20"><a href="#cb71-20"></a></span>
<span id="cb71-21"><a href="#cb71-21"></a><span class="at">@Module</span></span>
<span id="cb71-22"><a href="#cb71-22"></a><span class="kw">class</span> AppModule(<span class="kw">private</span> <span class="kw">val</span> <span class="va">application</span>: <span class="dt">Application</span>) {</span>
<span id="cb71-23"><a href="#cb71-23"></a>    ...</span>
<span id="cb71-24"><a href="#cb71-24"></a></span>
<span id="cb71-25"><a href="#cb71-25"></a>    <span class="at">@Provides</span></span>
<span id="cb71-26"><a href="#cb71-26"></a>    <span class="at">@Singleton</span></span>
<span id="cb71-27"><a href="#cb71-27"></a>    <span class="kw">fun</span> <span class="fu">provideDatabase</span>(<span class="va">context</span>: <span class="dt">Context</span>) = Room.databaseBuilder(context, AppDatabase::<span class="kw">class</span>.java, &quot;jetbus.db&quot;).build()</span>
<span id="cb71-28"><a href="#cb71-28"></a></span>
<span id="cb71-29"><a href="#cb71-29"></a>    @Provides</span>
<span id="cb71-30"><a href="#cb71-30"></a>    @IntoMap</span>
<span id="cb71-31"><a href="#cb71-31"></a>    @ViewModelKey(<span class="va">BusApproachesViewModel</span>::<span class="dt">class</span>)</span>
<span id="cb71-32"><a href="#cb71-32"></a>    <span class="kw">fun</span> provideBusApproachesViewModel(<span class="va">repository</span>: <span class="dt">Repository</span>) = BusApproachesViewModel(<span class="va">repository</span>) <span class="kw">as</span> ViewModel</span>
<span id="cb71-33"><a href="#cb71-33"></a>}</span></code></pre></div>
<p><code>AppComponent</code>に<code>BusApproachesFragment</code>に依存性を注入するメソッドの定義します。</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb72-1"><a href="#cb72-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb72-2"><a href="#cb72-2"></a></span>
<span id="cb72-3"><a href="#cb72-3"></a><span class="kw">import</span> <span class="im">dagger.Component</span></span>
<span id="cb72-4"><a href="#cb72-4"></a><span class="kw">import</span> <span class="im">javax.inject.Singleton</span></span>
<span id="cb72-5"><a href="#cb72-5"></a></span>
<span id="cb72-6"><a href="#cb72-6"></a><span class="at">@Singleton</span></span>
<span id="cb72-7"><a href="#cb72-7"></a><span class="at">@Component</span>(modules = [AppModule::<span class="kw">class</span>])</span>
<span id="cb72-8"><a href="#cb72-8"></a><span class="kw">interface</span> AppComponent {</span>
<span id="cb72-9"><a href="#cb72-9"></a>    <span class="kw">fun</span> <span class="fu">inject</span>(<span class="va">splashFragment</span>: <span class="dt">SplashFragment</span>)</span>
<span id="cb72-10"><a href="#cb72-10"></a>    <span class="kw">fun</span> <span class="fu">inject</span>(<span class="va">busApproachesFragment</span>: <span class="dt">BusApproachesFragment</span>)</span>
<span id="cb72-11"><a href="#cb72-11"></a>}</span></code></pre></div>
<p>この章で<code>App</code>に追加したコードを全部削除して、<code>BusApproachesFragment</code>を修正します。</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb73-1"><a href="#cb73-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb73-2"><a href="#cb73-2"></a></span>
<span id="cb73-3"><a href="#cb73-3"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb73-4"><a href="#cb73-4"></a><span class="kw">import</span> <span class="im">android.util.Log</span></span>
<span id="cb73-5"><a href="#cb73-5"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.Fragment</span></span>
<span id="cb73-6"><a href="#cb73-6"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb73-7"><a href="#cb73-7"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb73-8"><a href="#cb73-8"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb73-9"><a href="#cb73-9"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.viewModels</span></span>
<span id="cb73-10"><a href="#cb73-10"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.FragmentBusApproachesBinding</span></span>
<span id="cb73-11"><a href="#cb73-11"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.view_model.BusApproachesViewModel</span></span>
<span id="cb73-12"><a href="#cb73-12"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb73-13"><a href="#cb73-13"></a><span class="kw">import</span> <span class="im">kotlin.concurrent.thread</span></span>
<span id="cb73-14"><a href="#cb73-14"></a></span>
<span id="cb73-15"><a href="#cb73-15"></a><span class="kw">class</span> BusApproachesFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb73-16"><a href="#cb73-16"></a>    <span class="at">@Inject</span> lateinit <span class="kw">var</span> <span class="va">viewModelProviderFactory</span>: AppViewModelProvideFactory</span>
<span id="cb73-17"><a href="#cb73-17"></a></span>
<span id="cb73-18"><a href="#cb73-18"></a>    <span class="kw">private</span> <span class="kw">val</span> <span class="va">viewModel</span> <span class="kw">by</span> viewModels&lt;BusApproachesViewModel&gt; { viewModelProviderFactory }</span>
<span id="cb73-19"><a href="#cb73-19"></a></span>
<span id="cb73-20"><a href="#cb73-20"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateView</span>(<span class="va">inflater</span>: <span class="dt">LayoutInflater</span>, <span class="va">container</span>: <span class="dt">ViewGroup?</span>, <span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>): <span class="dt">View?</span> {</span>
<span id="cb73-21"><a href="#cb73-21"></a>        (requireActivity().application <span class="kw">as</span> App).component.inject(<span class="kw">this</span>)</span>
<span id="cb73-22"><a href="#cb73-22"></a></span>
<span id="cb73-23"><a href="#cb73-23"></a>        <span class="kw">return</span> FragmentBusApproachesBinding.inflate(inflater, container, <span class="kw">false</span>).apply {</span>
<span id="cb73-24"><a href="#cb73-24"></a>            lifecycleOwner = viewLifecycleOwner</span>
<span id="cb73-25"><a href="#cb73-25"></a>            viewModel      = this<span class="at">@BusApproachesFragment</span>.viewModel</span>
<span id="cb73-26"><a href="#cb73-26"></a></span>
<span id="cb73-27"><a href="#cb73-27"></a>            thread {</span>
<span id="cb73-28"><a href="#cb73-28"></a>                Thread.sleep(<span class="dv">5000</span>)</span>
<span id="cb73-29"><a href="#cb73-29"></a></span>
<span id="cb73-30"><a href="#cb73-30"></a>                viewModel.departureBusStopName.postValue(<span class="st">&quot;日本ユニシス本社前&quot;</span>)</span>
<span id="cb73-31"><a href="#cb73-31"></a>                Log.d(<span class="st">&quot;BusApproachesFragment&quot;</span>, <span class="st">&quot;MutableLiveData.postValue()&quot;</span>)</span>
<span id="cb73-32"><a href="#cb73-32"></a></span>
<span id="cb73-33"><a href="#cb73-33"></a>                Thread.sleep(<span class="dv">5000</span>)</span>
<span id="cb73-34"><a href="#cb73-34"></a></span>
<span id="cb73-35"><a href="#cb73-35"></a>                viewModel.departureBusStopName.postValue(<span class="st">&quot;深川第八中学校前&quot;</span>)</span>
<span id="cb73-36"><a href="#cb73-36"></a>            }</span>
<span id="cb73-37"><a href="#cb73-37"></a>        }.root</span>
<span id="cb73-38"><a href="#cb73-38"></a>    }</span>
<span id="cb73-39"><a href="#cb73-39"></a>}</span></code></pre></div>
<p>解説とは<code>ViewModel</code>の作成方法が違うじゃんと思われたと思いますが、これ、Android JetpackのKotlin向け便利機能なんです。</p>
<p>この書き方にしておくと、たとえば認証情報のような<code>Fragment</code>よりも生存期間が長い（別の<code>Fragment</code>に遷移したらまたIDとパスワード入力するなんてやってられないですよね？）ViewModelを使う場合に、<code>private val authorizationViewModel by activityViewModel&lt;AuthorizationViewModel&gt; { viewModelProviderFactory }</code>とするだけで、<code>ViewModel</code>の生存期間が<code>Activity</code>と同じになるのでとても便利ですよ。</p>
<p>はい、これで完成！　正しく動くか試してみましょう。</p>
<p>動画</p>
<p>うん、動いた……のですけど、確認のために<code>AppModule</code>を開いてソース・コードを眺めていたら、なんかちょっと気持ち悪い。<code>fun provideBusApproachesViewModel(repository: Repository) = BusApproachesViewModel(repository) as ViewModel</code>の<code>repository</code>は、どうやって取得したのでしょうか？　だって、<code>Repository</code>を<code>@Provides</code>するメソッドは定義していないんですよ？</p>
<p>その答えは「<code>@Inject</code>アノテーションが付いたコンストラクタを持つクラスは、自動で<code>@Provides</code>なメソッドを作成してくれるから」です。先程<code>Repository</code>を作成したときに、<code>@Singleton</code>アノテーションと<code>@Inject</code>アノテーションを追加しましたよね。この<code>@Inject</code>アノテーションが役に立ってくれたんです。</p>
<p>では<code>@Singleton</code>アノテーションは何なのかというと、<code>@Singleton</code>をDaggerで生成したい型に付加しておくと、<code>@Provides</code>メソッドを生成するときに<code>@Singleton</code>が自動で付くようになるんです。<code>Repository</code>は何個もいらないですもんね。というわけで、<code>AppModule</code>の<code>@Singleton</code>は生成対象の型に移動……させるという手は、<code>provideContext()</code>や<code>provideConsumerKey()</code>では使えません。書き方が統一できないとミスが発生しそうで怖いのですけど、しょうがないので、念の為に両方に書くという方式にしましょう。<code>AppDatabase</code>と<code>WebService</code>にも<code>@Singleton</code>を付加しておきます。</p>
<p>というわけで、コンストラクタに<code>@Inject</code>を書くだけで依存性を注入しまくれるんです。注入した依存性を活用できるのは<code>ViewModel</code>経由で呼び出す場合だけですけど、MVVMアーキテクチャを採用してアプリを組むのですから問題とはなりません。ほら、前章からの宿題だったDaggerをどうやって使うかが決まったでしょ？　これ以降は、依存性を注入したいならコンストラクタに<code>@Inject</code>を書くだけでよくなったんです。</p>
<p>まぁ、<code>Activity</code>や<code>Fragment</code>には、依存性を注入する処理を手で書かなければならないんだけどな。</p>
<h1 id="コルーチン">コルーチン</h1>
<p>もろもろ片付いたのでよーしパパ残りのViewModelも作っちゃうぞーと考えたのですけど、最初の画面の<code>SplashFragment</code>向けのViewModelでいきなり詰まってしまいました。RoomやRetrofit2はメイン・スレッドからは呼び出せないのですけど、スレッドどうしましょ？</p>
<p>ViewModelの中で<code>thread</code>で別スレッドを生成する……のは前の章で書いておいてアレなのですけど、ダメ、絶対。だって、生成されたスレッドは終了するまで生き残ってしまうんですから。ViewModelを作成してその中でスレッドを生成して、画面遷移して<code>Fragment</code>が終了するとかでViewModelを終了する。この場合でも、スレッドは処理が終わるまで動き続けます。で、もう一度同じ<code>Fragment</code>が表示されたりしてViewModelが生成されると、またスレッドが生成されちゃう。負荷が大きいことに加えて、処理が2重に動いてしまうんですよ。実は前の章までで作成したアプリにはこの問題に起因するバグがあって、<code>SplashFragment</code>でスレッドを生成してデータベースを更新しているときにスマートフォンを回転させたりすると、<code>Activity</code>が再生成されて<code>Fragment</code>が再生成されてデータベースを更新するスレッドがもう一つ動いて、データの不整合ができてアプリが落ちちゃうんです。</p>
<p>というわけで、スレッドの生存期間をViewModelと同じになるようにしなければなりません。そんなときに便利なのが、途中で処理を中断したり再開できたり、さらには中断したまま途中でやめちゃったりもできる、コルーチンなんです。</p>
<h2 id="途中で処理を中断再開">途中で処理を中断、再開？</h2>
<p>途中で処理を中断したり再開したりするというのがどういうことなのか、具体的なコードでご説明します。</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb74-1"><a href="#cb74-1"></a><span class="kw">fun</span> <span class="fu">useCoroutine</span>() {</span>
<span id="cb74-2"><a href="#cb74-2"></a>    runBlocking {  <span class="co">// とりあえず、runBlockingは無視してください……</span></span>
<span id="cb74-3"><a href="#cb74-3"></a>        <span class="cf">for</span> (i <span class="kw">in</span> <span class="fl">3.</span>downTo(<span class="dv">1</span>)) {</span>
<span id="cb74-4"><a href="#cb74-4"></a>            launch {</span>
<span id="cb74-5"><a href="#cb74-5"></a>                delay(i.toLong() * <span class="dv">1000</span>)</span>
<span id="cb74-6"><a href="#cb74-6"></a>                Log.d(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;${i}&quot;</span>)</span>
<span id="cb74-7"><a href="#cb74-7"></a>            }</span>
<span id="cb74-8"><a href="#cb74-8"></a>        }</span>
<span id="cb74-9"><a href="#cb74-9"></a>    }</span>
<span id="cb74-10"><a href="#cb74-10"></a>}</span></code></pre></div>
<p>このコードを実行すると、「1」のあとに「2」、そのあとに「3」が表示されます。<code>for</code>文は<code>3.downTo(1)</code>となっているので<code>i</code>の値は3、2、1の順なのですけど、<code>launch</code>の中身は非同期に実行され、<code>delay()</code>は指定した時間（ミリ秒）待つので、1,000ミリ秒待って「1」、2,000ミリ秒待って「2」、3,000ミリ秒まって「3」というループとは逆の順に出力されるというわけですな。</p>
<p>……ってそれ、<code>thread</code>と<code>Thread.sleep()</code>でも同じことができるのでは？　たとえば、こんなコードで。</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb75-1"><a href="#cb75-1"></a><span class="kw">fun</span> <span class="fu">useThread</span>() {</span>
<span id="cb75-2"><a href="#cb75-2"></a>    <span class="cf">for</span> (i <span class="kw">in</span> <span class="fl">3.</span>downTo(<span class="dv">1</span>)) {</span>
<span id="cb75-3"><a href="#cb75-3"></a>        thread {</span>
<span id="cb75-4"><a href="#cb75-4"></a>            Thread.sleep(i.toLong() * <span class="dv">1000</span>)</span>
<span id="cb75-5"><a href="#cb75-5"></a>            Log.d(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;${i}&quot;</span>)</span>
<span id="cb75-6"><a href="#cb75-6"></a>        }</span>
<span id="cb75-7"><a href="#cb75-7"></a>    }</span>
<span id="cb75-8"><a href="#cb75-8"></a>}</span></code></pre></div>
<p>はい、その通り。<code>thread</code>を使ったこのコードでも、確かに出力は同じになります。でも、<code>useCoroutine()</code>は実はとてもすごくて、<em>新しいスレッドを使わずに、すべてメイン・スレッドで実行</em>しているんです。確認してみましょう。</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb76-1"><a href="#cb76-1"></a><span class="kw">fun</span> <span class="fu">useCoroutine</span>() {</span>
<span id="cb76-2"><a href="#cb76-2"></a>    Log.d(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;Main thread id: ${Thread.currentThread().id}&quot;</span>)</span>
<span id="cb76-3"><a href="#cb76-3"></a></span>
<span id="cb76-4"><a href="#cb76-4"></a>    runBlocking {</span>
<span id="cb76-5"><a href="#cb76-5"></a>        <span class="cf">for</span> (i <span class="kw">in</span> <span class="fl">3.</span>downTo(<span class="dv">1</span>)) {</span>
<span id="cb76-6"><a href="#cb76-6"></a>            launch {</span>
<span id="cb76-7"><a href="#cb76-7"></a>                delay(i.toLong() * <span class="dv">1000</span>)</span>
<span id="cb76-8"><a href="#cb76-8"></a>                Log.d(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;${i}: ${Thread.currentThread().id}&quot;</span>)</span>
<span id="cb76-9"><a href="#cb76-9"></a>            }</span>
<span id="cb76-10"><a href="#cb76-10"></a>        }</span>
<span id="cb76-11"><a href="#cb76-11"></a>    }</span>
<span id="cb76-12"><a href="#cb76-12"></a>}</span>
<span id="cb76-13"><a href="#cb76-13"></a></span>
<span id="cb76-14"><a href="#cb76-14"></a><span class="kw">fun</span> <span class="fu">useThread</span>() {</span>
<span id="cb76-15"><a href="#cb76-15"></a>    Log.d(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;Main thread id: ${Thread.currentThread().id}&quot;</span>)</span>
<span id="cb76-16"><a href="#cb76-16"></a></span>
<span id="cb76-17"><a href="#cb76-17"></a>    <span class="cf">for</span> (i <span class="kw">in</span> <span class="fl">3.</span>downTo(<span class="dv">1</span>)) {</span>
<span id="cb76-18"><a href="#cb76-18"></a>        thread {</span>
<span id="cb76-19"><a href="#cb76-19"></a>            Thread.sleep(i.toLong() * <span class="dv">1000</span>)</span>
<span id="cb76-20"><a href="#cb76-20"></a>            Log.d(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;${i}: ${Thread.currentThread().id}&quot;</span>)</span>
<span id="cb76-21"><a href="#cb76-21"></a>        }</span>
<span id="cb76-22"><a href="#cb76-22"></a>    }</span>
<span id="cb76-23"><a href="#cb76-23"></a>}</span></code></pre></div>
<p>このコードを実行すると、<code>useCoroutine()</code>の方ではすべて同じスレッドIDが、<code>useThread()</code>の方ではすべて異なるスレッドIDが出力されます。ほら、<code>useCoroutine()</code>の方は、すべてメイン・スレッドで実行されているでしょ？</p>
<p>でも、一つのスレッドでは一つのことしかできないはずで、だから、「待つ」のと「出力」の両方は実行できないはず。でもできちゃっているのはなぜかといえば、実は<code>delay()</code>は「待つ」のではなく「中断」だからなんです。中断している間は他のコルーチンを実行できるので、だから並列処理に見えたというわけ。たとえば<code>delay(1000)</code>なら、中断して1,000ミリ秒たったら再開するという意味になるんですよ（とはいえ、メイン・スレッドで動く他の処理がいつまでも終わらなかったりするような場合は、1,000ミリ秒たっても再開されなかったりしますけど）。</p>
<h2 id="中断して実行するスレッドを変えて再開しちゃえ">中断して、実行するスレッドを変えて、再開しちゃえ！</h2>
<p>コルーチンのすごいのは、それだけじゃありません。実行するスレッドを変更することができるんです。</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb77-1"><a href="#cb77-1"></a>Log.d(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;Main thread id: ${Thread.currentThread().id}&quot;</span>)</span>
<span id="cb77-2"><a href="#cb77-2"></a></span>
<span id="cb77-3"><a href="#cb77-3"></a>runBlocking {</span>
<span id="cb77-4"><a href="#cb77-4"></a>    launch {</span>
<span id="cb77-5"><a href="#cb77-5"></a>        Log.d(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;Hello: ${Thread.currentThread().id}&quot;</span>)</span>
<span id="cb77-6"><a href="#cb77-6"></a></span>
<span id="cb77-7"><a href="#cb77-7"></a>        withContext(Dispatchers.IO) {</span>
<span id="cb77-8"><a href="#cb77-8"></a>            Log.d(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;Coroutines: ${Thread.currentThread().id}&quot;</span>)</span>
<span id="cb77-9"><a href="#cb77-9"></a>        }</span>
<span id="cb77-10"><a href="#cb77-10"></a></span>
<span id="cb77-11"><a href="#cb77-11"></a>        Log.d(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;World: ${Thread.currentThread().id}&quot;</span>)</span>
<span id="cb77-12"><a href="#cb77-12"></a>    }</span>
<span id="cb77-13"><a href="#cb77-13"></a>}</span></code></pre></div>
<p>上のコードを実行すると、<code>withContext()</code>の中だけスレッドIDが変わっていることが分かります。しかも、実行順序は「Hello」「Coroutines」「World」の順序を保っています。まぁ、中断して再開できるのですから、中断してゴニョゴニョして別のスレッドで再開できても不思議ではありませんよね？</p>
<p>なお、上のコードの<code>Dispatchers.IO</code>はファイル操作やデータベース・アクセス、Webサービス呼び出し等向けで、他には、<code>Dispatchers.Default</code>（バック・グラウンドでの計算処理など向け）、<code>Dispatchers.Main</code>（メイン・スレッド）があります。というわけで、<code>withContext(Dispatchers.IO) {}</code>すれば、データベース・アクセスもWebサービス呼び出しもやりたい放題ですよ。</p>
<h2 id="中断して途中でやめちゃえ">中断して、途中でやめちゃえ！</h2>
<p><code>ViewModel</code>の中で<code>viewModelScope.launch</code>した場合は、もっと面白いです。</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb78-1"><a href="#cb78-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.view_model</span></span>
<span id="cb78-2"><a href="#cb78-2"></a></span>
<span id="cb78-3"><a href="#cb78-3"></a><span class="kw">import</span> <span class="im">android.util.Log</span></span>
<span id="cb78-4"><a href="#cb78-4"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.*</span></span>
<span id="cb78-5"><a href="#cb78-5"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.Repository</span></span>
<span id="cb78-6"><a href="#cb78-6"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.Route</span></span>
<span id="cb78-7"><a href="#cb78-7"></a><span class="kw">import</span> <span class="im">kotlinx.coroutines.delay</span></span>
<span id="cb78-8"><a href="#cb78-8"></a><span class="kw">import</span> <span class="im">kotlinx.coroutines.launch</span></span>
<span id="cb78-9"><a href="#cb78-9"></a></span>
<span id="cb78-10"><a href="#cb78-10"></a><span class="kw">class</span> BusApproachesViewModel(<span class="kw">private</span> <span class="kw">val</span> <span class="va">repository</span>: <span class="dt">Repository</span>): <span class="dt">ViewModel</span>() {</span>
<span id="cb78-11"><a href="#cb78-11"></a>    ...</span>
<span id="cb78-12"><a href="#cb78-12"></a></span>
<span id="cb78-13"><a href="#cb78-13"></a>    <span class="kw">fun</span> <span class="fu">foo</span>() {</span>
<span id="cb78-14"><a href="#cb78-14"></a>        viewModelScope.launch {</span>
<span id="cb78-15"><a href="#cb78-15"></a>            <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb78-16"><a href="#cb78-16"></a>                delay(<span class="dv">1000</span>)</span>
<span id="cb78-17"><a href="#cb78-17"></a></span>
<span id="cb78-18"><a href="#cb78-18"></a>                Log.d(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;viewModelScope&quot;</span>)</span>
<span id="cb78-19"><a href="#cb78-19"></a>            }</span>
<span id="cb78-20"><a href="#cb78-20"></a>        }</span>
<span id="cb78-21"><a href="#cb78-21"></a>    }</span>
<span id="cb78-22"><a href="#cb78-22"></a>}</span></code></pre></div>
<p><code>runBlocking</code>と<code>launch</code>ではなく、<code>viewModelScope.launch</code>しています。中身は無限ループなので、いつまでも実行されるはず。</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb79-1"><a href="#cb79-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb79-2"><a href="#cb79-2"></a></span>
<span id="cb79-3"><a href="#cb79-3"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb79-4"><a href="#cb79-4"></a><span class="kw">import</span> <span class="im">android.util.Log</span></span>
<span id="cb79-5"><a href="#cb79-5"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.Fragment</span></span>
<span id="cb79-6"><a href="#cb79-6"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb79-7"><a href="#cb79-7"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb79-8"><a href="#cb79-8"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb79-9"><a href="#cb79-9"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.viewModels</span></span>
<span id="cb79-10"><a href="#cb79-10"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.FragmentBusApproachesBinding</span></span>
<span id="cb79-11"><a href="#cb79-11"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.view_model.BusApproachesViewModel</span></span>
<span id="cb79-12"><a href="#cb79-12"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb79-13"><a href="#cb79-13"></a><span class="kw">import</span> <span class="im">kotlin.concurrent.thread</span></span>
<span id="cb79-14"><a href="#cb79-14"></a></span>
<span id="cb79-15"><a href="#cb79-15"></a><span class="kw">class</span> BusApproachesFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb79-16"><a href="#cb79-16"></a>    <span class="at">@Inject</span> lateinit <span class="kw">var</span> <span class="va">viewModelProviderFactory</span>: AppViewModelProvideFactory</span>
<span id="cb79-17"><a href="#cb79-17"></a></span>
<span id="cb79-18"><a href="#cb79-18"></a>    <span class="kw">private</span> <span class="kw">val</span> <span class="va">viewModel</span> <span class="kw">by</span> viewModels&lt;BusApproachesViewModel&gt; { viewModelProviderFactory }</span>
<span id="cb79-19"><a href="#cb79-19"></a></span>
<span id="cb79-20"><a href="#cb79-20"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateView</span>(<span class="va">inflater</span>: <span class="dt">LayoutInflater</span>, <span class="va">container</span>: <span class="dt">ViewGroup?</span>, <span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>): <span class="dt">View?</span> {</span>
<span id="cb79-21"><a href="#cb79-21"></a>        (requireActivity().application <span class="kw">as</span> App).component.inject(<span class="kw">this</span>)</span>
<span id="cb79-22"><a href="#cb79-22"></a></span>
<span id="cb79-23"><a href="#cb79-23"></a>        viewModel.foo()</span>
<span id="cb79-24"><a href="#cb79-24"></a></span>
<span id="cb79-25"><a href="#cb79-25"></a>        <span class="kw">return</span> FragmentBusApproachesBinding.inflate(inflater, container, <span class="kw">false</span>).apply {</span>
<span id="cb79-26"><a href="#cb79-26"></a>            ...</span>
<span id="cb79-27"><a href="#cb79-27"></a>        }.root</span>
<span id="cb79-28"><a href="#cb79-28"></a>    }</span>
<span id="cb79-29"><a href="#cb79-29"></a>}</span></code></pre></div>
<p>こんな感じで、先程の無限ループする処理を呼び出しています。<code>delay(1000)</code>の間にメイン・スレッドは別の処理をできるのでユーザー・インターフェースが止まらず、それでいてもちろん、logcatにログが出力されます。で、それだけではなく、画面が遷移すると無限ループなのに処理が止まるんですよ！</p>
<p>中断して、再開しなければいい（あと、再開に必要な情報を破棄する）だけですもんね。うん、できるの分かってた。<code>viewModelScope</code>は<code>ViewModel</code>と同じライフ・サイクルを持っているので、画面が遷移して<code>ViewModel</code>が破棄されると処理が止まるというわけ。</p>
<p>あと、<code>viewModelScope</code>の他に、<code>Activity</code>や<code>Fragment</code>で使用できる<code>lifecycleScope</code>や、アプリと同じライフサイクルを持つ<code>GlobalScope</code>なんてものあります。でも、できるだけ<code>GlobalScope</code>は使わないでくださいね。</p>
<h2 id="関数に抽出しちゃえ">関数に抽出しちゃえ！</h2>
<p>さて、ここまでのコードに出てきた<code>launch {}</code>はコルーチンを生成するのですけど、その中に大きな処理を書くと可読性が下がってしまいますから、小さな関数に分割したい。でも、以下のコードはコンパイル・エラーになってしまうんです。</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb80-1"><a href="#cb80-1"></a><span class="kw">fun</span> <span class="fu">bar</span>() {</span>
<span id="cb80-2"><a href="#cb80-2"></a>    delay(<span class="dv">1000</span>)</span>
<span id="cb80-3"><a href="#cb80-3"></a></span>
<span id="cb80-4"><a href="#cb80-4"></a>    Log.d(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;viewModelScope&quot;</span>)</span>
<span id="cb80-5"><a href="#cb80-5"></a>}</span>
<span id="cb80-6"><a href="#cb80-6"></a></span>
<span id="cb80-7"><a href="#cb80-7"></a><span class="kw">fun</span> <span class="fu">foo</span>() {</span>
<span id="cb80-8"><a href="#cb80-8"></a>    viewModelScope.launch {</span>
<span id="cb80-9"><a href="#cb80-9"></a>        <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb80-10"><a href="#cb80-10"></a>            bar()</span>
<span id="cb80-11"><a href="#cb80-11"></a>        }</span>
<span id="cb80-12"><a href="#cb80-12"></a>    }</span>
<span id="cb80-13"><a href="#cb80-13"></a>}</span></code></pre></div>
<p>というのも、<code>delay()</code>はコルーチンの中だからできる特別な処理なわけで、だからコルーチンではない場所から呼び出されても困っちゃう。だから、コルーチンの中から呼び出す特別な関数とするために、<code>suspend</code>を付加しなければならないんです。</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb81-1"><a href="#cb81-1"></a>suspend <span class="kw">fun</span> <span class="fu">bar</span>() {  <span class="co">// suspendを付加</span></span>
<span id="cb81-2"><a href="#cb81-2"></a>    delay(<span class="dv">1000</span>)</span>
<span id="cb81-3"><a href="#cb81-3"></a></span>
<span id="cb81-4"><a href="#cb81-4"></a>    Log.d(<span class="st">&quot;xxx&quot;</span>, <span class="st">&quot;viewModelScope&quot;</span>)</span>
<span id="cb81-5"><a href="#cb81-5"></a>}</span>
<span id="cb81-6"><a href="#cb81-6"></a></span>
<span id="cb81-7"><a href="#cb81-7"></a><span class="kw">fun</span> <span class="fu">foo</span>() {</span>
<span id="cb81-8"><a href="#cb81-8"></a>    viewModelScope.launch {</span>
<span id="cb81-9"><a href="#cb81-9"></a>        <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb81-10"><a href="#cb81-10"></a>            bar()</span>
<span id="cb81-11"><a href="#cb81-11"></a>        }</span>
<span id="cb81-12"><a href="#cb81-12"></a>    }</span>
<span id="cb81-13"><a href="#cb81-13"></a>}</span></code></pre></div>
<p>はい、これでコンパイル通ります。なお、<code>suspend</code>な関数はコルーチン向けの特別な関数なので、コルーチンの外では呼び出せません。<code>launch {}</code>の中や<code>suspend</code>な関数の中から呼び出してください。</p>
<h2 id="splashfragmentのデータベースアクセスとwebサービス呼び出しをコルーチンにする">SplashFragmentのデータベース・アクセスとWebサービス呼び出しをコルーチンにする</h2>
<p>というわけでコルーチンの説明が終了したので（他にもいろいろな便利機能があるので、ぜひ<a href="https://kotlinlang.org/docs/reference/coroutines/coroutines-guide.html">公式ガイド</a>を読んでみてください）、アプリの実装を勧めましょう。</p>
<h3 id="repository-1"><code>Repository</code></h3>
<p>まずは、<code>Repository</code>にデータをクリアする<code>suspend</code>なメソッドと<a href="https://www.odpt.org/">公共交通オープンデータセンター</a>のWebサービスを呼び出してデータベースにキャッシュする<code>suspend</code>なメソッドを作ります。</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb82-1"><a href="#cb82-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb82-2"><a href="#cb82-2"></a></span>
<span id="cb82-3"><a href="#cb82-3"></a><span class="kw">import</span> <span class="im">android.util.Log</span></span>
<span id="cb82-4"><a href="#cb82-4"></a><span class="kw">import</span> <span class="im">androidx.room.withTransaction</span></span>
<span id="cb82-5"><a href="#cb82-5"></a><span class="kw">import</span> <span class="im">kotlinx.coroutines.Dispatchers</span></span>
<span id="cb82-6"><a href="#cb82-6"></a><span class="kw">import</span> <span class="im">kotlinx.coroutines.withContext</span></span>
<span id="cb82-7"><a href="#cb82-7"></a><span class="kw">import</span> <span class="im">retrofit2.Call</span></span>
<span id="cb82-8"><a href="#cb82-8"></a><span class="kw">import</span> <span class="im">java.io.IOException</span></span>
<span id="cb82-9"><a href="#cb82-9"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb82-10"><a href="#cb82-10"></a><span class="kw">import</span> <span class="im">javax.inject.Named</span></span>
<span id="cb82-11"><a href="#cb82-11"></a><span class="kw">import</span> <span class="im">javax.inject.Singleton</span></span>
<span id="cb82-12"><a href="#cb82-12"></a></span>
<span id="cb82-13"><a href="#cb82-13"></a><span class="at">@Singleton</span></span>
<span id="cb82-14"><a href="#cb82-14"></a><span class="kw">class</span> Repository @Inject <span class="kw">constructor</span>(<span class="kw">private</span> <span class="kw">val</span> <span class="va">database</span>: <span class="dt">AppDatabase</span>, <span class="kw">private</span> <span class="kw">val</span> <span class="va">webService</span>: <span class="dt">WebService</span>, @<span class="va">param</span>:<span class="dt">Named</span>(&quot;<span class="va">consumerKey</span>&quot;) <span class="kw">private</span> <span class="kw">val</span> consumerKey: <span class="dt">String</span>) {</span>
<span id="cb82-15"><a href="#cb82-15"></a>    suspend <span class="kw">fun</span> <span class="fu">clearDatabase</span>() = withContext(Dispatchers.IO) {</span>
<span id="cb82-16"><a href="#cb82-16"></a>        <span class="cf">try</span> {</span>
<span id="cb82-17"><a href="#cb82-17"></a>            database.withTransaction {</span>
<span id="cb82-18"><a href="#cb82-18"></a>                database.getTimeTableDetailDao().clear()</span>
<span id="cb82-19"><a href="#cb82-19"></a>                database.getTimeTableDao().clear()</span>
<span id="cb82-20"><a href="#cb82-20"></a>                database.getRouteBusStopPoleDao().clear()</span>
<span id="cb82-21"><a href="#cb82-21"></a>                database.getRouteDao().clear()</span>
<span id="cb82-22"><a href="#cb82-22"></a>                database.getBusStopPoleDao().clear()</span>
<span id="cb82-23"><a href="#cb82-23"></a>                database.getBusStopDao().clear()</span>
<span id="cb82-24"><a href="#cb82-24"></a>            }</span>
<span id="cb82-25"><a href="#cb82-25"></a></span>
<span id="cb82-26"><a href="#cb82-26"></a>            <span class="kw">Unit</span></span>
<span id="cb82-27"><a href="#cb82-27"></a></span>
<span id="cb82-28"><a href="#cb82-28"></a>        } <span class="cf">catch</span> (e: IOException) {</span>
<span id="cb82-29"><a href="#cb82-29"></a>            Log.e(<span class="st">&quot;Repository&quot;</span>, <span class="st">&quot;${e.message}&quot;</span>)</span>
<span id="cb82-30"><a href="#cb82-30"></a>            <span class="kw">null</span></span>
<span id="cb82-31"><a href="#cb82-31"></a>        }</span>
<span id="cb82-32"><a href="#cb82-32"></a>    }</span>
<span id="cb82-33"><a href="#cb82-33"></a></span>
<span id="cb82-34"><a href="#cb82-34"></a>    <span class="kw">private</span> <span class="kw">fun</span> &lt;<span class="dt">T</span>&gt; <span class="fu">getWebServiceResultBody</span>(<span class="va">callWebService</span>: () -&gt; <span class="dt">Call</span>&lt;<span class="va">T</span>&gt;): <span class="dt">T?</span> {</span>
<span id="cb82-35"><a href="#cb82-35"></a>        <span class="kw">val</span> <span class="va">response</span> = callWebService().execute()</span>
<span id="cb82-36"><a href="#cb82-36"></a></span>
<span id="cb82-37"><a href="#cb82-37"></a>        <span class="cf">if</span> (!response.isSuccessful) {</span>
<span id="cb82-38"><a href="#cb82-38"></a>            Log.e(<span class="st">&quot;Repository&quot;</span>, <span class="st">&quot;HTTP Error: ${response.code()}&quot;</span>)</span>
<span id="cb82-39"><a href="#cb82-39"></a>            <span class="kw">return</span> <span class="kw">null</span></span>
<span id="cb82-40"><a href="#cb82-40"></a>        }</span>
<span id="cb82-41"><a href="#cb82-41"></a></span>
<span id="cb82-42"><a href="#cb82-42"></a>        <span class="kw">return</span> response.body()</span>
<span id="cb82-43"><a href="#cb82-43"></a>    }</span>
<span id="cb82-44"><a href="#cb82-44"></a></span>
<span id="cb82-45"><a href="#cb82-45"></a>    suspend <span class="kw">fun</span> <span class="fu">syncDatabase</span>() = withContext(Dispatchers.IO) {</span>
<span id="cb82-46"><a href="#cb82-46"></a>        <span class="cf">try</span> {</span>
<span id="cb82-47"><a href="#cb82-47"></a>            <span class="cf">if</span> (database.getBusStopDao().getCount() &gt; <span class="dv">0</span>) {</span>
<span id="cb82-48"><a href="#cb82-48"></a>                return<span class="at">@withContext</span> <span class="kw">Unit</span></span>
<span id="cb82-49"><a href="#cb82-49"></a>            }</span>
<span id="cb82-50"><a href="#cb82-50"></a></span>
<span id="cb82-51"><a href="#cb82-51"></a>            <span class="kw">val</span> <span class="va">busStopPoleJsonArray</span> = getWebServiceResultBody { webService.busstopPole(consumerKey)     } ?: return<span class="at">@withContext</span> <span class="kw">null</span></span>
<span id="cb82-52"><a href="#cb82-52"></a>            <span class="kw">val</span> <span class="va">routeJsonArray</span> =       getWebServiceResultBody { webService.busroutePattern(consumerKey) } ?: return<span class="at">@withContext</span> <span class="kw">null</span></span>
<span id="cb82-53"><a href="#cb82-53"></a></span>
<span id="cb82-54"><a href="#cb82-54"></a>            database.withTransaction {</span>
<span id="cb82-55"><a href="#cb82-55"></a>                <span class="cf">for</span> (busStopPoleJsonObject <span class="kw">in</span> busStopPoleJsonArray.map { it.asJsonObject }.filter { it.<span class="kw">get</span>(<span class="st">&quot;odpt:operator&quot;</span>).asString == <span class="st">&quot;odpt.Operator:Toei&quot;</span> }) {</span>
<span id="cb82-56"><a href="#cb82-56"></a>                    <span class="kw">val</span> <span class="va">busStop</span> = database.getBusStopDao().getByName(busStopPoleJsonObject.<span class="kw">get</span>(<span class="st">&quot;dc:title&quot;</span>).asString) ?: run {</span>
<span id="cb82-57"><a href="#cb82-57"></a>                        BusStop(</span>
<span id="cb82-58"><a href="#cb82-58"></a>                            busStopPoleJsonObject.<span class="kw">get</span>(<span class="st">&quot;dc:title&quot;</span>).asString,</span>
<span id="cb82-59"><a href="#cb82-59"></a>                            busStopPoleJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:kana&quot;</span>)?.asString</span>
<span id="cb82-60"><a href="#cb82-60"></a>                        ).also {</span>
<span id="cb82-61"><a href="#cb82-61"></a>                            database.getBusStopDao().add(it)</span>
<span id="cb82-62"><a href="#cb82-62"></a>                        }</span>
<span id="cb82-63"><a href="#cb82-63"></a>                    }</span>
<span id="cb82-64"><a href="#cb82-64"></a></span>
<span id="cb82-65"><a href="#cb82-65"></a>                    BusStopPole(</span>
<span id="cb82-66"><a href="#cb82-66"></a>                        busStopPoleJsonObject.<span class="kw">get</span>(<span class="st">&quot;owl:sameAs&quot;</span>).asString,</span>
<span id="cb82-67"><a href="#cb82-67"></a>                        busStop.name</span>
<span id="cb82-68"><a href="#cb82-68"></a>                    ).also {</span>
<span id="cb82-69"><a href="#cb82-69"></a>                        database.getBusStopPoleDao().add(it)</span>
<span id="cb82-70"><a href="#cb82-70"></a>                    }</span>
<span id="cb82-71"><a href="#cb82-71"></a>                }</span>
<span id="cb82-72"><a href="#cb82-72"></a></span>
<span id="cb82-73"><a href="#cb82-73"></a>                <span class="cf">for</span> (routeJsonObject <span class="kw">in</span> routeJsonArray.map { it.asJsonObject }.filter { it.<span class="kw">get</span>(<span class="st">&quot;odpt:operator&quot;</span>).asString == <span class="st">&quot;odpt.Operator:Toei&quot;</span> }) {</span>
<span id="cb82-74"><a href="#cb82-74"></a>                    <span class="kw">val</span> <span class="va">route</span> = Route(</span>
<span id="cb82-75"><a href="#cb82-75"></a>                        routeJsonObject.<span class="kw">get</span>(<span class="st">&quot;owl:sameAs&quot;</span>).asString,</span>
<span id="cb82-76"><a href="#cb82-76"></a>                        routeJsonObject.<span class="kw">get</span>(<span class="st">&quot;dc:title&quot;</span>).asString</span>
<span id="cb82-77"><a href="#cb82-77"></a>                    ).also {</span>
<span id="cb82-78"><a href="#cb82-78"></a>                        database.getRouteDao().add(it)</span>
<span id="cb82-79"><a href="#cb82-79"></a>                    }</span>
<span id="cb82-80"><a href="#cb82-80"></a></span>
<span id="cb82-81"><a href="#cb82-81"></a>                    <span class="cf">for</span> (routeBusStopPoleJsonObject <span class="kw">in</span> routeJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:busstopPoleOrder&quot;</span>).asJsonArray.map { it.asJsonObject }) {</span>
<span id="cb82-82"><a href="#cb82-82"></a>                        RouteBusStopPole(</span>
<span id="cb82-83"><a href="#cb82-83"></a>                            route.id,</span>
<span id="cb82-84"><a href="#cb82-84"></a>                            routeBusStopPoleJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:index&quot;</span>).asInt,</span>
<span id="cb82-85"><a href="#cb82-85"></a>                            routeBusStopPoleJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:busstopPole&quot;</span>).asString</span>
<span id="cb82-86"><a href="#cb82-86"></a>                        ).also {</span>
<span id="cb82-87"><a href="#cb82-87"></a>                            it.id = database.getRouteBusStopPoleDao().add(it)</span>
<span id="cb82-88"><a href="#cb82-88"></a>                        }</span>
<span id="cb82-89"><a href="#cb82-89"></a>                    }</span>
<span id="cb82-90"><a href="#cb82-90"></a>                }</span>
<span id="cb82-91"><a href="#cb82-91"></a>            }</span>
<span id="cb82-92"><a href="#cb82-92"></a></span>
<span id="cb82-93"><a href="#cb82-93"></a>            <span class="kw">Unit</span></span>
<span id="cb82-94"><a href="#cb82-94"></a></span>
<span id="cb82-95"><a href="#cb82-95"></a>        } <span class="cf">catch</span> (e: IOException) {</span>
<span id="cb82-96"><a href="#cb82-96"></a>            Log.e(<span class="st">&quot;Repository&quot;</span>, <span class="st">&quot;${e.message}&quot;</span>)</span>
<span id="cb82-97"><a href="#cb82-97"></a>            <span class="kw">null</span></span>
<span id="cb82-98"><a href="#cb82-98"></a>        }</span>
<span id="cb82-99"><a href="#cb82-99"></a>    }</span>
<span id="cb82-100"><a href="#cb82-100"></a></span>
<span id="cb82-101"><a href="#cb82-101"></a>    ...</span>
<span id="cb82-102"><a href="#cb82-102"></a>}</span></code></pre></div>
<p>中身は、前に<code>SplashFragment</code>の中に書いたコードのほぼコピー＆ペーストです。変更点は、<code>clearDatabase()</code>と<code>syncDatabase()</code>に分割したのと、<code>withContext(Dispatchers.IO)</code>で囲んだのと、成功（Unit）か失敗（null）を返すようにしたこと（ラムダ式は最後に実行する行の値が返り値になります）と、毎回データを取得するのは時間がかかって嫌なので<code>if (database.getBusStopDao().getCount() &gt; 0)</code>なら処理をしないというチェック・ロジックを付加した（<code>getCount()</code>は<code>@Query(&quot;SELECT COUNT(*) FROM BusStop&quot;)</code>アノテーションで作成しました）のと、そのチェック・ロジックが正常に動作するように<code>database.withTransaction {}</code>で囲んだことくらい。Roomのところで説明し忘れたのですけど、<code>database.withTransaction {}</code>で囲むと処理がアトミックになる（完全にやるか、全くやらないかのどちらかになる）ので便利ですよ。</p>
<h3 id="splashviewmodel"><code>SplashViewModel</code></h3>
<p>次は<code>ViewModel</code>です。SplashViewModel.ktを追加して、以下のコードを書きました。</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb83-1"><a href="#cb83-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.view_model</span></span>
<span id="cb83-2"><a href="#cb83-2"></a></span>
<span id="cb83-3"><a href="#cb83-3"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.MutableLiveData</span></span>
<span id="cb83-4"><a href="#cb83-4"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.ViewModel</span></span>
<span id="cb83-5"><a href="#cb83-5"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.viewModelScope</span></span>
<span id="cb83-6"><a href="#cb83-6"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.Repository</span></span>
<span id="cb83-7"><a href="#cb83-7"></a><span class="kw">import</span> <span class="im">kotlinx.coroutines.launch</span></span>
<span id="cb83-8"><a href="#cb83-8"></a></span>
<span id="cb83-9"><a href="#cb83-9"></a><span class="kw">class</span> SplashViewModel(<span class="kw">private</span> <span class="kw">val</span> <span class="va">repository</span>: <span class="dt">Repository</span>): <span class="dt">ViewModel</span>() {</span>
<span id="cb83-10"><a href="#cb83-10"></a>    <span class="kw">val</span> <span class="va">isSyncDatabaseFinished</span> = MutableLiveData&lt;<span class="kw">Boolean</span>&gt;()</span>
<span id="cb83-11"><a href="#cb83-11"></a></span>
<span id="cb83-12"><a href="#cb83-12"></a>    init {</span>
<span id="cb83-13"><a href="#cb83-13"></a>        viewModelScope.launch {</span>
<span id="cb83-14"><a href="#cb83-14"></a>            repository.syncDatabase() ?: run { isSyncDatabaseFinished.value = <span class="kw">false</span>; return<span class="at">@launch</span> }</span>
<span id="cb83-15"><a href="#cb83-15"></a></span>
<span id="cb83-16"><a href="#cb83-16"></a>            isSyncDatabaseFinished.value = <span class="kw">true</span></span>
<span id="cb83-17"><a href="#cb83-17"></a>        }</span>
<span id="cb83-18"><a href="#cb83-18"></a>    }</span>
<span id="cb83-19"><a href="#cb83-19"></a>}</span></code></pre></div>
<p><code>init {}</code>には、インスタンスが生成されたときに実行する処理を記述します。本章の最初に書いたように、Webサービスを呼び出してデータベースにキャッシュするコルーチンは、<code>ViewModel</code>と同じライフサイクルを持っていて欲しい。だから生成と同時に<code>viewModelScope.launch {}</code>しているわけですな。<code>viewModelScope</code>で<code>launch</code>しているのでViewModelが破棄されればこのコルーチンは終了しますから、終了もバッチリ。アプリがバックグラウンドになればコルーチンが止まるので、他のアプリに迷惑をかけないですし。</p>
<p><code>isSyncDatabaseFinished</code>プロパティは、<code>syncDatabase()</code>が成功したか失敗したかを表現する目的で追加しました。ViewModelは<code>isSyncDatabaseFinished</code>を<code>observe()</code>して、正常に終了したら次の画面に遷移、そうでなければアプリケーションを終了するとかすればよいわけ。</p>
<h3 id="splashfragment"><code>SplashFragment</code></h3>
<p>というわけで、<code>SplashFragment</code>には<code>isSyncDatabaseFinished</code>を<code>observe()</code>する処理を追加して、その代わりにWebサービスを呼び出したりデータベースにアクセスしたりしていた処理をまるごと削除しました。こんな感じ。</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb84-1"><a href="#cb84-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb84-2"><a href="#cb84-2"></a></span>
<span id="cb84-3"><a href="#cb84-3"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb84-4"><a href="#cb84-4"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb84-5"><a href="#cb84-5"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb84-6"><a href="#cb84-6"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb84-7"><a href="#cb84-7"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.Fragment</span></span>
<span id="cb84-8"><a href="#cb84-8"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.viewModels</span></span>
<span id="cb84-9"><a href="#cb84-9"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.Observer</span></span>
<span id="cb84-10"><a href="#cb84-10"></a><span class="kw">import</span> <span class="im">androidx.navigation.fragment.findNavController</span></span>
<span id="cb84-11"><a href="#cb84-11"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.FragmentSplashBinding</span></span>
<span id="cb84-12"><a href="#cb84-12"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.view_model.SplashViewModel</span></span>
<span id="cb84-13"><a href="#cb84-13"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb84-14"><a href="#cb84-14"></a></span>
<span id="cb84-15"><a href="#cb84-15"></a><span class="kw">class</span> SplashFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb84-16"><a href="#cb84-16"></a>    <span class="at">@Inject</span> lateinit <span class="kw">var</span> <span class="va">viewModelProviderFactory</span>: AppViewModelProvideFactory</span>
<span id="cb84-17"><a href="#cb84-17"></a></span>
<span id="cb84-18"><a href="#cb84-18"></a>    <span class="kw">private</span> <span class="kw">val</span> <span class="va">viewModel</span> <span class="kw">by</span> viewModels&lt;SplashViewModel&gt; { viewModelProviderFactory }</span>
<span id="cb84-19"><a href="#cb84-19"></a></span>
<span id="cb84-20"><a href="#cb84-20"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateView</span>(<span class="va">inflater</span>: <span class="dt">LayoutInflater</span>, <span class="va">container</span>: <span class="dt">ViewGroup?</span>, <span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>): <span class="dt">View?</span> {</span>
<span id="cb84-21"><a href="#cb84-21"></a>        (requireActivity().application <span class="kw">as</span> App).component.inject(<span class="kw">this</span>)</span>
<span id="cb84-22"><a href="#cb84-22"></a></span>
<span id="cb84-23"><a href="#cb84-23"></a>        viewModel.isSyncDatabaseFinished.observe(viewLifecycleOwner, Observer {</span>
<span id="cb84-24"><a href="#cb84-24"></a>            <span class="cf">if</span> (!it) {</span>
<span id="cb84-25"><a href="#cb84-25"></a>                requireActivity().finish()</span>
<span id="cb84-26"><a href="#cb84-26"></a>                return<span class="at">@Observer</span></span>
<span id="cb84-27"><a href="#cb84-27"></a>            }</span>
<span id="cb84-28"><a href="#cb84-28"></a></span>
<span id="cb84-29"><a href="#cb84-29"></a>            findNavController().navigate(SplashFragmentDirections.splashFragmentToBookmarksFragment())</span>
<span id="cb84-30"><a href="#cb84-30"></a>        })</span>
<span id="cb84-31"><a href="#cb84-31"></a></span>
<span id="cb84-32"><a href="#cb84-32"></a>        <span class="kw">return</span> FragmentSplashBinding.inflate(inflater, container, <span class="kw">false</span>).root</span>
<span id="cb84-33"><a href="#cb84-33"></a>    }</span>
<span id="cb84-34"><a href="#cb84-34"></a>}</span></code></pre></div>
<p>うん、スッキリしました（<code>isSyncDatabaseFinished</code>が<code>Unit?</code>ならエルビス演算子が使えてもっとスッキリするのですけど、プロパティ名を「is」で始めたので<code>Boolean</code>にせざるを得なかった……）。</p>
<p>というわけで、これで自動で画面遷移するようになったのでもうボタンは不要になりましたから、<code>fragment_splash.xml</code>を以下に変更します。</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb85-1"><a href="#cb85-1"></a>&lt;?xml version=<span class="st">&quot;1.0&quot;</span> encoding=<span class="st">&quot;utf-8&quot;</span>?&gt;</span>
<span id="cb85-2"><a href="#cb85-2"></a>&lt;layout</span>
<span id="cb85-3"><a href="#cb85-3"></a>    xmlns:android=<span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb85-4"><a href="#cb85-4"></a>    xmlns:tools=<span class="st">&quot;http://schemas.android.com/tools&quot;</span></span>
<span id="cb85-5"><a href="#cb85-5"></a>    xmlns:app=<span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span>
<span id="cb85-6"><a href="#cb85-6"></a>    tools:context=<span class="st">&quot;.SplashFragment&quot;</span>&gt;</span>
<span id="cb85-7"><a href="#cb85-7"></a></span>
<span id="cb85-8"><a href="#cb85-8"></a>    &lt;androidx.constraintlayout.widget.ConstraintLayout</span>
<span id="cb85-9"><a href="#cb85-9"></a>        android:layout_width=<span class="st">&quot;match_parent&quot;</span></span>
<span id="cb85-10"><a href="#cb85-10"></a>        android:layout_height=<span class="st">&quot;match_parent&quot;</span>&gt;</span>
<span id="cb85-11"><a href="#cb85-11"></a></span>
<span id="cb85-12"><a href="#cb85-12"></a>        &lt;ImageView</span>
<span id="cb85-13"><a href="#cb85-13"></a>            android:id=<span class="st">&quot;@+id/icon&quot;</span></span>
<span id="cb85-14"><a href="#cb85-14"></a>            android:layout_width=<span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb85-15"><a href="#cb85-15"></a>            android:layout_height=<span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb85-16"><a href="#cb85-16"></a>            android:layout_marginBottom=<span class="st">&quot;8dp&quot;</span></span>
<span id="cb85-17"><a href="#cb85-17"></a>            app:layout_constraintStart_toStartOf=<span class="st">&quot;@id/nowDownloadingTextView&quot;</span></span>
<span id="cb85-18"><a href="#cb85-18"></a>            app:layout_constraintEnd_toEndOf=<span class="st">&quot;@id/nowDownloadingTextView&quot;</span></span>
<span id="cb85-19"><a href="#cb85-19"></a>            app:layout_constraintBottom_toTopOf=<span class="st">&quot;@id/nowDownloadingTextView&quot;</span></span>
<span id="cb85-20"><a href="#cb85-20"></a>            android:contentDescription=<span class="st">&quot;@string/app_name&quot;</span></span>
<span id="cb85-21"><a href="#cb85-21"></a>            android:src=<span class="st">&quot;@mipmap/ic_launcher_round&quot;</span> /&gt;</span>
<span id="cb85-22"><a href="#cb85-22"></a></span>
<span id="cb85-23"><a href="#cb85-23"></a>        &lt;TextView</span>
<span id="cb85-24"><a href="#cb85-24"></a>            android:id=<span class="st">&quot;@+id/nowDownloadingTextView&quot;</span></span>
<span id="cb85-25"><a href="#cb85-25"></a>            android:layout_width=<span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb85-26"><a href="#cb85-26"></a>            android:layout_height=<span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb85-27"><a href="#cb85-27"></a>            app:layout_constraintStart_toStartOf=<span class="st">&quot;parent&quot;</span></span>
<span id="cb85-28"><a href="#cb85-28"></a>            app:layout_constraintEnd_toEndOf=<span class="st">&quot;parent&quot;</span></span>
<span id="cb85-29"><a href="#cb85-29"></a>            app:layout_constraintTop_toTopOf=<span class="st">&quot;parent&quot;</span></span>
<span id="cb85-30"><a href="#cb85-30"></a>            app:layout_constraintBottom_toBottomOf=<span class="st">&quot;parent&quot;</span></span>
<span id="cb85-31"><a href="#cb85-31"></a>            android:text=<span class="st">&quot;バス停と路線の情報を取得しています……&quot;</span> /&gt;</span>
<span id="cb85-32"><a href="#cb85-32"></a></span>
<span id="cb85-33"><a href="#cb85-33"></a>        &lt;ProgressBar</span>
<span id="cb85-34"><a href="#cb85-34"></a>            android:layout_width=<span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb85-35"><a href="#cb85-35"></a>            android:layout_height=<span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb85-36"><a href="#cb85-36"></a>            android:layout_marginTop=<span class="st">&quot;8dp&quot;</span></span>
<span id="cb85-37"><a href="#cb85-37"></a>            app:layout_constraintStart_toStartOf=<span class="st">&quot;@id/nowDownloadingTextView&quot;</span></span>
<span id="cb85-38"><a href="#cb85-38"></a>            app:layout_constraintEnd_toEndOf=<span class="st">&quot;@id/nowDownloadingTextView&quot;</span></span>
<span id="cb85-39"><a href="#cb85-39"></a>            app:layout_constraintTop_toBottomOf=<span class="st">&quot;@id/nowDownloadingTextView&quot;</span> /&gt;</span>
<span id="cb85-40"><a href="#cb85-40"></a></span>
<span id="cb85-41"><a href="#cb85-41"></a>    &lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span>
<span id="cb85-42"><a href="#cb85-42"></a></span>
<span id="cb85-43"><a href="#cb85-43"></a>&lt;/layout&gt;</span></code></pre></div>
<p>アイコンと、何をしているのかの説明と、あとは処理に時間がかかるので<code>&lt;ProgressBar&gt;</code>という名前のぐるぐるアイコンですな。これで<code>SpashFragment</code>は完成です。</p>
<h3 id="mainactivity"><code>MainActivity</code></h3>
<p>でも、このままだと一回<code>syncDatabase()</code>に成功しちゃうと次からは実行しないので、コードが正しいのかよく分かりません……。なので、<code>menu_navigation.xml</code>に追加したきりすっかり忘れていた<code>&lt;item android:id=&quot;@+id/clearDatabase&quot; android:title=&quot;バス停と路線のデータを再取得&quot; /&gt;</code>のリスナーを作成しましょう。</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb86-1"><a href="#cb86-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb86-2"><a href="#cb86-2"></a></span>
<span id="cb86-3"><a href="#cb86-3"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb86-4"><a href="#cb86-4"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb86-5"><a href="#cb86-5"></a><span class="kw">import</span> <span class="im">androidx.activity.viewModels</span></span>
<span id="cb86-6"><a href="#cb86-6"></a><span class="kw">import</span> <span class="im">androidx.appcompat.app.AppCompatActivity</span></span>
<span id="cb86-7"><a href="#cb86-7"></a><span class="kw">import</span> <span class="im">androidx.core.view.GravityCompat</span></span>
<span id="cb86-8"><a href="#cb86-8"></a><span class="kw">import</span> <span class="im">androidx.databinding.DataBindingUtil</span></span>
<span id="cb86-9"><a href="#cb86-9"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.lifecycleScope</span></span>
<span id="cb86-10"><a href="#cb86-10"></a><span class="kw">import</span> <span class="im">androidx.navigation.findNavController</span></span>
<span id="cb86-11"><a href="#cb86-11"></a><span class="kw">import</span> <span class="im">androidx.navigation.ui.AppBarConfiguration</span></span>
<span id="cb86-12"><a href="#cb86-12"></a><span class="kw">import</span> <span class="im">androidx.navigation.ui.NavigationUI</span></span>
<span id="cb86-13"><a href="#cb86-13"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.ActivityMainBinding</span></span>
<span id="cb86-14"><a href="#cb86-14"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.view_model.MainViewModel</span></span>
<span id="cb86-15"><a href="#cb86-15"></a><span class="kw">import</span> <span class="im">kotlinx.coroutines.launch</span></span>
<span id="cb86-16"><a href="#cb86-16"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb86-17"><a href="#cb86-17"></a></span>
<span id="cb86-18"><a href="#cb86-18"></a><span class="kw">class</span> MainActivity: <span class="dt">AppCompatActivity</span>() {</span>
<span id="cb86-19"><a href="#cb86-19"></a>    <span class="at">@Inject</span> lateinit <span class="kw">var</span> <span class="va">viewModelProviderFactory</span>: AppViewModelProvideFactory</span>
<span id="cb86-20"><a href="#cb86-20"></a></span>
<span id="cb86-21"><a href="#cb86-21"></a>    <span class="kw">private</span> <span class="kw">val</span> <span class="va">viewModel</span> <span class="kw">by</span> viewModels&lt;MainViewModel&gt; { viewModelProviderFactory }</span>
<span id="cb86-22"><a href="#cb86-22"></a></span>
<span id="cb86-23"><a href="#cb86-23"></a>    <span class="kw">private</span> lateinit <span class="kw">var</span> <span class="va">binding</span>: ActivityMainBinding</span>
<span id="cb86-24"><a href="#cb86-24"></a></span>
<span id="cb86-25"><a href="#cb86-25"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreate</span>(<span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>) {</span>
<span id="cb86-26"><a href="#cb86-26"></a>        <span class="kw">super</span>.onCreate(savedInstanceState)</span>
<span id="cb86-27"><a href="#cb86-27"></a></span>
<span id="cb86-28"><a href="#cb86-28"></a>        (application <span class="kw">as</span> App).component.inject(<span class="kw">this</span>)</span>
<span id="cb86-29"><a href="#cb86-29"></a></span>
<span id="cb86-30"><a href="#cb86-30"></a>        binding = DataBindingUtil.setContentView&lt;ActivityMainBinding&gt;(<span class="kw">this</span>, R.layout.activity_main).apply {</span>
<span id="cb86-31"><a href="#cb86-31"></a>            navigationView.setNavigationItemSelectedListener {</span>
<span id="cb86-32"><a href="#cb86-32"></a>                <span class="cf">when</span> (it.itemId) {</span>
<span id="cb86-33"><a href="#cb86-33"></a>                    R.id.clearDatabase -&gt; run {</span>
<span id="cb86-34"><a href="#cb86-34"></a>                        lifecycleScope.launch {</span>
<span id="cb86-35"><a href="#cb86-35"></a>                            viewModel.clearDatabase()</span>
<span id="cb86-36"><a href="#cb86-36"></a>                            findNavController(R.id.navHostFragment).navigate(R.id.splashFragment)</span>
<span id="cb86-37"><a href="#cb86-37"></a>                        }</span>
<span id="cb86-38"><a href="#cb86-38"></a></span>
<span id="cb86-39"><a href="#cb86-39"></a>                        <span class="kw">true</span></span>
<span id="cb86-40"><a href="#cb86-40"></a>                    }</span>
<span id="cb86-41"><a href="#cb86-41"></a>                    <span class="cf">else</span> -&gt; <span class="kw">false</span></span>
<span id="cb86-42"><a href="#cb86-42"></a></span>
<span id="cb86-43"><a href="#cb86-43"></a>                }.also {</span>
<span id="cb86-44"><a href="#cb86-44"></a>                    <span class="cf">if</span> (!it) {</span>
<span id="cb86-45"><a href="#cb86-45"></a>                        return<span class="at">@also</span></span>
<span id="cb86-46"><a href="#cb86-46"></a>                    }</span>
<span id="cb86-47"><a href="#cb86-47"></a></span>
<span id="cb86-48"><a href="#cb86-48"></a>                    drawerLayout.closeDrawer(GravityCompat.START)</span>
<span id="cb86-49"><a href="#cb86-49"></a>                }</span>
<span id="cb86-50"><a href="#cb86-50"></a>            }</span>
<span id="cb86-51"><a href="#cb86-51"></a></span>
<span id="cb86-52"><a href="#cb86-52"></a>        }.also {</span>
<span id="cb86-53"><a href="#cb86-53"></a>            findNavController(R.id.navHostFragment).apply {</span>
<span id="cb86-54"><a href="#cb86-54"></a>                NavigationUI.setupWithNavController(it.toolbar, <span class="kw">this</span>, AppBarConfiguration(setOf(R.id.bookmarksFragment), it.drawerLayout))</span>
<span id="cb86-55"><a href="#cb86-55"></a></span>
<span id="cb86-56"><a href="#cb86-56"></a>                addOnDestinationChangedListener { _, destination, _ -&gt;</span>
<span id="cb86-57"><a href="#cb86-57"></a>                    it.appBarLayout.visibility = <span class="cf">if</span> (destination.id == R.id.splashFragment) View.GONE <span class="cf">else</span> View.VISIBLE</span>
<span id="cb86-58"><a href="#cb86-58"></a>                }</span>
<span id="cb86-59"><a href="#cb86-59"></a>            }</span>
<span id="cb86-60"><a href="#cb86-60"></a>        }</span>
<span id="cb86-61"><a href="#cb86-61"></a>    }</span>
<span id="cb86-62"><a href="#cb86-62"></a></span>
<span id="cb86-63"><a href="#cb86-63"></a>    ...</span>
<span id="cb86-64"><a href="#cb86-64"></a>}</span></code></pre></div>
<p><code>SplashViewModel</code>のときのように<code>clearDatabase()</code>が完了したかどうかを表現するプロパティを追加する方式だとコード量が増えてしまうので、今回は<code>lifecycleScope.launch {}</code>することにしました。</p>
<p><code>MainViewModel</code>の中身は、以下のようにとても単純です。</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb87-1"><a href="#cb87-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.view_model</span></span>
<span id="cb87-2"><a href="#cb87-2"></a></span>
<span id="cb87-3"><a href="#cb87-3"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.ViewModel</span></span>
<span id="cb87-4"><a href="#cb87-4"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.Repository</span></span>
<span id="cb87-5"><a href="#cb87-5"></a></span>
<span id="cb87-6"><a href="#cb87-6"></a><span class="kw">class</span> MainViewModel(<span class="kw">private</span> <span class="kw">val</span> <span class="va">repository</span>: <span class="dt">Repository</span>): <span class="dt">ViewModel</span>() {</span>
<span id="cb87-7"><a href="#cb87-7"></a>    suspend <span class="kw">fun</span> <span class="fu">clearDatabase</span>() = repository.clearDatabase()</span>
<span id="cb87-8"><a href="#cb87-8"></a>}</span></code></pre></div>
<p><code>Repository</code>のメソッドを呼び出し直しているだけ。あとは、前の章で紹介した手順で<code>ViewModel</code>をDaggerで注入可能にすれば、作業終了です。ぜひ実際に動かしてみてください。ほらこのアプリ、端末を回転させても正常に動作するんです！</p>
<p>……そんなの当たり前だと思うかもしれませんけど、Androidアプリ開発ではこの程度でも大変だったんだよ。</p>
<h1 id="recyclerview">RecyclerView</h1>
<p>と、ここまでいろいろ作ってきましたけど、なのにいまだに画面がスカスカで悲しい……。画面を作りましょう。使うのは、これを覚えるだけで閲覧系のアプリなら大体どうにかなっちゃうという噂の<code>RecyclerView</code>です。</p>
<h2 id="リサイクル">リサイクル？</h2>
<p><code>RecyclerView</code>は、スクロール可能なリストを作成するGUIウィジェットです。特徴は大規模なデータ・セットに対応可能なこと（大は小を兼ねるので、小さなデータ・セットで使っても特に問題はありませんけど）。</p>
<p>で、この「大規模」という点が、<code>RecyclerView</code>という名前つながります。Androidの画面は<code>View</code>（本稿でも、文字を表示するための<code>TextView</code>とかを使いましたよね？）で構成されるので、リストの各行も<code>View</code>で構成されます。画面を上にスクロールすると、上の行が画面の外側に消えて下に新しい行が表示されるわけですが、その際に画面の外側に消えた行の<code>View</code>をどうしましょうか？　放っておくとメモリに負荷がかかるし、ガベージ・コレクションの際にはCPUに負荷がかかっちゃう。だから、下から出てくる新しい行の<code>View</code>としてリサイクルしたい。これを自動でやってくれるのが<code>RecyclerView</code>というわけ。</p>
<p>実装の詳細で名前を決めるのは悪いスタイルだとは思うんだけど、でも、<code>ListView</code>って名前はすでに使われていたし、<code>ListView</code>と<code>RecyclerView</code>の一番大きな違いはリサイクルするところなんだしね……。</p>
<h2 id="viewholderとdiffcallbackとadapterを作る"><code>ViewHolder</code>と<code>DiffCallback</code>とAdapterを作る</h2>
<p>リストを表示する場合、リストそのものを管理する人とリストの要素を管理する人を分けた方が楽になります。<code>List&lt;MyClass&gt;</code>って分割するのと一緒。<code>RecyclerView</code>の場合、リストの要素は<code>ViewHolder</code>で管理します。で、<code>ViewHolder</code>と<code>RecyclerView</code>を繋げるのが<code>ListAdapter</code>。まずはこの<code>ViewHolder</code>の説明から。</p>
<p><code>RecyclerView</code>は<code>View</code>をリサイクルするので、これまでは会社の前のバス停を表示していた<code>View</code>に対して、これからは私のアパートの近くのバス停を表示するように指示できなければなりません。これは、前に説明したデータ・バインディングで実現すれば簡単でしょう。レイアウトのXMLの<code>&lt;data&gt;</code>タグの中身を変えちゃえばいいんですからね。</p>
<p>というわけで、たとえばバス停をリスト表示する<code>ViewHolder</code>向けのレイアウトXMLは以下のようになります。名前はlist_item_bus_stop.xmlにしましょう。</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb88-1"><a href="#cb88-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb88-2"><a href="#cb88-2"></a><span class="kw">&lt;layout</span></span>
<span id="cb88-3"><a href="#cb88-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb88-4"><a href="#cb88-4"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span><span class="kw">&gt;</span></span>
<span id="cb88-5"><a href="#cb88-5"></a></span>
<span id="cb88-6"><a href="#cb88-6"></a>    <span class="kw">&lt;data&gt;</span></span>
<span id="cb88-7"><a href="#cb88-7"></a>        <span class="kw">&lt;variable</span><span class="ot"> name=</span><span class="st">&quot;item&quot;</span><span class="ot"> type=</span><span class="st">&quot;com.tail_island.jetbus.model.BusStop&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb88-8"><a href="#cb88-8"></a>    <span class="kw">&lt;/data&gt;</span></span>
<span id="cb88-9"><a href="#cb88-9"></a></span>
<span id="cb88-10"><a href="#cb88-10"></a>    <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb88-11"><a href="#cb88-11"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb88-12"><a href="#cb88-12"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span><span class="kw">&gt;</span></span>
<span id="cb88-13"><a href="#cb88-13"></a></span>
<span id="cb88-14"><a href="#cb88-14"></a>        <span class="kw">&lt;com.google.android.material.button.MaterialButton</span></span>
<span id="cb88-15"><a href="#cb88-15"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/busStopButton&quot;</span></span>
<span id="cb88-16"><a href="#cb88-16"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb88-17"><a href="#cb88-17"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb88-18"><a href="#cb88-18"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb88-19"><a href="#cb88-19"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb88-20"><a href="#cb88-20"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb88-21"><a href="#cb88-21"></a><span class="ot">            android:gravity=</span><span class="st">&quot;start|center_vertical&quot;</span></span>
<span id="cb88-22"><a href="#cb88-22"></a><span class="ot">            style=</span><span class="st">&quot;@style/Widget.MaterialComponents.Button.TextButton&quot;</span></span>
<span id="cb88-23"><a href="#cb88-23"></a><span class="ot">            android:text=</span><span class="st">&#39;@{item.name}&#39;</span> <span class="kw">/&gt;</span></span>
<span id="cb88-24"><a href="#cb88-24"></a></span>
<span id="cb88-25"><a href="#cb88-25"></a>    <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb88-26"><a href="#cb88-26"></a></span>
<span id="cb88-27"><a href="#cb88-27"></a><span class="kw">&lt;/layout&gt;</span></span></code></pre></div>
<p><code>&lt;data&gt;</code>タグの中の<code>item</code>の値を変更することで、<code>ViewHolder</code>のリサイクルを実現するわけですな。<code>MaterialButton</code>はAndroidの標準のデザイン・ガイドラインである<a href="https://material.io/">マテリアル・デザイン</a>のボタンを実現するボタンで、見た目がかっこいい上に<code>style</code>を指定するだけで見た目を大きく変えられます。今回は、背景がないTextButtonにしました。</p>
<p>このレイアウトを使用する<code>ViewHolder</code>はこんな感じ。</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb89-1"><a href="#cb89-1"></a><span class="kw">class</span> ViewHolder(<span class="kw">private</span> <span class="kw">val</span> <span class="va">binding</span>: <span class="dt">ListItemBusStopBinding</span>): <span class="dt">RecyclerView</span>.<span class="dt">ViewHolder</span>(<span class="va">binding</span>.<span class="va">root</span>) {</span>
<span id="cb89-2"><a href="#cb89-2"></a>    <span class="kw">fun</span> <span class="fu">bind</span>(<span class="va">item</span>: <span class="dt">BusStop</span>) {</span>
<span id="cb89-3"><a href="#cb89-3"></a>        binding.item = item</span>
<span id="cb89-4"><a href="#cb89-4"></a>        binding.executePendingBindings()</span>
<span id="cb89-5"><a href="#cb89-5"></a></span>
<span id="cb89-6"><a href="#cb89-6"></a>        binding.busStopButton.setOnClickListener {</span>
<span id="cb89-7"><a href="#cb89-7"></a>            <span class="co">// ここに、バス停がタップされたときの処理を入れる</span></span>
<span id="cb89-8"><a href="#cb89-8"></a>        }</span>
<span id="cb89-9"><a href="#cb89-9"></a>    }</span>
<span id="cb89-10"><a href="#cb89-10"></a>}</span></code></pre></div>
<p><code>bind()</code>メソッドは、<code>ViewHolder</code>にデータを設定するためのメソッドです（このメソッドを呼び出す部分は、<code>ListAdapter</code>で作ります）。<code>&lt;data&gt;</code>タグの<code>item</code>を変更して、<code>executePendingBindings()</code>でデータ・バインディングを強制的に実行させて、あと、リスナーを再設定しています。</p>
<p>でもちょっと待って。リストが変更された場合のことを考えてみましょう。たとえば最後に1行追加された場合は、残りの行は何もしなくてもよいはず。でも、今回のようにデータベースからデータを取得する場合は、データの変更があったので再取得すると異なるインスタンスになってしまう。以前表示していた<code>BusStop</code>のインスタンスと今回表示する<code>BusStop</code>のインスタンスは、同じバス停を表している場合であっても異るというわけ。異なるインスタンスなのだからもう一度データ・バインディングをやり直しましょうというのは、リソースの無駄遣いなのでやりたくない。あと、<code>RecyclerView.ViewHolder</code>のAPIリファレンスを眺めてみると、リストの中のどの位置なのかを表現する<code>getPosition()</code>というメソッドがありました。他にも、<code>getOldPosition()</code>という位置を移動するアニメーションのためのメソッドも。ということは、<code>ViewHolder</code>はリストの中を上下に移動することが可能なはず。それはそうですよね。最初に一行挿入された場合に、全部を書き直すのは無駄ですもん。</p>
<p>というわけで、データの変更が無いから再バインディングは不要と判断したり、異なるインスタンスだけど同じデータを表現しているので上下への移動で対応しようと判断したりするための機能が必要です。これが<code>DiffCallback</code>です。コードは以下に示すとおりで、<code>DiffUtil.ItemCallback</code>を継承して作成します。</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb90-1"><a href="#cb90-1"></a><span class="kw">class</span> DiffCallback: <span class="dt">DiffUtil</span>.<span class="dt">ItemCallback</span>&lt;<span class="dt">BusStop</span>&gt;() {</span>
<span id="cb90-2"><a href="#cb90-2"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">areItemsTheSame</span>(<span class="va">oldItem</span>: <span class="dt">BusStop</span>, <span class="va">newItem</span>: <span class="dt">BusStop</span>) = oldItem.name == newItem.name</span>
<span id="cb90-3"><a href="#cb90-3"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">areContentsTheSame</span>(<span class="va">oldItem</span>: <span class="dt">BusStop</span>, <span class="va">newItem</span>: <span class="dt">BusStop</span>) = oldItem == newItem</span>
<span id="cb90-4"><a href="#cb90-4"></a>}</span></code></pre></div>
<p><code>areItemsTheSame()</code>が同じ要素かを調べるメソッド、<code>areContentsTheSame()</code>メソッドが中身が変わっていないかを調べるメソッドです。我々はリレーショナル・データベースを使用していて、リレーショナル・データベースのエンティティは主キーを持っているので、<code>areItemsTheSame()</code>は主キーを比較するだけです。あと、Roomのエンティティは属性すべての値が同じかを調べる<code>==</code>演算子を定義してくれているので、<code>areContentsTheSame()</code>はただ単に<code>oldItem</code>と<code>newItem</code>を<code>==</code>で結ぶだけでオッケー。</p>
<p>と、こんな感じで<code>ViewHolder</code>と<code>DiffCallback</code>ができましたので、あとはこれらと<code>RecyclerView</code>をつなげてくれるAdapterを作るだけ。コードを以下に示します。</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb91-1"><a href="#cb91-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.adapter</span></span>
<span id="cb91-2"><a href="#cb91-2"></a></span>
<span id="cb91-3"><a href="#cb91-3"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb91-4"><a href="#cb91-4"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb91-5"><a href="#cb91-5"></a><span class="kw">import</span> <span class="im">androidx.recyclerview.widget.DiffUtil</span></span>
<span id="cb91-6"><a href="#cb91-6"></a><span class="kw">import</span> <span class="im">androidx.recyclerview.widget.ListAdapter</span></span>
<span id="cb91-7"><a href="#cb91-7"></a><span class="kw">import</span> <span class="im">androidx.recyclerview.widget.RecyclerView</span></span>
<span id="cb91-8"><a href="#cb91-8"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.ListItemBusStopBinding</span></span>
<span id="cb91-9"><a href="#cb91-9"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.BusStop</span></span>
<span id="cb91-10"><a href="#cb91-10"></a></span>
<span id="cb91-11"><a href="#cb91-11"></a><span class="kw">class</span> BusStopAdapter: <span class="dt">ListAdapter</span>&lt;<span class="dt">BusStop</span>, <span class="dt">BusStopAdapter</span>.<span class="dt">ViewHolder</span>&gt;(<span class="va">DiffCallback</span>()) {</span>
<span id="cb91-12"><a href="#cb91-12"></a>    lateinit <span class="kw">var</span> <span class="va">onBusStopClick</span>: (busStop: BusStop) -&gt; <span class="kw">Unit</span></span>
<span id="cb91-13"><a href="#cb91-13"></a></span>
<span id="cb91-14"><a href="#cb91-14"></a>    inner <span class="kw">class</span> ViewHolder(<span class="kw">private</span> <span class="kw">val</span> <span class="va">binding</span>: <span class="dt">ListItemBusStopBinding</span>): <span class="dt">RecyclerView</span>.<span class="dt">ViewHolder</span>(<span class="va">binding</span>.<span class="va">root</span>) {</span>
<span id="cb91-15"><a href="#cb91-15"></a>        <span class="kw">fun</span> <span class="fu">bind</span>(<span class="va">item</span>: <span class="dt">BusStop</span>) {</span>
<span id="cb91-16"><a href="#cb91-16"></a>            binding.item = item</span>
<span id="cb91-17"><a href="#cb91-17"></a>            binding.executePendingBindings()</span>
<span id="cb91-18"><a href="#cb91-18"></a></span>
<span id="cb91-19"><a href="#cb91-19"></a>            binding.busStopButton.setOnClickListener {</span>
<span id="cb91-20"><a href="#cb91-20"></a>                onBusStopClick(item)</span>
<span id="cb91-21"><a href="#cb91-21"></a>            }</span>
<span id="cb91-22"><a href="#cb91-22"></a>        }</span>
<span id="cb91-23"><a href="#cb91-23"></a>    }</span>
<span id="cb91-24"><a href="#cb91-24"></a></span>
<span id="cb91-25"><a href="#cb91-25"></a>    <span class="kw">class</span> DiffCallback: <span class="dt">DiffUtil</span>.<span class="dt">ItemCallback</span>&lt;<span class="dt">BusStop</span>&gt;() {</span>
<span id="cb91-26"><a href="#cb91-26"></a>        <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">areItemsTheSame</span>(<span class="va">oldItem</span>: <span class="dt">BusStop</span>, <span class="va">newItem</span>: <span class="dt">BusStop</span>) = oldItem.name == newItem.name</span>
<span id="cb91-27"><a href="#cb91-27"></a>        <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">areContentsTheSame</span>(<span class="va">oldItem</span>: <span class="dt">BusStop</span>, <span class="va">newItem</span>: <span class="dt">BusStop</span>) = oldItem == newItem</span>
<span id="cb91-28"><a href="#cb91-28"></a>    }</span>
<span id="cb91-29"><a href="#cb91-29"></a></span>
<span id="cb91-30"><a href="#cb91-30"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateViewHolder</span>(<span class="va">viewGroup</span>: <span class="dt">ViewGroup</span>, <span class="va">viewType</span>: <span class="dt">Int</span>): <span class="dt">ViewHolder</span> = ViewHolder(ListItemBusStopBinding.inflate(LayoutInflater.from(viewGroup.context), viewGroup, <span class="kw">false</span>))</span>
<span id="cb91-31"><a href="#cb91-31"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onBindViewHolder</span>(<span class="va">viewHolder</span>: <span class="dt">ViewHolder</span>, <span class="va">position</span>: <span class="dt">Int</span>) = viewHolder.bind(getItem(position))</span>
<span id="cb91-32"><a href="#cb91-32"></a>}</span></code></pre></div>
<p>先程作成した<code>ViewHolder</code>と<code>DiffCallback</code>は、管理を簡単にするためにAdapterの中に入れました。Kotlinでは、単純に<code>class</code>の内側に<code>class</code>を作成しただけだと、外側の<code>class</code>の属性やメソッドを参照することはできません。で、<code>ViewHolder</code>では外側のクラスの<code>onBusStopClick</code>を使用したいので、<code>inner class</code>にしました。</p>
<p>あとは、<code>ViewHolder</code>を作成する<code>onCreateViewHolder()</code>メソッドと、データ・バインディングのときに呼ばれる<code>onBindViewHolder()</code>メソッドを定義するだけです。GitHubのコードを見ていただければ分かるのですけど、Adapterはすべてほぼ同じコードです。コピー＆ペーストして、少しだけ置換すれば完成しちゃうので、一度上のコードを覚えてしまえばとても簡単ですよ。</p>
<h2 id="recyclerviewを組み込む">RecyclerViewを組み込む</h2>
<p>上で作成したバス停をリスト表示するための<code>BusStopAdapter</code>を、<code>DepartureBusStopFragment</code>に組み込みましょう。まずは、レイアウトのXMLです。</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb92-1"><a href="#cb92-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb92-2"><a href="#cb92-2"></a><span class="kw">&lt;layout</span></span>
<span id="cb92-3"><a href="#cb92-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb92-4"><a href="#cb92-4"></a><span class="ot">    xmlns:tools=</span><span class="st">&quot;http://schemas.android.com/tools&quot;</span></span>
<span id="cb92-5"><a href="#cb92-5"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span>
<span id="cb92-6"><a href="#cb92-6"></a><span class="ot">    tools:context=</span><span class="st">&quot;.DepartureBusStopFragment&quot;</span><span class="kw">&gt;</span></span>
<span id="cb92-7"><a href="#cb92-7"></a></span>
<span id="cb92-8"><a href="#cb92-8"></a>    <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb92-9"><a href="#cb92-9"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb92-10"><a href="#cb92-10"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;match_parent&quot;</span><span class="kw">&gt;</span></span>
<span id="cb92-11"><a href="#cb92-11"></a></span>
<span id="cb92-12"><a href="#cb92-12"></a>        <span class="kw">&lt;androidx.recyclerview.widget.RecyclerView</span></span>
<span id="cb92-13"><a href="#cb92-13"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/recyclerView&quot;</span></span>
<span id="cb92-14"><a href="#cb92-14"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb92-15"><a href="#cb92-15"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb92-16"><a href="#cb92-16"></a><span class="ot">            android:padding=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb92-17"><a href="#cb92-17"></a><span class="ot">            android:clipToPadding=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb92-18"><a href="#cb92-18"></a><span class="ot">            app:layoutManager=</span><span class="st">&quot;androidx.recyclerview.widget.LinearLayoutManager&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb92-19"><a href="#cb92-19"></a></span>
<span id="cb92-20"><a href="#cb92-20"></a>    <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb92-21"><a href="#cb92-21"></a></span>
<span id="cb92-22"><a href="#cb92-22"></a><span class="kw">&lt;/layout&gt;</span></span></code></pre></div>
<p><code>android:clipToPadding</code>というのは、パディング範囲を超えた部分を消すかどうかです。なんでこんな指定をしているかというと、これが無いととても不自然なユーザー・インターフェースになってしまうから。マテリアル・デザインではスマートフォンの場合は端から16dpの隙間を空けることになっています。だから、<code>android:padding=&quot;16dp&quot;</code>で隙間を作成しています。でも、上下にスクロールした時にこの16dpの隙間部分を消して真っ白にしてしまうと、表示している内容がどこに消えていったのか分からなくてとても不自然なユーザー・インターフェースになってしまうんですよ。だから<code>android:clipToPadding</code>を敢えて<code>false</code>にして消さないようにして、上方向はApp barの下に、下方向は画面の外に消えていったように見せているわけ。</p>
<p>あと、<code>app:layoutManager</code>というのは、<code>RecyclerView</code>の要素をどのように表示するかのレイアウトを決めるクラスです。<code>LinearLayoutManager</code>を指定すると、上から下にリスト状に表示されるようになります。</p>
<p>ここまできたら、BusStopDaoに<code>getObservables()</code>メソッドを、Repositoryに<code>getObservableBusStops()</code>メソッドを追加して、<code>DepartureBusStopViewModel</code>を作成して<code>departureBusStops</code>プロパティを追加してDaggerで挿入できるようにして、で、<code>DepartureBusStopFragment</code>を修正するだけ。コードはこんな感じ。</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb93-1"><a href="#cb93-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb93-2"><a href="#cb93-2"></a></span>
<span id="cb93-3"><a href="#cb93-3"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb93-4"><a href="#cb93-4"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb93-5"><a href="#cb93-5"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb93-6"><a href="#cb93-6"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb93-7"><a href="#cb93-7"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.Fragment</span></span>
<span id="cb93-8"><a href="#cb93-8"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.viewModels</span></span>
<span id="cb93-9"><a href="#cb93-9"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.Observer</span></span>
<span id="cb93-10"><a href="#cb93-10"></a><span class="kw">import</span> <span class="im">androidx.navigation.fragment.findNavController</span></span>
<span id="cb93-11"><a href="#cb93-11"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.adapter.BusStopAdapter</span></span>
<span id="cb93-12"><a href="#cb93-12"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.FragmentDepartureBusStopBinding</span></span>
<span id="cb93-13"><a href="#cb93-13"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.view_model.DepartureBusStopViewModel</span></span>
<span id="cb93-14"><a href="#cb93-14"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb93-15"><a href="#cb93-15"></a></span>
<span id="cb93-16"><a href="#cb93-16"></a><span class="kw">class</span> DepartureBusStopFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb93-17"><a href="#cb93-17"></a>    <span class="at">@Inject</span> lateinit <span class="kw">var</span> <span class="va">viewModelProviderFactory</span>: AppViewModelProvideFactory</span>
<span id="cb93-18"><a href="#cb93-18"></a></span>
<span id="cb93-19"><a href="#cb93-19"></a>    <span class="kw">private</span> <span class="kw">val</span> <span class="va">viewModel</span> <span class="kw">by</span> viewModels&lt;DepartureBusStopViewModel&gt; { viewModelProviderFactory }</span>
<span id="cb93-20"><a href="#cb93-20"></a></span>
<span id="cb93-21"><a href="#cb93-21"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateView</span>(<span class="va">inflater</span>: <span class="dt">LayoutInflater</span>, <span class="va">container</span>: <span class="dt">ViewGroup?</span>, <span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>): <span class="dt">View?</span> {</span>
<span id="cb93-22"><a href="#cb93-22"></a>        (requireActivity().application <span class="kw">as</span> App).component.inject(<span class="kw">this</span>)</span>
<span id="cb93-23"><a href="#cb93-23"></a></span>
<span id="cb93-24"><a href="#cb93-24"></a>        <span class="kw">return</span> FragmentDepartureBusStopBinding.inflate(inflater, container, <span class="kw">false</span>).apply {</span>
<span id="cb93-25"><a href="#cb93-25"></a>            recyclerView.adapter = BusStopAdapter().apply {</span>
<span id="cb93-26"><a href="#cb93-26"></a>                viewModel.busStops.observe(viewLifecycleOwner, Observer {</span>
<span id="cb93-27"><a href="#cb93-27"></a>                    submitList(it)</span>
<span id="cb93-28"><a href="#cb93-28"></a>                })</span>
<span id="cb93-29"><a href="#cb93-29"></a></span>
<span id="cb93-30"><a href="#cb93-30"></a>                onBusStopClick = {</span>
<span id="cb93-31"><a href="#cb93-31"></a>                    findNavController().navigate(DepartureBusStopFragmentDirections.departureBusStopFragmentToArrivalBusStopFragment(it.name))</span>
<span id="cb93-32"><a href="#cb93-32"></a>                }</span>
<span id="cb93-33"><a href="#cb93-33"></a>            }</span>
<span id="cb93-34"><a href="#cb93-34"></a>        }.root</span>
<span id="cb93-35"><a href="#cb93-35"></a>    }</span>
<span id="cb93-36"><a href="#cb93-36"></a>}</span></code></pre></div>
<p>レイアウトのXMLに<code>&lt;data&gt;</code>がなかったのは、上のように<code>BusStopAdapter.submitList()</code>をコードでやるため。データが変更になったら<code>submitList()</code>しなおします（今回はデータが変更になることはないけど、変更があり得る場合と無い場合で記述を変えるのと保守性が落ちますから、変更がある場合むけのコードで統一します）。で、バス停がタップされた場合のリスナーに画面遷移をするコードを書いただけ。</p>
<h2 id="さらに索引用のrecyclerviewを作る">さらに、索引用の<code>RecyclerView</code>を作る</h2>
<p>うん、これで完成……じゃないんですよ、今回のアプリでは。というのも、バス停の件数があまりに膨大なんです。だから、下の方のバス停を選ぶにはひたすらスクロールしなければならなくて、とても実用にはなりません。というわけで、索引を作りましょう。もう一つ<code>RecyclerView</code>を作って重ねるだけの簡単な作業です。</p>
<p>list_item_index.xmlを追加します。</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb94-1"><a href="#cb94-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb94-2"><a href="#cb94-2"></a><span class="kw">&lt;layout</span></span>
<span id="cb94-3"><a href="#cb94-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb94-4"><a href="#cb94-4"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span><span class="kw">&gt;</span></span>
<span id="cb94-5"><a href="#cb94-5"></a></span>
<span id="cb94-6"><a href="#cb94-6"></a>    <span class="kw">&lt;data&gt;</span></span>
<span id="cb94-7"><a href="#cb94-7"></a>        <span class="kw">&lt;variable</span><span class="ot"> name=</span><span class="st">&quot;item&quot;</span><span class="ot"> type=</span><span class="st">&quot;char&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb94-8"><a href="#cb94-8"></a>    <span class="kw">&lt;/data&gt;</span></span>
<span id="cb94-9"><a href="#cb94-9"></a></span>
<span id="cb94-10"><a href="#cb94-10"></a>    <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb94-11"><a href="#cb94-11"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb94-12"><a href="#cb94-12"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span><span class="kw">&gt;</span></span>
<span id="cb94-13"><a href="#cb94-13"></a></span>
<span id="cb94-14"><a href="#cb94-14"></a>        <span class="kw">&lt;com.google.android.material.button.MaterialButton</span></span>
<span id="cb94-15"><a href="#cb94-15"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/indexButton&quot;</span></span>
<span id="cb94-16"><a href="#cb94-16"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb94-17"><a href="#cb94-17"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb94-18"><a href="#cb94-18"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;@id/indexTextView&quot;</span></span>
<span id="cb94-19"><a href="#cb94-19"></a><span class="ot">            app:layout_constraintBottom_toBottomOf=</span><span class="st">&quot;@id/indexTextView&quot;</span></span>
<span id="cb94-20"><a href="#cb94-20"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;@id/indexTextView&quot;</span></span>
<span id="cb94-21"><a href="#cb94-21"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;@id/indexTextView&quot;</span></span>
<span id="cb94-22"><a href="#cb94-22"></a><span class="ot">            style=</span><span class="st">&quot;@style/Widget.MaterialComponents.Button.TextButton&quot;</span></span>
<span id="cb94-23"><a href="#cb94-23"></a><span class="ot">            android:insetLeft=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb94-24"><a href="#cb94-24"></a><span class="ot">            android:insetTop=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb94-25"><a href="#cb94-25"></a><span class="ot">            android:insetRight=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb94-26"><a href="#cb94-26"></a><span class="ot">            android:insetBottom=</span><span class="st">&quot;0dp&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb94-27"><a href="#cb94-27"></a></span>
<span id="cb94-28"><a href="#cb94-28"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb94-29"><a href="#cb94-29"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/indexTextView&quot;</span></span>
<span id="cb94-30"><a href="#cb94-30"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb94-31"><a href="#cb94-31"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb94-32"><a href="#cb94-32"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;8dp&quot;</span></span>
<span id="cb94-33"><a href="#cb94-33"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb94-34"><a href="#cb94-34"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb94-35"><a href="#cb94-35"></a><span class="ot">            android:text=</span><span class="st">&#39;@{String.format(&quot;%c&quot;, item)}&#39;</span> <span class="kw">/&gt;</span></span>
<span id="cb94-36"><a href="#cb94-36"></a></span>
<span id="cb94-37"><a href="#cb94-37"></a>    <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb94-38"><a href="#cb94-38"></a></span>
<span id="cb94-39"><a href="#cb94-39"></a><span class="kw">&lt;/layout&gt;</span></span></code></pre></div>
<p>単純に<code>MaterialButton</code>で作ると見た目に変化が無いので混乱しますから、<code>TextView</code>で索引の文字を表示させます。でも<code>TextView</code>だけだとタップしたときの見た目のフィードバックがないので、同じ位置に重なるように<code>MaterialButton</code>も配置します。あと、<code>MaterialButton</code>は<code>android:inset</code>として上下左右に隙間を持っているので、この隙間をなくすために<code>0dp</code>に設定しました。</p>
<p>次に、<code>IndexAdapter</code>を作成します。</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb95-1"><a href="#cb95-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.adapter</span></span>
<span id="cb95-2"><a href="#cb95-2"></a></span>
<span id="cb95-3"><a href="#cb95-3"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb95-4"><a href="#cb95-4"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb95-5"><a href="#cb95-5"></a><span class="kw">import</span> <span class="im">androidx.recyclerview.widget.DiffUtil</span></span>
<span id="cb95-6"><a href="#cb95-6"></a><span class="kw">import</span> <span class="im">androidx.recyclerview.widget.ListAdapter</span></span>
<span id="cb95-7"><a href="#cb95-7"></a><span class="kw">import</span> <span class="im">androidx.recyclerview.widget.RecyclerView</span></span>
<span id="cb95-8"><a href="#cb95-8"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.ListItemIndexBinding</span></span>
<span id="cb95-9"><a href="#cb95-9"></a></span>
<span id="cb95-10"><a href="#cb95-10"></a><span class="kw">class</span> IndexAdapter: <span class="dt">ListAdapter</span>&lt;<span class="dt">Char</span>, <span class="dt">IndexAdapter</span>.<span class="dt">ViewHolder</span>&gt;(<span class="va">DiffCallback</span>()) {</span>
<span id="cb95-11"><a href="#cb95-11"></a>    lateinit <span class="kw">var</span> <span class="va">onIndexClick</span>: (index: <span class="kw">Char</span>) -&gt; <span class="kw">Unit</span></span>
<span id="cb95-12"><a href="#cb95-12"></a></span>
<span id="cb95-13"><a href="#cb95-13"></a>    inner <span class="kw">class</span> ViewHolder(<span class="kw">private</span> <span class="kw">val</span> <span class="va">binding</span>: <span class="dt">ListItemIndexBinding</span>): <span class="dt">RecyclerView</span>.<span class="dt">ViewHolder</span>(<span class="va">binding</span>.<span class="va">root</span>) {</span>
<span id="cb95-14"><a href="#cb95-14"></a>        <span class="kw">fun</span> <span class="fu">bind</span>(<span class="va">item</span>: <span class="dt">Char</span>) {</span>
<span id="cb95-15"><a href="#cb95-15"></a>            binding.item = item</span>
<span id="cb95-16"><a href="#cb95-16"></a>            binding.executePendingBindings()</span>
<span id="cb95-17"><a href="#cb95-17"></a></span>
<span id="cb95-18"><a href="#cb95-18"></a>            binding.indexButton.setOnClickListener {</span>
<span id="cb95-19"><a href="#cb95-19"></a>                onIndexClick(item)</span>
<span id="cb95-20"><a href="#cb95-20"></a>            }</span>
<span id="cb95-21"><a href="#cb95-21"></a>        }</span>
<span id="cb95-22"><a href="#cb95-22"></a>    }</span>
<span id="cb95-23"><a href="#cb95-23"></a></span>
<span id="cb95-24"><a href="#cb95-24"></a>    <span class="kw">class</span> DiffCallback: <span class="dt">DiffUtil</span>.<span class="dt">ItemCallback</span>&lt;<span class="dt">Char</span>&gt;() {</span>
<span id="cb95-25"><a href="#cb95-25"></a>        <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">areItemsTheSame</span>(<span class="va">oldItem</span>: <span class="dt">Char</span>, <span class="va">newItem</span>: <span class="dt">Char</span>) = oldItem == newItem</span>
<span id="cb95-26"><a href="#cb95-26"></a>        <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">areContentsTheSame</span>(<span class="va">oldItem</span>: <span class="dt">Char</span>, <span class="va">newItem</span>: <span class="dt">Char</span>) = oldItem == newItem</span>
<span id="cb95-27"><a href="#cb95-27"></a>    }</span>
<span id="cb95-28"><a href="#cb95-28"></a></span>
<span id="cb95-29"><a href="#cb95-29"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateViewHolder</span>(<span class="va">viewGroup</span>: <span class="dt">ViewGroup</span>, <span class="va">viewType</span>: <span class="dt">Int</span>): <span class="dt">ViewHolder</span> = ViewHolder(ListItemIndexBinding.inflate(LayoutInflater.from(viewGroup.context), viewGroup, <span class="kw">false</span>))</span>
<span id="cb95-30"><a href="#cb95-30"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onBindViewHolder</span>(<span class="va">viewHolder</span>: <span class="dt">IndexAdapter</span>.<span class="va">ViewHolder</span>, <span class="va">position</span>: <span class="dt">Int</span>) = viewHolder.bind(getItem(position))</span>
<span id="cb95-31"><a href="#cb95-31"></a> }</span></code></pre></div>
<p>うん、見事なまでに<code>BusStopAdapter</code>とそっくり。コピー＆ペーストで作りました。注意すべきは、索引は<code>Char</code>一文字で属性がないので、<code>areItemsTheSame()</code>が<code>areContentsTheSame()</code>と同じである点くらいです。</p>
<p>で、索引はどうしましょ？「あ」から「ん」まで全て並べてもよいのですけど、できるだけ短くしたいので、バス停の一覧の頭文字を使うことにしましょう。あと、「か」と「が」が同じになるような考慮もしたい。というわけで、Utility.ktを修正してこんな関数を作成しました。</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb96-1"><a href="#cb96-1"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.BusStop</span></span>
<span id="cb96-2"><a href="#cb96-2"></a></span>
<span id="cb96-3"><a href="#cb96-3"></a>...</span>
<span id="cb96-4"><a href="#cb96-4"></a></span>
<span id="cb96-5"><a href="#cb96-5"></a><span class="kw">private</span> <span class="kw">val</span> <span class="va">indexConverter</span> = <span class="st">&quot;ぁぃぅぇぉがぎぐげござじずぜぞだぢっづでどばぱびぴぶぷべぺぼぽゃゅょゎゐゑゔゕゖ&quot;</span>.zip(<span class="st">&quot;あいうえおかきくけこさしすせそたちつつてとははひひふふへへほほやゆよわいえうかけ&quot;</span>).toMap()</span>
<span id="cb96-6"><a href="#cb96-6"></a></span>
<span id="cb96-7"><a href="#cb96-7"></a><span class="kw">fun</span> <span class="fu">convertIndex</span>(<span class="va">index</span>: <span class="dt">Char</span>): <span class="dt">Char</span> {</span>
<span id="cb96-8"><a href="#cb96-8"></a>    <span class="kw">return</span> <span class="cf">when</span> (index) {</span>
<span id="cb96-9"><a href="#cb96-9"></a>        <span class="kw">in</span> <span class="ch">&#39;</span><span class="sc">\u30a1</span><span class="ch">&#39;</span>..<span class="ch">&#39;</span><span class="sc">\u30fa</span><span class="ch">&#39;</span> -&gt; index - <span class="dv">0x0060</span></span>
<span id="cb96-10"><a href="#cb96-10"></a>        <span class="cf">else</span>                  -&gt; index</span>
<span id="cb96-11"><a href="#cb96-11"></a>    }.let {</span>
<span id="cb96-12"><a href="#cb96-12"></a>        indexConverter[it] ?: it</span>
<span id="cb96-13"><a href="#cb96-13"></a>    }</span>
<span id="cb96-14"><a href="#cb96-14"></a>}</span>
<span id="cb96-15"><a href="#cb96-15"></a></span>
<span id="cb96-16"><a href="#cb96-16"></a><span class="kw">fun</span> <span class="fu">getBusStopIndexes</span>(<span class="va">busStops</span>: <span class="dt">List</span>&lt;<span class="va">BusStop</span>&gt;): <span class="dt">List</span>&lt;<span class="dt">Char</span>&gt; {</span>
<span id="cb96-17"><a href="#cb96-17"></a>    <span class="kw">return</span> busStops.asSequence().map { busStop -&gt; busStop.phoneticName?.firstOrNull() }.filterNotNull().map { convertIndex(it) }.distinct().toList()</span>
<span id="cb96-18"><a href="#cb96-18"></a>}</span>
<span id="cb96-19"><a href="#cb96-19"></a></span>
<span id="cb96-20"><a href="#cb96-20"></a><span class="kw">fun</span> <span class="fu">getBusStopPosition</span>(<span class="va">busStops</span>: <span class="dt">List</span>&lt;<span class="va">BusStop</span>&gt;, <span class="va">index</span>: <span class="dt">Char</span>): <span class="dt">Int</span> {</span>
<span id="cb96-21"><a href="#cb96-21"></a>    <span class="kw">return</span> busStops.indexOfFirst { busStop -&gt; busStop.phoneticName?.firstOrNull()?.let { convertIndex(it) == index } ?: <span class="kw">false</span> }</span>
<span id="cb96-22"><a href="#cb96-22"></a>}</span></code></pre></div>
<p><code>indexConverter</code>という<code>Map</code>を作成して、「ぁ」を「あ」に変換できるようにします。全部の文字をこの<code>Map</code>で変換するのは記述が面倒だったので、<code>convertIndex()</code>関数を作成して、変換が不要な場合はそのまま、そうでなければ<code>indexConverter</code>を使用して変換するようにしました。あとは、<code>List&lt;BusStop&gt;</code>から関数型プログラミングのテクニックでサクッと一覧を作成する<code>getBusStopIndexes()</code>関数と、あとで使用する索引から位置を求める<code>getBusStopPosition()</code>関数です。</p>
<p>この<code>getBusStopIndexes()</code>関数を使用して、<code>DepartureBusStopViewModel</code>を完成させます。</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb97-1"><a href="#cb97-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.view_model</span></span>
<span id="cb97-2"><a href="#cb97-2"></a></span>
<span id="cb97-3"><a href="#cb97-3"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.Transformations</span></span>
<span id="cb97-4"><a href="#cb97-4"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.ViewModel</span></span>
<span id="cb97-5"><a href="#cb97-5"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.getBusStopIndexes</span></span>
<span id="cb97-6"><a href="#cb97-6"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.Repository</span></span>
<span id="cb97-7"><a href="#cb97-7"></a></span>
<span id="cb97-8"><a href="#cb97-8"></a><span class="kw">class</span> DepartureBusStopViewModel(<span class="kw">private</span> <span class="kw">val</span> <span class="va">repository</span>: <span class="dt">Repository</span>): <span class="dt">ViewModel</span>() {</span>
<span id="cb97-9"><a href="#cb97-9"></a>    <span class="kw">val</span> <span class="va">departureBusStops</span> = repository.getObservableBusStops()</span>
<span id="cb97-10"><a href="#cb97-10"></a></span>
<span id="cb97-11"><a href="#cb97-11"></a>    <span class="kw">val</span> <span class="va">departureBusStopIndexes</span> = Transformations.map(departureBusStops) {</span>
<span id="cb97-12"><a href="#cb97-12"></a>        getBusStopIndexes(it)</span>
<span id="cb97-13"><a href="#cb97-13"></a>    }</span>
<span id="cb97-14"><a href="#cb97-14"></a>}</span></code></pre></div>
<p>これで完成、<code>DepartureBusStopFragment</code>に新しい<code>RecyclerView</code>を追加します。レイアウトのXMLはこんな感じ。</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb98-1"><a href="#cb98-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb98-2"><a href="#cb98-2"></a><span class="kw">&lt;layout</span></span>
<span id="cb98-3"><a href="#cb98-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb98-4"><a href="#cb98-4"></a><span class="ot">    xmlns:tools=</span><span class="st">&quot;http://schemas.android.com/tools&quot;</span></span>
<span id="cb98-5"><a href="#cb98-5"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span>
<span id="cb98-6"><a href="#cb98-6"></a><span class="ot">    tools:context=</span><span class="st">&quot;.DepartureBusStopFragment&quot;</span><span class="kw">&gt;</span></span>
<span id="cb98-7"><a href="#cb98-7"></a></span>
<span id="cb98-8"><a href="#cb98-8"></a>    <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb98-9"><a href="#cb98-9"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb98-10"><a href="#cb98-10"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;match_parent&quot;</span><span class="kw">&gt;</span></span>
<span id="cb98-11"><a href="#cb98-11"></a></span>
<span id="cb98-12"><a href="#cb98-12"></a>        <span class="kw">&lt;androidx.recyclerview.widget.RecyclerView</span></span>
<span id="cb98-13"><a href="#cb98-13"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/recyclerView&quot;</span></span>
<span id="cb98-14"><a href="#cb98-14"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb98-15"><a href="#cb98-15"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb98-16"><a href="#cb98-16"></a><span class="ot">            android:padding=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb98-17"><a href="#cb98-17"></a><span class="ot">            android:clipToPadding=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb98-18"><a href="#cb98-18"></a><span class="ot">            app:layoutManager=</span><span class="st">&quot;androidx.recyclerview.widget.LinearLayoutManager&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb98-19"><a href="#cb98-19"></a></span>
<span id="cb98-20"><a href="#cb98-20"></a>        <span class="kw">&lt;androidx.recyclerview.widget.RecyclerView</span></span>
<span id="cb98-21"><a href="#cb98-21"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/indexRecyclerView&quot;</span></span>
<span id="cb98-22"><a href="#cb98-22"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb98-23"><a href="#cb98-23"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb98-24"><a href="#cb98-24"></a><span class="ot">            android:padding=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb98-25"><a href="#cb98-25"></a><span class="ot">            android:clipToPadding=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb98-26"><a href="#cb98-26"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb98-27"><a href="#cb98-27"></a><span class="ot">            app:layoutManager=</span><span class="st">&quot;androidx.recyclerview.widget.LinearLayoutManager&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb98-28"><a href="#cb98-28"></a></span>
<span id="cb98-29"><a href="#cb98-29"></a>    <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb98-30"><a href="#cb98-30"></a></span>
<span id="cb98-31"><a href="#cb98-31"></a><span class="kw">&lt;/layout&gt;</span></span></code></pre></div>
<p><code>DepartureBusStopFragment</code>はこんな感じです。</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb99-1"><a href="#cb99-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb99-2"><a href="#cb99-2"></a></span>
<span id="cb99-3"><a href="#cb99-3"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb99-4"><a href="#cb99-4"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb99-5"><a href="#cb99-5"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb99-6"><a href="#cb99-6"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb99-7"><a href="#cb99-7"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.Fragment</span></span>
<span id="cb99-8"><a href="#cb99-8"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.viewModels</span></span>
<span id="cb99-9"><a href="#cb99-9"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.Observer</span></span>
<span id="cb99-10"><a href="#cb99-10"></a><span class="kw">import</span> <span class="im">androidx.navigation.fragment.findNavController</span></span>
<span id="cb99-11"><a href="#cb99-11"></a><span class="kw">import</span> <span class="im">androidx.recyclerview.widget.LinearSmoothScroller</span></span>
<span id="cb99-12"><a href="#cb99-12"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.adapter.BusStopAdapter</span></span>
<span id="cb99-13"><a href="#cb99-13"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.adapter.IndexAdapter</span></span>
<span id="cb99-14"><a href="#cb99-14"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.FragmentDepartureBusStopBinding</span></span>
<span id="cb99-15"><a href="#cb99-15"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.view_model.DepartureBusStopViewModel</span></span>
<span id="cb99-16"><a href="#cb99-16"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb99-17"><a href="#cb99-17"></a></span>
<span id="cb99-18"><a href="#cb99-18"></a><span class="kw">class</span> DepartureBusStopFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb99-19"><a href="#cb99-19"></a>    <span class="at">@Inject</span> lateinit <span class="kw">var</span> <span class="va">viewModelProviderFactory</span>: AppViewModelProvideFactory</span>
<span id="cb99-20"><a href="#cb99-20"></a></span>
<span id="cb99-21"><a href="#cb99-21"></a>    <span class="kw">private</span> <span class="kw">val</span> <span class="va">viewModel</span> <span class="kw">by</span> viewModels&lt;DepartureBusStopViewModel&gt; { viewModelProviderFactory }</span>
<span id="cb99-22"><a href="#cb99-22"></a></span>
<span id="cb99-23"><a href="#cb99-23"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateView</span>(<span class="va">inflater</span>: <span class="dt">LayoutInflater</span>, <span class="va">container</span>: <span class="dt">ViewGroup?</span>, <span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>): <span class="dt">View?</span> {</span>
<span id="cb99-24"><a href="#cb99-24"></a>        (requireActivity().application <span class="kw">as</span> App).component.inject(<span class="kw">this</span>)</span>
<span id="cb99-25"><a href="#cb99-25"></a></span>
<span id="cb99-26"><a href="#cb99-26"></a>        <span class="kw">return</span> FragmentDepartureBusStopBinding.inflate(inflater, container, <span class="kw">false</span>).apply {</span>
<span id="cb99-27"><a href="#cb99-27"></a>            recyclerView.adapter = BusStopAdapter().apply {</span>
<span id="cb99-28"><a href="#cb99-28"></a>                viewModel.departureBusStops.observe(viewLifecycleOwner, Observer {</span>
<span id="cb99-29"><a href="#cb99-29"></a>                    submitList(it)</span>
<span id="cb99-30"><a href="#cb99-30"></a>                })</span>
<span id="cb99-31"><a href="#cb99-31"></a></span>
<span id="cb99-32"><a href="#cb99-32"></a>                onBusStopClick = {</span>
<span id="cb99-33"><a href="#cb99-33"></a>                    findNavController().navigate(DepartureBusStopFragmentDirections.departureBusStopFragmentToArrivalBusStopFragment(it.name))</span>
<span id="cb99-34"><a href="#cb99-34"></a>                }</span>
<span id="cb99-35"><a href="#cb99-35"></a>            }</span>
<span id="cb99-36"><a href="#cb99-36"></a></span>
<span id="cb99-37"><a href="#cb99-37"></a>            indexRecyclerView.adapter = IndexAdapter().apply {</span>
<span id="cb99-38"><a href="#cb99-38"></a>                viewModel.departureBusStopIndexes.observe(viewLifecycleOwner, Observer {</span>
<span id="cb99-39"><a href="#cb99-39"></a>                    submitList(it)</span>
<span id="cb99-40"><a href="#cb99-40"></a>                })</span>
<span id="cb99-41"><a href="#cb99-41"></a></span>
<span id="cb99-42"><a href="#cb99-42"></a>                onIndexClick = {</span>
<span id="cb99-43"><a href="#cb99-43"></a>                    recyclerView.layoutManager!!.startSmoothScroll(</span>
<span id="cb99-44"><a href="#cb99-44"></a>                        AcceleratedSmoothScroller(requireContext()).apply {</span>
<span id="cb99-45"><a href="#cb99-45"></a>                            targetPosition = getBusStopPosition(viewModel.departureBusStops.value!!, it)</span>
<span id="cb99-46"><a href="#cb99-46"></a>                        }</span>
<span id="cb99-47"><a href="#cb99-47"></a>                    )</span>
<span id="cb99-48"><a href="#cb99-48"></a>                }</span>
<span id="cb99-49"><a href="#cb99-49"></a>            }</span>
<span id="cb99-50"><a href="#cb99-50"></a>        }.root</span>
<span id="cb99-51"><a href="#cb99-51"></a>    }</span>
<span id="cb99-52"><a href="#cb99-52"></a>}</span></code></pre></div>
<p>このコードの中の<code>AcceleratedSmoothScroller</code>というのは、<a href="https://qiita.com/chibatching/items/52d9b73d244eac52d0d4">RecyclerViewの長距離スムーズスクロールをスムーズにする</a>を猿真似して作成した良い感じスクロールさせるためのクラスです。<code>RecylerView</code>のAPIには、指定した場所にスクロールする機能（画面がいきなり切り替わるので使いづらいユーザー・インターフェースになる）と指定した場所までスムーズにスクロールする機能（使いやすいユーザー・インターフェースになるけど、スクロールが終わるまで長時間かかる）しかなくて、これだけだと指定場所までスクロールするという機能がとても作りづらいんです。この問題は、<a href="https://qiita.com/chibatching/items/52d9b73d244eac52d0d4">RecyclerViewの長距離スムーズスクロールをスムーズにする</a>ですべて解決です。ぜひ読んでみてください。なお、今回は少しだけ実装を変えたので、クラス名も少しだけ変更しました。</p>
<h2 id="bookmarksfragmentとarrivalbusstopfragmentを同じやり方で作ってbusapproachesfragmentを少しだけ修正する"><code>BookmarksFragment</code>と<code>ArrivalBusStopFragment</code>を同じやり方で作って、<code>BusApproachesFragment</code>を少しだけ修正する</h2>
<p>あとは、同じやり方で（コピー＆ペーストをやりまくって）<code>BookmarksFragment</code>と<code>ArrivalBusStopFragment</code>を作りましょう。少しだけ工夫したのは、list_item_bookmark.xmlの<code>android:text</code>で<code>String.format()</code>を使用したこと、あと、文字列リソースは<code>@string/id</code>と書けば参照できて、それはデータ・バインディングの中でも変わらないことを証明するために<code>String.format()</code>の中に<code>@string/start_to_end_arrow</code>と書いたことと、ついでだったので文字列をres/values/string.xmlに移動させて、都営バスを思わせる緑色で画面が表示されるようにres/values/colors.xmlを修正したくらい。</p>
<p>で、このままだとブックマークが一つもないので<code>BookmarksFragment</code>を正しく実装できたか確認できなかったので、<code>BusApproachesFragment</code>にブックマークを追加する機能（<code>BusApproachesViewModel</code>の<code>toggleBookmark()</code>）を追加しました。</p>
<p>コードの詳細は、GitHubのコードのrecycler-viewブランチをご参照ください。ほとんどコピー＆ペーストなので書くこと何もなかったんですよ……。</p>
<p>ともあれ、大分見た目もしっかりしてきました。</p>
<p>動画</p>
<p>あとは、バスの接近情報を表示するだけ。表示そのものはRecyclerViewでできそうだけど、表示するデータはどうしましょうか？</p>
<h1 id="バス接近情報を表示する">バス接近情報を表示する</h1>
<p>バス接近情報を表示する部分は少し複雑なので、データ・アクセス・オブジェクト、<code>Repository</code>、<code>ViewModel</code>、<code>Fragment</code>の順で説明していきます。</p>
<h2 id="データアクセスオブジェクトを作成する">データ・アクセス・オブジェクトを作成する</h2>
<p>まずは、バスの接近情報を表示するために必要な情報を取得するデータ・アクセス・オブジェクトを、順を追って作成していきましょう。</p>
<h3 id="routebusstoppole"><code>RouteBusStopPole</code></h3>
<p>出発バス停名称と到着バス停名称から<code>Route</code>を取得するところまでは実装済みですので、最初に<code>RouteBusStopPole</code>を考えましょう。<code>RouteBusStopPole</code>は<code>Route</code>と<code>BusStopPole</code>を関連付けるものなのですけど、バスの「接近」情報を表示する本アプリでは、出発バス停以降の<code>RouteBusStopPole</code>の情報は不要でしょう（どれだけ遠ざかったかを表示するプログラムなら、出発バス停以降こそが重要なのでしょうけど）。あと、出発バス停よりも遥かに手前の<code>RouteBusStopPole</code>も不要です。あと3時間でバスが到着する（バスは出発バス停よりも300手前のバス停を出発した）なんて表示されても困りますもんね。私の独断と偏見で、出発バス停の手前10個までを取得の対象としました。</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb100-1"><a href="#cb100-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb100-2"><a href="#cb100-2"></a></span>
<span id="cb100-3"><a href="#cb100-3"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.LiveData</span></span>
<span id="cb100-4"><a href="#cb100-4"></a><span class="kw">import</span> <span class="im">androidx.room.Dao</span></span>
<span id="cb100-5"><a href="#cb100-5"></a><span class="kw">import</span> <span class="im">androidx.room.Insert</span></span>
<span id="cb100-6"><a href="#cb100-6"></a><span class="kw">import</span> <span class="im">androidx.room.Query</span></span>
<span id="cb100-7"><a href="#cb100-7"></a></span>
<span id="cb100-8"><a href="#cb100-8"></a><span class="at">@Dao</span></span>
<span id="cb100-9"><a href="#cb100-9"></a><span class="kw">interface</span> RouteBusStopPoleDao {</span>
<span id="cb100-10"><a href="#cb100-10"></a>    <span class="at">@Insert</span></span>
<span id="cb100-11"><a href="#cb100-11"></a>    <span class="kw">fun</span> <span class="fu">add</span>(<span class="va">routeBusStopPole</span>: <span class="dt">RouteBusStopPole</span>): <span class="dt">Long</span></span>
<span id="cb100-12"><a href="#cb100-12"></a></span>
<span id="cb100-13"><a href="#cb100-13"></a>    @<span class="fu">Query</span>(&quot;<span class="va">DELETE</span> <span class="va">FROM</span> <span class="va">RouteBusStopPole</span>&quot;)</span>
<span id="cb100-14"><a href="#cb100-14"></a>    <span class="kw">fun</span> <span class="fu">clear</span>()</span>
<span id="cb100-15"><a href="#cb100-15"></a></span>
<span id="cb100-16"><a href="#cb100-16"></a>    @<span class="fu">Query</span>(</span>
<span id="cb100-17"><a href="#cb100-17"></a>        &quot;&quot;&quot;</span>
<span id="cb100-18"><a href="#cb100-18"></a>            <span class="va">SELECT</span> <span class="va">RouteBusStopPole</span>.*</span>
<span id="cb100-19"><a href="#cb100-19"></a>            <span class="va">FROM</span> <span class="va">RouteBusStopPole</span></span>
<span id="cb100-20"><a href="#cb100-20"></a>            <span class="va">INNER</span> <span class="va">JOIN</span> (</span>
<span id="cb100-21"><a href="#cb100-21"></a>                <span class="va">SELECT</span> <span class="va">RouteBusStopPole</span>.<span class="va">routeId</span>, <span class="va">RouteBusStopPole</span>.&#39;<span class="va">order</span>&#39;</span>
<span id="cb100-22"><a href="#cb100-22"></a>                <span class="va">FROM</span> <span class="va">RouteBusStopPole</span></span>
<span id="cb100-23"><a href="#cb100-23"></a>                <span class="va">INNER</span> <span class="va">JOIN</span> <span class="va">BusStopPole</span> <span class="va">ON</span> <span class="va">BusStopPole</span>.<span class="va">id</span> = RouteBusStopPole.busStopPoleId</span>
<span id="cb100-24"><a href="#cb100-24"></a>                WHERE RouteBusStopPole.routeId IN (:routeIds) AND BusStopPole.busStopName = :departureBusStopName</span>
<span id="cb100-25"><a href="#cb100-25"></a>            ) <span class="fu">DepartureRouteBusStopPole</span> <span class="fu">ON</span> <span class="fu">RouteBusStopPole</span>.<span class="fu">routeId</span> = DepartureRouteBusStopPole.routeId</span>
<span id="cb100-26"><a href="#cb100-26"></a>            WHERE RouteBusStopPole.<span class="ch">&#39;order&#39;</span> &lt;= DepartureRouteBusStopPole.<span class="ch">&#39;order&#39;</span> AND RouteBusStopPole.<span class="ch">&#39;order&#39;</span> &gt;= DepartureRouteBusStopPole.<span class="ch">&#39;order&#39;</span> - <span class="dv">10</span></span>
<span id="cb100-27"><a href="#cb100-27"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb100-28"><a href="#cb100-28"></a><span class="st">    )</span></span>
<span id="cb100-29"><a href="#cb100-29"></a><span class="st">    fun getObservablesByRouteIdsAndDepartureBusStopName(routeIds: List&lt;String&gt;, departureBusStopName: String): LiveData&lt;List&lt;RouteBusStopPole&gt;&gt;</span></span>
<span id="cb100-30"><a href="#cb100-30"></a><span class="st">}</span></span></code></pre></div>
<p>うん、副問合せですね。<code>INNER JOIN</code>のカッコの中で、<code>Route</code>と出発バス停名称に関連付けられたRouteBusStopPoleを取得します。で、外側のSQLの<code>WHERE</code>で、出発の<code>RouteBusStopPole</code>よりも<code>order</code>が小さく、かつ、出発の<code>RouteBusStopPole</code>の<code>order</code>-10よりも大きいとやることで、先に述べた条件を満たす<code>RouteBusStopPole</code>を取得しているというわけ。</p>
<h3 id="busstoppole"><code>BusStopPole</code></h3>
<p>バス停の情報を表示できるように、<code>BusStopPole</code>も取得しましょう。<code>RouteBusStop</code>を取得済みなので、これはとても簡単です。</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb101-1"><a href="#cb101-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb101-2"><a href="#cb101-2"></a></span>
<span id="cb101-3"><a href="#cb101-3"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.LiveData</span></span>
<span id="cb101-4"><a href="#cb101-4"></a><span class="kw">import</span> <span class="im">androidx.room.Dao</span></span>
<span id="cb101-5"><a href="#cb101-5"></a><span class="kw">import</span> <span class="im">androidx.room.Insert</span></span>
<span id="cb101-6"><a href="#cb101-6"></a><span class="kw">import</span> <span class="im">androidx.room.Query</span></span>
<span id="cb101-7"><a href="#cb101-7"></a></span>
<span id="cb101-8"><a href="#cb101-8"></a><span class="at">@Dao</span></span>
<span id="cb101-9"><a href="#cb101-9"></a><span class="kw">interface</span> BusStopPoleDao {</span>
<span id="cb101-10"><a href="#cb101-10"></a>    ...</span>
<span id="cb101-11"><a href="#cb101-11"></a></span>
<span id="cb101-12"><a href="#cb101-12"></a>    <span class="at">@Query</span>(<span class="st">&quot;SELECT * FROM BusStopPole WHERE id IN (:ids)&quot;</span>)</span>
<span id="cb101-13"><a href="#cb101-13"></a>    <span class="kw">fun</span> <span class="fu">getObservablesByIds</span>(<span class="va">ids</span>: <span class="dt">List</span>&lt;<span class="va">String</span>&gt;): <span class="dt">LiveData</span>&lt;<span class="dt">List</span>&lt;<span class="dt">BusStopPole</span>&gt;&gt;</span>
<span id="cb101-14"><a href="#cb101-14"></a>}</span></code></pre></div>
<p>取得した<code>RouteBusStopPole</code>の<code>busStopPoleId</code>のリストを引数に渡すわけですな。</p>
<h3 id="timetable"><code>TimeTable</code></h3>
<p>前にも述べましたが、バスは一つの路線を日に何回も行き来していますから、<code>Route</code>と<code>TimeTable</code>の関係は1対多となっています。よって、複数ある<code>TimeTable</code>の中から一つを選ばなければなりません。道路が混んでいるときと空いているときは時刻表が変わるかもしれませんから、到着バス停に関連付けられた<code>TimeTableDetail.arrival</code>が現在時刻に最も近いものを選ぶのが良いでしょう。ということで、<code>TimeTableDao</code>に以下の<code>@Query</code>を追加しました。</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb102-1"><a href="#cb102-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb102-2"><a href="#cb102-2"></a></span>
<span id="cb102-3"><a href="#cb102-3"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.LiveData</span></span>
<span id="cb102-4"><a href="#cb102-4"></a><span class="kw">import</span> <span class="im">androidx.room.Dao</span></span>
<span id="cb102-5"><a href="#cb102-5"></a><span class="kw">import</span> <span class="im">androidx.room.Insert</span></span>
<span id="cb102-6"><a href="#cb102-6"></a><span class="kw">import</span> <span class="im">androidx.room.Query</span></span>
<span id="cb102-7"><a href="#cb102-7"></a></span>
<span id="cb102-8"><a href="#cb102-8"></a><span class="at">@Dao</span></span>
<span id="cb102-9"><a href="#cb102-9"></a><span class="kw">interface</span> TimeTableDao {</span>
<span id="cb102-10"><a href="#cb102-10"></a>    ...</span>
<span id="cb102-11"><a href="#cb102-11"></a></span>
<span id="cb102-12"><a href="#cb102-12"></a>    <span class="at">@Query</span>(</span>
<span id="cb102-13"><a href="#cb102-13"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb102-14"><a href="#cb102-14"></a><span class="st">            SELECT TimeTable.*</span></span>
<span id="cb102-15"><a href="#cb102-15"></a><span class="st">            FROM TimeTable</span></span>
<span id="cb102-16"><a href="#cb102-16"></a><span class="st">            INNER JOIN (</span></span>
<span id="cb102-17"><a href="#cb102-17"></a><span class="st">                SELECT TimeTable.routeId, MIN(TimeTable.id) AS id</span></span>
<span id="cb102-18"><a href="#cb102-18"></a><span class="st">                FROM TimeTable</span></span>
<span id="cb102-19"><a href="#cb102-19"></a><span class="st">                INNER JOIN TimeTableDetail ON TimeTableDetail.timeTableId = TimeTable.id</span></span>
<span id="cb102-20"><a href="#cb102-20"></a><span class="st">                INNER JOIN BusStopPole ON BusStopPole.id = TimeTableDetail.busStopPoleId</span></span>
<span id="cb102-21"><a href="#cb102-21"></a><span class="st">                WHERE</span></span>
<span id="cb102-22"><a href="#cb102-22"></a><span class="st">                    TimeTable.routeId IN (:routeIds) AND</span></span>
<span id="cb102-23"><a href="#cb102-23"></a><span class="st">                    BusStopPole.busStopName = :departureBusStopName AND</span></span>
<span id="cb102-24"><a href="#cb102-24"></a><span class="st">                    NOT EXISTS (</span></span>
<span id="cb102-25"><a href="#cb102-25"></a><span class="st">                        SELECT T1.*</span></span>
<span id="cb102-26"><a href="#cb102-26"></a><span class="st">                        FROM TimeTable AS T1</span></span>
<span id="cb102-27"><a href="#cb102-27"></a><span class="st">                        INNER JOIN TimeTableDetail AS T2 ON T2.timeTableId = T1.id</span></span>
<span id="cb102-28"><a href="#cb102-28"></a><span class="st">                        INNER JOIN BusStopPole AS T3 ON T3.id = T2.busStopPoleId</span></span>
<span id="cb102-29"><a href="#cb102-29"></a><span class="st">                        WHERE T1.routeId = TimeTable.routeId AND T3.busStopName = BusStopPole.busStopName AND ABS(T2.arrival - :now) &lt; ABS(TimeTableDetail.arrival - :now)</span></span>
<span id="cb102-30"><a href="#cb102-30"></a><span class="st">                    )</span></span>
<span id="cb102-31"><a href="#cb102-31"></a><span class="st">                GROUP BY TimeTable.routeId</span></span>
<span id="cb102-32"><a href="#cb102-32"></a><span class="st">            ) AS T ON T.id = TimeTable.id</span></span>
<span id="cb102-33"><a href="#cb102-33"></a><span class="st">        &quot;&quot;&quot;</span>)</span>
<span id="cb102-34"><a href="#cb102-34"></a>    <span class="kw">fun</span> <span class="fu">getObservablesByRouteIdsAndDepartureBusStopName</span>(<span class="va">routeIds</span>: <span class="dt">List</span>&lt;<span class="va">String</span>&gt;, <span class="va">departureBusStopName</span>: <span class="dt">String</span>, <span class="va">now</span>: <span class="dt">Int</span>): <span class="dt">LiveData</span>&lt;<span class="dt">List</span>&lt;<span class="dt">TimeTable</span>&gt;&gt;</span>
<span id="cb102-35"><a href="#cb102-35"></a>}</span></code></pre></div>
<p>ある特定の条件（これがwindow）下での集約や分析を実現するSQLのwindow関数を使えば簡単に作れそうなのですけど、残念なことにSQLite3がwindow関数をサポートするのはバージョン3.25.0からで、2020年3月現在で最新のAndroid 10であってもSQLite3のバージョンは3.22.0です……。だから、上のSQLでは<code>NOT EXISTS</code>の中の副問合せで代用しました。副問合せの外側の行よりも到着バス停に関連付けられた<code>TimeTableDetail.arrival</code>から現在時刻を引いた結果の絶対値が小さいものが存在しない（<code>NOT EXISTS</code>）なので、結果として到着バス停に関連付けられた<code>TimeTableDetail.arrival</code>が現在時刻に最も近いものがSELECTされます。……ま、現在時刻との差が同じものが複数ある場合に、全部取得されちゃうんだけどな。なので、<code>INNER JOIN</code>でもう一回副問合せして、<code>GROUP BY</code>して最小（順序が付いて一つに絞れるなら何でもいいので、最大とかでも大丈夫）の<code>TimeTable.id</code>と<code>INNER JOIN</code>しています。ちょっと（かなり）複雑なSQL文ですけど、でもたぶん、普通のプログラミング言語でループを回してデータを取得する処理を書くよりは楽だと思いますよ。O/Rマッピング・ツールがなかった頃にプログラムを書いていた私のようなおっさんに頼めば、この程度のSQLは大喜びで書いてくれるはずです。なんとかとハサミは使いようですよ。職場のおっさんを大事にしてくださいね。</p>
<h3 id="timetabledetail"><code>TimeTableDetail</code></h3>
<p><code>TimeTable</code>を取得できたので、<code>TimeTableDetail</code>も取得します。<code>RouteBusStopPole</code>のときと同じで、出発バス停以降の<code>TimeTableDetail</code>も、出発バス停のはるか手前の<code>TimeTableDetail</code>も不要……なのですけど、同じ条件式を2回書くのは大変なので、取得済みの<code>BusStopPole</code>を活用することにしましょう。</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb103-1"><a href="#cb103-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb103-2"><a href="#cb103-2"></a></span>
<span id="cb103-3"><a href="#cb103-3"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.LiveData</span></span>
<span id="cb103-4"><a href="#cb103-4"></a><span class="kw">import</span> <span class="im">androidx.room.Dao</span></span>
<span id="cb103-5"><a href="#cb103-5"></a><span class="kw">import</span> <span class="im">androidx.room.Insert</span></span>
<span id="cb103-6"><a href="#cb103-6"></a><span class="kw">import</span> <span class="im">androidx.room.Query</span></span>
<span id="cb103-7"><a href="#cb103-7"></a></span>
<span id="cb103-8"><a href="#cb103-8"></a><span class="at">@Dao</span></span>
<span id="cb103-9"><a href="#cb103-9"></a><span class="kw">interface</span> TimeTableDetailDao {</span>
<span id="cb103-10"><a href="#cb103-10"></a>    ...</span>
<span id="cb103-11"><a href="#cb103-11"></a></span>
<span id="cb103-12"><a href="#cb103-12"></a>    <span class="at">@Query</span>(<span class="st">&quot;SELECT * FROM TimeTableDetail WHERE timeTableId IN (:timeTableIds) AND busStopPoleId IN (:busStopPoleIds) ORDER BY &#39;order&#39;&quot;</span>)</span>
<span id="cb103-13"><a href="#cb103-13"></a>    <span class="kw">fun</span> <span class="fu">getObservablesByTimeTableIdsAndBusStopPoleIds</span>(<span class="va">timeTableIds</span>: <span class="dt">List</span>&lt;<span class="va">String</span>&gt;, <span class="va">busStopPoleIds</span>: <span class="dt">List</span>&lt;<span class="va">String</span>&gt;): <span class="dt">LiveData</span>&lt;<span class="dt">List</span>&lt;<span class="dt">TimeTableDetail</span>&gt;&gt;</span>
<span id="cb103-14"><a href="#cb103-14"></a>}</span></code></pre></div>
<p>うん、SQL便利。これでデータ・アクセス・オブジェクトの作成は終了です。</p>
<h2 id="repositoryを作成する"><code>Repository</code>を作成する</h2>
<p><code>Repository</code>でデータベースとWebサービスの差異を吸収して統一した操作を実現する……なんてのはまず無理。トランザクションがある環境とない環境で、同じ操作なんて無理なんだよ（と私は思います）！　とはいえ、<code>Repository</code>というレイヤーを作っておくとやはり便利です。以前作成した<code>syncDatabase()</code>メソッドのようなデータベースとWebサービスの複雑な呼び出しを隠蔽するメソッドを置けますし、データ・アクセス・オブジェクトのメソッドがへっぽこだったりWebサービスの仕様が物足りなかったりする場合を補う処理を書けますから。</p>
<p>というわけで、作成した<code>Repository</code>は以下の通り。</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb104-1"><a href="#cb104-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb104-2"><a href="#cb104-2"></a></span>
<span id="cb104-3"><a href="#cb104-3"></a><span class="kw">import</span> <span class="im">android.util.Log</span></span>
<span id="cb104-4"><a href="#cb104-4"></a><span class="kw">import</span> <span class="im">androidx.room.withTransaction</span></span>
<span id="cb104-5"><a href="#cb104-5"></a><span class="kw">import</span> <span class="im">kotlinx.coroutines.Dispatchers</span></span>
<span id="cb104-6"><a href="#cb104-6"></a><span class="kw">import</span> <span class="im">kotlinx.coroutines.delay</span></span>
<span id="cb104-7"><a href="#cb104-7"></a><span class="kw">import</span> <span class="im">kotlinx.coroutines.withContext</span></span>
<span id="cb104-8"><a href="#cb104-8"></a><span class="kw">import</span> <span class="im">retrofit2.Call</span></span>
<span id="cb104-9"><a href="#cb104-9"></a><span class="kw">import</span> <span class="im">java.io.IOException</span></span>
<span id="cb104-10"><a href="#cb104-10"></a><span class="kw">import</span> <span class="im">java.util.*</span></span>
<span id="cb104-11"><a href="#cb104-11"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb104-12"><a href="#cb104-12"></a><span class="kw">import</span> <span class="im">javax.inject.Named</span></span>
<span id="cb104-13"><a href="#cb104-13"></a><span class="kw">import</span> <span class="im">javax.inject.Singleton</span></span>
<span id="cb104-14"><a href="#cb104-14"></a></span>
<span id="cb104-15"><a href="#cb104-15"></a><span class="at">@Singleton</span></span>
<span id="cb104-16"><a href="#cb104-16"></a><span class="kw">class</span> Repository @Inject <span class="kw">constructor</span>(<span class="kw">private</span> <span class="kw">val</span> <span class="va">database</span>: <span class="dt">AppDatabase</span>, <span class="kw">private</span> <span class="kw">val</span> <span class="va">webService</span>: <span class="dt">WebService</span>, @<span class="va">param</span>:<span class="dt">Named</span>(&quot;<span class="va">consumerKey</span>&quot;) <span class="kw">private</span> <span class="kw">val</span> consumerKey: <span class="dt">String</span>) {</span>
<span id="cb104-17"><a href="#cb104-17"></a>    ...</span>
<span id="cb104-18"><a href="#cb104-18"></a></span>
<span id="cb104-19"><a href="#cb104-19"></a>    suspend <span class="kw">fun</span> <span class="fu">syncTimeTables</span>(<span class="va">routes</span>: <span class="dt">Iterable</span>&lt;<span class="va">Route</span>&gt;) = withContext(Dispatchers.IO) {</span>
<span id="cb104-20"><a href="#cb104-20"></a>        <span class="cf">try</span> {</span>
<span id="cb104-21"><a href="#cb104-21"></a>            <span class="cf">for</span> (route <span class="kw">in</span> routes) {</span>
<span id="cb104-22"><a href="#cb104-22"></a>                delay(<span class="dv">0</span>)  <span class="co">// 一応だけど、キャンセル可能にしてみました。。。</span></span>
<span id="cb104-23"><a href="#cb104-23"></a></span>
<span id="cb104-24"><a href="#cb104-24"></a>                <span class="cf">if</span> (database.getTimeTableDao().getCountByRouteId(route.id) &gt; <span class="dv">0</span>) {</span>
<span id="cb104-25"><a href="#cb104-25"></a>                    <span class="cf">continue</span></span>
<span id="cb104-26"><a href="#cb104-26"></a>                }</span>
<span id="cb104-27"><a href="#cb104-27"></a></span>
<span id="cb104-28"><a href="#cb104-28"></a>                <span class="kw">val</span> <span class="va">timeTableJsonArray</span> = getWebServiceResultBody { webService.busTimeTable(consumerKey, route.id) } ?: return<span class="at">@withContext</span> <span class="kw">null</span></span>
<span id="cb104-29"><a href="#cb104-29"></a></span>
<span id="cb104-30"><a href="#cb104-30"></a>                database.withTransaction {</span>
<span id="cb104-31"><a href="#cb104-31"></a>                    <span class="cf">for</span> (timeTableJsonObject <span class="kw">in</span> timeTableJsonArray.map { it.asJsonObject }) {</span>
<span id="cb104-32"><a href="#cb104-32"></a>                        <span class="kw">val</span> <span class="va">timeTable</span> = TimeTable(</span>
<span id="cb104-33"><a href="#cb104-33"></a>                            timeTableJsonObject.<span class="kw">get</span>(<span class="st">&quot;owl:sameAs&quot;</span>).asString,</span>
<span id="cb104-34"><a href="#cb104-34"></a>                            timeTableJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:busroutePattern&quot;</span>).asString</span>
<span id="cb104-35"><a href="#cb104-35"></a>                        ).also {</span>
<span id="cb104-36"><a href="#cb104-36"></a>                            database.getTimeTableDao().add(it)</span>
<span id="cb104-37"><a href="#cb104-37"></a>                        }</span>
<span id="cb104-38"><a href="#cb104-38"></a></span>
<span id="cb104-39"><a href="#cb104-39"></a>                        <span class="cf">for</span> (timeTableDetailJsonObject <span class="kw">in</span> timeTableJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:busTimetableObject&quot;</span>).asJsonArray.map { it.asJsonObject }) {</span>
<span id="cb104-40"><a href="#cb104-40"></a>                            TimeTableDetail(</span>
<span id="cb104-41"><a href="#cb104-41"></a>                                timeTable.id,</span>
<span id="cb104-42"><a href="#cb104-42"></a>                                timeTableDetailJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:index&quot;</span>).asInt,</span>
<span id="cb104-43"><a href="#cb104-43"></a>                                timeTableDetailJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:busstopPole&quot;</span>).asString,</span>
<span id="cb104-44"><a href="#cb104-44"></a>                                timeTableDetailJsonObject.<span class="kw">get</span>(<span class="st">&quot;odpt:arrivalTime&quot;</span>).asString.split(<span class="st">&quot;:&quot;</span>).let { (hour, minute) -&gt; hour.toInt() * <span class="dv">60</span> * <span class="dv">60</span> + minute.toInt() * <span class="dv">60</span> }</span>
<span id="cb104-45"><a href="#cb104-45"></a>                            ).also {</span>
<span id="cb104-46"><a href="#cb104-46"></a>                                it.id = database.getTimeTableDetailDao().add(it)</span>
<span id="cb104-47"><a href="#cb104-47"></a>                            }</span>
<span id="cb104-48"><a href="#cb104-48"></a>                        }</span>
<span id="cb104-49"><a href="#cb104-49"></a>                    }</span>
<span id="cb104-50"><a href="#cb104-50"></a>                }</span>
<span id="cb104-51"><a href="#cb104-51"></a>            }</span>
<span id="cb104-52"><a href="#cb104-52"></a></span>
<span id="cb104-53"><a href="#cb104-53"></a>            <span class="kw">Unit</span></span>
<span id="cb104-54"><a href="#cb104-54"></a></span>
<span id="cb104-55"><a href="#cb104-55"></a>        } <span class="cf">catch</span> (e: IOException) {</span>
<span id="cb104-56"><a href="#cb104-56"></a>            Log.e(<span class="st">&quot;Repository&quot;</span>, <span class="st">&quot;${e.message}&quot;</span>)</span>
<span id="cb104-57"><a href="#cb104-57"></a>            <span class="kw">null</span></span>
<span id="cb104-58"><a href="#cb104-58"></a>        }</span>
<span id="cb104-59"><a href="#cb104-59"></a>    }</span>
<span id="cb104-60"><a href="#cb104-60"></a></span>
<span id="cb104-61"><a href="#cb104-61"></a>    suspend <span class="kw">fun</span> <span class="fu">clearBookmarks</span>() = withContext(Dispatchers.IO) {</span>
<span id="cb104-62"><a href="#cb104-62"></a>        database.getBookmarkDao().clear()</span>
<span id="cb104-63"><a href="#cb104-63"></a>    }</span>
<span id="cb104-64"><a href="#cb104-64"></a></span>
<span id="cb104-65"><a href="#cb104-65"></a>    suspend <span class="kw">fun</span> <span class="fu">toggleBookmark</span>(<span class="va">departureBusStopName</span>: <span class="dt">String</span>, <span class="va">arrivalBusStopName</span>: <span class="dt">String</span>) = withContext(Dispatchers.IO) {</span>
<span id="cb104-66"><a href="#cb104-66"></a>        <span class="kw">val</span> <span class="va">bookmark</span> = database.getBookmarkDao().<span class="kw">get</span>(departureBusStopName, arrivalBusStopName)</span>
<span id="cb104-67"><a href="#cb104-67"></a></span>
<span id="cb104-68"><a href="#cb104-68"></a>        <span class="cf">if</span> (bookmark == <span class="kw">null</span>) {</span>
<span id="cb104-69"><a href="#cb104-69"></a>            database.getBookmarkDao().add(Bookmark(departureBusStopName, arrivalBusStopName))</span>
<span id="cb104-70"><a href="#cb104-70"></a>        } <span class="cf">else</span> {</span>
<span id="cb104-71"><a href="#cb104-71"></a>            database.getBookmarkDao().remove(bookmark)</span>
<span id="cb104-72"><a href="#cb104-72"></a>        }</span>
<span id="cb104-73"><a href="#cb104-73"></a>    }</span>
<span id="cb104-74"><a href="#cb104-74"></a></span>
<span id="cb104-75"><a href="#cb104-75"></a>    suspend <span class="kw">fun</span> <span class="fu">getBuses</span>(<span class="va">routes</span>: <span class="dt">Iterable</span>&lt;<span class="va">Route</span>&gt;, <span class="va">routeBusStopPoles</span>: <span class="dt">Iterable</span>&lt;<span class="va">RouteBusStopPole</span>&gt;) = withContext(Dispatchers.IO) {</span>
<span id="cb104-76"><a href="#cb104-76"></a>        <span class="cf">try</span> {</span>
<span id="cb104-77"><a href="#cb104-77"></a>            <span class="kw">val</span> <span class="va">busStopPoleIds</span> = routeBusStopPoles.groupBy { it.routeId }.map { (routeId, routeBusStopPoles) -&gt; Pair(routeId, routeBusStopPoles.map { it.busStopPoleId }.toSet()) }.toMap()</span>
<span id="cb104-78"><a href="#cb104-78"></a></span>
<span id="cb104-79"><a href="#cb104-79"></a>            getWebServiceResultBody { webService.bus(consumerKey, routes.map { it.id }.joinToString(<span class="st">&quot;,&quot;</span>)) }?.filter { bus -&gt;</span>
<span id="cb104-80"><a href="#cb104-80"></a>                <span class="co">// routeBusStopPolesに含まれるバス停を出発したところ、かつ、routeBusStopPolesの同じルートの最後（つまり出発バス停）を出発したのではない</span></span>
<span id="cb104-81"><a href="#cb104-81"></a>                bus.fromBusStopPoleId <span class="kw">in</span> busStopPoleIds.getValue(bus.routeId) &amp;&amp; bus.fromBusStopPoleId != routeBusStopPoles.filter { it.routeId == bus.routeId }.sortedByDescending { it.order }.first().busStopPoleId</span>
<span id="cb104-82"><a href="#cb104-82"></a>            }</span>
<span id="cb104-83"><a href="#cb104-83"></a></span>
<span id="cb104-84"><a href="#cb104-84"></a>        } <span class="cf">catch</span> (e: IOException) {</span>
<span id="cb104-85"><a href="#cb104-85"></a>            Log.e(<span class="st">&quot;Repository&quot;</span>, <span class="st">&quot;${e.message}&quot;</span>)</span>
<span id="cb104-86"><a href="#cb104-86"></a>            <span class="kw">null</span></span>
<span id="cb104-87"><a href="#cb104-87"></a>        }</span>
<span id="cb104-88"><a href="#cb104-88"></a>    }</span>
<span id="cb104-89"><a href="#cb104-89"></a></span>
<span id="cb104-90"><a href="#cb104-90"></a>    ...</span>
<span id="cb104-91"><a href="#cb104-91"></a>    <span class="kw">fun</span> <span class="fu">getObservableBusStopPolesByRouteBusStopPoles</span>(<span class="va">routeBusStopPoles</span>: <span class="dt">Iterable</span>&lt;<span class="va">RouteBusStopPole</span>&gt;) = database.getBusStopPoleDao().getObservablesByIds(routeBusStopPoles.map { it.busStopPoleId }.distinct())  <span class="co">// 複数の路線が同じバス停を含んでいる可能性があるので、distinct()しておきます。</span></span>
<span id="cb104-92"><a href="#cb104-92"></a>    ...</span>
<span id="cb104-93"><a href="#cb104-93"></a>    <span class="kw">fun</span> <span class="fu">getObservableRouteBusStopPolesByRoutes</span>(<span class="va">routes</span>: <span class="dt">Iterable</span>&lt;<span class="va">Route</span>&gt;, <span class="va">departureBusStopName</span>: <span class="dt">String</span>) = database.getRouteBusStopPoleDao().getObservablesByRouteIdsAndDepartureBusStopName(routes.map { it.id }, departureBusStopName)</span>
<span id="cb104-94"><a href="#cb104-94"></a>    <span class="kw">fun</span> <span class="fu">getObservableRoutesByDepartureBusStopNameAndArrivalBusStopName</span>(<span class="va">departureBusStopName</span>: <span class="dt">String</span>, <span class="va">arrivalBusStopName</span>: <span class="dt">String</span>) = database.getRouteDao().getObservablesByDepartureBusStopNameAndArrivalBusStopName(departureBusStopName, arrivalBusStopName)</span>
<span id="cb104-95"><a href="#cb104-95"></a>    <span class="kw">fun</span> <span class="fu">getObservableTimeTablesByRoutesAndDepartureBusStop</span>(<span class="va">routes</span>: <span class="dt">Iterable</span>&lt;<span class="va">Route</span>&gt;, <span class="va">departureBusStopName</span>: <span class="dt">String</span>) = database.getTimeTableDao().getObservablesByRouteIdsAndDepartureBusStopName(routes.map { it.id }, departureBusStopName, Calendar.getInstance().let { it.<span class="kw">get</span>(Calendar.HOUR_OF_DAY) * <span class="dv">60</span> * <span class="dv">60</span> + it.<span class="kw">get</span>(Calendar.MINUTE) * <span class="dv">60</span> })</span>
<span id="cb104-96"><a href="#cb104-96"></a>    <span class="kw">fun</span> <span class="fu">getObservableTimeTableDetailsByTimeTablesAndBusStopPoles</span>(<span class="va">timeTables</span>: <span class="dt">Iterable</span>&lt;<span class="va">TimeTable</span>&gt;, <span class="va">busStopPoles</span>: <span class="dt">Iterable</span>&lt;<span class="va">BusStopPole</span>&gt;) = database.getTimeTableDetailDao().getObservablesByTimeTableIdsAndBusStopPoleIds(timeTables.map { it.id }, busStopPoles.map { it.id })</span>
<span id="cb104-97"><a href="#cb104-97"></a>}</span></code></pre></div>
<p><code>syncTimeTables()</code>は<code>syncDatabase()</code>の外側にループがもう一つ付いただけ。これで、<code>TimeTable</code>と<code>TimeTableDetail</code>をデータベースにキャッシュできるようになりました。<code>clearBookmarks()</code>はバス停が廃止された場合にブックマークの削除ができなくなっちゃうじゃんと考えてこっそり追加した[ブックマークを全て削除]メニュー向けのメソッド、<code>toggleBookmark()</code>は前の章で作成した（けど説明をし忘れた）ブックマークを設定したり解除したりするためのメソッドです。</p>
<p>重要なのはここから。<code>getBuses()</code>はWebサービスを呼び出しているのですけど、このWebサービスって<code>Route</code>のバスを全て返すんですよ。で、データ・アクセス・オブジェクトのところで何度も考えたように、出発バス停以降を走っているバスや出発バス停のはるか手前を走っているバスの情報は不要です。なので、不要な情報を削除する処理をこのメソッドの中に入れています。出発バス停を出発したバスを除外するところが格好悪いコードになっていますけど、ご容赦ください。</p>
<p>あと、たとえば<code>BusStopPoleDao.getObservablesByIds()</code>ではIDの集合が引数になっていたわけですけど、それだと呼び出しづらいので、<code>BusStopPoleDao.getObservablesByIds()</code>をラップする<code>getObservableBusStopPolesByRouteBusStopPoles()</code>は<code>RouteBusStopPole</code>の集合を引数に呼び出せるようにしたりしています。<code>getObservableRouteBusStopPolesByRoutes()</code>や<code>getObservableTimeTableDetailsByTimeTablesAndBusStopPoles()</code>も同様。<code>getObservableTimeTablesByRoutesAndDepartureBusStop()</code>では、それにくわええて現在時刻の引数を生成しています。</p>
<p>うん、<code>Repository</code>を作っておいて良かった。これなら<code>ViewModel</code>の作成は簡単でしょう。</p>
<h2 id="viewmodelを作成する">ViewModelを作成する</h2>
<p>たしかに<code>ViewModel</code>の作成は簡単っちゃあ簡単なんですけど、面倒くださいです。その理由は<code>MediatorLiveData</code>。同じような記述を何度も繰り返さなければならないので、簡単だけど面倒でした……。その<code>BusApproachesViewModel</code>はこんな感じ。</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb105-1"><a href="#cb105-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.view_model</span></span>
<span id="cb105-2"><a href="#cb105-2"></a></span>
<span id="cb105-3"><a href="#cb105-3"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.*</span></span>
<span id="cb105-4"><a href="#cb105-4"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.*</span></span>
<span id="cb105-5"><a href="#cb105-5"></a><span class="kw">import</span> <span class="im">kotlinx.coroutines.Job</span></span>
<span id="cb105-6"><a href="#cb105-6"></a><span class="kw">import</span> <span class="im">kotlinx.coroutines.cancelAndJoin</span></span>
<span id="cb105-7"><a href="#cb105-7"></a><span class="kw">import</span> <span class="im">kotlinx.coroutines.delay</span></span>
<span id="cb105-8"><a href="#cb105-8"></a><span class="kw">import</span> <span class="im">kotlinx.coroutines.launch</span></span>
<span id="cb105-9"><a href="#cb105-9"></a></span>
<span id="cb105-10"><a href="#cb105-10"></a><span class="kw">class</span> BusApproachesViewModel(<span class="kw">private</span> <span class="kw">val</span> <span class="va">repository</span>: <span class="dt">Repository</span>): <span class="dt">ViewModel</span>() {</span>
<span id="cb105-11"><a href="#cb105-11"></a>    <span class="kw">val</span> <span class="va">departureBusStopName</span> = MutableLiveData&lt;<span class="kw">String</span>&gt;()</span>
<span id="cb105-12"><a href="#cb105-12"></a></span>
<span id="cb105-13"><a href="#cb105-13"></a>    <span class="kw">val</span> <span class="va">arrivalBusStopName</span> = MutableLiveData&lt;<span class="kw">String</span>&gt;()</span>
<span id="cb105-14"><a href="#cb105-14"></a></span>
<span id="cb105-15"><a href="#cb105-15"></a>    <span class="kw">val</span> <span class="va">bookmark</span> = MediatorLiveData&lt;Bookmark?&gt;().apply {</span>
<span id="cb105-16"><a href="#cb105-16"></a>        <span class="kw">var</span> <span class="va">source</span>: LiveData&lt;Bookmark?&gt;? = <span class="kw">null</span></span>
<span id="cb105-17"><a href="#cb105-17"></a></span>
<span id="cb105-18"><a href="#cb105-18"></a>        <span class="kw">fun</span> <span class="fu">update</span>() {</span>
<span id="cb105-19"><a href="#cb105-19"></a>            <span class="kw">val</span> <span class="va">departureBusStopNameValue</span> = departureBusStopName.value ?: <span class="kw">return</span></span>
<span id="cb105-20"><a href="#cb105-20"></a>            <span class="kw">val</span> <span class="va">arrivalBusStopNameValue</span>   = arrivalBusStopName.value   ?: <span class="kw">return</span></span>
<span id="cb105-21"><a href="#cb105-21"></a></span>
<span id="cb105-22"><a href="#cb105-22"></a>            source?.let {</span>
<span id="cb105-23"><a href="#cb105-23"></a>                removeSource(it)</span>
<span id="cb105-24"><a href="#cb105-24"></a>            }</span>
<span id="cb105-25"><a href="#cb105-25"></a></span>
<span id="cb105-26"><a href="#cb105-26"></a>            source = repository.getObservableBookmarkByDepartureBusStopNameAndArrivalBusStopName(departureBusStopNameValue, arrivalBusStopNameValue).also {</span>
<span id="cb105-27"><a href="#cb105-27"></a>                addSource(it) { sourceValue -&gt;</span>
<span id="cb105-28"><a href="#cb105-28"></a>                    value = sourceValue</span>
<span id="cb105-29"><a href="#cb105-29"></a>                }</span>
<span id="cb105-30"><a href="#cb105-30"></a>            }</span>
<span id="cb105-31"><a href="#cb105-31"></a>        }</span>
<span id="cb105-32"><a href="#cb105-32"></a></span>
<span id="cb105-33"><a href="#cb105-33"></a>        addSource(departureBusStopName) { update() }</span>
<span id="cb105-34"><a href="#cb105-34"></a>        addSource(arrivalBusStopName)   { update() }</span>
<span id="cb105-35"><a href="#cb105-35"></a>    }</span>
<span id="cb105-36"><a href="#cb105-36"></a></span>
<span id="cb105-37"><a href="#cb105-37"></a>    <span class="kw">val</span> <span class="va">routes</span> = MediatorLiveData&lt;List&lt;Route&gt;&gt;().apply {</span>
<span id="cb105-38"><a href="#cb105-38"></a>        <span class="kw">var</span> <span class="va">source</span>: LiveData&lt;List&lt;Route&gt;&gt;? = <span class="kw">null</span></span>
<span id="cb105-39"><a href="#cb105-39"></a></span>
<span id="cb105-40"><a href="#cb105-40"></a>        <span class="kw">fun</span> <span class="fu">update</span>() {</span>
<span id="cb105-41"><a href="#cb105-41"></a>            <span class="kw">val</span> <span class="va">departureBusStopNameValue</span> = departureBusStopName.value ?: <span class="kw">return</span></span>
<span id="cb105-42"><a href="#cb105-42"></a>            <span class="kw">val</span> <span class="va">arrivalBusStopNameValue</span>   = arrivalBusStopName.value   ?: <span class="kw">return</span></span>
<span id="cb105-43"><a href="#cb105-43"></a></span>
<span id="cb105-44"><a href="#cb105-44"></a>            source?.let {</span>
<span id="cb105-45"><a href="#cb105-45"></a>                removeSource(it)</span>
<span id="cb105-46"><a href="#cb105-46"></a>            }</span>
<span id="cb105-47"><a href="#cb105-47"></a></span>
<span id="cb105-48"><a href="#cb105-48"></a>            source = repository.getObservableRoutesByDepartureBusStopNameAndArrivalBusStopName(departureBusStopNameValue, arrivalBusStopNameValue).also {</span>
<span id="cb105-49"><a href="#cb105-49"></a>                addSource(it) { sourceValue -&gt;</span>
<span id="cb105-50"><a href="#cb105-50"></a>                    value = sourceValue</span>
<span id="cb105-51"><a href="#cb105-51"></a>                }</span>
<span id="cb105-52"><a href="#cb105-52"></a>            }</span>
<span id="cb105-53"><a href="#cb105-53"></a>        }</span>
<span id="cb105-54"><a href="#cb105-54"></a></span>
<span id="cb105-55"><a href="#cb105-55"></a>        addSource(departureBusStopName) { update() }</span>
<span id="cb105-56"><a href="#cb105-56"></a>        addSource(arrivalBusStopName)   { update() }</span>
<span id="cb105-57"><a href="#cb105-57"></a>    }</span>
<span id="cb105-58"><a href="#cb105-58"></a></span>
<span id="cb105-59"><a href="#cb105-59"></a>    <span class="kw">val</span> <span class="va">routeBusStopPoles</span> = MediatorLiveData&lt;List&lt;RouteBusStopPole&gt;&gt;().apply {</span>
<span id="cb105-60"><a href="#cb105-60"></a>        <span class="kw">var</span> <span class="va">source</span>: LiveData&lt;List&lt;RouteBusStopPole&gt;&gt;? = <span class="kw">null</span></span>
<span id="cb105-61"><a href="#cb105-61"></a></span>
<span id="cb105-62"><a href="#cb105-62"></a>        <span class="kw">fun</span> <span class="fu">update</span>() {</span>
<span id="cb105-63"><a href="#cb105-63"></a>            <span class="kw">val</span> <span class="va">routesValue</span>               = routes.value               ?: <span class="kw">return</span></span>
<span id="cb105-64"><a href="#cb105-64"></a>            <span class="kw">val</span> <span class="va">departureBusStopNameValue</span> = departureBusStopName.value ?: <span class="kw">return</span></span>
<span id="cb105-65"><a href="#cb105-65"></a></span>
<span id="cb105-66"><a href="#cb105-66"></a>            source?.let {</span>
<span id="cb105-67"><a href="#cb105-67"></a>                removeSource(it)</span>
<span id="cb105-68"><a href="#cb105-68"></a>            }</span>
<span id="cb105-69"><a href="#cb105-69"></a></span>
<span id="cb105-70"><a href="#cb105-70"></a>            source = repository.getObservableRouteBusStopPolesByRoutes(routesValue, departureBusStopNameValue).also {</span>
<span id="cb105-71"><a href="#cb105-71"></a>                addSource(it) { sourceValue -&gt;</span>
<span id="cb105-72"><a href="#cb105-72"></a>                    value = sourceValue</span>
<span id="cb105-73"><a href="#cb105-73"></a>                }</span>
<span id="cb105-74"><a href="#cb105-74"></a>            }</span>
<span id="cb105-75"><a href="#cb105-75"></a>        }</span>
<span id="cb105-76"><a href="#cb105-76"></a></span>
<span id="cb105-77"><a href="#cb105-77"></a>        addSource(routes)               { update() }</span>
<span id="cb105-78"><a href="#cb105-78"></a>        addSource(departureBusStopName) { update() }</span>
<span id="cb105-79"><a href="#cb105-79"></a>    }</span>
<span id="cb105-80"><a href="#cb105-80"></a></span>
<span id="cb105-81"><a href="#cb105-81"></a>    <span class="kw">val</span> <span class="va">busStopPoles</span> = Transformations.switchMap(routeBusStopPoles) { routeStopPolesValue -&gt;</span>
<span id="cb105-82"><a href="#cb105-82"></a>        repository.getObservableBusStopPolesByRouteBusStopPoles(routeStopPolesValue)</span>
<span id="cb105-83"><a href="#cb105-83"></a>    }</span>
<span id="cb105-84"><a href="#cb105-84"></a></span>
<span id="cb105-85"><a href="#cb105-85"></a>    <span class="kw">val</span> <span class="va">timeTables</span> = MediatorLiveData&lt;List&lt;TimeTable&gt;&gt;().apply {</span>
<span id="cb105-86"><a href="#cb105-86"></a>        <span class="kw">var</span> <span class="va">source</span>: LiveData&lt;List&lt;TimeTable&gt;&gt;? = <span class="kw">null</span></span>
<span id="cb105-87"><a href="#cb105-87"></a>        <span class="kw">var</span> <span class="va">job</span>: Job? = <span class="kw">null</span></span>
<span id="cb105-88"><a href="#cb105-88"></a></span>
<span id="cb105-89"><a href="#cb105-89"></a>        <span class="kw">fun</span> <span class="fu">update</span>() = viewModelScope.launch {  <span class="co">// Jobの管理をしたいので、launchします</span></span>
<span id="cb105-90"><a href="#cb105-90"></a>            <span class="kw">val</span> <span class="va">routesValue</span>               = routes.value               ?: return<span class="at">@launch</span></span>
<span id="cb105-91"><a href="#cb105-91"></a>            <span class="kw">val</span> <span class="va">departureBusStopNameValue</span> = departureBusStopName.value ?: return<span class="at">@launch</span></span>
<span id="cb105-92"><a href="#cb105-92"></a></span>
<span id="cb105-93"><a href="#cb105-93"></a>            source?.let {</span>
<span id="cb105-94"><a href="#cb105-94"></a>                removeSource(it)</span>
<span id="cb105-95"><a href="#cb105-95"></a>            }</span>
<span id="cb105-96"><a href="#cb105-96"></a></span>
<span id="cb105-97"><a href="#cb105-97"></a>            source = repository.getObservableTimeTablesByRoutesAndDepartureBusStop(routesValue, departureBusStopNameValue).also {</span>
<span id="cb105-98"><a href="#cb105-98"></a>                addSource(it) { sourceValue -&gt;</span>
<span id="cb105-99"><a href="#cb105-99"></a>                    value = sourceValue</span>
<span id="cb105-100"><a href="#cb105-100"></a>                }</span>
<span id="cb105-101"><a href="#cb105-101"></a>            }</span>
<span id="cb105-102"><a href="#cb105-102"></a></span>
<span id="cb105-103"><a href="#cb105-103"></a>            job?.cancelAndJoin()</span>
<span id="cb105-104"><a href="#cb105-104"></a></span>
<span id="cb105-105"><a href="#cb105-105"></a>            job = viewModelScope.launch {</span>
<span id="cb105-106"><a href="#cb105-106"></a>                repository.syncTimeTables(routesValue)</span>
<span id="cb105-107"><a href="#cb105-107"></a>            }</span>
<span id="cb105-108"><a href="#cb105-108"></a>        }</span>
<span id="cb105-109"><a href="#cb105-109"></a></span>
<span id="cb105-110"><a href="#cb105-110"></a>        addSource(routes)               { update() }</span>
<span id="cb105-111"><a href="#cb105-111"></a>        addSource(departureBusStopName) { update() }</span>
<span id="cb105-112"><a href="#cb105-112"></a>    }</span>
<span id="cb105-113"><a href="#cb105-113"></a></span>
<span id="cb105-114"><a href="#cb105-114"></a>    <span class="kw">val</span> <span class="va">timeTableDetails</span> = MediatorLiveData&lt;List&lt;TimeTableDetail&gt;&gt;().apply {</span>
<span id="cb105-115"><a href="#cb105-115"></a>        <span class="kw">var</span> <span class="va">source</span>: LiveData&lt;List&lt;TimeTableDetail&gt;&gt;? = <span class="kw">null</span></span>
<span id="cb105-116"><a href="#cb105-116"></a></span>
<span id="cb105-117"><a href="#cb105-117"></a>        <span class="kw">fun</span> <span class="fu">update</span>() {</span>
<span id="cb105-118"><a href="#cb105-118"></a>            <span class="kw">val</span> <span class="va">timeTablesValue</span>   = timeTables.value   ?: <span class="kw">return</span></span>
<span id="cb105-119"><a href="#cb105-119"></a>            <span class="kw">val</span> <span class="va">busStopPolesValue</span> = busStopPoles.value ?: <span class="kw">return</span></span>
<span id="cb105-120"><a href="#cb105-120"></a></span>
<span id="cb105-121"><a href="#cb105-121"></a>            source?.let {</span>
<span id="cb105-122"><a href="#cb105-122"></a>                removeSource(it)</span>
<span id="cb105-123"><a href="#cb105-123"></a>            }</span>
<span id="cb105-124"><a href="#cb105-124"></a></span>
<span id="cb105-125"><a href="#cb105-125"></a>            source = repository.getObservableTimeTableDetailsByTimeTablesAndBusStopPoles(timeTablesValue, busStopPolesValue).also {</span>
<span id="cb105-126"><a href="#cb105-126"></a>                addSource(it) { sourceValue -&gt;</span>
<span id="cb105-127"><a href="#cb105-127"></a>                    value = sourceValue</span>
<span id="cb105-128"><a href="#cb105-128"></a>                }</span>
<span id="cb105-129"><a href="#cb105-129"></a>            }</span>
<span id="cb105-130"><a href="#cb105-130"></a>        }</span>
<span id="cb105-131"><a href="#cb105-131"></a></span>
<span id="cb105-132"><a href="#cb105-132"></a>        addSource(timeTables)   { update() }</span>
<span id="cb105-133"><a href="#cb105-133"></a>        addSource(busStopPoles) { update() }</span>
<span id="cb105-134"><a href="#cb105-134"></a>    }</span>
<span id="cb105-135"><a href="#cb105-135"></a></span>
<span id="cb105-136"><a href="#cb105-136"></a>    <span class="kw">val</span> <span class="va">buses</span> = MediatorLiveData&lt;List&lt;Bus&gt;&gt;().apply {</span>
<span id="cb105-137"><a href="#cb105-137"></a>        <span class="kw">var</span> <span class="va">job</span>: Job? = <span class="kw">null</span></span>
<span id="cb105-138"><a href="#cb105-138"></a></span>
<span id="cb105-139"><a href="#cb105-139"></a>        <span class="kw">fun</span> <span class="fu">update</span>() = viewModelScope.launch {  <span class="co">// Jobの管理をしたいので、launchします</span></span>
<span id="cb105-140"><a href="#cb105-140"></a>            <span class="kw">val</span> <span class="va">routesValue</span>            = routes.value            ?: return<span class="at">@launch</span></span>
<span id="cb105-141"><a href="#cb105-141"></a>            <span class="kw">val</span> <span class="va">routeBusStopPolesValue</span> = routeBusStopPoles.value ?: return<span class="at">@launch</span></span>
<span id="cb105-142"><a href="#cb105-142"></a></span>
<span id="cb105-143"><a href="#cb105-143"></a>            job?.cancelAndJoin()</span>
<span id="cb105-144"><a href="#cb105-144"></a></span>
<span id="cb105-145"><a href="#cb105-145"></a>            job = viewModelScope.launch {</span>
<span id="cb105-146"><a href="#cb105-146"></a>                <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb105-147"><a href="#cb105-147"></a>                    value = repository.getBuses(routesValue, routeBusStopPolesValue) ?: listOf()</span>
<span id="cb105-148"><a href="#cb105-148"></a></span>
<span id="cb105-149"><a href="#cb105-149"></a>                    delay(<span class="dv">15000</span>)</span>
<span id="cb105-150"><a href="#cb105-150"></a>                }</span>
<span id="cb105-151"><a href="#cb105-151"></a>            }</span>
<span id="cb105-152"><a href="#cb105-152"></a>        }</span>
<span id="cb105-153"><a href="#cb105-153"></a></span>
<span id="cb105-154"><a href="#cb105-154"></a>        addSource(routes)            { update() }</span>
<span id="cb105-155"><a href="#cb105-155"></a>        addSource(routeBusStopPoles) { update() }</span>
<span id="cb105-156"><a href="#cb105-156"></a>    }</span>
<span id="cb105-157"><a href="#cb105-157"></a></span>
<span id="cb105-158"><a href="#cb105-158"></a>    <span class="kw">val</span> <span class="va">busApproaches</span> = MediatorLiveData&lt;List&lt;BusApproach&gt;&gt;().apply {</span>
<span id="cb105-159"><a href="#cb105-159"></a>        <span class="kw">fun</span> <span class="fu">update</span>() {</span>
<span id="cb105-160"><a href="#cb105-160"></a>            <span class="kw">val</span> <span class="va">routesValue</span>            = routes.value            ?: <span class="kw">return</span></span>
<span id="cb105-161"><a href="#cb105-161"></a>            <span class="kw">val</span> <span class="va">routeBusStopPolesValue</span> = routeBusStopPoles.value ?: <span class="kw">return</span></span>
<span id="cb105-162"><a href="#cb105-162"></a>            <span class="kw">val</span> <span class="va">busStopPolesValue</span>      = busStopPoles.value      ?: <span class="kw">return</span></span>
<span id="cb105-163"><a href="#cb105-163"></a>            <span class="kw">val</span> <span class="va">timeTablesValue</span>        = timeTables.value        <span class="co">// syncTimeTable()は時間がかかるので、</span></span>
<span id="cb105-164"><a href="#cb105-164"></a>            <span class="kw">val</span> <span class="va">timeTableDetailsValue</span>  = timeTableDetails.value  <span class="co">// 時刻表がない場合はバス停の数で代用することにしてnullでも強行します。</span></span>
<span id="cb105-165"><a href="#cb105-165"></a>            <span class="kw">val</span> <span class="va">busesValue</span>             = buses.value             ?: <span class="kw">return</span></span>
<span id="cb105-166"><a href="#cb105-166"></a></span>
<span id="cb105-167"><a href="#cb105-167"></a>            value = busesValue.map { bus -&gt;</span>
<span id="cb105-168"><a href="#cb105-168"></a>                BusApproach(</span>
<span id="cb105-169"><a href="#cb105-169"></a>                    bus.id,</span>
<span id="cb105-170"><a href="#cb105-170"></a>                    timeTablesValue?.find { timeTable -&gt; timeTable.routeId == bus.routeId }?.let { timeTable -&gt;</span>
<span id="cb105-171"><a href="#cb105-171"></a>                        timeTableDetailsValue?.filter { it.timeTableId == timeTable.id }?.sortedByDescending { it.order }?.takeWhile { it.busStopPoleId != bus.fromBusStopPoleId }?.zipWithNext()?.map { (next, prev) -&gt; next.arrival - prev.arrival }?.sum()</span>
<span id="cb105-172"><a href="#cb105-172"></a>                    },</span>
<span id="cb105-173"><a href="#cb105-173"></a>                    routeBusStopPolesValue.sortedByDescending { it.order }.let { it.first().order - it.find { routeBusStopPole -&gt; routeBusStopPole.busStopPoleId == bus.fromBusStopPoleId }!!.order },</span>
<span id="cb105-174"><a href="#cb105-174"></a>                    routesValue.find { it.id == bus.routeId }!!.name,</span>
<span id="cb105-175"><a href="#cb105-175"></a>                    busStopPolesValue.find { it.id == bus.fromBusStopPoleId }!!.busStopName</span>
<span id="cb105-176"><a href="#cb105-176"></a>                )</span>
<span id="cb105-177"><a href="#cb105-177"></a>            }.sortedWith(compareBy({ it.willArriveAfter ?: <span class="kw">Int</span>.MAX_VALUE }, { it.busStopCount }))</span>
<span id="cb105-178"><a href="#cb105-178"></a>        }</span>
<span id="cb105-179"><a href="#cb105-179"></a></span>
<span id="cb105-180"><a href="#cb105-180"></a>        addSource(routes)            { update() }</span>
<span id="cb105-181"><a href="#cb105-181"></a>        addSource(routeBusStopPoles) { update() }</span>
<span id="cb105-182"><a href="#cb105-182"></a>        addSource(busStopPoles)      { update() }</span>
<span id="cb105-183"><a href="#cb105-183"></a>        addSource(timeTables)        { update() }</span>
<span id="cb105-184"><a href="#cb105-184"></a>        addSource(timeTableDetails)  { update() }</span>
<span id="cb105-185"><a href="#cb105-185"></a>        addSource(buses)             { update() }</span>
<span id="cb105-186"><a href="#cb105-186"></a>    }</span>
<span id="cb105-187"><a href="#cb105-187"></a></span>
<span id="cb105-188"><a href="#cb105-188"></a>    <span class="kw">fun</span> <span class="fu">toggleBookmark</span>() {</span>
<span id="cb105-189"><a href="#cb105-189"></a>        viewModelScope.launch {</span>
<span id="cb105-190"><a href="#cb105-190"></a>            <span class="kw">val</span> <span class="va">departureBusStopNameValue</span> = departureBusStopName.value ?: return<span class="at">@launch</span></span>
<span id="cb105-191"><a href="#cb105-191"></a>            <span class="kw">val</span> <span class="va">arrivalBusStopNameValue</span>   = arrivalBusStopName.value   ?: return<span class="at">@launch</span></span>
<span id="cb105-192"><a href="#cb105-192"></a></span>
<span id="cb105-193"><a href="#cb105-193"></a>            repository.toggleBookmark(departureBusStopNameValue, arrivalBusStopNameValue)</span>
<span id="cb105-194"><a href="#cb105-194"></a>        }</span>
<span id="cb105-195"><a href="#cb105-195"></a>    }</span>
<span id="cb105-196"><a href="#cb105-196"></a>}</span></code></pre></div>
<p>うん、面倒くさかった……。でも、<code>departureBusStopName</code>と<code>arrivalBusStopName</code>、<code>bookmark</code>、<code>routes</code>、<code>routeBusStopPoles</code>、<code>busStopPoles</code>、<code>timeTableDetails</code>については、これまでに説明したやり方をそのまま繰り返しただけなので簡単です。</p>
<p>問題は<code>timeTables</code>プロパティと<code>buses</code>プロパティ、<code>busApproaches</code>プロパティです。<code>TimeTable</code>は<code>Repository</code>の<code>syncTimeTables()</code>メソッドを実行しないとデータベースは空なので、だからどこかで<code>syncTimeTables()</code>を呼ばなければなりません。<code>buses</code>はWebサービスから取得する値で、自分で値を定期的に更新しなければなりません。バスの接近情報そのものである<code>busApproaches</code>は、全ての情報を手作りしなければなりません……。</p>
<p>というわけで、まずは<code>timeTables</code>プロパティから。<code>syncTimeTables()</code>を呼ぶのに一番良いタイミングは<code>routes</code>プロパティと<code>departureBusStopName</code>プロパティの両方に値が設定された時なので、<code>MediatorLiveData&lt;List&lt;TimeTable&gt;&gt;().apply { ... }</code>の中に<code>syncTimeTables()</code>を呼び出す処理を入れたい。値を取得する処理の中に更新処理を入れるのは目的違いな気もするけど、他に適当な場所が無いから今回は我慢。で、syncTimeTables()はコルーチンで呼び出さなければならないので<code>viewModelScope.launch { ... }</code>して呼び出します。今回は<code>routes</code>も<code>departureBusStopName</code>も変更がないので実は考慮しなくても動作するのですけど、念の為に、<code>syncTimeTables()</code>している最中にもう一度<code>viewModelScope.launch { ... }</code>が動いてしまっても二重に処理されないための考慮をしておきたい。というわけで、<code>source</code>と同様に<code>job</code>という変数を作成して、<code>cancelAndJoin()</code>するようにしました。<code>cancelAndJoin()</code>も<code>suspend</code>なメソッドなので、<code>update()</code>全体を<code>viewModelScope.launch { ... }</code>で囲んでいます。これで<code>timeTables</code>プロパティは完成。<code>syncTimeTables()</code>が終わればデータベースが更新されたことがLiveDataで通知されて、結果として<code>timeTables</code>プロパティに値が設定されます。</p>
<p><code>buses</code>プロパティも同じやり方で作りました。こちらは15,000ミリ秒の間隔で繰り返される無限ループです。コルーチンがあると気軽に無限ループが使えて便利ですな。</p>
<p>最後の<code>busApproaches</code>プロパティはゴリゴリにロジックを書いて実現します。で、説明を忘れていたのですけど、このプロパティを作成する前にバスの接近情報を表現する<code>BusApproach</code>を追加しておきます。</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb106-1"><a href="#cb106-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.model</span></span>
<span id="cb106-2"><a href="#cb106-2"></a></span>
<span id="cb106-3"><a href="#cb106-3"></a><span class="kw">data</span> <span class="kw">class</span> BusApproach(</span>
<span id="cb106-4"><a href="#cb106-4"></a>    <span class="kw">val</span> <span class="va">id</span>: <span class="dt">String</span>,</span>
<span id="cb106-5"><a href="#cb106-5"></a>    <span class="kw">val</span> <span class="va">willArriveAfter</span>: <span class="dt">Int?</span>,</span>
<span id="cb106-6"><a href="#cb106-6"></a>    <span class="kw">val</span> <span class="va">busStopCount</span>: <span class="dt">Int</span>,</span>
<span id="cb106-7"><a href="#cb106-7"></a>    <span class="kw">val</span> <span class="va">routeName</span>: <span class="dt">String</span>,</span>
<span id="cb106-8"><a href="#cb106-8"></a>    <span class="kw">val</span> <span class="va">leftBusStopName</span>: <span class="dt">String</span></span>
<span id="cb106-9"><a href="#cb106-9"></a>)</span></code></pre></div>
<p>何秒後に到着するのかを表現する<code>willArriveAfter</code>プロパティに加えて<code>busStopCount</code>プロパティがあるのは、<code>TimeTable</code>を同期する<code>syncTimeTables()</code>はかなり時間がかかるので、それまでの間はあといくつバス停があるのかで到着時刻を判断していただくためです。と、こんな感じに<code>TimeTable</code>がまだない場合も想定しているので、<code>busApproaches</code>プロパティの中の<code>timeTablesValue</code>と<code>timeTableDetailsValue</code>を設定する部分では、<code>null</code>の場合にリターンする処理が省かれているわけですな。</p>
<p>さて、<code>busApproaches</code>プロパティでは、<code>buses</code>の要素である<code>Bus</code>単位で<code>BusApproach</code>を作成します。関数型プログラミングの<code>map</code>ですね。</p>
<p><code>willArriveAfter</code>は、TimeTableDetail（出発バス停から手前10バス停分が入っている）を<code>sortedByDescending()</code>で逆順にソートして、<code>takeWhile</code>で<code>bus.fromBusStopPoleId</code>と異なる間だけ取得します。これで、出発バス停からバスが最後に出発したバス停の次のバス停までを入手できるというわけ。あとは、<code>zipWithNext()</code>でペアを作成して、時刻の差を求めて、合計する。これで、何秒後に到着するのかの情報を取得できました！　関数型プログラミングは本当に楽ちんですな。</p>
<h2 id="fragmentを作成する">Fragmentを作成する</h2>
<p>もう終わったも同然。機械作業でRecyclerViewを組み込みます。</p>
<p>まずはlist_item_bus_approaches.xml。</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb107-1"><a href="#cb107-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb107-2"><a href="#cb107-2"></a><span class="kw">&lt;layout</span></span>
<span id="cb107-3"><a href="#cb107-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb107-4"><a href="#cb107-4"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span><span class="kw">&gt;</span></span>
<span id="cb107-5"><a href="#cb107-5"></a></span>
<span id="cb107-6"><a href="#cb107-6"></a>    <span class="kw">&lt;data&gt;</span></span>
<span id="cb107-7"><a href="#cb107-7"></a>        <span class="kw">&lt;variable</span><span class="ot"> name=</span><span class="st">&quot;item&quot;</span><span class="ot"> type=</span><span class="st">&quot;com.tail_island.jetbus.model.BusApproach&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb107-8"><a href="#cb107-8"></a>    <span class="kw">&lt;/data&gt;</span></span>
<span id="cb107-9"><a href="#cb107-9"></a></span>
<span id="cb107-10"><a href="#cb107-10"></a>    <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb107-11"><a href="#cb107-11"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb107-12"><a href="#cb107-12"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span><span class="kw">&gt;</span></span>
<span id="cb107-13"><a href="#cb107-13"></a></span>
<span id="cb107-14"><a href="#cb107-14"></a>        <span class="kw">&lt;ImageView</span></span>
<span id="cb107-15"><a href="#cb107-15"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/imageView&quot;</span></span>
<span id="cb107-16"><a href="#cb107-16"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;32dp&quot;</span></span>
<span id="cb107-17"><a href="#cb107-17"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;32dp&quot;</span></span>
<span id="cb107-18"><a href="#cb107-18"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb107-19"><a href="#cb107-19"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;@id/routeNameTextView&quot;</span></span>
<span id="cb107-20"><a href="#cb107-20"></a><span class="ot">            app:layout_constraintBottom_toBottomOf=</span><span class="st">&quot;@id/leftBusStopName&quot;</span></span>
<span id="cb107-21"><a href="#cb107-21"></a><span class="ot">            android:src=</span><span class="st">&quot;@drawable/ic_bus&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb107-22"><a href="#cb107-22"></a></span>
<span id="cb107-23"><a href="#cb107-23"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb107-24"><a href="#cb107-24"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/routeNameTextView&quot;</span></span>
<span id="cb107-25"><a href="#cb107-25"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb107-26"><a href="#cb107-26"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb107-27"><a href="#cb107-27"></a><span class="ot">            android:layout_marginStart=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb107-28"><a href="#cb107-28"></a><span class="ot">            android:layout_marginEnd=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb107-29"><a href="#cb107-29"></a><span class="ot">            app:layout_constraintStart_toEndOf=</span><span class="st">&quot;@id/imageView&quot;</span></span>
<span id="cb107-30"><a href="#cb107-30"></a><span class="ot">            app:layout_constraintEnd_toStartOf=</span><span class="st">&quot;@id/willArriveAfterTextView&quot;</span></span>
<span id="cb107-31"><a href="#cb107-31"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb107-32"><a href="#cb107-32"></a><span class="ot">            android:text=</span><span class="st">&quot;@{item.routeName}&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb107-33"><a href="#cb107-33"></a></span>
<span id="cb107-34"><a href="#cb107-34"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb107-35"><a href="#cb107-35"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/leftBusStopNameTextView&quot;</span></span>
<span id="cb107-36"><a href="#cb107-36"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb107-37"><a href="#cb107-37"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb107-38"><a href="#cb107-38"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;@id/routeNameTextView&quot;</span></span>
<span id="cb107-39"><a href="#cb107-39"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;@id/routeNameTextView&quot;</span></span>
<span id="cb107-40"><a href="#cb107-40"></a><span class="ot">            app:layout_constraintTop_toBottomOf=</span><span class="st">&quot;@id/routeNameTextView&quot;</span></span>
<span id="cb107-41"><a href="#cb107-41"></a><span class="ot">            android:text=</span><span class="st">&#39;@{String.format(&quot;%sを通過&quot;, item.leftBusStopName)}&#39;</span> <span class="kw">/&gt;</span></span>
<span id="cb107-42"><a href="#cb107-42"></a></span>
<span id="cb107-43"><a href="#cb107-43"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb107-44"><a href="#cb107-44"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/willArriveAfterTextView&quot;</span></span>
<span id="cb107-45"><a href="#cb107-45"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb107-46"><a href="#cb107-46"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb107-47"><a href="#cb107-47"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb107-48"><a href="#cb107-48"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;@id/routeNameTextView&quot;</span></span>
<span id="cb107-49"><a href="#cb107-49"></a><span class="ot">            app:layout_constraintBottom_toBottomOf=</span><span class="st">&quot;@id/leftBusStopName&quot;</span></span>
<span id="cb107-50"><a href="#cb107-50"></a><span class="ot">            android:textColor=</span><span class="st">&quot;@color/colorAccent&quot;</span></span>
<span id="cb107-51"><a href="#cb107-51"></a><span class="ot">            android:textSize=</span><span class="st">&quot;28sp&quot;</span></span>
<span id="cb107-52"><a href="#cb107-52"></a><span class="ot">            android:text=</span><span class="st">&#39;@{item.willArriveAfter == null ? &quot;-&quot; : String.format(&quot;%d 分&quot;, safeUnbox(item.willArriveAfter) / 60)}&#39;</span> <span class="kw">/&gt;</span></span>
<span id="cb107-53"><a href="#cb107-53"></a></span>
<span id="cb107-54"><a href="#cb107-54"></a>        <span class="kw">&lt;View</span></span>
<span id="cb107-55"><a href="#cb107-55"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb107-56"><a href="#cb107-56"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb107-57"><a href="#cb107-57"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb107-58"><a href="#cb107-58"></a><span class="ot">            app:layout_constraintTop_toBottomOf=</span><span class="st">&quot;@id/leftBusStopName&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb107-59"><a href="#cb107-59"></a></span>
<span id="cb107-60"><a href="#cb107-60"></a>    <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb107-61"><a href="#cb107-61"></a></span>
<span id="cb107-62"><a href="#cb107-62"></a><span class="kw">&lt;/layout&gt;</span></span></code></pre></div>
<p>少しだけ見た目にこだわってみました。Google様が用意してくださっているアイコンの中からバスのアイコンを探し出して<code>ic_bus</code>として登録して<code>&lt;ImageView&gt;</code>タグで表示しています。<code>routeNameTextView</code>で路線名を、<code>leftBusStopNameTextView</code>でどのバス停を出たところなのか、<code>willArriveAfterTextView</code>であと何分で到着するのかを表示します。あ、最後に追加してある<code>&lt;View&gt;</code>タグは、強制的に隙間を作るためのものです……。</p>
<p><code>BusApproachAdapter</code>はいつもどおりのコピー＆ペースト。</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb108-1"><a href="#cb108-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus.adapter</span></span>
<span id="cb108-2"><a href="#cb108-2"></a></span>
<span id="cb108-3"><a href="#cb108-3"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb108-4"><a href="#cb108-4"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb108-5"><a href="#cb108-5"></a><span class="kw">import</span> <span class="im">androidx.recyclerview.widget.DiffUtil</span></span>
<span id="cb108-6"><a href="#cb108-6"></a><span class="kw">import</span> <span class="im">androidx.recyclerview.widget.ListAdapter</span></span>
<span id="cb108-7"><a href="#cb108-7"></a><span class="kw">import</span> <span class="im">androidx.recyclerview.widget.RecyclerView</span></span>
<span id="cb108-8"><a href="#cb108-8"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.ListItemBusApproachBinding</span></span>
<span id="cb108-9"><a href="#cb108-9"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.model.BusApproach</span></span>
<span id="cb108-10"><a href="#cb108-10"></a></span>
<span id="cb108-11"><a href="#cb108-11"></a><span class="kw">class</span> BusApproachAdapter: <span class="dt">ListAdapter</span>&lt;<span class="dt">BusApproach</span>, <span class="dt">BusApproachAdapter</span>.<span class="dt">ViewHolder</span>&gt;(<span class="va">DiffCallback</span>()) {</span>
<span id="cb108-12"><a href="#cb108-12"></a>    inner <span class="kw">class</span> ViewHolder(<span class="kw">private</span> <span class="kw">val</span> <span class="va">binding</span>: <span class="dt">ListItemBusApproachBinding</span>): <span class="dt">RecyclerView</span>.<span class="dt">ViewHolder</span>(<span class="va">binding</span>.<span class="va">root</span>) {</span>
<span id="cb108-13"><a href="#cb108-13"></a>        <span class="kw">fun</span> <span class="fu">bind</span>(<span class="va">item</span>: <span class="dt">BusApproach</span>) {</span>
<span id="cb108-14"><a href="#cb108-14"></a>            binding.item = item</span>
<span id="cb108-15"><a href="#cb108-15"></a>            binding.executePendingBindings()</span>
<span id="cb108-16"><a href="#cb108-16"></a>        }</span>
<span id="cb108-17"><a href="#cb108-17"></a>    }</span>
<span id="cb108-18"><a href="#cb108-18"></a></span>
<span id="cb108-19"><a href="#cb108-19"></a>    <span class="kw">class</span> DiffCallback: <span class="dt">DiffUtil</span>.<span class="dt">ItemCallback</span>&lt;<span class="dt">BusApproach</span>&gt;() {</span>
<span id="cb108-20"><a href="#cb108-20"></a>        <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">areItemsTheSame</span>(<span class="va">oldItem</span>: <span class="dt">BusApproach</span>, <span class="va">newItem</span>: <span class="dt">BusApproach</span>) = oldItem.id == newItem.id</span>
<span id="cb108-21"><a href="#cb108-21"></a>        <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">areContentsTheSame</span>(<span class="va">oldItem</span>: <span class="dt">BusApproach</span>, <span class="va">newItem</span>: <span class="dt">BusApproach</span>) = oldItem == newItem</span>
<span id="cb108-22"><a href="#cb108-22"></a>    }</span>
<span id="cb108-23"><a href="#cb108-23"></a></span>
<span id="cb108-24"><a href="#cb108-24"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateViewHolder</span>(<span class="va">viewGroup</span>: <span class="dt">ViewGroup</span>, <span class="va">viewType</span>: <span class="dt">Int</span>): <span class="dt">ViewHolder</span> = ViewHolder(ListItemBusApproachBinding.inflate(LayoutInflater.from(viewGroup.context), viewGroup, <span class="kw">false</span>))</span>
<span id="cb108-25"><a href="#cb108-25"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onBindViewHolder</span>(<span class="va">viewHolder</span>: <span class="dt">ViewHolder</span>, <span class="va">position</span>: <span class="dt">Int</span>) = viewHolder.bind(getItem(position))</span>
<span id="cb108-26"><a href="#cb108-26"></a>}</span></code></pre></div>
<p>fragment_bus_approaches.xmlに<code>RecyclerView</code>を追加します。</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb109-1"><a href="#cb109-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb109-2"><a href="#cb109-2"></a><span class="kw">&lt;layout</span></span>
<span id="cb109-3"><a href="#cb109-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb109-4"><a href="#cb109-4"></a><span class="ot">    xmlns:tools=</span><span class="st">&quot;http://schemas.android.com/tools&quot;</span></span>
<span id="cb109-5"><a href="#cb109-5"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span>
<span id="cb109-6"><a href="#cb109-6"></a><span class="ot">    tools:context=</span><span class="st">&quot;.DepartureBusStopFragment&quot;</span><span class="kw">&gt;</span></span>
<span id="cb109-7"><a href="#cb109-7"></a></span>
<span id="cb109-8"><a href="#cb109-8"></a>    <span class="kw">&lt;data&gt;</span></span>
<span id="cb109-9"><a href="#cb109-9"></a>        <span class="kw">&lt;variable</span><span class="ot"> name=</span><span class="st">&quot;viewModel&quot;</span><span class="ot"> type=</span><span class="st">&quot;com.tail_island.jetbus.view_model.BusApproachesViewModel&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb109-10"><a href="#cb109-10"></a>    <span class="kw">&lt;/data&gt;</span></span>
<span id="cb109-11"><a href="#cb109-11"></a></span>
<span id="cb109-12"><a href="#cb109-12"></a>    <span class="kw">&lt;androidx.constraintlayout.widget.ConstraintLayout</span></span>
<span id="cb109-13"><a href="#cb109-13"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb109-14"><a href="#cb109-14"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;match_parent&quot;</span><span class="kw">&gt;</span></span>
<span id="cb109-15"><a href="#cb109-15"></a></span>
<span id="cb109-16"><a href="#cb109-16"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb109-17"><a href="#cb109-17"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/departureBusStopAndArrivalBusStopTextView&quot;</span></span>
<span id="cb109-18"><a href="#cb109-18"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb109-19"><a href="#cb109-19"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb109-20"><a href="#cb109-20"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb109-21"><a href="#cb109-21"></a><span class="ot">            android:layout_marginStart=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb109-22"><a href="#cb109-22"></a><span class="ot">            android:layout_marginEnd=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb109-23"><a href="#cb109-23"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb109-24"><a href="#cb109-24"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb109-25"><a href="#cb109-25"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb109-26"><a href="#cb109-26"></a><span class="ot">            android:text=</span><span class="st">&#39;@{String.format(&quot;%s %s %s&quot;, viewModel.departureBusStopName, @string/start_to_end_arrow, viewModel.arrivalBusStopName)}&#39;</span> <span class="kw">/&gt;</span></span>
<span id="cb109-27"><a href="#cb109-27"></a></span>
<span id="cb109-28"><a href="#cb109-28"></a>        <span class="kw">&lt;ImageView</span></span>
<span id="cb109-29"><a href="#cb109-29"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/bookmarkImageView&quot;</span></span>
<span id="cb109-30"><a href="#cb109-30"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb109-31"><a href="#cb109-31"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb109-32"><a href="#cb109-32"></a><span class="ot">            android:layout_marginEnd=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb109-33"><a href="#cb109-33"></a><span class="ot">            app:layout_constraintTop_toTopOf=</span><span class="st">&quot;@id/departureBusStopAndArrivalBusStopTextView&quot;</span></span>
<span id="cb109-34"><a href="#cb109-34"></a><span class="ot">            app:layout_constraintBottom_toBottomOf=</span><span class="st">&quot;@id/departureBusStopAndArrivalBusStopTextView&quot;</span></span>
<span id="cb109-35"><a href="#cb109-35"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb109-36"><a href="#cb109-36"></a><span class="ot">            android:src=</span><span class="st">&#39;@{viewModel.bookmark != null ? @drawable/ic_bookmark_on : @drawable/ic_bookmark_off}&#39;</span> <span class="kw">/&gt;</span></span>
<span id="cb109-37"><a href="#cb109-37"></a></span>
<span id="cb109-38"><a href="#cb109-38"></a>        <span class="kw">&lt;androidx.recyclerview.widget.RecyclerView</span></span>
<span id="cb109-39"><a href="#cb109-39"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/recyclerView&quot;</span></span>
<span id="cb109-40"><a href="#cb109-40"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb109-41"><a href="#cb109-41"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;0dp&quot;</span></span>
<span id="cb109-42"><a href="#cb109-42"></a><span class="ot">            android:paddingBottom=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb109-43"><a href="#cb109-43"></a><span class="ot">            android:paddingStart=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb109-44"><a href="#cb109-44"></a><span class="ot">            android:paddingEnd=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb109-45"><a href="#cb109-45"></a><span class="ot">            android:clipToPadding=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb109-46"><a href="#cb109-46"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb109-47"><a href="#cb109-47"></a><span class="ot">            app:layout_constraintTop_toBottomOf=</span><span class="st">&quot;@id/departureBusStopAndArrivalBusStopTextView&quot;</span></span>
<span id="cb109-48"><a href="#cb109-48"></a><span class="ot">            app:layout_constraintBottom_toBottomOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb109-49"><a href="#cb109-49"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb109-50"><a href="#cb109-50"></a><span class="ot">            app:layout_constraintEnd_toEndOf=</span><span class="st">&quot;parent&quot;</span></span>
<span id="cb109-51"><a href="#cb109-51"></a><span class="ot">            app:layoutManager=</span><span class="st">&quot;androidx.recyclerview.widget.LinearLayoutManager&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb109-52"><a href="#cb109-52"></a></span>
<span id="cb109-53"><a href="#cb109-53"></a>        <span class="kw">&lt;TextView</span></span>
<span id="cb109-54"><a href="#cb109-54"></a><span class="ot">            android:id=</span><span class="st">&quot;@+id/noBusApproachesTextView&quot;</span></span>
<span id="cb109-55"><a href="#cb109-55"></a><span class="ot">            android:layout_width=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb109-56"><a href="#cb109-56"></a><span class="ot">            android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb109-57"><a href="#cb109-57"></a><span class="ot">            android:layout_marginTop=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb109-58"><a href="#cb109-58"></a><span class="ot">            app:layout_constraintStart_toStartOf=</span><span class="st">&quot;@id/departureBusStopAndArrivalBusStopTextView&quot;</span></span>
<span id="cb109-59"><a href="#cb109-59"></a><span class="ot">            app:layout_constraintTop_toBottomOf=</span><span class="st">&quot;@id/departureBusStopAndArrivalBusStopTextView&quot;</span></span>
<span id="cb109-60"><a href="#cb109-60"></a><span class="ot">            android:visibility=</span><span class="st">&quot;gone&quot;</span></span>
<span id="cb109-61"><a href="#cb109-61"></a><span class="ot">            android:text=</span><span class="st">&quot;@string/no_bus_approaches&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb109-62"><a href="#cb109-62"></a></span>
<span id="cb109-63"><a href="#cb109-63"></a>    <span class="kw">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></span>
<span id="cb109-64"><a href="#cb109-64"></a></span>
<span id="cb109-65"><a href="#cb109-65"></a><span class="kw">&lt;/layout&gt;</span></span></code></pre></div>
<p>データ件数が0件だった場合に画面に何も表示されないと混乱するので、<code>noBusApproachesTextView</code>で「接近中のバスはありません」と表示するようにしています。</p>
<p>これで最後の<code>BusApproachesFragment</code>は、処理の大部分を他のレイヤに移動させているのでとても簡単です。</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb110-1"><a href="#cb110-1"></a><span class="kw">package</span> <span class="im">com.tail_island.jetbus</span></span>
<span id="cb110-2"><a href="#cb110-2"></a></span>
<span id="cb110-3"><a href="#cb110-3"></a><span class="kw">import</span> <span class="im">android.os.Bundle</span></span>
<span id="cb110-4"><a href="#cb110-4"></a><span class="kw">import</span> <span class="im">android.view.LayoutInflater</span></span>
<span id="cb110-5"><a href="#cb110-5"></a><span class="kw">import</span> <span class="im">android.view.View</span></span>
<span id="cb110-6"><a href="#cb110-6"></a><span class="kw">import</span> <span class="im">android.view.ViewGroup</span></span>
<span id="cb110-7"><a href="#cb110-7"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.Fragment</span></span>
<span id="cb110-8"><a href="#cb110-8"></a><span class="kw">import</span> <span class="im">androidx.fragment.app.viewModels</span></span>
<span id="cb110-9"><a href="#cb110-9"></a><span class="kw">import</span> <span class="im">androidx.lifecycle.Observer</span></span>
<span id="cb110-10"><a href="#cb110-10"></a><span class="kw">import</span> <span class="im">androidx.navigation.fragment.navArgs</span></span>
<span id="cb110-11"><a href="#cb110-11"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.adapter.BusApproachAdapter</span></span>
<span id="cb110-12"><a href="#cb110-12"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.databinding.FragmentBusApproachesBinding</span></span>
<span id="cb110-13"><a href="#cb110-13"></a><span class="kw">import</span> <span class="im">com.tail_island.jetbus.view_model.BusApproachesViewModel</span></span>
<span id="cb110-14"><a href="#cb110-14"></a><span class="kw">import</span> <span class="im">javax.inject.Inject</span></span>
<span id="cb110-15"><a href="#cb110-15"></a></span>
<span id="cb110-16"><a href="#cb110-16"></a><span class="kw">class</span> BusApproachesFragment: <span class="dt">Fragment</span>() {</span>
<span id="cb110-17"><a href="#cb110-17"></a>    <span class="at">@Inject</span> lateinit <span class="kw">var</span> <span class="va">viewModelProviderFactory</span>: AppViewModelProvideFactory</span>
<span id="cb110-18"><a href="#cb110-18"></a></span>
<span id="cb110-19"><a href="#cb110-19"></a>    <span class="kw">private</span> <span class="kw">val</span> <span class="va">viewModel</span> <span class="kw">by</span> viewModels&lt;BusApproachesViewModel&gt; { viewModelProviderFactory }</span>
<span id="cb110-20"><a href="#cb110-20"></a></span>
<span id="cb110-21"><a href="#cb110-21"></a>    <span class="kw">private</span> <span class="kw">val</span> <span class="va">args</span> <span class="kw">by</span> navArgs&lt;BusApproachesFragmentArgs&gt;()</span>
<span id="cb110-22"><a href="#cb110-22"></a></span>
<span id="cb110-23"><a href="#cb110-23"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">onCreateView</span>(<span class="va">inflater</span>: <span class="dt">LayoutInflater</span>, <span class="va">container</span>: <span class="dt">ViewGroup?</span>, <span class="va">savedInstanceState</span>: <span class="dt">Bundle?</span>): <span class="dt">View?</span> {</span>
<span id="cb110-24"><a href="#cb110-24"></a>        (requireActivity().application <span class="kw">as</span> App).component.inject(<span class="kw">this</span>)</span>
<span id="cb110-25"><a href="#cb110-25"></a></span>
<span id="cb110-26"><a href="#cb110-26"></a>        viewModel.departureBusStopName.value = args.departureBusStopName</span>
<span id="cb110-27"><a href="#cb110-27"></a>        viewModel.arrivalBusStopName.value   = args.arrivalBusStopName</span>
<span id="cb110-28"><a href="#cb110-28"></a></span>
<span id="cb110-29"><a href="#cb110-29"></a>        <span class="kw">return</span> FragmentBusApproachesBinding.inflate(inflater, container, <span class="kw">false</span>).apply {</span>
<span id="cb110-30"><a href="#cb110-30"></a>            lifecycleOwner = viewLifecycleOwner</span>
<span id="cb110-31"><a href="#cb110-31"></a>            viewModel      = this<span class="at">@BusApproachesFragment</span>.viewModel</span>
<span id="cb110-32"><a href="#cb110-32"></a></span>
<span id="cb110-33"><a href="#cb110-33"></a>            bookmarkImageView.setOnClickListener {</span>
<span id="cb110-34"><a href="#cb110-34"></a>                this<span class="at">@BusApproachesFragment</span>.viewModel.toggleBookmark()</span>
<span id="cb110-35"><a href="#cb110-35"></a>            }</span>
<span id="cb110-36"><a href="#cb110-36"></a></span>
<span id="cb110-37"><a href="#cb110-37"></a>            recyclerView.adapter = BusApproachAdapter().apply {</span>
<span id="cb110-38"><a href="#cb110-38"></a>                this<span class="at">@BusApproachesFragment</span>.viewModel.busApproaches.observe(viewLifecycleOwner, Observer {</span>
<span id="cb110-39"><a href="#cb110-39"></a>                    noBusApproachesTextView.visibility = <span class="cf">if</span> (it.isEmpty()) { View.VISIBLE } <span class="cf">else</span> { View.GONE }</span>
<span id="cb110-40"><a href="#cb110-40"></a></span>
<span id="cb110-41"><a href="#cb110-41"></a>                    submitList(it)</span>
<span id="cb110-42"><a href="#cb110-42"></a>                })</span>
<span id="cb110-43"><a href="#cb110-43"></a>            }</span>
<span id="cb110-44"><a href="#cb110-44"></a>        }.root</span>
<span id="cb110-45"><a href="#cb110-45"></a>    }</span>
<span id="cb110-46"><a href="#cb110-46"></a>}</span></code></pre></div>
<p>動画</p>
<p>はい。動きました！　これで通勤が楽になるのでもう少しサラリーマンを続けられそうです。素晴らしい！</p>
<h1 id="asset-studioでアイコンを作れば完成">Asset Studioでアイコンを作れば完成！</h1>
<p>でも、まだ不十分。アイコンを作らないとね。Android Studioのメニューから[File] - [New] - [Image Asset]を選んで、アプリのアイコンを作成します。</p>
<p>まぁ、私に絵心はないので、Android Studioのアイコンを流用するだけなんですけどな。[Source Asset]の[Asset Type]の[Clip Art]ラジオ・ボタンをクリックすると、Android Studioが提供するアイコンから選べるようになります。</p>
<p>絵</p>
<p>Clip Artをクリックして、バスのアイコンをクリックします。</p>
<p>絵</p>
<p>色を設定します。今回は真っ白にしたいので、「FFFFFF」を入力します。</p>
<p>絵</p>
<p>背景の絵を考えるのも面倒でしたので、単色でやりましょう。[Background Layer]タブを選択して、Colorをクリックします。背景色は、アプリの<code>colorPrimaryDark</code>に設定した色の「006428」です。この色は<a href="https://material.io/resources/color/#!/?view.left=0&amp;view.right=1">Color Tool</a>で作成しました。Primary Colorに適当な色を設定するだけでPrimary Dark Colorが作成されてとても便利ですよ。</p>
<p>絵</p>
<p>あとは、[Next]ボタンをクリックして[Finish]ボタンをクリックして、ビルドしてインストールして、でも何故かアプリのアイコンが変わりませんでした……。</p>
<p>その理由は、drawableのリソースのXMLにはAndroidのバージョンで記述できる事柄に差異があって、Android Studioがデフォルトで作成したアプリのアイコンは新しいバージョン向け、Image Assetで先程作成したアプリのアイコンは古いバージョン向けのファイルを作成していたため。というわけで、不要になった以前のdrawableを消しちゃいましょう。app/src/main/res/drawable-v24フォルダをまるっと削除しました。</p>
<p>まだ終わりません。今回は単色の背景にしたので、app/src/main/res/valuesフォルダの中にic_launcher_background.xmlが生成されています。でも、以前のアイコンはいろいろ描いてあるベクトル・グラフィックスだったので、app/src/main/res/drawablesにあったんですよ。以前のアイコン向けの背景が悪さをするのを防ぐために、app/src/main/res/drawable/ic_launcher_background.xmlも削除します。</p>
<p>ふう、これで本当の本当に完了です。いろいろあったけど、Androidアプリの開発って別に難しくない、というか簡単でしょ？ Android Jetpackは本当に偉大なライブラリですな。</p>
</article>
</body>
</html>
